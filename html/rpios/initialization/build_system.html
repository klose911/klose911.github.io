<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kernel build system</title>
<meta name="author" content="Wu, Shanliang" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
</style>
<link rel="stylesheet" type="text/css" href="../css/main.css" />
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="./linux.html"> UP </a>
 |
 <a accesskey="H" href="./initialization.html"> HOME </a>
</div><div id="content" class="content">
<h1 class="title">Kernel build system</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org43b0c62">A few essential kbuild concepts</a></li>
<li><a href="#org89e8946">Building the kernel</a>
<ul>
<li><a href="#orgf02ccdd">Link stage</a></li>
<li><a href="#orgb654287">Build stage</a></li>
</ul>
</li>
</ul>
</div>
</div>
<pre class="example" id="org8ed742e">
After we examined Linux kernel structure, it worth spending some time investigating how we can build and run it
</pre>
<p>
Linux also uses <span class="underline">make</span> utility to build the kernel, though Linux Makefile is much more complicated. Before we will take a look at the makefile, let's learn some important concepts about Linux build system, which is called <span class="underline">kbuild</span>
</p>
<div id="outline-container-org43b0c62" class="outline-2">
<h2 id="org43b0c62">A few essential kbuild concepts</h2>
<div class="outline-text-2" id="text-org43b0c62">
<p>
Build process can be customized by using kbuild variables. Those variables are defined in <span class="underline">Kconfig</span> files.
</p>
<ul class="org-ul">
<li>Here you can define the variables themselves and their default values
<ul class="org-ul">
<li>Variables can have different types, including string, boolean and integer</li>
</ul></li>
<li><p>
In a Kconfig file you can also define dependencies between variables
</p>
<pre class="example" id="orgc6b5a76">
 for example, you can say that if variable X is selected then variable Y will be selected implicitly

you can take a look at arm64 Kconfig file. This file defines all variables, specific for arm64 architecture
</pre></li>
<li>Kconfig functionality is not part of the standard make and is implemented in the Linux makefile</li>
<li>Variables, defined in Kconfig are exposed to the kernel source code as well as to the nested makefiles</li>
<li><p>
Variable values can be set during kernel configuration step
</p>
<pre class="example" id="org88cb99b">
for example, if you type make menuconfig a console GUI will be shown

It allows you to customize values for all kernel variables and stores the values in .config

Use make help command to view all possible options to configure the kernel
</pre></li>
</ul>

<p>
Linux uses <b>recursive</b> build. This means that each subfolder of the Linux kernel can define it's own Makefile and Kconfig. Most of the nested Makefiles are very simple and just define what object files need to be compiled. Usually, such definitions have the following format:
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span style="color: #4eee94;">obj-$(</span><span style="color: #4eee94;">SOME_CONFIG_VARIABLE</span><span style="color: #4eee94;">)</span> += some_file.o
</pre>
</div>

<p>
This definition means that <span class="underline">some_file.c</span> will be compiled and linked to the kernel only if <span class="underline">SOME_CONFIG_VARIABLE</span> is <b>set</b> . If you want to compile and link a file unconditionally, you need to change the previous definition to look like this 
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span style="color: #4eee94;">obj-y</span> += some_file.o
</pre>
</div>

<p>
Before we move forward, you need to understand the structure of a basic make <span class="underline">rule</span> and be comfortable with make <span class="underline">terminology</span> . Common rule structure is illustrated in the following diagram:
</p>
<div class="org-src-container">
<pre class="src src-makefile"><span style="color: #daa520; font-weight: bold;">targets</span> : prerequisites
recipe
&#8230;
</pre>
</div>
<ul class="org-ul">
<li><span class="underline">targets</span> : are file names, separated by spaces. Targets are <b>generated</b> after the rule is executed. Usually, there is only one target per rule</li>
<li><span class="underline">prerequisites</span> : are files that make trackes to see whether it needs to <b>update</b> the targets</li>
<li><p>
<span class="underline">recipe</span> is a <b>bash</b> script. Make calls it when some of the prerequisites have been updated. The recipe is responsible for <b>generating</b> the targets.
</p>

<pre class="example" id="org533eb7a">
Both targets and prerequisites can include wildcards (%). When wildcards are used the recipe is executed for each of the matched prerequisites separately

In this case, you can use $&lt; and $@ variables to refer to the prerequisite and the target inside the recipe 
</pre></li>
</ul>

<p>
<span class="underline">make</span> is very good in detecting whether any of the prerequisites have been changed and updating only targets that need to be rebuilt
</p>
<pre class="example" id="org1e13a57">
However, if a recipe is dynamically updated, make is unable to detect this change

One good example is when you change some configuration variable, which results in appending an additional option to the recipe

By default, in this case, make will not recompile previously generated object files, because their prerequisites haven't been changed, only the recipe have been updated
</pre>


<p>
To overcome this behavior Linux introduces <span class="underline">if_changed</span> function. To see how it works let's consider the following example:
</p>
<div class="org-src-container">
<pre class="src src-makefile"><span style="color: #4eee94;">cmd_compile</span> = gcc $(<span style="color: #4eee94;">flags</span>) -o <span style="color: #daa520; font-weight: bold;">$</span><span style="color: #ffd700; font-weight: bold;">@</span> $<span style="color: #ffd700;">&lt;</span>

<span style="color: #daa520; font-weight: bold;">%.o</span>: %.c FORCE
$(<span style="color: #4eee94;">call</span> if_changed,compile)
</pre>
</div>

<p>
Here for each .c file we build corresponding .o file by calling if_changed function with the argument compile. <span class="underline">if_changed</span> then looks for <span class="underline">cmd_compile</span> variable (it adds cmd_ prefix to the first argument) and checks whether this variable has been updated since the last execution, or any of the prerequisites has been changed:
</p>
<ul class="org-ul">
<li>If yes: cmd_compile command is executed and object file is regenerated</li>
</ul>

<p>
Our sample rule has 2 prerequisites: source .c file and <span class="underline">FORCE</span>
</p>
<ul class="org-ul">
<li><p>
FORCE is a special prerequisite that forces the recipe to be called each time when make command is called
</p>
<pre class="example" id="orgc1c58fb">
Without it, the recipe would be called only if .c file was changed
</pre></li>
</ul>
</div>
</div>
<div id="outline-container-org89e8946" class="outline-2">
<h2 id="org89e8946">Building the kernel</h2>
<div class="outline-text-2" id="text-org89e8946">
<p>
Now, that we learned some important concepts about the Linux build system, let's try to figure out what exactly is going on after you type make command. This process is very complicated and includes a lot of details, most of which we will skip. Our goal will be to answer 2 questions.
</p>
<ol class="org-ol">
<li>How exactly are source files compiled into object files?</li>
<li>How are object files linked into the OS image?</li>
</ol>

<p>
We are going to tackle the second question first.
</p>
</div>
<div id="outline-container-orgf02ccdd" class="outline-3">
<h3 id="orgf02ccdd">Link stage</h3>
<div class="outline-text-3" id="text-orgf02ccdd">
<p>
As you might see from the output of <span class="underline">make help</span> command, the default target, which is responsible for building the kernel, is called <b>vmlinux</b> and it looks like this:
</p>

<div class="org-src-container">
<pre class="src src-makefile"><span style="color: #4eee94;">cmd_link-vmlinux</span> =                                                 \
$(<span style="color: #4eee94;">CONFIG_SHELL</span>) $<span style="color: #ffd700;">&lt;</span> $(<span style="color: #4eee94;">LD</span>) $(<span style="color: #4eee94;">LDFLAGS</span>) $(<span style="color: #4eee94;">LDFLAGS_vmlinux</span>) ;    \
$(<span style="color: #4eee94;">if</span> $(<span style="color: #4eee94;">ARCH_POSTLINK</span>), $(<span style="color: #4eee94;">MAKE</span>) -f $(<span style="color: #4eee94;">ARCH_POSTLINK</span>) <span style="color: #daa520; font-weight: bold;">$</span><span style="color: #ffd700; font-weight: bold;">@</span>, true)

<span style="color: #daa520; font-weight: bold;">vmlinux</span>: scripts/link-vmlinux.sh vmlinux_prereq $(<span style="color: #4eee94;">vmlinux-deps</span>) FORCE
+$(<span style="color: #4eee94;">call</span> if_changed,link-vmlinux)
</pre>
</div>

<p>
This target uses already familiar to us <span class="underline">if_changed</span> function. Whenever some of the prerequsities are updated <span class="underline">cmd_link-vmlinux</span> command is executed. This command executes <span class="underline">scripts/link-vmlinux.sh</span> script
</p>

<pre class="example" id="org659f30e">
Note usage of $&lt; automatic variable in the cmd_link-vmlinux command

It also executes architecture specific postlink script, but we are not very interested in it
</pre>

<p>
When <span class="underline">scripts/link-vmlinux.sh</span> is executed it assumes that all required object files are already built and their locations are stored in 3 variables:
</p>
<ul class="org-ul">
<li><span class="underline">KBUILD_VMLINUX_INIT</span></li>
<li><span class="underline">KBUILD_VMLINUX_MAIN</span></li>
<li><span class="underline">KBUILD_VMLINUX_LIBS</span></li>
</ul>

<p>
<span class="underline">link-vmlinux.sh</span> script first creates thin archive from all available object files. thin archive is a special object that contains references to a set of <b>object files</b> as well as their combined <b>symbol table</b> . This is done inside <span class="underline">archive_builtin</span> function. In order to create thin archive this function uses <b>ar</b> utility. Generated thin archive is stored as <span class="underline">built-in.o</span> file and has the format that is understandable by the linker, so it can be used as any other normal object file
</p>

<p>
Next <span class="underline">modpost_link</span> is called. This function calls <span class="underline">linker</span> and <b>generates</b> <span class="underline">vmlinux.o</span> object file
</p>
<pre class="example" id="orgc271ece">
We need this object file to perform Section mismatch analysis

This analysis is performed by the modpost program
</pre>

<p>
Next <span class="underline">kernel symbol table</span> is generated. It contains information about all functions and global variables as well as their location in the vmlinux binary. The main work is done inside <span class="underline">kallsyms</span> function:
</p>
<ol class="org-ol">
<li>This function first uses <b>nm</b> to extract all symbols from vmlinux binary</li>
<li>Then it uses <span class="underline">scripts/kallsyms</span> utility to generate a special assembler file containing all symbols in a special format, understandable by the Linux kernel</li>
<li><p>
Next, this assembler file is compiled and linked together with the original binary. Information from the kernel symbol table is used to generate <span class="underline">/proc/kallsyms</span> file at runtime
</p>
<pre class="example" id="org43d1175">
This process is repeated several times because after the final link addresses of some symbols can be changed
</pre></li>
</ol>

<p>
Finally <span class="underline">vmlinux</span> binary is ready and <span class="underline">System.map</span> is build. System.map contains the same information as <span class="underline">/proc/kallsyms</span> but this is <b>static</b> file and unlike /proc/kallsyms it is not generated at runtime. System.map is mostly used to <b>resolve</b> <span class="underline">addresses</span> to <span class="underline">symbol names</span> during kernel oops. The same <b>nm</b> utility is used to build System.map 
</p>
</div>
</div>
<div id="outline-container-orgb654287" class="outline-3">
<h3 id="orgb654287">Build stage</h3>
</div>
</div>
</div>
<div id="postamble" class="status">

		  <br/>
		  <div class='ds-thread'></div>
		  <script>
		  var duoshuoQuery = {short_name:'klose911'};
		  (function() {
					  var dsThread = document.getElementsByClassName('ds-thread')[0];
					  dsThread.setAttribute('data-thread-key', document.title);
					  dsThread.setAttribute('data-title', document.title);
					  dsThread.setAttribute('data-url', window.location.href);
					  var ds = document.createElement('script');
					  ds.type = 'text/javascript';ds.async = true;
					  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
					  ds.charset = 'UTF-8';
					  (document.getElementsByTagName('head')[0] 
						|| document.getElementsByTagName('body')[0]).appendChild(ds);
					  })();
		  </script>
		  <script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
		  ga('create', 'UA-90850421-1', 'auto');
		  ga('send', 'pageview');
		  </script>
</div>
</body>
</html>
