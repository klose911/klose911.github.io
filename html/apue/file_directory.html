<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>文件和目录</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wu, Shanliang" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="css/main.css" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="file_io.html"> UP </a>
 |
 <a accesskey="H" href="apue.html"> HOME </a>
</div><div id="content">
<h1 class="title">文件和目录</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgf51d2da">stat、fstat和lstat函数</a>
<ul>
<li><a href="#org460b728">stat结构</a></li>
</ul>
</li>
<li><a href="#org57bb942">文件类型</a>
<ul>
<li><a href="#org1500e61">文件类型测试宏</a></li>
</ul>
</li>
<li><a href="#org8766df0">文件权限</a>
<ul>
<li><a href="#orgfa5ba38">进程相关的用户和组ID</a></li>
<li><a href="#org90f5f24">设置-用户-ID和设置-组-ID</a></li>
<li><a href="#org2b33019">文件存取许可权</a>
<ul>
<li><a href="#org48fea8f">存取权限规则</a></li>
<li><a href="#orgf3877a6">存取权限测试</a></li>
<li><a href="#orgb41801b">新文件和目录的所有权</a></li>
</ul>
</li>
<li><a href="#org0d96ba3">access函数</a>
<ul>
<li><a href="#org303ecd9">mode参数</a></li>
<li><a href="#orgaecdc92">access函数实例</a></li>
</ul>
</li>
<li><a href="#org13e9e78">umask函数</a>
<ul>
<li><a href="#org6c54b5a">umask实例</a></li>
</ul>
</li>
<li><a href="#orgaa9d48c">chmod和fchmod函数</a>
<ul>
<li><a href="#org4ab0852">mode参数</a></li>
<li><a href="#org95ceeaa">chmod实例</a></li>
<li><a href="#orgc74a9fd">自动忽略某些权限常数</a></li>
</ul>
</li>
<li><a href="#org1051939">chown, fchown和lchown函数</a>
<ul>
<li><a href="#org7d1b787">chown限制</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgde44fc5">文件长度</a>
<ul>
<li><a href="#org32109d2">st_blksize和st_blocks</a></li>
<li><a href="#orgbc572c1">文件空洞</a></li>
<li><a href="#orgea11c07">truncate和ftruncate函数</a></li>
</ul>
</li>
<li><a href="#org81a56ff">文件系统</a>
<ul>
<li><a href="#org0aaf383">i节点</a></li>
<li><a href="#orgc4151c4">目录项</a></li>
<li><a href="#orgbc769d0">数据块</a></li>
<li><a href="#orgf364669">链接</a>
<ul>
<li><a href="#org8f1d34c">硬链接</a></li>
<li><a href="#orge3a1736">符号链接</a></li>
<li><a href="#org2b0ae50">目录链接</a></li>
</ul>
</li>
<li><a href="#org89e6383">link函数</a></li>
<li><a href="#org33fd0ef">unlink函数</a>
<ul>
<li><a href="#org20e6199">unlink实例</a></li>
</ul>
</li>
<li><a href="#orgfa1709a">remove函数</a></li>
<li><a href="#org45ec1d9">rename函数</a></li>
<li><a href="#org12609d1">符号连接</a>
<ul>
<li><a href="#orgb3c46d8">函数对符号连接的处理</a></li>
<li><a href="#org30d5bad">符号连接循环</a></li>
</ul>
</li>
<li><a href="#org7e0ea1a">symlink函数</a></li>
<li><a href="#org2f42988">readlink函数</a></li>
</ul>
</li>
<li><a href="#org5a60ae2">文件的时间</a>
<ul>
<li><a href="#org62e4268">三个时间的作用</a></li>
<li><a href="#org7e35ef7">各个函数的影响</a></li>
<li><a href="#org238205b">utime函数</a>
<ul>
<li><a href="#org4cc18d8">utime函数实例</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org3c63e8d">目录操作</a>
<ul>
<li><a href="#org81213ac">mkdir函数</a></li>
<li><a href="#org7094d56">rmdir函数</a></li>
<li><a href="#org7456a28">读取目录</a>
<ul>
<li><a href="#org14a0219">DIR和dirent结构</a></li>
<li><a href="#org5862b6a">目录流操作函数</a></li>
<li><a href="#org29cd2b3">遍历文件层次结构</a></li>
</ul>
</li>
<li><a href="#org488cb2f">chdir，fchdir函数</a>
<ul>
<li><a href="#orga6f73e2">chdir实例</a></li>
</ul>
</li>
<li><a href="#org1949041">getpwd函数</a>
<ul>
<li><a href="#orge9adfd8">getpwd实例</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgd1ac8f6">设备文件</a>
<ul>
<li><a href="#org364315f">打印设备号</a></li>
<li><a href="#org28ef86b">sync，fsync函数</a></li>
</ul>
</li>
</ul>
</div>
</div>
<pre class="example">
  首先从stat函数开始逐个说明stat结构的每一个成员以了解文件的所有属性

  然后将说明修改这些属性的各个函数(更改所有者,更改许可权等)

  接着更详细地察看UNIX文件系统的结构以及符号连接

  最后介绍对目录进行操作的各个函数并且开发了一个以降序遍历目录层次结构的函数
</pre>

<div id="outline-container-orgf51d2da" class="outline-2">
<h2 id="orgf51d2da">stat、fstat和lstat函数</h2>
<div class="outline-text-2" id="text-orgf51d2da">
<p>
<b>获取一个文件的详细信息</b> 可以使用 <span class="underline">stat</span> 函数组：
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;sys/types.h&gt;</span>
<span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;sys/stat.h&gt;</span>

<span style="color: #ffebcd;">/**</span>
<span style="color: #ffebcd;"> *  &#26681;&#25454;&#25991;&#20214;&#36335;&#24452;&#21517;&#33719;&#21462;&#25991;&#20214;&#30340;&#35814;&#32454;&#20449;&#24687;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * pathname: &#25991;&#20214;&#36335;&#24452;&#21517;</span>
<span style="color: #ffebcd;"> * buf: &#25351;&#21521;&#25991;&#20214;&#20449;&#24687;&#32467;&#26500;&#20307;stat&#21464;&#37327;&#30340;&#25351;&#38024;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> *  &#25104;&#21151;&#65306;&#36820;&#22238; 0&#65292;&#20986;&#38169;&#65306;&#36820;&#22238; -1</span>
<span style="color: #ffebcd;"> * </span>
<span style="color: #ffebcd;"> */</span>
<span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">stat</span>(<span style="color: #00bfff; font-weight: bold;">const</span> <span style="color: #98f5ff;">char</span>* <span style="color: #4eee94;">pathname</span>, <span style="color: #00bfff; font-weight: bold;">struct</span> <span style="color: #98f5ff;">stat</span>* <span style="color: #4eee94;">buf</span>);

<span style="color: #ffebcd;">/**</span>
<span style="color: #ffebcd;"> * &#26681;&#25454;&#25991;&#20214;&#25551;&#36848;&#31526;&#33719;&#21462;&#25991;&#20214;&#30340;&#35814;&#32454;&#20449;&#24687;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * filedes: &#25991;&#20214;&#25551;&#36848;&#31526;&#21495;</span>
<span style="color: #ffebcd;"> * buf: &#25351;&#21521;&#25991;&#20214;&#20449;&#24687;&#32467;&#26500;&#20307;stat&#21464;&#37327;&#30340;&#25351;&#38024;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * &#25104;&#21151;&#65306;&#36820;&#22238; 0&#65292;&#20986;&#38169;&#65306;&#36820;&#22238; -1</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> */</span>
<span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">fstat</span>(<span style="color: #98f5ff;">int</span> <span style="color: #4eee94;">filedes</span>, <span style="color: #00bfff; font-weight: bold;">struct</span> <span style="color: #98f5ff;">stat</span>* <span style="color: #4eee94;">buf</span>);  


<span style="color: #ffebcd;">/**</span>
<span style="color: #ffebcd;"> * &#36820;&#22238;&#38142;&#25509;&#25991;&#20214;&#30340;&#26377;&#20851;&#20449;&#24687;,&#32780;&#19981;&#26159;&#30001;&#35813;&#38142;&#25509;&#24341;&#29992;&#30340;&#25991;&#20214;&#30340;&#20449;&#24687;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * pathname&#65306;&#25991;&#20214;&#36335;&#24452;&#21517;</span>
<span style="color: #ffebcd;"> * buf&#65306;&#25351;&#21521;&#25991;&#20214;&#20449;&#24687;&#32467;&#26500;&#20307;stat&#21464;&#37327;&#30340;&#25351;&#38024;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * &#25104;&#21151;&#65306;&#36820;&#22238; 0&#65292;&#20986;&#38169;&#65306;&#36820;&#22238; -1</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> */</span>
<span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">lstat</span>(<span style="color: #00bfff; font-weight: bold;">const</span> <span style="color: #98f5ff;">char</span>* <span style="color: #4eee94;">pathname</span>, <span style="color: #00bfff; font-weight: bold;">struct</span> <span style="color: #98f5ff;">stat</span>* <span style="color: #4eee94;">buf</span>);
</pre>
</div>
<p>
使用stat函数最多的可能是 <span class="underline">ls -l</span> 命令，用其可以获得有关一个文件的所有信息
</p>
</div>
<div id="outline-container-org460b728" class="outline-3">
<h3 id="org460b728">stat结构</h3>
<div class="outline-text-3" id="text-org460b728">
<p>
stat结构给出了Unix下 <b>文件(目录)各种属性</b> 的相关信息
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #00bfff; font-weight: bold;">struct</span> <span style="color: #98f5ff;">stat</span>  
{  
    <span style="color: #98f5ff;">mode_t</span> <span style="color: #4eee94;">st_mode</span>; <span style="color: #5f9ea0; font-style: italic;">//</span><span style="color: #5f9ea0; font-style: italic;">&#25991;&#20214;&#30340;&#31867;&#22411;&#21644;&#26435;&#38480;  </span>
    <span style="color: #98f5ff;">ino_t</span> <span style="color: #4eee94;">st_ino</span>; <span style="color: #5f9ea0; font-style: italic;">//</span><span style="color: #5f9ea0; font-style: italic;">inode&#30340;&#33410;&#28857;&#21495;  </span>
    <span style="color: #98f5ff;">dev_t</span> <span style="color: #4eee94;">st_dev</span>; <span style="color: #5f9ea0; font-style: italic;">//</span><span style="color: #5f9ea0; font-style: italic;">&#35774;&#22791;&#21495;  </span>
    <span style="color: #98f5ff;">dev_t</span> <span style="color: #4eee94;">st_rdev</span>; <span style="color: #5f9ea0; font-style: italic;">//</span><span style="color: #5f9ea0; font-style: italic;">&#29305;&#27530;&#35774;&#22791;&#21495;  </span>
    <span style="color: #98f5ff;">nlink_t</span> <span style="color: #4eee94;">st_nlink</span>; <span style="color: #5f9ea0; font-style: italic;">//</span><span style="color: #5f9ea0; font-style: italic;">&#30828;&#38142;&#25509;&#25968;  </span>
    <span style="color: #98f5ff;">uid_t</span> <span style="color: #4eee94;">st_uid</span>; <span style="color: #5f9ea0; font-style: italic;">//</span><span style="color: #5f9ea0; font-style: italic;">&#25991;&#20214;&#25152;&#26377;&#32773;  </span>
    <span style="color: #98f5ff;">gid_t</span> <span style="color: #4eee94;">st_gid</span>; <span style="color: #5f9ea0; font-style: italic;">//</span><span style="color: #5f9ea0; font-style: italic;">&#25991;&#20214;&#25152;&#23646;&#32452;  </span>
    <span style="color: #98f5ff;">off_t</span> <span style="color: #4eee94;">st_st_size</span>; <span style="color: #5f9ea0; font-style: italic;">//</span><span style="color: #5f9ea0; font-style: italic;">&#25991;&#20214;&#30340;&#23383;&#33410;&#25968;  </span>
    <span style="color: #98f5ff;">time_t</span> <span style="color: #4eee94;">st_atime</span>; <span style="color: #5f9ea0; font-style: italic;">//</span><span style="color: #5f9ea0; font-style: italic;">&#25991;&#20214;&#30340;&#26368;&#21518;&#23384;&#21462;&#26102;&#38388;  </span>
    <span style="color: #98f5ff;">time_t</span> <span style="color: #4eee94;">mtime</span>; <span style="color: #5f9ea0; font-style: italic;">//</span><span style="color: #5f9ea0; font-style: italic;">&#25991;&#20214;&#30340;&#26368;&#21518;&#20462;&#25913;&#26102;&#38388;  </span>
    <span style="color: #98f5ff;">time_t</span> <span style="color: #4eee94;">ctime</span>; <span style="color: #5f9ea0; font-style: italic;">//</span><span style="color: #5f9ea0; font-style: italic;">&#25991;&#20214;&#26435;&#38480;&#30340;&#26368;&#21518;&#20462;&#25913;&#26102;&#38388;  </span>
    <span style="color: #98f5ff;">long</span> <span style="color: #4eee94;">st_blksize</span>; <span style="color: #5f9ea0; font-style: italic;">//</span><span style="color: #5f9ea0; font-style: italic;">&#26368;&#20339;&#30340;IO&#22359;&#38271;&#24230;  </span>
    <span style="color: #98f5ff;">long</span> <span style="color: #4eee94;">st_blocks</span>; <span style="color: #5f9ea0; font-style: italic;">//</span><span style="color: #5f9ea0; font-style: italic;">512&#23383;&#33410;&#30340;&#22359;&#25968;  </span>
};  
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org57bb942" class="outline-2">
<h2 id="org57bb942">文件类型</h2>
<div class="outline-text-2" id="text-org57bb942">
<ul class="org-ul">
<li>普通文件</li>
<li>目录</li>
<li>字符特殊设备：某些类型的设备，终端等</li>
<li>块特殊设备：磁盘设备</li>
<li>FIFO管道：进程间的通信</li>
<li>Socket套接字：主要是进程间的网络通信，也可以是同一台机器不同进程间通信</li>
<li>符号链接：文件指向另一个文件</li>
</ul>
</div>
<div id="outline-container-org1500e61" class="outline-3">
<h3 id="org1500e61">文件类型测试宏</h3>
<div class="outline-text-3" id="text-org1500e61">
<table border="1" cellspacing="0" cellpadding="6" rules="all" frame="boader　">
<caption class="t-above"><span class="table-number">Table 1:</span> &lt;sys/stat.h&gt;中的文件类型宏</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">宏</td>
<td class="org-left">文件类型</td>
</tr>

<tr>
<td class="org-left">S_ISREG()</td>
<td class="org-left">普通文件</td>
</tr>

<tr>
<td class="org-left">S_ISDIR()</td>
<td class="org-left">目录文件</td>
</tr>

<tr>
<td class="org-left">S_ISCHR()</td>
<td class="org-left">字符特殊文件</td>
</tr>

<tr>
<td class="org-left">S_ISBLK()</td>
<td class="org-left">块特殊文件</td>
</tr>

<tr>
<td class="org-left">S_ISFIFO()</td>
<td class="org-left">管道或FIFO</td>
</tr>

<tr>
<td class="org-left">S_ISLNK()</td>
<td class="org-left">符号连接</td>
</tr>

<tr>
<td class="org-left">S_ISSOCK()</td>
<td class="org-left">套接字</td>
</tr>
</tbody>
</table>

<p>
文件类型信息包含在stat结构的 <b>st_mode</b> 成员内，以其为参数调用以下宏进行测试，如果返回为真则说明是此种文件类型
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;sys/types.h&gt;</span>
<span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;sys/stat.h&gt;</span> 
<span style="color: #ffd700;">#include</span> <span style="color: #deb887;">"apue.h"</span> 

<span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">main</span>(<span style="color: #98f5ff;">int</span> <span style="color: #4eee94;">argc</span>, <span style="color: #98f5ff;">char</span> *<span style="color: #4eee94;">argv</span>[]) 
{
    <span style="color: #98f5ff;">int</span> <span style="color: #4eee94;">i</span>; 
    <span style="color: #00bfff; font-weight: bold;">struct</span> <span style="color: #98f5ff;">stat</span> <span style="color: #4eee94;">buf</span>; 
    <span style="color: #98f5ff;">char</span> *<span style="color: #4eee94;">ptr</span>; 

    <span style="color: #00bfff; font-weight: bold;">for</span>(i = 1; i &lt; argc; ++i) { 
        printf(<span style="color: #deb887;">"%s: "</span>, argv[i]);
        <span style="color: #00bfff; font-weight: bold;">if</span>(lstat(argv[i], &amp;buf) &lt; 0) {
            err_ret(<span style="color: #deb887;">"lstat error"</span>); 
            <span style="color: #00bfff; font-weight: bold;">continue</span>; 
        }
        <span style="color: #00bfff; font-weight: bold;">if</span>(S_ISREG(buf.st_mode))
            ptr = <span style="color: #deb887;">"regular"</span>; 
        <span style="color: #00bfff; font-weight: bold;">else</span> <span style="color: #00bfff; font-weight: bold;">if</span>(S_ISDIR(buf.st_mode)) 
            ptr = <span style="color: #deb887;">"directory"</span>; 
        <span style="color: #00bfff; font-weight: bold;">else</span> <span style="color: #00bfff; font-weight: bold;">if</span>(S_ISCHR(buf.st_mode)) 
            ptr = <span style="color: #deb887;">"character special"</span>; 
        <span style="color: #00bfff; font-weight: bold;">else</span> <span style="color: #00bfff; font-weight: bold;">if</span>(S_ISBLK(buf.st_mode)) 
            ptr = <span style="color: #deb887;">"block special"</span>; 
        <span style="color: #00bfff; font-weight: bold;">else</span> <span style="color: #00bfff; font-weight: bold;">if</span>(S_ISFIFO(buf.st_mode)) 
            ptr = <span style="color: #deb887;">"fifo"</span>; 
<span style="color: #ffd700;">#ifdef</span> S_ISLNK 
        <span style="color: #00bfff; font-weight: bold;">else</span> <span style="color: #00bfff; font-weight: bold;">if</span>(S_ISLNK(buf.st_mode)) 
            ptr = <span style="color: #deb887;">"symbolic link"</span>; 
<span style="color: #ffd700;">#endif</span> 
<span style="color: #ffd700;">#ifdef</span> S_ISSOCK
        <span style="color: #00bfff; font-weight: bold;">else</span> <span style="color: #00bfff; font-weight: bold;">if</span>(S_ISSOCK(buf.st_mode)) 
            ptr = <span style="color: #deb887;">"socket"</span>; 
<span style="color: #ffd700;">#endif</span> 
        <span style="color: #00bfff; font-weight: bold;">else</span> 
            ptr = <span style="color: #deb887;">"** unknown mode **"</span>;

        printf(<span style="color: #deb887;">"%s\n"</span>, ptr); 
    }

    exit(0);
}
</pre>
</div>

<p>
测试文件类型
</p>
<div class="org-src-container">
<pre class="src src-sh">$ ./filetype ./filetype.c ./filetype.o ./ /dev/sda1 /dev/tty1 /dev/log /dev/fd/0

./filetype.c: regular
./filetype.o: regular
./: directory
/dev/sda1: block special
/dev/tty1: character special
/dev/log: socket
/dev/fd/0: symbolic link
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org8766df0" class="outline-2">
<h2 id="org8766df0">文件权限</h2>
<div class="outline-text-2" id="text-org8766df0">
</div>
<div id="outline-container-orgfa5ba38" class="outline-3">
<h3 id="orgfa5ba38">进程相关的用户和组ID</h3>
<div class="outline-text-3" id="text-orgfa5ba38">
<table border="1" cellspacing="0" cellpadding="6" rules="all" frame="boader">
<caption class="t-above"><span class="table-number">Table 2:</span> 与一个进程相关联的用户ID和组ID</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">ID类型</th>
<th scope="col" class="org-left">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">实际用户ID, 实际组ID</td>
<td class="org-left">我们实际上是谁</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">有效用户ID，有效组ID，添加组ID</td>
<td class="org-left">用于文件存取许可权检查</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">保存设置-用户-ID，保存-设置-组ID</td>
<td class="org-left">由exec函数保存</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li><span class="underline">实际用户ID</span> 和 <span class="underline">实际组ID</span> 这两个字段在 <b>登录时取自口令文件中的登录项</b> 。通常在一个登录会话期间这些值并不改变，但是 <b>超级用户进程有方法改变它们</b></li>
<li><span class="underline">有效用户ID</span> ， <span class="underline">有效组ID</span> 以及 <span class="underline">添加组ID</span> 决定了 <b>文件访问权</b></li>
<li>保存的 <span class="underline">设置-用户-ID</span> 和 <span class="underline">设置-组-ID</span> 在 <b>执行一个程序</b> 时包含了 <b>有效用户ID和有效组ID的副本</b></li>
</ul>

<p>
通常有效用户ID等于实际用户ID，有效组ID等于实际组ID
</p>
</div>
</div>
<div id="outline-container-org90f5f24" class="outline-3">
<h3 id="org90f5f24">设置-用户-ID和设置-组-ID</h3>
<div class="outline-text-3" id="text-org90f5f24">
<p>
每个文件有一个所有者和组所有者。所有者由stat结构中的 <b>st_uid</b> 表示，组所有者则由 <b>st_gid</b> 成员表示。 
</p>

<p>
当执行一个程序文件时，进程的 <span class="underline">有效用户ID</span> 通常就是 <span class="underline">实际用户ID</span> ， <span class="underline">有效组ID</span> 通常是 <span class="underline">实际组ID</span> 。但是可以在 <b>st_mode中设置一个特殊标志</b> ，其定义是 <b>当执行此文件时，将 <span class="underline">进程的有效用户ID</span> 设置为 <span class="underline">文件的所有者</span> (st_uid)</b> 
</p>

<pre class="example">
     与此相类似，在文件方式字中可以设置另一位，它使得执行此文件的进程的有效组ID设置为文件的组所有者(st_gid)
</pre>

<p>
这两位被称之为 <b>设置-用户-ID</b> (set-user-ID)位和 <b>设置-组-ID</b> (set-group-ID)位。这两位可用常数 <b>S_ISUID</b> 和 <b>S_ISGID</b> 测试
</p>
</div>
</div>

<div id="outline-container-org2b33019" class="outline-3">
<h3 id="org2b33019">文件存取许可权</h3>
<div class="outline-text-3" id="text-org2b33019">
<p>
Unix对文件定义了三组用户权限，分别对应为 <b>宿主用户</b> (user)、 <b>组用户</b> (group)、 <b>其它用户</b> (other)，每组用户各有自己对此文件的 <b>读</b> 、 <b>写</b> 、 <b>执行</b> 权限。权限值以 <span class="underline">八进制</span> 的形式表示,也记录在stat结构的 <b>st_mode</b> 字段中
</p>

<table border="1" cellspacing="0" cellpadding="6" rules="groups" frame="boader">
<caption class="t-above"><span class="table-number">Table 3:</span> 9个存取许可权位</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">st_mode mask</th>
<th scope="col" class="org-left">意义</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">S_IRUSR</td>
<td class="org-left">用户读</td>
</tr>

<tr>
<td class="org-left">S_IWUSR</td>
<td class="org-left">用户写</td>
</tr>

<tr>
<td class="org-left">S_IXUSR</td>
<td class="org-left">用户执行</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">S_IRGRP</td>
<td class="org-left">组读</td>
</tr>

<tr>
<td class="org-left">S_IWGRP</td>
<td class="org-left">组写</td>
</tr>

<tr>
<td class="org-left">S_IXGRP</td>
<td class="org-left">组执行</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">S_IROTH</td>
<td class="org-left">其他用户读</td>
</tr>

<tr>
<td class="org-left">S_IWOTH</td>
<td class="org-left">其他用户写</td>
</tr>

<tr>
<td class="org-left">S_IXOTH</td>
<td class="org-left">其他用户执行</td>
</tr>
</tbody>
</table>
</div>

<div id="outline-container-org48fea8f" class="outline-4">
<h4 id="org48fea8f">存取权限规则</h4>
<div class="outline-text-4" id="text-org48fea8f">
<ul class="org-ul">
<li>用名字打开任一类型的文件时，对该名字中包含的 <span class="underline">每一个目录</span> ，包括它可能 <b>隐含的当前工作目录</b> 都应具有 <span class="underline">执行</span> 许可权。</li>
<li>对于一个 <span class="underline">文件的读许可权</span> 决定了是否能够 <b>打开该文件进行读操作</b> ：这对应于open函数的 <b>O_RDONLY</b> 和 <b>O_RDWR</b> 标志</li>
<li>对于一个 <span class="underline">文件的写许可权</span> 决定了是否能够 <b>打开该文件进行写操作</b> ：这对应于open函数的 <b>O_WRONLY</b> 和 <b>O_RDWR</b> 标志</li>
<li>为在open函数中对一个文件指定 <b>O_TRUNC</b> 标志，必须对该文件具有 <span class="underline">写</span> 许可权</li>
<li>为了在一个 <b>目录中创建一个新文件</b> ，必须对 <span class="underline">该目录</span> 具有 <span class="underline">写</span> 许可权 和 <span class="underline">执行</span> 许可权</li>
<li>为了 <b>删除一个文件</b> ，必须对 <span class="underline">包含该文件的目录</span> 具有 <span class="underline">写</span> 许可权和 <span class="underline">执行</span> 许可权。 <b>对该文件本身则不需要有读、写许可权</b></li>
<li>如果用6个exec函数中的任何一个 <span class="underline">执行某个文件</span> ，都必须对 <span class="underline">该文件</span> 具有 <span class="underline">执行</span> 许可权</li>
</ul>
</div>
</div>

<div id="outline-container-orgf3877a6" class="outline-4">
<h4 id="orgf3877a6">存取权限测试</h4>
<div class="outline-text-4" id="text-orgf3877a6">
<p>
适当的 <span class="underline">存取许可权位</span> 指的是： 
</p>
<ul class="org-ul">
<li>若进程为 <span class="underline">读而打开</span> 该文件，则相应 <b>读位应为1</b></li>
<li>若进程为 <span class="underline">写而打开</span> 该文件，则相应 <b>写位应为1</b></li>
<li>若进程将 <span class="underline">执行</span> 该文件，则相应 <b>执行位应为1</b></li>
</ul>

<p>
进程每次 <span class="underline">打开</span> 、 <span class="underline">创建</span> 或 <span class="underline">删除</span> 一个文件时，内核就进行 <b>文件存取许可权测试</b> ，而这种测试可能涉及 <span class="underline">文件的所有者</span> (st_uid和st_gid)， <span class="underline">进程的有效ID</span> (有效用户ID和有效组ID)以及 <span class="underline">进程的添加组ID</span> (若支持的话)。两个所有者ID是文件的性质，而有效ID和添加组ID则是进程的性质。内核进行的测试是:
</p>
<ol class="org-ol">
<li>若 <b>进程的有效用户ID是0</b> (超级用户)，则允许存取。这给予了超级用户对文件系统进行处理的最充分的自由</li>
<li>若 <b>进程的有效用户ID等于文件的所有者ID</b> (也就是该进程拥有此文件):
<ul class="org-ul">
<li>若 <b>适当的所有者存取许可权位被设置</b> ，则允许存取</li>
<li>否则拒绝存取</li>
</ul></li>
<li>若 <b>进程的有效组ID或进程的添加组ID之一等于文件的组ID</b> :
<ul class="org-ul">
<li>若 <b>适当的组存取许可权位被设置</b> ，则允许存取</li>
<li>否则拒绝存取</li>
</ul></li>
<li>若 <b>适当的其他用户存取许可权位被设置</b> ，则允许存取，否则拒绝存取</li>
</ol>
</div>
</div>

<div id="outline-container-orgb41801b" class="outline-4">
<h4 id="orgb41801b">新文件和目录的所有权</h4>
<div class="outline-text-4" id="text-orgb41801b">
<p>
创建新文件和目录的用户ID被设置为 <b>进程的有效用户ID</b> 
</p>

<p>
关于组ID，POSIX.1允许选择下列之一作为新文件和目录的组ID： 
</p>
<ol class="org-ol">
<li>新文件的组ID可以是 <span class="underline">进程的有效组ID</span></li>
<li>新文件的组ID可以是它 <span class="underline">所在目录的组ID</span></li>
</ol>
</div>
</div>
</div>


<div id="outline-container-org0d96ba3" class="outline-3">
<h3 id="org0d96ba3">access函数</h3>
<div class="outline-text-3" id="text-org0d96ba3">
<p>
access函数：按实际用户ID和实际组ID测试存取权限
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;unistd.h&gt;</span>
<span style="color: #ffebcd;">/**</span>
<span style="color: #ffebcd;"> * &#25353;&#23454;&#38469;&#29992;&#25143;ID&#21644;&#23454;&#38469;&#32452;ID&#36827;&#34892;&#23384;&#21462;&#35768;&#21487;&#26435;&#27979;&#35797;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * pathname&#65306;&#25991;&#20214;&#21517;&#36335;&#24452;</span>
<span style="color: #ffebcd;"> * mode: &#23384;&#21462;&#26435;&#38480;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * &#33509;&#25317;&#26377;&#26435;&#38480;&#65306;&#36820;&#22238;0&#65306;&#26080;&#26435;&#38480;&#25110;&#20986;&#38169;&#65306;&#36820;&#22238;-1&#65292;&#26681;&#25454;errno&#36827;&#34892;&#21028;&#26029;</span>
<span style="color: #ffebcd;"> * </span>
<span style="color: #ffebcd;"> */</span>
<span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">access</span>(<span style="color: #00bfff; font-weight: bold;">const</span> <span style="color: #98f5ff;">char</span> *<span style="color: #4eee94;">pathname</span>, <span style="color: #98f5ff;">int</span> <span style="color: #4eee94;">mode</span>);
</pre>
</div>
</div>

<div id="outline-container-org303ecd9" class="outline-4">
<h4 id="org303ecd9">mode参数</h4>
<div class="outline-text-4" id="text-org303ecd9">
<table border="1" cellspacing="0" cellpadding="6" rules="all" frame="boader">
<caption class="t-above"><span class="table-number">Table 4:</span> access函数中的mode常数，取自&lt;unistd.h&gt;</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">mode</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">R_OK</td>
<td class="org-left">测试读许可权</td>
</tr>

<tr>
<td class="org-left">W_OK</td>
<td class="org-left">测试写许可权</td>
</tr>

<tr>
<td class="org-left">X_OK</td>
<td class="org-left">测试执行许可权</td>
</tr>

<tr>
<td class="org-left">F_OK</td>
<td class="org-left">测试文件是否存在</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgaecdc92" class="outline-4">
<h4 id="orgaecdc92">access函数实例</h4>
<div class="outline-text-4" id="text-orgaecdc92">
<div class="org-src-container">
<pre class="src src-C"><span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;sys/types.h&gt;</span>
<span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;fcntl.h&gt;</span>
<span style="color: #ffd700;">#include</span> <span style="color: #deb887;">"apue.h"</span>

<span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">main</span>(<span style="color: #98f5ff;">int</span> <span style="color: #4eee94;">argc</span>, <span style="color: #98f5ff;">char</span> *<span style="color: #4eee94;">argv</span>[]) 
{
    <span style="color: #00bfff; font-weight: bold;">if</span>(argc != 2) 
        err_quit(<span style="color: #deb887;">"usage: a.out &lt;pathname&gt;"</span>); 

    <span style="color: #00bfff; font-weight: bold;">if</span>(access(argv[1], R_OK) &lt; 0) 
        err_ret(<span style="color: #deb887;">"access error for %s"</span>, argv[1]); 
    <span style="color: #00bfff; font-weight: bold;">else</span> 
        printf(<span style="color: #deb887;">"read access OK\n"</span>);

    <span style="color: #00bfff; font-weight: bold;">if</span>(open(argv[1], O_RDONLY) &lt; 0) 
        err_ret(<span style="color: #deb887;">"open error for %s"</span>, argv[1]); 
    <span style="color: #00bfff; font-weight: bold;">else</span> 
        printf(<span style="color: #deb887;">"open for reading OK\n"</span>);

    exit(0);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org13e9e78" class="outline-3">
<h3 id="org13e9e78">umask函数</h3>
<div class="outline-text-3" id="text-org13e9e78">
<p>
umask函数 <b>为进程设置文件方式创建mask值</b> 
</p>

<pre class="example">
   当该进程结束时，mask值仍保持原来系统中的值不变
</pre>

<div class="org-src-container">
<pre class="src src-C"><span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;sys/stat.h&gt;</span>
<span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;sys/type.h&gt;</span>

<span style="color: #ffebcd;">/**</span>
<span style="color: #ffebcd;"> * &#20026;&#36827;&#31243;&#35774;&#32622;&#25991;&#20214;&#26041;&#24335;&#21019;&#24314;&#23631;&#34109;&#23383;,&#24182;&#36820;&#22238;&#20197;&#21069;&#30340;&#20540;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * cmask&#65306;&#35774;&#32622;&#36827;&#31243;&#30340;mask&#20540;&#65292;&#30001;&#34920;4-4&#20013;&#30340;9&#20010;&#24120;&#25968;(S_IRUSR,S_IWUSR&#31561;)&#36880;&#20301;&#8220;&#25110;&#8221;&#26500;&#25104;&#30340;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * &#25104;&#21151;&#65306;&#36820;&#22238;&#24403;&#21069;&#36827;&#31243;&#30340;mask&#20540;&#65288;&#26080;&#20986;&#38169;&#36820;&#22238;&#65289;</span>
<span style="color: #ffebcd;"> * </span>
<span style="color: #ffebcd;"> */</span>
<span style="color: #98f5ff;">mode_t</span> <span style="color: #daa520; font-weight: bold;">umask</span>(<span style="color: #98f5ff;">mode_t</span> <span style="color: #4eee94;">cmask</span>);
</pre>
</div>

<p>
从 <span class="underline">创建文件时指定的权限</span> 中 <span class="underline">减掉umask中指定的权限</span> 
</p>

<pre class="example">
     比如进程创建文件时指定的用户权限是:777(rwxrwxrwx)，而指定的umask指定的值是022

     则该进程创建的该文件的权限就是755(rwxr-xr-x)
</pre>
</div>

<div id="outline-container-org6c54b5a" class="outline-4">
<h4 id="org6c54b5a">umask实例</h4>
<div class="outline-text-4" id="text-org6c54b5a">
<p>
创建第一个时umask值为0，创建第二个时umask值禁止所有组和其他存取许可权。结果是第一个文件的权限是rw-rw-rw-，第二个权限是rw- &#x2014; &#x2014;
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;sys/types.h&gt;</span>
<span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;sys/stat.h&gt;</span>
<span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;fcntl.h&gt;</span>
<span style="color: #ffd700;">#include</span> <span style="color: #deb887;">"apue.h"</span>

<span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">main</span>(<span style="color: #98f5ff;">void</span>)
{
    umask(0); <span style="color: #5f9ea0; font-style: italic;">//</span><span style="color: #5f9ea0; font-style: italic;">foo&#30340;&#26435;&#38480;&#26159;666</span>
    <span style="color: #00bfff; font-weight: bold;">if</span>(creat(<span style="color: #deb887;">"foo"</span>, S_IRUSR | S_IWUSR | S_IRGRP | S_IWGRP | S_IROTH | S_IWOTH) &lt; 0)
        err_sys(<span style="color: #deb887;">"creat error for foo"</span>);

    umask(S_IRGRP | S_IWGRP | S_IROTH | S_IWOTH);
    <span style="color: #5f9ea0; font-style: italic;">//</span><span style="color: #5f9ea0; font-style: italic;">bar&#30340;&#26435;&#38480;&#26159;600</span>
    <span style="color: #00bfff; font-weight: bold;">if</span>(creat(<span style="color: #deb887;">"bar"</span>, S_IRUSR | S_IWUSR | S_IRGRP | S_IWGRP | S_IROTH | S_IWOTH) &lt; 0)
        err_sys(<span style="color: #deb887;">"creat error for bar"</span>);

    exit(0);

}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgaa9d48c" class="outline-3">
<h3 id="orgaa9d48c">chmod和fchmod函数</h3>
<div class="outline-text-3" id="text-orgaa9d48c">
<p>
chmod/fchmod函数：改变文件访问权限
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;sys/stat.h&gt;</span>
<span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;sys/types.h&gt;</span>

<span style="color: #ffebcd;">/**</span>
<span style="color: #ffebcd;"> * &#26681;&#25454;&#25991;&#20214;&#36335;&#24452;&#21517;&#25913;&#21464;&#25991;&#20214;&#23384;&#21462;&#26435;&#38480;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * filename: &#25991;&#20214;&#36335;&#24452;&#21517;</span>
<span style="color: #ffebcd;"> * mode_t: &#25991;&#20214;&#23384;&#21462;&#26435;&#38480;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * &#25104;&#21151;&#65306;&#36820;&#22238; 0&#65292;&#22833;&#36133;&#65306;&#36820;&#22238; -1</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> */</span>
<span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">chmod</span>(<span style="color: #00bfff; font-weight: bold;">const</span> <span style="color: #98f5ff;">char</span> *<span style="color: #4eee94;">filename</span>, <span style="color: #98f5ff;">mode_t</span> <span style="color: #4eee94;">mode</span>);

<span style="color: #ffebcd;">/**</span>
<span style="color: #ffebcd;"> * &#26681;&#25454;&#25991;&#20214;&#25551;&#36848;&#31526;&#25913;&#21464;&#25991;&#20214;&#23384;&#21462;&#26435;&#38480;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * filedes: &#25991;&#20214;&#25551;&#36848;&#31526;</span>
<span style="color: #ffebcd;"> * mode_t: &#25991;&#20214;&#23384;&#21462;&#26435;&#38480;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * return&#65306;&#33509;&#25104;&#21151;&#21017;&#20026;0&#65292;&#33509;&#20986;&#38169;&#21017;&#20026;-1</span>
<span style="color: #ffebcd;"> */</span>
<span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">fchmod</span>(<span style="color: #98f5ff;">int</span> <span style="color: #4eee94;">filedes</span>, <span style="color: #98f5ff;">mode_t</span> <span style="color: #4eee94;">mode</span>);
</pre>
</div>
</div>

<div id="outline-container-org4ab0852" class="outline-4">
<h4 id="org4ab0852">mode参数</h4>
<div class="outline-text-4" id="text-org4ab0852">
<p>
参数mode：根据表4-6中所示常数的位运算获得
</p>
<table border="1" cellspacing="0" cellpadding="6" rules="groups" frame="boader">
<caption class="t-above"><span class="table-number">Table 5:</span> chmod函数的mode常数，取自&lt;sys/stat.h&gt;</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">mode</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">S_ISUID</td>
<td class="org-left">执行时设置-用户-ID</td>
</tr>

<tr>
<td class="org-left">S_ISGID</td>
<td class="org-left">执行时设置-组-ID</td>
</tr>

<tr>
<td class="org-left">S_ISVTX</td>
<td class="org-left">保存正文</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">S_IRWXU</td>
<td class="org-left">用户(所有者)读、写和执行</td>
</tr>

<tr>
<td class="org-left">S_IRUSR</td>
<td class="org-left">用户(所有者)读</td>
</tr>

<tr>
<td class="org-left">S_IWUSR</td>
<td class="org-left">用户(所有者)写</td>
</tr>

<tr>
<td class="org-left">S_IXUSR</td>
<td class="org-left">用户(所有者)执行</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">S_IRWXG</td>
<td class="org-left">组读、写和执行</td>
</tr>

<tr>
<td class="org-left">S_IRGRP</td>
<td class="org-left">组读</td>
</tr>

<tr>
<td class="org-left">S_IWGRP</td>
<td class="org-left">组写</td>
</tr>

<tr>
<td class="org-left">S_IXGRP</td>
<td class="org-left">组执行</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">S_IRWXO</td>
<td class="org-left">其他读、写和执行</td>
</tr>

<tr>
<td class="org-left">S_IROTH</td>
<td class="org-left">其他读</td>
</tr>

<tr>
<td class="org-left">S_IWOTH</td>
<td class="org-left">其他写</td>
</tr>

<tr>
<td class="org-left">S_IXOTH</td>
<td class="org-left">其他执行</td>
</tr>
</tbody>
</table>

<pre class="example">
      如果一个可执行程序文件的 S_ISVTX 这位被设置了，在该程序第一次执行并结束时，该程序正文的一个文本被保存在交换区

      程序的正文部分是机器指令部分，这使得下次执行该程序时能较快地将其装入内存区

      其原因是：在交换区，该文件是被连续存放的，而在一般的UNIX文件系统中，文件的各数据块很可能是随机存放的

      现今较新的UNIX系统大多数都具有虚存系统以及快速文件系统，所以不再需要使用这种技术
</pre>
</div>
</div>
<div id="outline-container-org95ceeaa" class="outline-4">
<h4 id="org95ceeaa">chmod实例</h4>
<div class="outline-text-4" id="text-org95ceeaa">
<p>
根据foo的当前状态设置其许可权。为此先调用stat获得其当前许可权，然后修改它。显式地打开了 <span class="underline">设置-组-ID位</span> 、关闭了 <span class="underline">组-执行位</span> 。最后直接修改bar的权限
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;sys/types.h&gt;</span>
<span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;sys/stat.h&gt;</span>
<span style="color: #ffd700;">#include</span> <span style="color: #deb887;">"apue.h"</span>

<span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">main</span>(<span style="color: #98f5ff;">void</span>)
{
    <span style="color: #00bfff; font-weight: bold;">struct</span> <span style="color: #98f5ff;">stat</span> <span style="color: #4eee94;">statbuf</span>;

    <span style="color: #00bfff; font-weight: bold;">if</span>(stat(<span style="color: #deb887;">"foo"</span>, &amp;statbuf) &lt; 0)
        err_sys(<span style="color: #deb887;">"stat error for foo"</span>);

    <span style="color: #5f9ea0; font-style: italic;">/* </span><span style="color: #5f9ea0; font-style: italic;">turn on set-group-ID and turn off group-execute </span><span style="color: #5f9ea0; font-style: italic;">*/</span>
    <span style="color: #00bfff; font-weight: bold;">if</span>(chmod(<span style="color: #deb887;">"foo"</span>, (statbuf.st_mode &amp; ~S_IXGRP) | S_ISGID) &lt; 0)
        err_sys(<span style="color: #deb887;">"chmod error for foo"</span>);

    <span style="color: #5f9ea0; font-style: italic;">/*</span><span style="color: #5f9ea0; font-style: italic;">set absolute mode to "rw-r--r--"</span><span style="color: #5f9ea0; font-style: italic;">*/</span>
    <span style="color: #00bfff; font-weight: bold;">if</span>(chmod(<span style="color: #deb887;">"bar"</span>, S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH) &lt; 0)
        err_sys(<span style="color: #deb887;">"chmod error for bar"</span>);

    exit(0);

}
</pre>
</div>

<pre class="example">
ls命令将 组-执行许可权 表示为 -l

chmod函数更新的只是i节点最近一次被更改的时间

而 ls -l 列出的是最后修改文件内容的时间
</pre>
</div>
</div>

<div id="outline-container-orgc74a9fd" class="outline-4">
<h4 id="orgc74a9fd">自动忽略某些权限常数</h4>
<div class="outline-text-4" id="text-orgc74a9fd">
<ol class="org-ol">
<li>如果试图设置 <span class="underline">普通文件的S_ISVTX</span> ，而且又 <span class="underline">没有超级用户</span> 优先权，那么mode中的 <b>粘住位自动被关闭</b></li>
</ol>
<pre class="example">
      只有超级用户才能设置普通文件的粘住位。这样做的理由是可以防止不怀好意的用户设置粘住位，并试图以此方式填满交换区
</pre>
<ol class="org-ol">
<li>新创建文件的组ID可能不是调用进程所属的组。特别地如果 <span class="underline">新文件的组ID</span> 不等于 <span class="underline">进程的有效组ID或者进程添加组ID中的一个</span> ，以及进程 <span class="underline">没有超级用户</span> 优先权，那么 <b>设置-组-ID位自动被关闭</b></li>
</ol>
<pre class="example">
      防止了用户创建一个设置-组-ID文件，而该文件是由并非该用户所属的组拥有的
</pre>
</div>
</div>
</div>


<div id="outline-container-org1051939" class="outline-3">
<h3 id="org1051939">chown, fchown和lchown函数</h3>
<div class="outline-text-3" id="text-org1051939">
<p>
chown函数组：更改文件的用户ID和组ID
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;sys/types.h&gt;</span>
<span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;unistd.h&gt;</span>

<span style="color: #ffebcd;">/**</span>
<span style="color: #ffebcd;"> * &#26681;&#25454;&#25991;&#20214;&#36335;&#24452;&#21517;&#26356;&#25913;&#29992;&#25143;ID&#21644;&#32452;ID</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * pathname: &#25991;&#20214;&#36335;&#24452;&#21517;</span>
<span style="color: #ffebcd;"> * owner: &#29992;&#25143;ID</span>
<span style="color: #ffebcd;"> * group: &#32452;ID</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * return: &#33509;&#25104;&#21151;&#21017;&#20026; 0&#65292;&#33509;&#20986;&#38169;&#21017;&#20026; -1</span>
<span style="color: #ffebcd;"> */</span>
<span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">chown</span>(<span style="color: #00bfff; font-weight: bold;">const</span> <span style="color: #98f5ff;">char</span>* <span style="color: #4eee94;">pathname</span>, <span style="color: #98f5ff;">uid_t</span> <span style="color: #4eee94;">owner</span>, <span style="color: #98f5ff;">gid_t</span> <span style="color: #4eee94;">group</span>);

<span style="color: #ffebcd;">/**</span>
<span style="color: #ffebcd;"> * &#26681;&#25454;&#25171;&#24320;&#30340;&#25991;&#20214;&#25551;&#36848;&#31526;&#26356;&#25913;&#29992;&#25143;ID&#21644;&#32452;ID</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * filedes: &#25991;&#20214;&#25551;&#36848;&#31526;</span>
<span style="color: #ffebcd;"> * owner: &#29992;&#25143;ID</span>
<span style="color: #ffebcd;"> * group: &#32452;ID</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * return: &#33509;&#25104;&#21151;&#21017;&#20026; 0&#65292;&#33509;&#20986;&#38169;&#21017;&#20026; -1</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> */</span>
<span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">fchown</span>(<span style="color: #98f5ff;">int</span> <span style="color: #4eee94;">filedes</span>, <span style="color: #98f5ff;">uid_t</span> <span style="color: #4eee94;">owner</span>, <span style="color: #98f5ff;">gid_t</span> <span style="color: #4eee94;">group</span>);

<span style="color: #ffebcd;">/**</span>
<span style="color: #ffebcd;"> * &#20462;&#25913;&#38142;&#25509;&#25991;&#20214;&#26412;&#36523;&#30340;&#26356;&#25913;&#29992;&#25143;ID&#21644;&#32452;ID&#65292;&#32780;&#19981;&#26159;&#25152;&#25351;&#21521;&#30340;&#25991;&#20214;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * pathname: &#25991;&#20214;&#36335;&#24452;&#21517;</span>
<span style="color: #ffebcd;"> * owner: &#29992;&#25143;ID</span>
<span style="color: #ffebcd;"> * group: &#32452;ID</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * return: &#33509;&#25104;&#21151;&#21017;&#20026; 0&#65292;&#33509;&#20986;&#38169;&#21017;&#20026; -1</span>
<span style="color: #ffebcd;"> * </span>
<span style="color: #ffebcd;"> */</span>
<span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">lchown</span>(<span style="color: #00bfff; font-weight: bold;">const</span> <span style="color: #98f5ff;">char</span>* <span style="color: #4eee94;">pathname</span>, <span style="color: #98f5ff;">uid_t</span> <span style="color: #4eee94;">owner</span>, <span style="color: #98f5ff;">gid_t</span> <span style="color: #4eee94;">group</span>);

</pre>
</div>

<p>
如果这些函数由非超级用户进程调用，则在成功返回时，该文件的 <span class="underline">设置-用户-ID位</span> 和 <span class="underline">设置-组-ID位</span> 都被 <b>清除</b> 
</p>
</div>

<div id="outline-container-org7d1b787" class="outline-4">
<h4 id="org7d1b787">chown限制</h4>
<div class="outline-text-4" id="text-org7d1b787">
<p>
若 <b>_POSIX_CHOWN_RESTRICTED</b> 系统配置常量对指定的文件起作用，则
</p>
<ul class="org-ul">
<li>只有 <b>超级用户</b> 进程能 <b>更改该文件的用户ID</b></li>
<li>若满足下列条件，一个 <span class="underline">非超级用户进程</span> 可以更改该文件的组ID:
<ol class="org-ol">
<li><b>进程拥有此文件</b> (其 <span class="underline">有效用户ID</span> 等于 <span class="underline">该文件的用户ID</span> )</li>
<li><span class="underline">参数owner</span> 等于 <span class="underline">文件的用户ID</span> ， <span class="underline">参数group</span> 等于 <span class="underline">进程的有效组ID</span> 或 <span class="underline">进程的添加组ID</span> 之一</li>
</ol></li>
</ul>

<pre class="example">
      当_POSIX_CHOWN_RESTRICTED有效时，不能更改其他用户的文件的用户ID

      只可以更改你所拥有的文件的组ID，但只能改到你所属的组
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgde44fc5" class="outline-2">
<h2 id="orgde44fc5">文件长度</h2>
<div class="outline-text-2" id="text-orgde44fc5">
<p>
stat结构的成员 <b>st_size</b> 包含了以 <span class="underline">字节</span> 为单位的该 <b>文件的长度</b> 。此字段只对 <span class="underline">普通</span> 文件、 <span class="underline">目录</span> 文件和 <span class="underline">符号链接</span> 有意义
</p>
<ul class="org-ul">
<li>普通文件：其文件长度可以是0，在读这种文件时，将得到文件结束指示</li>
<li>目录：文件长度通常是 <span class="underline">16</span> 或 <span class="underline">512</span> 的整倍数</li>
<li>符号连接：文件长度是 <span class="underline">被链接文件名的实际字节数</span></li>
</ul>

<pre class="example">
    例如：ant -&gt; apache-ant-1.9.7/

    其文件长度17，这就是路径名apache-ant-1.9.7的长度
</pre>

<div class="org-src-container">
<pre class="src src-sh">$ ls -l 
lrwxrwxrwx  1 klose klose   17 Nov 20 21:14 ant -&gt; apache-ant-1.9.7/
</pre>
</div>
<pre class="example">
    注意：因为符号连接文件长度总是由st_size指示，所以符号连接并不包含通常C语言用作名字结尾的'\0'(null)字符 
</pre>
</div>

<div id="outline-container-org32109d2" class="outline-3">
<h3 id="org32109d2">st_blksize和st_blocks</h3>
<div class="outline-text-3" id="text-org32109d2">
<ul class="org-ul">
<li>st_blksize：对 <span class="underline">文件I/O较好</span> 的块长度</li>
<li>st_blocks：所分配的 <span class="underline">实际st_blksize大小的字节数</span></li>
</ul>

<pre class="example">
st_blksize表示读操作时读一个文件所需的最少时间量

为了效率的缘故，标准I/O库也试图一次读、写st_blksize个字节
</pre>
</div>
</div>

<div id="outline-container-orgbc572c1" class="outline-3">
<h3 id="orgbc572c1">文件空洞</h3>
<div class="outline-text-3" id="text-orgbc572c1">
<p>
空洞是所设置的 <span class="underline">偏移量</span> 超过 <span class="underline">文件尾端</span> 并写入数据后造成的
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ls -l file.hole

<span style="color: #5f9ea0; font-style: italic;">#</span><span style="color: #5f9ea0; font-style: italic;">ls&#26174;&#31034;&#23454;&#38469;&#25991;&#20214;&#38271;&#24230;&#26159;4000010&#23383;&#33410;</span>
-rw-r--r-- 1 klose klose 4000010 Jan 30 20:41 file.hole

$ du ./file.hole

<span style="color: #5f9ea0; font-style: italic;">#</span><span style="color: #5f9ea0; font-style: italic;">du&#26174;&#31034;&#20102;&#23454;&#38469;&#19978;&#25991;&#20214;&#21482;&#21344;&#20102;12&#20010;1024&#23383;&#33410;&#22359;</span>
12      ./file.hole
</pre>
</div>

<pre class="example">
     空洞并不会占用实际的磁盘空间

     因此使用du则只会显示使用了多少字节块
     但是使用ls查看文件大小时会计算空洞的大小
</pre>
</div>
</div>
<div id="outline-container-orgea11c07" class="outline-3">
<h3 id="orgea11c07">truncate和ftruncate函数</h3>
<div class="outline-text-3" id="text-orgea11c07">
<p>
truncate函数组：以指定长度截短文件
</p>

<pre class="example">
len为0 等价于使用O_TRUNC标记调用open函数

在打开文件时将文件的内容清空
</pre>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;sys/types.h&gt;</span>
<span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;unistd.h&gt;</span>

<span style="color: #ffebcd;">/**</span>
<span style="color: #ffebcd;"> * &#20197;&#25351;&#23450;&#38271;&#24230;&#25130;&#30701;&#25991;&#20214;&#12288;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * pathname: &#25991;&#20214;&#36335;&#24452;&#21517;</span>
<span style="color: #ffebcd;"> * len: &#25351;&#23450;&#38271;&#24230;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * return: &#33509;&#25104;&#21151;&#21017;&#20026; 0&#65292;&#33509;&#20986;&#38169;&#21017;&#20026; -1</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> */</span>
<span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">truncate</span>(<span style="color: #00bfff; font-weight: bold;">const</span> <span style="color: #98f5ff;">char</span>* <span style="color: #4eee94;">pathname</span>, <span style="color: #98f5ff;">off_t</span> <span style="color: #4eee94;">len</span>);

<span style="color: #ffebcd;">/**</span>
<span style="color: #ffebcd;"> * &#20197;&#25351;&#23450;&#38271;&#24230;&#25130;&#30701;&#25991;&#20214;&#12288;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * filedes: &#25991;&#20214;&#25551;&#36848;&#31526;</span>
<span style="color: #ffebcd;"> * len: &#25351;&#23450;&#38271;&#24230;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * return: &#33509;&#25104;&#21151;&#21017;&#20026; 0&#65292;&#33509;&#20986;&#38169;&#21017;&#20026; -1</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> */</span>
<span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">ftruncate</span>(<span style="color: #98f5ff;">int</span> <span style="color: #4eee94;">filedes</span>, <span style="color: #98f5ff;">off_t</span> <span style="color: #4eee94;">len</span>);
</pre>
</div>
<ul class="org-ul">
<li>如果该文件以前的长度大于len，则超过len以外的数据就不再能存取</li>
<li>如果以前的长度短于length，则其后果与系统有关
<ul class="org-ul">
<li>比如某个实现的处理是扩展该文件，则在以前的文件尾端和新的文件尾端之间的数据将读作0(也就是在文件中创建了一个空洞)</li>
</ul></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org81a56ff" class="outline-2">
<h2 id="org81a56ff">文件系统</h2>
<div class="outline-text-2" id="text-org81a56ff">
<p>
Unix/Linux系统下可以使用多种文件系统实现，如基于BSD的Unix文件系统(UFS)，EXT，传统的V文件系统等。这些文件系统都不影响下面的描述　
</p>

<p>
一个磁盘分成一个或多个分区，见图4-1，每个分区可以包含一个文件系统
</p>

<div class="figure">
<p><img src="./pic/fs-1.png" alt="fs-1.png" width="90%" />
</p>
</div>

<p>
如果在忽略 <span class="underline">自举块</span> 和 <span class="underline">超级块</span> 情况下更仔细地观察文件系统，则可以得到图4-2中所示的情况
</p>

<div class="figure">
<p><img src="./pic/fs-2.jpg" alt="fs-2.jpg" width="90%" />
</p>
</div>
</div>
<div id="outline-container-org0aaf383" class="outline-3">
<h3 id="org0aaf383">i节点</h3>
<div class="outline-text-3" id="text-org0aaf383">
<p>
i节点：包含有关 <b>文件的大部分元信息</b> ，比如
</p>
<ul class="org-ul">
<li>文件类型</li>
<li>文件访问权限位</li>
<li>文件长度</li>
<li>指向文件数据块的指针等</li>
</ul>

<pre class="example">
每个文件只有一个i节点

stat结构中的大多数信息都取自i节点
</pre>
</div>
</div>

<div id="outline-container-orgc4151c4" class="outline-3">
<h3 id="orgc4151c4">目录项</h3>
<div class="outline-text-3" id="text-orgc4151c4">
<p>
目录项：
</p>
<ul class="org-ul">
<li>文件名</li>
<li>i节点号：数据类型是ino_t</li>
</ul>

<pre class="example">
     因为目录项中的i节点编号数指向同一文件系统中的i节点，所以不能使一个目录项指向另一个文件系统的i节点

     这就是为什么ln(1)命令不能跨越文件系统的原因
</pre>

<pre class="example">
     当在同一个分区内为一个文件更名时，该文件的实际内容并未移动

     只需构造一个指向现存i节点的新目录项，并删除老的目录项

     例如将文件/usr/lib/foo更名为/usr/foo

     如果目录/usr/lib和/usr在同一文件系统上，则文件foo的内容无需移动，这就是mv(1)命令的通常操作方式
</pre>
</div>
</div>
<div id="outline-container-orgbc769d0" class="outline-3">
<h3 id="orgbc769d0">数据块</h3>
<div class="outline-text-3" id="text-orgbc769d0">
<p>
数据块：用来记录文件的实际内容，它在磁盘上的 <b>位置由 <span class="underline">i结点</span> 来指示</b> 
</p>

<p>
它的大小可以为 <span class="underline">1</span> ， <span class="underline">2</span> ， <span class="underline">4K</span> 字节
</p>
</div>
</div>

<div id="outline-container-orgf364669" class="outline-3">
<h3 id="orgf364669">链接</h3>
<div class="outline-text-3" id="text-orgf364669">
</div>
<div id="outline-container-org8f1d34c" class="outline-4">
<h4 id="org8f1d34c">硬链接</h4>
<div class="outline-text-4" id="text-org8f1d34c">
<p>
在图4-2中有两个目录项指向同一i节点。每个i节点中都有一个 <span class="underline">链接计数</span> ，其值是 <b>指向该i节点的目录项数</b> 。这种连接被称为 <b>硬链接</b> 
</p>

<p>
<b>只有当连接计数减少为0时，才可删除该文件(也就是可以释放该文件占用的数据块)</b> 
</p>

<pre class="example">

</pre>
<p>
这就是为什么解除对一个文件的连接操作并不总是意味着释放该文件占用的磁盘块的原因。也就是为什么删除一个目录项的函数被称之为unlink而不是delete的原因。
</p>

<pre class="example">
      这就是为什么解除对一个文件的连接操作并不总是意味着释放该文件占用的磁盘块的原因

      也就是为什么删除一个目录项的函数被称之为 unlink 而不是 delete 的原因
</pre>
<p>
在stat结构中，连接计数包含在 <b>st_nlink</b> 成员中，其基本系统数据类型是 <b>nlink_t</b> 
</p>
</div>
</div>

<div id="outline-container-orge3a1736" class="outline-4">
<h4 id="orge3a1736">符号链接</h4>
<div class="outline-text-4" id="text-orge3a1736">
<p>
该文件的实际内容(在数据块) <b>包含了该符号连接所指向的文件的名字</b> 
</p>
<pre class="example">
      比如lib-&gt;urs/lib：该目录项中的文件名是lib，而在该文件中包含了7个数据字节usr/lib
</pre>

<p>
符号链接的文件类型是 <b>S_IFLNK</b> ，于是系统知道这是一个符号链接     
</p>
</div>
</div>
<div id="outline-container-org2b0ae50" class="outline-4">
<h4 id="org2b0ae50">目录链接</h4>
<div class="outline-text-4" id="text-org2b0ae50">
<p>
创建新的目录testdir
</p>
<div class="org-src-container">
<pre class="src src-sh">$ mkdir testdir
</pre>
</div>
<p>
图4-3显示了其结果：
</p>

<div class="figure">
<p><img src="./pic/inodes.png" alt="inodes.png" width="90%" />
</p>
</div>
<ul class="org-ul">
<li>编号为 <span class="underline">2549</span> 的i节点，其类型字段表示它是一个目录</li>
</ul>
<pre class="example">
      连接计数为2：任何一个叶子目录(不包含任何其他目录)其连接计数总是2

      数值2来自于命名该目录 'testdir' 的目录项以及在该目录中的 '..' 项
</pre>

<ul class="org-ul">
<li>编号为 <span class="underline">1267</span> 的i节点，其类型字段表示它是一个目录</li>
</ul>
<pre class="example">
      连接计数则大于或等于3：

      一个是命名它的目录项(在图4-3中没有表示出来)

      第二个是在该目录中的 '.' 项

      第三个是在其子目录testdir中的 '..' 项
</pre>

<p>
注意： <b>在工作目录中的每个子目录都使该工作目录的连接计数增1</b> 
</p>
</div>
</div>
</div>

<div id="outline-container-org89e6383" class="outline-3">
<h3 id="org89e6383">link函数</h3>
<div class="outline-text-3" id="text-org89e6383">
<p>
link函数： <b>创建一个向现存文件目录项</b> 
</p>

<div class="org-src-container">
<pre class="src src-C"><span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;unistd.h&gt;</span>
<span style="color: #ffebcd;">/**</span>
<span style="color: #ffebcd;"> * &#21019;&#24314;&#19968;&#20010;&#25351;&#21521;&#29616;&#23384;&#25991;&#20214;&#30340;&#30446;&#24405;&#39033;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * existingpath: &#24050;&#32463;&#23384;&#22312;&#30340;&#25991;&#20214;&#36335;&#24452;&#21517;</span>
<span style="color: #ffebcd;"> * newpath: &#36830;&#25509;&#21518;&#30340;&#25991;&#20214;&#36335;&#24452;&#21517;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * return: &#33509;&#25104;&#21151;&#21017;&#20026; 0&#65292;&#33509;&#20986;&#38169;&#21017;&#20026; -1</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> */</span>
<span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">link</span>(<span style="color: #00bfff; font-weight: bold;">const</span> <span style="color: #98f5ff;">char</span>* <span style="color: #4eee94;">existingpath</span>, <span style="color: #00bfff; font-weight: bold;">const</span> <span style="color: #98f5ff;">char</span>* <span style="color: #4eee94;">newpath</span>);
</pre>
</div>
<p>
创建一个新目录项newpath，它引用现存文件existingpath，如若newpath已经存在，则返回出错
</p>

<pre class="example">
     创建新目录项以及增加连接计数应当是个原子操作！
</pre>
</div>
</div>

<div id="outline-container-org33fd0ef" class="outline-3">
<h3 id="org33fd0ef">unlink函数</h3>
<div class="outline-text-3" id="text-org33fd0ef">
<p>
unlink函数： <b>删除一个现存的目录项</b> 
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;unistd.h&gt;</span>

<span style="color: #ffebcd;">/**</span>
<span style="color: #ffebcd;"> * &#21024;&#38500;&#19968;&#20010;&#29616;&#23384;&#30340;&#30446;&#24405;&#39033;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * pathname&#65306;&#25991;&#20214;&#25110;&#32773;&#30446;&#24405;&#36335;&#24452;&#21517;&#12288;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * return&#65306;&#33509;&#25104;&#21151;&#21017;&#20026; 0&#65292;&#33509;&#20986;&#38169;&#21017;&#20026; -1</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> */</span>
<span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">unlink</span>(<span style="color: #00bfff; font-weight: bold;">const</span> <span style="color: #98f5ff;">char</span>* <span style="color: #4eee94;">pathname</span>);
</pre>
</div>
<p>
删除目录项，并将由pathname所引用的文件的硬链接计数减1，如果出错，则不对该文件作任何更改：
</p>
<ul class="org-ul">
<li>为了解除对文件的连接,必须对包含该目录项的目录具有写和执行许可权</li>
<li>如果pathname是符号连接，那么unlink涉及的是符号连接而不是由该连接所引用的文件</li>
<li>超级用户可以调用带参数pathname的unlink指定一个目录，但是通常不使用这种方式，而使用函数rmdir</li>
</ul>

<pre class="example">
     如果文件还有其他连接，则仍可通过其他连接存取该文件的数据

     只有当连接计数达到0时并且没有进程打开该文件，文件的内容才可被删除

     关闭一个文件时内核首先检查使该文件打开的进程计数，如果该计数达到0，然后内核检查其连接计数，如果这也是0，那么就删除该文件的内容
</pre>
</div>
<div id="outline-container-org20e6199" class="outline-4">
<h4 id="org20e6199">unlink实例</h4>
<div class="outline-text-4" id="text-org20e6199">
<p>
打开一个文件，然后unlink它。执行该程序的进程然后睡眠15秒钟，接着就终止
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;sys/types.h&gt;</span>
<span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;sys/stat.h&gt;</span>
<span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;fcntl.h&gt;</span>
<span style="color: #ffd700;">#include</span> <span style="color: #deb887;">"apue.h"</span>

<span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">main</span>(<span style="color: #98f5ff;">void</span>)
{
    <span style="color: #00bfff; font-weight: bold;">if</span>(open(<span style="color: #deb887;">"tempfile"</span>, O_RDWR) &lt; 0)
        err_sys(<span style="color: #deb887;">"open error"</span>);

    <span style="color: #00bfff; font-weight: bold;">if</span>(unlink(<span style="color: #deb887;">"tempfile"</span>) &lt; 0)
        err_sys(<span style="color: #deb887;">"unlink error"</span>);
    printf(<span style="color: #deb887;">"file unlinked\n"</span>);

    sleep(15);
    printf(<span style="color: #deb887;">"done\n"</span>);

    exit(0);

}
</pre>
</div>
<p>
测试代码：
</p>
<div class="org-src-container">
<pre class="src src-sh">$ echo <span style="color: #deb887;">"hello world "</span> &gt; tempfile

$ ls -l tempfile
<span style="color: #5f9ea0; font-style: italic;"># </span><span style="color: #5f9ea0; font-style: italic;">1&#34920;&#31034;&#26377;1&#20010;&#30446;&#24405;&#39033;&#30446;&#25351;&#21521;tempfile</span>
-rw-r--r-- 1 klose klose 13 Jan 30 22:53 tempfile

$ ./unlinkExample

file unlinked
<span style="color: #00bfff; font-weight: bold;">done</span>

$ ls -l tempfile

ls: cannot access <span style="color: #deb887;">'tempfile'</span>: No such file or directory
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgfa1709a" class="outline-3">
<h3 id="orgfa1709a">remove函数</h3>
<div class="outline-text-3" id="text-orgfa1709a">
<p>
remove函数：对于文件remove与unlink一样，对于目录remove与rmdir一样
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;stdio.h&gt;</span>
<span style="color: #ffebcd;">/**</span>
<span style="color: #ffebcd;"> * &#23545;&#20110;&#25991;&#20214;remove&#19982;unlink&#19968;&#26679;&#65292;&#23545;&#20110;&#30446;&#24405;remove&#19982;rmdir&#19968;&#26679;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * pathname: &#25991;&#20214;&#25110;&#30446;&#24405;&#36335;&#24452;&#21517;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * return: &#33509;&#25104;&#21151;&#21017;&#20026; 0&#65292;&#33509;&#20986;&#38169;&#21017;&#20026; -1</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> */</span>
<span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">remove</span>(<span style="color: #00bfff; font-weight: bold;">const</span> <span style="color: #98f5ff;">char</span>* <span style="color: #4eee94;">pathname</span>);
</pre>
</div>
</div>
</div>

<div id="outline-container-org45ec1d9" class="outline-3">
<h3 id="org45ec1d9">rename函数</h3>
<div class="outline-text-3" id="text-org45ec1d9">
<p>
rename函数：修改文件或者目录名字
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;stdio.h&gt;</span>

<span style="color: #ffebcd;">/**</span>
<span style="color: #ffebcd;"> * &#20462;&#25913;&#25991;&#20214;&#25110;&#32773;&#30446;&#24405;&#21517;&#23383;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * oldname: &#26087;&#30340;&#25991;&#20214;&#25110;&#30446;&#24405;&#36335;&#24452;&#21517;</span>
<span style="color: #ffebcd;"> * newname: &#26032;&#30340;&#24681;&#35265;&#25110;&#30446;&#24405;&#36335;&#24452;&#21517;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * return: &#33509;&#25104;&#21151;&#21017;&#20026; 0&#65292;&#33509;&#20986;&#38169;&#21017;&#20026; -1</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> */</span>
<span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">rename</span>(<span style="color: #00bfff; font-weight: bold;">const</span> <span style="color: #98f5ff;">char</span>* <span style="color: #4eee94;">oldname</span>, <span style="color: #00bfff; font-weight: bold;">const</span> <span style="color: #98f5ff;">char</span>* <span style="color: #4eee94;">newname</span>);
</pre>
</div>
<ul class="org-ul">
<li>如果oldname是一个文件而不是目录，那么为该文件更名
<ul class="org-ul">
<li>如果newname已存在，则它不能引用一个目录</li>
<li>如果newname已存在而且不是一个目录
<ul class="org-ul">
<li>先将该目录项删除然后将oldname更名为newname</li>
<li>对包含oldname的目录以及包含newname的目录，调用进程必须具有写许可权，因为将更改这两个目录</li>
</ul></li>
</ul></li>
<li>如若oldname是一个目录，那么为该目录更名
<ul class="org-ul">
<li>如果newname已存在，则它必须引用一个目录，而且该目录应当是空目录(空目录指的是该目录中只有.和..项)
<ul class="org-ul">
<li>先将其删除，然后将oldname更名为newname</li>
</ul></li>
<li>当为一个目录更名时，newname不能包含oldname作为其路径前缀</li>
</ul></li>
</ul>
<pre class="example">
     例如，不能将/usr/foo更名为/usr/foo/testdir，因为老名字(/usr/foo)是新名字的路径前缀，因而不能将其删除

     作为一个特例，如果oldname和newname引用同一文件，则函数不做任何更改而成功返回
</pre>
<ul class="org-ul">
<li>若newname已经存在，则调用进程需要对其有写许可权。另外调用进程将删除oldname目录项，并可能要创建newname目录项，所以它需要对包含oldname及包含newname的目录具有写和执行许可权</li>
</ul>
</div>
</div>

<div id="outline-container-org12609d1" class="outline-3">
<h3 id="org12609d1">符号连接</h3>
<div class="outline-text-3" id="text-org12609d1">
<p>
符号连接是对一个文件的间接指针，而硬连接直接指向文件的i节点
</p>

<p>
引进符号连接的原因是为了避免硬连接的一些限制：
</p>
<ul class="org-ul">
<li>硬连接通常要求连接和文件位于 <b>同一文件系统</b> 中</li>
<li>只有 <b>超级用户</b> 才能创建到目录的硬连接</li>
</ul>

<p>
对符号连接以及它指向什么没有文件系统限制，任何用户都可创建指向目录的符号连接。符号连接一般用于将一个文件或整个目录结构移到系统中其他某个位置
</p>
</div>

<div id="outline-container-orgb3c46d8" class="outline-4">
<h4 id="orgb3c46d8">函数对符号连接的处理</h4>
<div class="outline-text-4" id="text-orgb3c46d8">
<ul class="org-ul">
<li>跟随：该函数的路径名参数引用会跟随由符号连接指向的文件</li>
<li>不跟随：该符号连接路径名不跟随由符号连接引用的文件</li>
</ul>


<table border="1" cellspacing="0" cellpadding="6" rules="all" frame="boader　">
<caption class="t-above"><span class="table-number">Table 6:</span> 各个函数对符号连接的处理</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">函数</td>
<td class="org-left">不跟随符号连接</td>
<td class="org-left">跟随符号连接</td>
</tr>

<tr>
<td class="org-left">access</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">•</td>
</tr>

<tr>
<td class="org-left">chdir</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">•</td>
</tr>

<tr>
<td class="org-left">chmod</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">•</td>
</tr>

<tr>
<td class="org-left">chown</td>
<td class="org-left">•</td>
<td class="org-left">•</td>
</tr>

<tr>
<td class="org-left">creat</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">•</td>
</tr>

<tr>
<td class="org-left">exec</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">•</td>
</tr>

<tr>
<td class="org-left">lchown</td>
<td class="org-left">•</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">link</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">•</td>
</tr>

<tr>
<td class="org-left">lstat</td>
<td class="org-left">•</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">mkdir</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">•</td>
</tr>

<tr>
<td class="org-left">mkfifo</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">•</td>
</tr>

<tr>
<td class="org-left">mknod</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">•</td>
</tr>

<tr>
<td class="org-left">open</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">•</td>
</tr>

<tr>
<td class="org-left">opendir</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">•</td>
</tr>

<tr>
<td class="org-left">pathconf</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">•</td>
</tr>

<tr>
<td class="org-left">readlink</td>
<td class="org-left">•</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">remove</td>
<td class="org-left">•</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">rename</td>
<td class="org-left">•</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">stat</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">•</td>
</tr>

<tr>
<td class="org-left">truncate</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">•</td>
</tr>

<tr>
<td class="org-left">unlink</td>
<td class="org-left">•</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>


<div id="outline-container-org30d5bad" class="outline-4">
<h4 id="org30d5bad">符号连接循环</h4>
<div class="outline-text-4" id="text-org30d5bad">
<p>
<b>使用符号连接可能在文件系统中引入循环</b> 。大多数查找路径名的函数在这种情况发生时都返回值为 <span class="underline">ELOOP</span> 的errno
</p>

<p>
创建了一个目录foo，它包含了一个名为a的文件以及一个指向foo的符号连接
</p>
<div class="org-src-container">
<pre class="src src-sh">$<span style="color: #4eee94;">mkdir</span> foo <span style="color: #5f9ea0; font-style: italic;">#</span><span style="color: #5f9ea0; font-style: italic;">&#21019;&#24314;&#19968;&#20010;&#26032;&#30446;&#24405;</span>

$<span style="color: #4eee94;">touch</span> foo/a <span style="color: #5f9ea0; font-style: italic;">#</span><span style="color: #5f9ea0; font-style: italic;">&#21019;&#24314;0&#38271;&#25991;&#20214;</span>

$<span style="color: #4eee94;">ln</span> - s ../foo foo/testdir <span style="color: #5f9ea0; font-style: italic;">#</span><span style="color: #5f9ea0; font-style: italic;">&#21019;&#24314;&#19968;&#31526;&#21495;&#36830;&#25509;</span>

$<span style="color: #4eee94;">ls</span> -1 foo

total 1
-rw-rw-r-- 1 stevens 0 Dec6 06:06 a
lrwxrwxrwx 1 stevens 6 Dec6 06:06 testdir -&gt; ../foo
</pre>
</div>
<p>
如果遍历目录不考虑这种情况，那么从foo到/foo/testdir则又会回到foo
</p>
</div>
</div>
</div>

<div id="outline-container-org7e0ea1a" class="outline-3">
<h3 id="org7e0ea1a">symlink函数</h3>
<div class="outline-text-3" id="text-org7e0ea1a">
<p>
symlink函数：创建一个符号连接
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #ffd700;">#include</span><span style="color: #deb887;">&lt;unistd.h&gt;</span>
<span style="color: #ffebcd;">/**</span>
<span style="color: #ffebcd;"> * &#21019;&#24314;&#19968;&#20010;&#31526;&#21495;&#36830;&#25509;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * actualpath&#65306;&#34987;&#24341;&#29992;&#25991;&#20214;&#36335;&#24452;&#21517;</span>
<span style="color: #ffebcd;"> * sympath&#65306;&#31526;&#21495;&#36830;&#25509;&#25991;&#20214;&#36335;&#24452;&#21517;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * return: &#33509;&#25104;&#21151;&#21017;&#20026; 0&#65292;&#33509;&#20986;&#38169;&#21017;&#20026; -1</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> */</span>
<span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">symlink</span>(<span style="color: #00bfff; font-weight: bold;">const</span> <span style="color: #98f5ff;">char</span>* <span style="color: #4eee94;">actualpath</span>, <span style="color: #00bfff; font-weight: bold;">const</span> <span style="color: #98f5ff;">char</span>* <span style="color: #4eee94;">sympath</span>);
</pre>
</div>
<p>
创建了一个指向actualpath的新目录项sympath，在创建此符号连接时，并不要求actualpath已经存在，并且actualpath和sympath并不需要位于同一文件系统中
</p>
</div>
</div>

<div id="outline-container-org2f42988" class="outline-3">
<h3 id="org2f42988">readlink函数</h3>
<div class="outline-text-3" id="text-org2f42988">
<p>
readlink函数：因为open函数跟随符号连接，所以需要有一种方法 <span class="underline">打开该连接本身文件</span> ，而readlink函数就提供了这个功能
</p>

<div class="org-src-container">
<pre class="src src-C"><span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;unistd.h&gt;</span>

<span style="color: #ffebcd;">/**</span>
<span style="color: #ffebcd;"> * &#35835;&#21462;&#19968;&#20010;&#31526;&#21495;&#38142;&#25509;&#65292;&#23427;&#19981;&#20250;&#36319;&#38543;&#31526;&#21495;&#38142;&#25509;&#25351;&#21521;&#30340;&#25991;&#20214;&#65292;&#36820;&#22238;&#30340;&#26159;&#31526;&#21495;&#38142;&#25509;&#26412;&#36523;&#30340;&#20449;&#24687;&#65292;&#21363;&#25351;&#21521;&#30340;&#25991;&#20214;&#30340;&#21517;&#23383;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * pathname: &#31526;&#21495;&#38142;&#25509;&#25991;&#20214;&#36335;&#24452;&#21517;</span>
<span style="color: #ffebcd;"> * buf: &#20445;&#23384;&#25351;&#21521;&#25991;&#20214;&#21517;&#23383;&#30340;&#32531;&#23384;&#21306;</span>
<span style="color: #ffebcd;"> * bufsize: &#32531;&#23384;&#21306;&#22823;&#23567;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * return: &#33509;&#25104;&#21151;&#21017;&#20026;&#35835;&#30340;&#23383;&#33410;&#25968;&#65292;&#33509;&#20986;&#38169;&#21017;&#20026; -1</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> */</span>
<span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">readlink</span>(<span style="color: #00bfff; font-weight: bold;">const</span> <span style="color: #98f5ff;">char</span>* <span style="color: #4eee94;">pathname</span>, <span style="color: #98f5ff;">char</span>* <span style="color: #4eee94;">buf</span>, <span style="color: #98f5ff;">int</span> <span style="color: #4eee94;">bufsize</span>);
</pre>
</div>
<p>
此函数组合了open，read和close的所有操作
</p>

<pre class="example">
     注意：在buf中返回的符号连接的内容不以null字符终止！
</pre>
</div>
</div>
</div>

<div id="outline-container-org5a60ae2" class="outline-2">
<h2 id="org5a60ae2">文件的时间</h2>
<div class="outline-text-2" id="text-org5a60ae2">
<p>
对每个文件保持有三个时间字段，它们的意义示于表4-7中
</p>

<table border="1" cellspacing="0" cellpadding="6" rules="all" frame="boader">
<caption class="t-above"><span class="table-number">Table 7:</span> 与文件相关的三个时间值</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">字段</td>
<td class="org-left">说明</td>
<td class="org-left">例子</td>
<td class="org-left">ls(1)选择项</td>
</tr>

<tr>
<td class="org-left">st_atime</td>
<td class="org-left">文件数据的最后读取时间</td>
<td class="org-left">read</td>
<td class="org-left">-u</td>
</tr>

<tr>
<td class="org-left">st_mtime</td>
<td class="org-left">文件数据的最后修改时间</td>
<td class="org-left">write</td>
<td class="org-left">缺省</td>
</tr>

<tr>
<td class="org-left">st_ctime</td>
<td class="org-left">i节点状态的最后更改时间</td>
<td class="org-left">chmod,chown</td>
<td class="org-left">-c</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li><span class="underline">修改</span> 时间： <b>文件内容</b> 最后一次被 <b>修改</b> 的时间</li>
<li><span class="underline">更改状态</span> 时间：该文件的 <b>i节点</b> 最后一次被 <b>修改</b> 的时间。比如文件的 <span class="underline">存取许可权</span> 、 <span class="underline">用户ID</span> 、 <span class="underline">链接数</span> 等操作，这些只会影响到i节点，而不影响实际内容</li>
<li><b>系统并不保存对一个i节点的最后一次读取时间</b> ，所以 <span class="underline">access</span> 和 <span class="underline">stat</span> 函数并不会影响这三个时间中的任何一个</li>
</ul>

<p>
ls命令会按这三个时间值中的一个排序进行显示：
</p>
<ul class="org-ul">
<li><span class="underline">-l</span> 按文件的 <span class="underline">修改</span> 时间的先后排序显示（系统默认）</li>
<li><span class="underline">-u</span> 选择项使其用 <span class="underline">读取</span> 时间排序</li>
<li><span class="underline">-c</span> 选择项则使其用 <span class="underline">更改状态</span> 时间排序</li>
</ul>
</div>

<div id="outline-container-org62e4268" class="outline-3">
<h3 id="org62e4268">三个时间的作用</h3>
<div class="outline-text-3" id="text-org62e4268">
<p>
使用 <span class="underline">读取</span> 时间来 <b>删除</b> 在一定的时间范围内没有读取过的文件
</p>

<pre class="example">
     典型的例子是使用find(1)命令删除在过去一周内没有读取过的名为a.out或core的文件
</pre>

<p>
<span class="underline">修改</span> 时间和 <span class="underline">更改状态</span> 时间可被用来 <b>归档</b> 其 <span class="underline">内容已经被修改</span> 或其 <span class="underline">i节点已经被更改</span> 的那些文件
</p>
</div>
</div>

<div id="outline-container-org7e35ef7" class="outline-3">
<h3 id="org7e35ef7">各个函数的影响</h3>
<div class="outline-text-3" id="text-org7e35ef7">
<p>
已说明过的各种函数对这三个时间的作用
</p>
<!-- This HTML table template is generated by emacs 26.3 -->
<table border="1">
  <tr>
    <td rowspan="2" align="left" valign="top">
      &nbsp;function&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td colspan="3" align="left" valign="top">
      &nbsp;&nbsp;referenced&nbsp;file(or&nbsp;directory)&nbsp;
    </td>
    <td colspan="3" align="left" valign="top">
      &nbsp;parent&nbsp;directory&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td rowspan="2" align="left" valign="top">
      &nbsp;comment&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;m&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;m&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      f/chmod&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      f/chown&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      create&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      O_CREATE&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      create&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      O_TRUNCATE&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      exec&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      lchown&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      link&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      mkdir&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      mkfifo&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      open&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      O_CREATE&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      open&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      O_TRUNCATE&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      pipe&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      read&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      remove&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      =&nbsp;unlink&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      remove&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      =&nbsp;rmdir&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      rename&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      rmdir&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      f/truncate
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      unlink&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      utime&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      write&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
</table>
</div>
</div>

<div id="outline-container-org238205b" class="outline-3">
<h3 id="org238205b">utime函数</h3>
<div class="outline-text-3" id="text-org238205b">
<p>
<span class="underline">atime</span> 和 <span class="underline">mtime</span> 可由 <b>utime</b> 函数更改，同时 <span class="underline">ctime</span> 将 <b>自动更新为执行时的时间</b> 
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;sys/types.h&gt;</span>
<span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;utime.h&gt;</span>

<span style="color: #ffebcd;">/**</span>
<span style="color: #ffebcd;"> * &#26356;&#25913;&#19968;&#20010;&#25991;&#20214;&#30340;&#23384;&#21462;&#21644;&#20462;&#25913;&#26102;&#38388;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * pathname: &#25991;&#20214;&#36335;&#24452;&#21517;</span>
<span style="color: #ffebcd;"> * times: &#25991;&#20214;&#26102;&#38388;&#32467;&#26500;&#12288;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * return: &#33509;&#25104;&#21151;&#21017;&#20026; 0&#65292;&#33509;&#20986;&#38169;&#21017;&#20026; -1</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> */</span>
<span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">utime</span>(<span style="color: #00bfff; font-weight: bold;">const</span> <span style="color: #98f5ff;">char</span> *<span style="color: #4eee94;">pathname</span>, <span style="color: #00bfff; font-weight: bold;">const</span> <span style="color: #00bfff; font-weight: bold;">struct</span> <span style="color: #98f5ff;">utimbuf</span> *<span style="color: #4eee94;">times</span>);
</pre>
</div>
<p>
<span class="underline">utimebuf</span> 结构：两个时间值是Unix日历时间（自1970年1月1日00:00:00以来国际标准时间所经过的秒数）
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #00bfff; font-weight: bold;">struct</span> <span style="color: #98f5ff;">utimbuf</span> {
    <span style="color: #98f5ff;">time_t</span> <span style="color: #4eee94;">actime</span>;  <span style="color: #5f9ea0; font-style: italic;">/*</span><span style="color: #5f9ea0; font-style: italic;">accesstime</span><span style="color: #5f9ea0; font-style: italic;">*/</span>
    <span style="color: #98f5ff;">time_t</span> <span style="color: #4eee94;">modtime</span>; <span style="color: #5f9ea0; font-style: italic;">/*</span><span style="color: #5f9ea0; font-style: italic;">modificationtime</span><span style="color: #5f9ea0; font-style: italic;">*/</span>
}
</pre>
</div>
<ol class="org-ol">
<li>如果 <span class="underline">times</span> 是一个 <span class="underline">空指针</span> ，则 <span class="underline">存取</span> 时间和 <span class="underline">修改</span> 时间两者都设置为 <span class="underline">当前时间</span> 。为了执行此操作必须满足下列两条件之一：
<ul class="org-ul">
<li><span class="underline">进程的有效用户ID</span> 必须等于该 <span class="underline">文件的所有者ID</span></li>
<li>进程对该文件必须具有 <span class="underline">写许可权</span></li>
</ul></li>
</ol>
<p>
2.如果 <span class="underline">times</span> 是 <span class="underline">非空</span> 指针，则 <span class="underline">存取</span> 时间和 <span class="underline">修改</span> 时间被设置为 <span class="underline">times所指向的结构中的值</span> 。为了执行此操作只具有写权限是不够的，必须满足下列两个条件之一：
</p>
<ul class="org-ul">
<li><span class="underline">进程的有效用户ID</span> 必须等于 <span class="underline">该文件的所有者ID</span></li>
<li>进程必须是一个 <b>超级用户进程</b></li>
</ul>
</div>

<div id="outline-container-org4cc18d8" class="outline-4">
<h4 id="org4cc18d8">utime函数实例</h4>
<div class="outline-text-4" id="text-org4cc18d8">
<pre class="example">
      使用带O_TRUNC选择项的open函数将文件长度截短为0，但并不更改其存取时间及修改时间
</pre>
<p>
首先用stat函数得到这些时间，然后截短文件，最后再用utime函数重置这两个时间
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;sys/types.h&gt;</span>
<span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;sys/stat.h&gt;</span>
<span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;fcntl.h&gt;</span>
<span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;utime.h&gt;</span>
<span style="color: #ffd700;">#include</span> <span style="color: #deb887;">"apue.h"</span>

<span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">main</span>(<span style="color: #98f5ff;">int</span> <span style="color: #4eee94;">argc</span>, <span style="color: #98f5ff;">char</span> *<span style="color: #4eee94;">argv</span>[])
{
    <span style="color: #98f5ff;">int</span> <span style="color: #4eee94;">i</span>;
    <span style="color: #00bfff; font-weight: bold;">struct</span> <span style="color: #98f5ff;">stat</span> <span style="color: #4eee94;">statbuf</span>;
    <span style="color: #00bfff; font-weight: bold;">struct</span> <span style="color: #98f5ff;">utimbuf</span> <span style="color: #4eee94;">timebuf</span>;

    <span style="color: #00bfff; font-weight: bold;">for</span>(i = 1; i &lt; argc ; ++i) {
        <span style="color: #00bfff; font-weight: bold;">if</span>(stat(argv[i], &amp;statbuf) &lt; 0) {
            err_ret(<span style="color: #deb887;">"%s: stat error"</span>, argv[i]);
            <span style="color: #00bfff; font-weight: bold;">continue</span>;
        }

        <span style="color: #00bfff; font-weight: bold;">if</span>(open(argv[i], O_RDWR | O_TRUNC) &lt; 0) {
            err_ret(<span style="color: #deb887;">"%s: open error"</span>, argv[i]);
            <span style="color: #00bfff; font-weight: bold;">continue</span>;
        }

        timebuf.actime = statbuf.st_atime;
        timebuf.modtime = statbuf.st_mtime;
        <span style="color: #00bfff; font-weight: bold;">if</span>(utime(argv[i], &amp;timebuf)&lt; 0) {
            err_ret(<span style="color: #deb887;">"%s: utime error"</span>, argv[i]);
            <span style="color: #00bfff; font-weight: bold;">continue</span>;
        }
    }

    exit(0);    
}
</pre>
</div>

<p>
测试代码：
</p>
<div class="org-src-container">
<pre class="src src-sh">$<span style="color: #4eee94;">ls</span> -l helloworld
-rw-r--r-- 1 klose klose 12 Jan 31 22:42 helloworld

$<span style="color: #4eee94;">ls</span> -lu helloworld
-rw-r--r-- 1 klose klose 12 Jan 31 22:42 helloworld

$./utimeExample helloworld

$<span style="color: #4eee94;">ls</span> -l helloworld
-rw-r--r-- 1 klose klose 0 Jan 31 22:42 helloworld

$<span style="color: #4eee94;">ls</span> -lu helloworld
-rw-r--r-- 1 klose klose 0 Jan 31 22:42 helloworld
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org3c63e8d" class="outline-2">
<h2 id="org3c63e8d">目录操作</h2>
<div class="outline-text-2" id="text-org3c63e8d">
</div>
<div id="outline-container-org81213ac" class="outline-3">
<h3 id="org81213ac">mkdir函数</h3>
<div class="outline-text-3" id="text-org81213ac">
<p>
mkdir函数：创建目录
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;sys/types.h&gt;</span>
<span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;sys/stat.h&gt;</span>

<span style="color: #ffebcd;">/**</span>
<span style="color: #ffebcd;"> * &#21019;&#24314;&#30446;&#24405;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * pathname: &#30446;&#24405;&#36335;&#24452;&#21517;</span>
<span style="color: #ffebcd;"> * mode: &#30446;&#24405;&#26435;&#38480;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * return: &#33509;&#25104;&#21151;&#21017;&#20026; 0&#65292;&#33509;&#20986;&#38169;&#21017;&#20026; -1</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> */</span>
<span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">mkdir</span>(<span style="color: #00bfff; font-weight: bold;">const</span> <span style="color: #98f5ff;">char</span> *<span style="color: #4eee94;">pathname</span>, <span style="color: #98f5ff;">mode_t</span> <span style="color: #4eee94;">mode</span>);
</pre>
</div>
<p>
此函数创建一个新的空目录。 <span class="underline">'.'</span> 和 <span class="underline">'..'</span> 目录项是 <b>自动创建</b> 的。所指定的 <b>文件存取许可权mode由进程的umask修改</b> 
</p>

<pre class="example">
     常见的错误是指定与文件相同的mode(只指定读、写许可权)

     但是对于目录通常至少要设置1个“执行“许可权位，以允许存取该目录中的文件名
</pre>
</div>
</div>

<div id="outline-container-org7094d56" class="outline-3">
<h3 id="org7094d56">rmdir函数</h3>
<div class="outline-text-3" id="text-org7094d56">
<p>
rmdir函数：删除目录
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;unistd.h&gt;</span>

<span style="color: #ffebcd;">/**</span>
<span style="color: #ffebcd;"> * &#21024;&#38500;&#30446;&#24405;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * pathname: &#30446;&#24405;&#36335;&#24452;&#21517;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * return: &#33509;&#25104;&#21151;&#21017;&#20026; 0&#65292;&#33509;&#20986;&#38169;&#21017;&#20026; -1</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> */</span>
<span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">rmdir</span>(<span style="color: #00bfff; font-weight: bold;">const</span> <span style="color: #98f5ff;">char</span> *<span style="color: #4eee94;">pathname</span>);
</pre>
</div>
<ul class="org-ul">
<li>如果此调用使目录的 <span class="underline">连接计数成为0</span> ，并且也 <span class="underline">没有其他进程打开此目录</span> ，则 <b>释放由此目录占用的空间</b></li>
<li>如果在 <span class="underline">连接计数达到0</span> 时，有 <span class="underline">一个或几个进程打开了此目录</span> ，则在此函数返回前 <b>删除最后一个连接及 <span class="underline">'.'</span> 和 <span class="underline">'..'</span> 项</b> 
<ul class="org-ul">
<li>在此目录中 <b>不能再创建新文件</b></li>
<li>但是在 <span class="underline">最后一个进程关闭</span> 它之前 <b>并不释放此目录</b></li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org7456a28" class="outline-3">
<h3 id="org7456a28">读取目录</h3>
<div class="outline-text-3" id="text-org7456a28">
<ul class="org-ul">
<li>目录的 <span class="underline">读许可权位</span> ：用户是否能 <b>读</b> 该目录，但是 <b>只有内核才能写目录</b> (防止文件系统发生混乱)</li>
<li>目录的 <span class="underline">写许可权位</span> ：决定了在该目录中能否 <b>创建</b> 新文件（并不表示能否写目录本身）</li>
<li>目录的 <span class="underline">执行许可权位</span> ：决定了在该目录中能否 <b>删除</b> 文件</li>
</ul>

<pre class="example">
     目录的实现依赖于不同的实现，早期系统可能每个目录项的文件名是14个字节，i节点编号是2个字节

     而现代的系统文件名可以更长。这就意味着读目录的程序与系统相关

     为了简化这种情况，UNIX现在包含了一套与读目录有关的例程，它们是POSIX.1的一部分
</pre>
</div>

<div id="outline-container-org14a0219" class="outline-4">
<h4 id="org14a0219">DIR和dirent结构</h4>
<div class="outline-text-4" id="text-org14a0219">
<ul class="org-ul">
<li><span class="underline">目录流DIR结构</span> 是一个内部结构，其作用类似于FILE，由 <span class="underline">标准I/O库</span> 维护</li>

<li><p>
<span class="underline">目录项结构dirent</span> 与实现有关，必须包含2个字段： <span class="underline">i结点号</span> 和 <span class="underline">文件/目录名</span> 
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #00bfff; font-weight: bold;">struct</span> <span style="color: #98f5ff;">__dirstream</span>
{
    <span style="color: #98f5ff;">int</span> <span style="color: #4eee94;">fd</span>;                     <span style="color: #5f9ea0; font-style: italic;">/* </span><span style="color: #5f9ea0; font-style: italic;">File descriptor.  </span><span style="color: #5f9ea0; font-style: italic;">*/</span>

    <span style="color: #98f5ff;">size_t</span> <span style="color: #4eee94;">allocation</span>;          <span style="color: #5f9ea0; font-style: italic;">/* </span><span style="color: #5f9ea0; font-style: italic;">Space allocated for the block.  </span><span style="color: #5f9ea0; font-style: italic;">*/</span>
    <span style="color: #98f5ff;">size_t</span> <span style="color: #4eee94;">size</span>;                <span style="color: #5f9ea0; font-style: italic;">/* </span><span style="color: #5f9ea0; font-style: italic;">Total valid data in the block.  </span><span style="color: #5f9ea0; font-style: italic;">*/</span>
    <span style="color: #98f5ff;">size_t</span> <span style="color: #4eee94;">offset</span>;              <span style="color: #5f9ea0; font-style: italic;">/* </span><span style="color: #5f9ea0; font-style: italic;">Current offset into the block.  </span><span style="color: #5f9ea0; font-style: italic;">*/</span>

    <span style="color: #98f5ff;">off_t</span> <span style="color: #4eee94;">filepos</span>;              <span style="color: #5f9ea0; font-style: italic;">/* </span><span style="color: #5f9ea0; font-style: italic;">Position of next entry to read.  </span><span style="color: #5f9ea0; font-style: italic;">*/</span>

    <span style="color: #98f5ff;">char</span> <span style="color: #4eee94;">data</span>[0];               <span style="color: #5f9ea0; font-style: italic;">/* </span><span style="color: #5f9ea0; font-style: italic;">Directory block.  </span><span style="color: #5f9ea0; font-style: italic;">*/</span>
};   

<span style="color: #00bfff; font-weight: bold;">typedef</span> <span style="color: #00bfff; font-weight: bold;">struct</span> <span style="color: #98f5ff;">__dirstream</span> <span style="color: #98f5ff;">DIR</span>;

<span style="color: #00bfff; font-weight: bold;">struct</span> <span style="color: #98f5ff;">dirent</span>
{
    <span style="color: #98f5ff;">ino_t</span> <span style="color: #4eee94;">d_ino</span>; <span style="color: #5f9ea0; font-style: italic;">/*</span><span style="color: #5f9ea0; font-style: italic;">i-node number</span><span style="color: #5f9ea0; font-style: italic;">*/</span>        
    <span style="color: #98f5ff;">char</span> <span style="color: #4eee94;">d_nam</span>[NAME_MAX + 1]; <span style="color: #5f9ea0; font-style: italic;">/* </span><span style="color: #5f9ea0; font-style: italic;">null-teminated file/directory name </span><span style="color: #5f9ea0; font-style: italic;">*/</span>
}
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org5862b6a" class="outline-4">
<h4 id="org5862b6a">目录流操作函数</h4>
<div class="outline-text-4" id="text-org5862b6a">
<ul class="org-ul">
<li>opendir：把目录内容放到目录流 ，使第一个readdir读目录中的第一个目录项</li>
<li>readdir：读取一个目录项，目录流指针指向下一个目录项</li>
<li>rewinddir：重置目录流指针到第一个目录项目</li>
<li><p>
closedir：关闭目录流指针
</p>

<div class="org-src-container">
<pre class="src src-C"><span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;sys/types.h&gt;</span>
<span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;dirent.h&gt;</span>

<span style="color: #ffebcd;">/**</span>
<span style="color: #ffebcd;"> * &#25226;&#23376;&#30446;&#24405;&#21644;&#25991;&#20214;&#31561;&#25918;&#21040;&#30446;&#24405;&#27969;&#20013;&#65292;&#20351;&#31532;&#19968;&#20010;readdir&#35835;&#30446;&#24405;&#20013;&#30340;&#31532;&#19968;&#20010;&#30446;&#24405;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * pathname: &#30446;&#24405;&#36335;&#24452;&#21517;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> *  return: &#33509;&#25104;&#21151;&#21017;&#20026;&#25351;&#21521;&#30446;&#24405;&#27969;&#30340;&#25351;&#38024;&#65292;&#33509;&#20986;&#38169;&#21017;&#20026; NULL</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> */</span>
<span style="color: #98f5ff;">DIR</span> *<span style="color: #daa520; font-weight: bold;">opendir</span>(<span style="color: #00bfff; font-weight: bold;">const</span> <span style="color: #98f5ff;">char</span> *<span style="color: #4eee94;">pathname</span>);

<span style="color: #ffebcd;">/**</span>
<span style="color: #ffebcd;"> * &#35835;&#21462;&#19968;&#20010;&#30446;&#24405;&#39033;&#65292;&#30446;&#24405;&#27969;&#25351;&#38024;&#25351;&#21521;&#19979;&#19968;&#20010;&#30446;&#24405;&#39033;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * dp: &#25351;&#21521;&#30446;&#24405;&#27969;&#30340;&#25351;&#38024;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * return: &#33509;&#25104;&#21151;&#21017;&#20026;&#25351;&#21521;&#30446;&#24405;&#39033;&#30340;&#25351;&#38024;&#65292;&#33509;&#22312;&#30446;&#24405;&#23614;&#25110;&#20986;&#38169;&#21017;&#20026; NULL</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> */</span>
<span style="color: #00bfff; font-weight: bold;">struct</span> <span style="color: #98f5ff;">dirent</span> *<span style="color: #daa520; font-weight: bold;">readdir</span>(<span style="color: #98f5ff;">DIR</span> *<span style="color: #4eee94;">dp</span>);

<span style="color: #ffebcd;">/**</span>
<span style="color: #ffebcd;"> * &#37325;&#32622;&#30446;&#24405;&#27969;&#25351;&#38024;&#21040;DIR*&#27969;&#30340;&#36215;&#28857;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * dp: &#25351;&#21521;&#30446;&#24405;&#27969;&#30340;&#25351;&#38024;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * return: &#33509;&#25104;&#21151;&#20026; 0&#65292;&#33509;&#22833;&#36133;&#20026; -1</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> */</span>
<span style="color: #98f5ff;">void</span> <span style="color: #daa520; font-weight: bold;">rewinddir</span>(<span style="color: #98f5ff;">DIR</span> *<span style="color: #4eee94;">dp</span>);

<span style="color: #ffebcd;">/**</span>
<span style="color: #ffebcd;"> * &#20851;&#38381;&#30446;&#24405;&#27969;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * dp: &#25351;&#21521;&#30446;&#24405;&#27969;&#30340;&#25351;&#38024;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * return: &#33509;&#25104;&#21151;&#20026; 0&#65292;&#33509;&#22833;&#36133;&#20026; -1</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> */</span>
<span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">closedir</span>(<span style="color: #98f5ff;">DIR</span> *<span style="color: #4eee94;">dp</span>);
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org29cd2b3" class="outline-4">
<h4 id="org29cd2b3">遍历文件层次结构</h4>
<div class="outline-text-4" id="text-org29cd2b3">
<p>
根据起点目录路径名开始递归降序遍历文件层次结构
</p>

<p>
MyFunc：函数指针类型，接受3个参数，返回int
</p>
<div class="org-src-container">
<pre class="src src-C++"><span style="color: #ffd700;">#include</span> <span style="color: #deb887;">"apue.h"</span>
<span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;dirent.h&gt;</span>
<span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;limits.h&gt;</span>

<span style="color: #5f9ea0; font-style: italic;">/* </span><span style="color: #5f9ea0; font-style: italic;">function type that is called for each filename */</span>
<span style="color: #00bfff; font-weight: bold;">typedef</span> <span style="color: #98f5ff;">int</span> <span style="color: #98f5ff;">Myfunc</span>(<span style="color: #00bfff; font-weight: bold;">const</span> <span style="color: #98f5ff;">char</span> *, <span style="color: #00bfff; font-weight: bold;">const</span> <span style="color: #00bfff; font-weight: bold;">struct</span> <span style="color: #98f5ff;">stat</span> *, <span style="color: #98f5ff;">int</span>);

<span style="color: #00bfff; font-weight: bold;">static</span> <span style="color: #98f5ff;">Myfunc</span>   <span style="color: #4eee94;">myfunc</span>;
<span style="color: #00bfff; font-weight: bold;">static</span> <span style="color: #98f5ff;">int</span>      <span style="color: #daa520; font-weight: bold;">myftw</span>(<span style="color: #98f5ff;">char</span> *, <span style="color: #98f5ff;">Myfunc</span> *);
<span style="color: #00bfff; font-weight: bold;">static</span> <span style="color: #98f5ff;">int</span>      <span style="color: #daa520; font-weight: bold;">dopath</span>(<span style="color: #98f5ff;">Myfunc</span> *);

<span style="color: #00bfff; font-weight: bold;">static</span> <span style="color: #98f5ff;">long</span> <span style="color: #4eee94;">nreg</span>, <span style="color: #4eee94;">ndir</span>, <span style="color: #4eee94;">nblk</span>, <span style="color: #4eee94;">nchr</span>, <span style="color: #4eee94;">nfifo</span>, <span style="color: #4eee94;">nslink</span>, <span style="color: #4eee94;">nsock</span>, <span style="color: #4eee94;">ntot</span>;

<span style="color: #5f9ea0; font-style: italic;">/*</span>
<span style="color: #5f9ea0; font-style: italic;"> * Descend through the hierarchy, starting at "pathname".</span>
<span style="color: #5f9ea0; font-style: italic;"> * The caller's func() is called for every file.</span>
<span style="color: #5f9ea0; font-style: italic;"> */</span>
<span style="color: #ffd700;">#define</span> <span style="color: #4eee94;">FTW_F</span>   1       <span style="color: #5f9ea0; font-style: italic;">/* </span><span style="color: #5f9ea0; font-style: italic;">file other than directory */</span>
<span style="color: #ffd700;">#define</span> <span style="color: #4eee94;">FTW_D</span>   2       <span style="color: #5f9ea0; font-style: italic;">/* </span><span style="color: #5f9ea0; font-style: italic;">directory */</span>
<span style="color: #ffd700;">#define</span> <span style="color: #4eee94;">FTW_DNR</span> 3       <span style="color: #5f9ea0; font-style: italic;">/* </span><span style="color: #5f9ea0; font-style: italic;">directory that can't be read */</span>
<span style="color: #ffd700;">#define</span> <span style="color: #4eee94;">FTW_NS</span>  4       <span style="color: #5f9ea0; font-style: italic;">/* </span><span style="color: #5f9ea0; font-style: italic;">file that we can't stat */</span>

<span style="color: #00bfff; font-weight: bold;">static</span> <span style="color: #98f5ff;">char</span> *<span style="color: #4eee94;">fullpath</span>;      <span style="color: #5f9ea0; font-style: italic;">/* </span><span style="color: #5f9ea0; font-style: italic;">contains full pathname for every file */</span>
</pre>
</div>

<p>
dopath函数：遍历某个目录，把目录流中各个目录项相关数据传递给func函数指针进行处理
</p>
<div class="org-src-container">
<pre class="src src-C++"><span style="color: #5f9ea0; font-style: italic;">/*</span>
<span style="color: #5f9ea0; font-style: italic;"> * Descend through the hierarchy, starting at "fullpath".</span>
<span style="color: #5f9ea0; font-style: italic;"> * If "fullpath" is anything other than a directory, we lstat() it,</span>
<span style="color: #5f9ea0; font-style: italic;"> * call func(), and return.  For a directory, we call ourself</span>
<span style="color: #5f9ea0; font-style: italic;"> * recursively for each name in the directory.</span>
<span style="color: #5f9ea0; font-style: italic;"> */</span>
<span style="color: #00bfff; font-weight: bold;">static</span> <span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">dopath</span>(<span style="color: #98f5ff;">Myfunc</span>* <span style="color: #4eee94;">func</span>)  <span style="color: #5f9ea0; font-style: italic;">/* </span><span style="color: #5f9ea0; font-style: italic;">we return whatever func() returns */</span>
{
    <span style="color: #00bfff; font-weight: bold;">struct</span> <span style="color: #98f5ff;">stat</span>     <span style="color: #4eee94;">statbuf</span>;
    <span style="color: #00bfff; font-weight: bold;">struct</span> <span style="color: #98f5ff;">dirent</span>   *<span style="color: #4eee94;">dirp</span>;
    <span style="color: #98f5ff;">DIR</span>             *<span style="color: #4eee94;">dp</span>;
    <span style="color: #98f5ff;">int</span>             <span style="color: #4eee94;">ret</span>;
    <span style="color: #98f5ff;">char</span>            *<span style="color: #4eee94;">ptr</span>;

    <span style="color: #00bfff; font-weight: bold;">if</span> (lstat(fullpath, &amp;statbuf) &lt; 0)  <span style="color: #5f9ea0; font-style: italic;">/* </span><span style="color: #5f9ea0; font-style: italic;">stat error */</span>
        <span style="color: #00bfff; font-weight: bold;">return</span>(func(fullpath, &amp;statbuf, FTW_NS));
    <span style="color: #00bfff; font-weight: bold;">if</span> (S_ISDIR(statbuf.st_mode) == 0)  <span style="color: #5f9ea0; font-style: italic;">/* </span><span style="color: #5f9ea0; font-style: italic;">not a directory */</span>
        <span style="color: #00bfff; font-weight: bold;">return</span>(func(fullpath, &amp;statbuf, FTW_F));

    <span style="color: #5f9ea0; font-style: italic;">/*</span>
<span style="color: #5f9ea0; font-style: italic;">     * It's a directory.  First call func() for the directory,</span>
<span style="color: #5f9ea0; font-style: italic;">     * then process each filename in the directory.</span>
<span style="color: #5f9ea0; font-style: italic;">     */</span>
    <span style="color: #00bfff; font-weight: bold;">if</span> ((ret = func(fullpath, &amp;statbuf, FTW_D)) != 0)
        <span style="color: #00bfff; font-weight: bold;">return</span>(ret);

    ptr = fullpath + strlen(fullpath);  <span style="color: #5f9ea0; font-style: italic;">/* </span><span style="color: #5f9ea0; font-style: italic;">point to end of fullpath */</span>
    *ptr++ = <span style="color: #deb887;">'/'</span>;
    *ptr = 0;

    <span style="color: #00bfff; font-weight: bold;">if</span> ((dp = opendir(fullpath)) == <span style="color: #ffd700;">NULL</span>)   <span style="color: #5f9ea0; font-style: italic;">/* </span><span style="color: #5f9ea0; font-style: italic;">can't read directory */</span>
        <span style="color: #00bfff; font-weight: bold;">return</span>(func(fullpath, &amp;statbuf, FTW_DNR));

    <span style="color: #00bfff; font-weight: bold;">while</span> ((dirp = readdir(dp)) != <span style="color: #ffd700;">NULL</span>) {
        <span style="color: #00bfff; font-weight: bold;">if</span> (strcmp(dirp-&gt;d_name, <span style="color: #deb887;">"."</span>) == 0  ||
            strcmp(dirp-&gt;d_name, <span style="color: #deb887;">".."</span>) == 0)
            <span style="color: #00bfff; font-weight: bold;">continue</span>;       <span style="color: #5f9ea0; font-style: italic;">/* </span><span style="color: #5f9ea0; font-style: italic;">ignore dot and dot-dot */</span>

        strcpy(ptr, dirp-&gt;d_name);  <span style="color: #5f9ea0; font-style: italic;">/* </span><span style="color: #5f9ea0; font-style: italic;">append name after slash */</span>

        <span style="color: #00bfff; font-weight: bold;">if</span> ((ret = dopath(func)) != 0)      <span style="color: #5f9ea0; font-style: italic;">/* </span><span style="color: #5f9ea0; font-style: italic;">recursive */</span>
            <span style="color: #00bfff; font-weight: bold;">break</span>;  <span style="color: #5f9ea0; font-style: italic;">/* </span><span style="color: #5f9ea0; font-style: italic;">time to leave */</span>
    }
    ptr[-1] = 0;    <span style="color: #5f9ea0; font-style: italic;">/* </span><span style="color: #5f9ea0; font-style: italic;">erase everything from slash onwards */</span>

    <span style="color: #00bfff; font-weight: bold;">if</span> (closedir(dp) &lt; 0)
        err_ret(<span style="color: #deb887;">"can't close directory %s"</span>, fullpath);

    <span style="color: #00bfff; font-weight: bold;">return</span>(ret);
}
</pre>
</div>

<p>
myfunc函数：根据目录项类型，文件类型的不同，出错类型对目录项进行不同操作
</p>
<ol class="org-ol">
<li>文件：相应文件类型的数目增加1</li>
<li>目录：目录类型的数目增加1</li>
<li>无法读取目录项：相应错误类型数目增加1</li>
<li>无法读取文件stat：相应错误类型数目增加1</li>
</ol>
<div class="org-src-container">
<pre class="src src-C++"><span style="color: #00bfff; font-weight: bold;">static</span> <span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">myfunc</span>(<span style="color: #00bfff; font-weight: bold;">const</span> <span style="color: #98f5ff;">char</span> *<span style="color: #4eee94;">pathname</span>, <span style="color: #00bfff; font-weight: bold;">const</span> <span style="color: #00bfff; font-weight: bold;">struct</span> <span style="color: #98f5ff;">stat</span> *<span style="color: #4eee94;">statptr</span>, <span style="color: #98f5ff;">int</span> <span style="color: #4eee94;">type</span>)
{
    <span style="color: #00bfff; font-weight: bold;">switch</span> (type) {
    <span style="color: #00bfff; font-weight: bold;">case</span> FTW_F:
        <span style="color: #00bfff; font-weight: bold;">switch</span> (statptr-&gt;st_mode &amp; S_IFMT) {
        <span style="color: #00bfff; font-weight: bold;">case</span> S_IFREG:   nreg++;     <span style="color: #00bfff; font-weight: bold;">break</span>;
        <span style="color: #00bfff; font-weight: bold;">case</span> S_IFBLK:   nblk++;     <span style="color: #00bfff; font-weight: bold;">break</span>;
        <span style="color: #00bfff; font-weight: bold;">case</span> S_IFCHR:   nchr++;     <span style="color: #00bfff; font-weight: bold;">break</span>;
        <span style="color: #00bfff; font-weight: bold;">case</span> S_IFIFO:   nfifo++;    <span style="color: #00bfff; font-weight: bold;">break</span>;
        <span style="color: #00bfff; font-weight: bold;">case</span> S_IFLNK:   nslink++;   <span style="color: #00bfff; font-weight: bold;">break</span>;
        <span style="color: #00bfff; font-weight: bold;">case</span> S_IFSOCK:  nsock++;    <span style="color: #00bfff; font-weight: bold;">break</span>;
        <span style="color: #00bfff; font-weight: bold;">case</span> S_IFDIR:
            err_dump(<span style="color: #deb887;">"for S_IFDIR for %s"</span>, pathname);
            <span style="color: #5f9ea0; font-style: italic;">/* </span><span style="color: #5f9ea0; font-style: italic;">directories should have type = FTW_D */</span>
        }
        <span style="color: #00bfff; font-weight: bold;">break</span>;

    <span style="color: #00bfff; font-weight: bold;">case</span> FTW_D:
        ndir++;
        <span style="color: #00bfff; font-weight: bold;">break</span>;

    <span style="color: #00bfff; font-weight: bold;">case</span> FTW_DNR:
        err_ret(<span style="color: #deb887;">"can't read directory %s"</span>, pathname);
        <span style="color: #00bfff; font-weight: bold;">break</span>;

    <span style="color: #00bfff; font-weight: bold;">case</span> FTW_NS:
        err_ret(<span style="color: #deb887;">"stat error for %s"</span>, pathname);
        <span style="color: #00bfff; font-weight: bold;">break</span>;

    <span style="color: #00bfff; font-weight: bold;">default</span>:
        err_dump(<span style="color: #deb887;">"unknown type %d for pathname %s"</span>, type, pathname);
    }

    <span style="color: #00bfff; font-weight: bold;">return</span>(0);
}
</pre>
</div>

<p>
myftw函数：保护性拷贝输入的目录路径名，开始遍历
</p>
<div class="org-src-container">
<pre class="src src-C++"><span style="color: #5f9ea0; font-style: italic;">/* </span><span style="color: #5f9ea0; font-style: italic;">we return whatever func() returns */</span>
<span style="color: #00bfff; font-weight: bold;">static</span> <span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">myftw</span>(<span style="color: #98f5ff;">char</span> *<span style="color: #4eee94;">pathname</span>, <span style="color: #98f5ff;">Myfunc</span> *<span style="color: #4eee94;">func</span>)
{
    <span style="color: #98f5ff;">int</span> <span style="color: #4eee94;">len</span>;
    fullpath = path_alloc(&amp;len);    <span style="color: #5f9ea0; font-style: italic;">/* </span><span style="color: #5f9ea0; font-style: italic;">malloc's for PATH_MAX+1 bytes */</span>
    strncpy(fullpath, pathname, len);   <span style="color: #5f9ea0; font-style: italic;">/* </span><span style="color: #5f9ea0; font-style: italic;">protect against */</span>
    fullpath[len-1] = 0;                <span style="color: #5f9ea0; font-style: italic;">/* </span><span style="color: #5f9ea0; font-style: italic;">buffer overrun */</span>

    <span style="color: #00bfff; font-weight: bold;">return</span>(dopath(func));
}
</pre>
</div>

<p>
main函数：输入作为要遍历的目录路径名，遍历完毕后输出对应统计结果
</p>
<div class="org-src-container">
<pre class="src src-C++"><span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">main</span>(<span style="color: #98f5ff;">int</span> <span style="color: #4eee94;">argc</span>, <span style="color: #98f5ff;">char</span> *<span style="color: #4eee94;">argv</span>[])
{
    <span style="color: #98f5ff;">int</span>     <span style="color: #4eee94;">ret</span>;

    <span style="color: #00bfff; font-weight: bold;">if</span> (argc != 2)
        err_quit(<span style="color: #deb887;">"usage:  ftw  &lt;starting-pathname&gt;"</span>);

    ret = myftw(argv[1], myfunc);       <span style="color: #5f9ea0; font-style: italic;">/* </span><span style="color: #5f9ea0; font-style: italic;">does it all */</span>

    ntot = nreg + ndir + nblk + nchr + nfifo + nslink + nsock;
    <span style="color: #00bfff; font-weight: bold;">if</span> (ntot == 0)
        ntot = 1;       <span style="color: #5f9ea0; font-style: italic;">/* </span><span style="color: #5f9ea0; font-style: italic;">avoid divide by 0; print 0 for all counts */</span>
    printf(<span style="color: #deb887;">"regular files  = %7ld, %5.2f %%\n"</span>, nreg,
           nreg*100.0/ntot);
    printf(<span style="color: #deb887;">"directories    = %7ld, %5.2f %%\n"</span>, ndir,
           ndir*100.0/ntot);
    printf(<span style="color: #deb887;">"block special  = %7ld, %5.2f %%\n"</span>, nblk,
           nblk*100.0/ntot);
    printf(<span style="color: #deb887;">"char special   = %7ld, %5.2f %%\n"</span>, nchr,
           nchr*100.0/ntot);
    printf(<span style="color: #deb887;">"FIFOs          = %7ld, %5.2f %%\n"</span>, nfifo,
           nfifo*100.0/ntot);
    printf(<span style="color: #deb887;">"symbolic links = %7ld, %5.2f %%\n"</span>, nslink,
           nslink*100.0/ntot);
    printf(<span style="color: #deb887;">"sockets        = %7ld, %5.2f %%\n"</span>, nsock,
           nsock*100.0/ntot);

    exit(ret);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org488cb2f" class="outline-3">
<h3 id="org488cb2f">chdir，fchdir函数</h3>
<div class="outline-text-3" id="text-org488cb2f">
<ul class="org-ul">
<li>当前工作目录：每个进程都有一个目录， <b>搜索所有相对路径名的起点</b> ，这是 <b>进程</b> 的一个属性
<ul class="org-ul">
<li><p>
起始目录：当用户登录到UNIX系统时，其 <span class="underline">当前工作目录</span> 通常是口令文件 (/etc/passwd)中该 <span class="underline">用户登录项</span> 的 <span class="underline">第6个字段</span> 这，是 <b>登录名</b> 的一个属性 
</p>

<p>
chdir函数组：更改当前进程的工作目录
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;unistd.h&gt;</span>

<span style="color: #ffebcd;">/**</span>
<span style="color: #ffebcd;"> * &#26681;&#25454;&#30446;&#24405;&#36335;&#24452;&#21517;&#26356;&#25913;&#24403;&#21069;&#24037;&#20316;&#30446;&#24405;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * pathname: &#26356;&#25913;&#21518;&#30340;&#24403;&#21069;&#24037;&#20316;&#30446;&#24405;&#36335;&#24452;&#21517;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * return: &#33509;&#25104;&#21151;&#36820;&#22238; 0&#65292;&#33509;&#20986;&#38169;&#36820;&#22238; -1</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> */</span>
<span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">chdir</span>(<span style="color: #00bfff; font-weight: bold;">const</span> <span style="color: #98f5ff;">char</span> *<span style="color: #4eee94;">pathname</span>);

<span style="color: #ffebcd;">/**</span>
<span style="color: #ffebcd;"> * &#26681;&#25454;&#25991;&#20214;&#25551;&#36848;&#31526;&#26356;&#25913;&#24403;&#21069;&#24037;&#20316;&#30446;&#24405;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * pathname: &#26032;&#30340;&#24403;&#21069;&#24037;&#20316;&#30446;&#24405;&#30340;&#25991;&#20214;&#25551;&#36848;&#31526;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * return: &#33509;&#25104;&#21151;&#36820;&#22238; 0&#65292;&#33509;&#20986;&#38169;&#36820;&#22238; -1</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> */</span>
<span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">fchdir</span>(<span style="color: #98f5ff;">int</span> <span style="color: #4eee94;">filedes</span>);
</pre>
</div></li>
</ul></li>
</ul>
</div>

<div id="outline-container-orga6f73e2" class="outline-4">
<h4 id="orga6f73e2">chdir实例</h4>
<div class="outline-text-4" id="text-orga6f73e2">
<div class="org-src-container">
<pre class="src src-C"><span style="color: #ffd700;">#include</span> <span style="color: #deb887;">"apue.h"</span>

<span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">main</span>(<span style="color: #98f5ff;">void</span>)
{
    <span style="color: #00bfff; font-weight: bold;">if</span> (chdir(<span style="color: #deb887;">"/tmp"</span>) &lt; 0)
        err_sys(<span style="color: #deb887;">"chdir failed"</span>);
    printf(<span style="color: #deb887;">"chdir to /tmp succeeded\n"</span>);
    exit(0);
}
</pre>
</div>

<p>
测试代码：
</p>
<div class="org-src-container">
<pre class="src src-sh">$ pwd
/home/klose/Documents/programming/c/apue

$ ./src/file_directory/chdirExample
chdir to /tmp succeeded

$ pwd
/home/klose/Documents/programming/c/apue
</pre>
</div>

<pre class="example">
      执行chdirExample程序的shell的当前工作目录并没有改变

      这是因为当前工作目录是一个进程的属性，所以它只影响调用chdirExample进程本身，而不影响其他进程

      因此cd命令的执行程序必须直接包含在shell程序中！ 
</pre>
</div>
</div>
</div>

<div id="outline-container-org1949041" class="outline-3">
<h3 id="org1949041">getpwd函数</h3>
<div class="outline-text-3" id="text-org1949041">
<p>
内核保持有当前工作目录的信息，所以可以取其当前值
</p>

<pre class="example">
     不幸的是，内核为每个进程只保存其当前工作目录的i节点编号以及设备标识，但并不保存该目录的完整路径名
</pre>

<p>
getpwd函数：获取当前工作目录的绝对路径名
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;unistd.h&gt;</span>

<span style="color: #ffebcd;">/**</span>
<span style="color: #ffebcd;"> * &#25226;&#24403;&#21069;&#24037;&#20316;&#30446;&#24405;&#32477;&#23545;&#36335;&#24452;&#21517;+null&#23383;&#31526;&#25918;&#32622;&#21040;buf&#20013;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * buf: &#25918;&#32622;&#24403;&#21069;&#24037;&#20316;&#30446;&#24405;&#32477;&#23545;&#36335;&#24452;&#21517;&#30340;&#32531;&#23384;</span>
<span style="color: #ffebcd;"> * size: buf&#32531;&#23384;&#22823;&#23567;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * return: &#33509;&#25104;&#21151;&#20026;buf&#65292;&#33509;&#20986;&#38169;&#20026; NULL</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> */</span>
<span style="color: #98f5ff;">char</span> *<span style="color: #daa520; font-weight: bold;">getcwd</span>(<span style="color: #98f5ff;">char</span> *<span style="color: #4eee94;">buf</span>, <span style="color: #98f5ff;">size_t</span> <span style="color: #4eee94;">size</span>);
</pre>
</div>
<p>
getpwd从当前工作目录开始，找到其上一级的目录，然后读其目录项，直到该目录项中的i节点编号数与工作目录i节点编号数相同，这样地就找到了其对应的文件。按照这种方法，逐层上移，直到遇到根，由此获得当前工作目录的绝对路径名
</p>
</div>

<div id="outline-container-orge9adfd8" class="outline-4">
<h4 id="orge9adfd8">getpwd实例</h4>
<div class="outline-text-4" id="text-orge9adfd8">
<div class="org-src-container">
<pre class="src src-C"><span style="color: #ffd700;">#include</span> <span style="color: #deb887;">"apue.h"</span>

<span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">main</span>(<span style="color: #98f5ff;">void</span>)
{
    <span style="color: #98f5ff;">char</span>    *<span style="color: #4eee94;">ptr</span>;
    <span style="color: #98f5ff;">int</span>     <span style="color: #4eee94;">size</span>;

    <span style="color: #00bfff; font-weight: bold;">if</span> (chdir(<span style="color: #deb887;">"/home/klose/Applications/maven/"</span>) &lt; 0)
        err_sys(<span style="color: #deb887;">"chdir failed"</span>);

    ptr = path_alloc(&amp;size);    <span style="color: #5f9ea0; font-style: italic;">/* </span><span style="color: #5f9ea0; font-style: italic;">our own function </span><span style="color: #5f9ea0; font-style: italic;">*/</span>
    <span style="color: #00bfff; font-weight: bold;">if</span> (getcwd(ptr, size) == <span style="color: #ffd700;">NULL</span>)
        err_sys(<span style="color: #deb887;">"getcwd failed"</span>);

    printf(<span style="color: #deb887;">"cwd = %s\n"</span>, ptr);
    exit(0);
}
</pre>
</div>
<p>
测试代码：更改当前工作目录为某个连接目录，然后使用getpwd打印当前工作目录
</p>
<div class="org-src-container">
<pre class="src src-C">$ pwd
/home/klose/Documents/programming/c/apue

$ ./src/file_directory/getpwdExample 
cwd = /home/klose/Applications/apache-maven-3.3.9 
</pre>
</div>

<pre class="example">
      注意：chdir会跟随符号连接，而getpwd函数并不支持符号连接！
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgd1ac8f6" class="outline-2">
<h2 id="orgd1ac8f6">设备文件</h2>
<div class="outline-text-2" id="text-orgd1ac8f6">
<p>
stat结构中的 <b>st_dev</b> 和 <b>st_rdev</b> 这两个字段用来表示设备，规则如下:
</p>
<ul class="org-ul">
<li>每个文件系统都由其 <span class="underline">主</span> 、 <span class="underline">次</span> 设备号，设备号所用的数据类型是 <b>dev_t</b></li>
<li>使用两个宏 <span class="underline">major</span> 和 <span class="underline">minor</span> 来存取主、次设备号。这意味着无需关心这两个数是如何存放在dev_t对象中</li>
<li>系统中每个文件名的 <b>st_dev</b> 值是 <b>文件系统的设备号</b></li>
<li>只有 <span class="underline">字符设备</span> 文件和 <span class="underline">块设备</span> 文件才有 <b>st_rdev值</b> 是该 <b>实际硬件设备的设备号</b></li>
</ul>
</div>

<div id="outline-container-org364315f" class="outline-3">
<h3 id="org364315f">打印设备号</h3>
<div class="outline-text-3" id="text-org364315f">
<p>
打印普通文件的st_dev，硬盘设备和终端设备的st_rdev
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;sys/types.h&gt;</span>
<span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;sys/stat.h&gt;</span>
<span style="color: #ffd700;">#include</span> <span style="color: #deb887;">"apue.h"</span>

<span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">main</span>(<span style="color: #98f5ff;">int</span> <span style="color: #4eee94;">argc</span>, <span style="color: #98f5ff;">char</span> *<span style="color: #4eee94;">argv</span>[])
{
    <span style="color: #98f5ff;">int</span>         <span style="color: #4eee94;">i</span>;
    <span style="color: #00bfff; font-weight: bold;">struct</span> <span style="color: #98f5ff;">stat</span> <span style="color: #4eee94;">buf</span>;

    <span style="color: #00bfff; font-weight: bold;">for</span> (i = 1; i &lt; argc; i++) {
        printf(<span style="color: #deb887;">"%s: "</span>, argv[i]);
        <span style="color: #00bfff; font-weight: bold;">if</span> (stat(argv[i], &amp;buf) &lt; 0) {
            err_ret(<span style="color: #deb887;">"stat error"</span>);
            <span style="color: #00bfff; font-weight: bold;">continue</span>;
        }

        printf(<span style="color: #deb887;">"dev = %d/%d"</span>, major(buf.st_dev),  minor(buf.st_dev));

        <span style="color: #00bfff; font-weight: bold;">if</span> (S_ISCHR(buf.st_mode) || S_ISBLK(buf.st_mode)) {
            printf(<span style="color: #deb887;">" (%s) rdev = %d/%d"</span>,
                   (S_ISCHR(buf.st_mode)) ? <span style="color: #deb887;">"character"</span> : <span style="color: #deb887;">"block"</span>,
                   major(buf.st_rdev), minor(buf.st_rdev));
        }
        printf(<span style="color: #deb887;">"\n"</span>);
    }

    exit(0);
}
</pre>
</div>

<p>
测试代码
</p>
<div class="org-src-container">
<pre class="src src-sh">$ ./src/file_directory/printDev /home/klose/
/home/klose/: dev = 8/6

$ ./src/file_directory/printDev /dev/sda
/dev/sda: dev = 0/6 (block) rdev = 8/0

$ ./src/file_directory/printDev /dev/sda2 
/dev/sda2: dev = 0/6 (block) rdev = 8/2

 $ ./src/file_directory/printDev /dev/tty
/dev/tty: dev = 0/6 (character) rdev = 5/0

$ ./src/file_directory/printDev /dev/tty2
/dev/tty2: dev = 0/6 (character) rdev = 4/2

./src/file_directory/printDev /dev/pts/2
/dev/pts/2: dev = 0/12 (character) rdev = 136/2
</pre>
</div>
<pre class="example">
     由此可见 st_dev对与任何文件而言都是文件系统的设备主次号

     对于磁盘和终端等设备文件而言st_rdev包含真正设备主次号
</pre>
</div>
</div>

<div id="outline-container-org28ef86b" class="outline-3">
<h3 id="org28ef86b">sync，fsync函数</h3>
<div class="outline-text-3" id="text-org28ef86b">
<p>
<b>延迟写</b> ：UNIX实现在内核中设有 <span class="underline">高速缓冲区</span> ，大多数磁盘I/O都通过缓存进行。当将数据写到文件上时，通常该数据先由 <span class="underline">内核</span> 复制到 <span class="underline">高速缓存</span> 中，如果该 <span class="underline">高速缓存尚未写满</span> 则并 <b>不将其排入输出队列</b> ，而是 <span class="underline">等待其写满</span> 或者 <span class="underline">当内核需要重用该缓存</span> 以便存放其他磁盘块数据时，再将该缓存排入输出队列，然后 <span class="underline">待其到达队首</span> 时才进行 <b>实际的I/O操作</b> 
</p>

<pre class="example">
     延迟写减少了磁盘读写次数，但是却降低了文件内容的更新速度，使得欲写到文件中的数据在一段时间内并没有写到磁盘上

     当系统发生故障时，这种延迟可能造成文件更新内容的丢失
</pre>

<p>
为了保证 <span class="underline">磁盘上实际文件系统</span> 与 <span class="underline">缓存中内容</span> 的 <b>一致性</b> ，UNIX系统提供了sync和fsync两个系统调用函数
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #ffd700;">#include</span> <span style="color: #deb887;">&lt;unistd.h&gt;</span>

<span style="color: #ffebcd;">/**</span>
<span style="color: #ffebcd;"> * &#26356;&#26032;&#20869;&#26680;&#32531;&#20914;&#21306;&#20869;&#23481;&#21040;&#30913;&#30424;&#19978;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * return: &#33509;&#25104;&#21151;&#21017;&#20026; 0&#65292;&#33509;&#20986;&#38169;&#21017;&#20026; -1</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> */</span>
<span style="color: #98f5ff;">void</span> <span style="color: #daa520; font-weight: bold;">sync</span>(<span style="color: #98f5ff;">void</span>);

<span style="color: #ffebcd;">/**</span>
<span style="color: #ffebcd;"> * &#30452;&#25509;&#26356;&#26032;&#29305;&#23450;&#25991;&#20214;&#25551;&#36848;&#31526;&#25351;&#21521;&#30340;&#25991;&#20214;&#30340;&#30913;&#30424;&#19978;&#30340;&#20869;&#23481;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * filedes: &#25991;&#20214;&#25551;&#36848;&#31526;</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> * return: &#33509;&#25104;&#21151;&#21017;&#20026; 0&#65292;&#33509;&#20986;&#38169;&#21017;&#20026; -1</span>
<span style="color: #ffebcd;"> *</span>
<span style="color: #ffebcd;"> */</span>
<span style="color: #98f5ff;">int</span> <span style="color: #daa520; font-weight: bold;">fsync</span>(<span style="color: #98f5ff;">int</span> <span style="color: #4eee94;">filedes</span>);
</pre>
</div>
<pre class="example">
fsync是执行完毕后确保文件在磁盘上的内容是最新的(比较适合实现数据库commit操作)

而如果使用O_SYNC选项打开文件，那每次write操作都会直接更新文件磁盘上的内容
</pre>

<p>
<a href="stdio.html">Next：标准I/O</a>
</p>

<p>
<a href="file_io.html">Previous：文件I/O</a>
</p>

<p>
<a href="apue.html">Home：目录</a>
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

		  <br/>
		  <div class='ds-thread'></div>
		  <script>
		  var duoshuoQuery = {short_name:'klose911'};
		  (function() {
					  var dsThread = document.getElementsByClassName('ds-thread')[0];
					  dsThread.setAttribute('data-thread-key', document.title);
					  dsThread.setAttribute('data-title', document.title);
					  dsThread.setAttribute('data-url', window.location.href);
					  var ds = document.createElement('script');
					  ds.type = 'text/javascript';ds.async = true;
					  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
					  ds.charset = 'UTF-8';
					  (document.getElementsByTagName('head')[0] 
						|| document.getElementsByTagName('body')[0]).appendChild(ds);
					  })();
		  </script>
		  <script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
		  ga('create', 'UA-90850421-1', 'auto');
		  ga('send', 'pageview');
		  </script>
</div>
</body>
</html>
