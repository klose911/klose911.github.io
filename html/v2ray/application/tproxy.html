<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>透明代理</title>
<meta name="author" content="Wu, Shanliang" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="../css/main.css" />
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href=""> UP </a>
 |
 <a accesskey="H" href="application.html"> HOME </a>
</div><div id="content" class="content">
<h1 class="title">透明代理</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org088e398">优点</a></li>
<li><a href="#org5f50695">准备</a></li>
<li><a href="#orgb3207b0">设置</a></li>
<li><a href="#orgc43d737">注意</a></li>
<li><a href="#orgc102ba8">TProxy</a>
<ul>
<li><a href="#org24d4426">网关</a></li>
<li><a href="#org9612796">安装V2ray</a></li>
<li><a href="#org0c55854">配置透明代理</a>
<ul>
<li><a href="#org4aafb24">为 V2Ray 配置透明代理的入站和 DNS 分流</a></li>
</ul>
</li>
<li><a href="#org552ac4d">配置透明代理规则</a>
<ul>
<li><a href="#org2b04ca1">iptables</a></li>
<li><a href="#orgaa90987">nftables</a></li>
</ul>
</li>
<li><a href="#org98bed64">开机自动运行透明代理规则</a></li>
<li><a href="#org3a5d2f0">其他</a>
<ul>
<li><a href="#orge1cf5af">解决 too many open files 问题</a></li>
<li><a href="#org0602948">备注</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<pre class="example" id="orgd6adc69">
在这儿指使用 V2Ray 做透明代理实现路由器翻墙

使用网关翻墙可以使局域网内的所有设备都具有直接翻墙的能力，并且能够全局代理，而不必每台设备都安装 V2Ray，配置更新时只需在网关修改配置
</pre>

<p>
透明代理适用于以下情况：
</p>
<ul class="org-ul">
<li>局域网设备较多，比如说办公室、实验室、大家庭等</li>
<li>设备(的软件)无法/不方便设置代理，比如说 Chromecast、电视盒子等</li>
<li>希望设备的所有软件都走代理</li>
</ul>
<div id="outline-container-org088e398" class="outline-2">
<h2 id="org088e398">优点</h2>
<div class="outline-text-2" id="text-org088e398">
<p>
就目前来说，使用 V2Ray 透明代理：
</p>
<ul class="org-ul">
<li>解决了墙外 DNS 污染问题</li>
<li>在解决了 1 的情况下国内域名的即能够解析到国内 CDN</li>
<li>不需要外部软件或自建 DNS 就可决绝 1 和 2 的问题，只要系统支持 V2Ray 和 iptables</li>
<li>能够完美利用 V2Ray 强大而灵活的路由功能，而不必额外维护一个路由表</li>
</ul>
</div>
</div>
<div id="outline-container-org5f50695" class="outline-2">
<h2 id="org5f50695">准备</h2>
<div class="outline-text-2" id="text-org5f50695">
<ul class="org-ul">
<li><p>
一台已经搭建 V2Ray 并能正常使用的 VPS
</p>
<pre class="example" id="orgd57f3bf">
本文假设 IP 为 110.231.43.65
</pre></li>
<li><p>
一台带 iptables、有 root 权限并且系统为 Linux 的设备
</p>
<pre class="example" id="org81d717d">
假设地址为 192.168.1.22，已经配置好 V2Ray 作为客户端

这个设备可以是路由器、开发板、个人电脑、虚拟机和 Android 设备等，更具普适性地称之为网关

要是真不愿意出这点钱，用电脑开个虚拟机吧，VirtualBox、Hyper 之类的都可以，但是别忘了网络模式用网桥
</pre></li>
</ul>
</div>
</div>
<div id="outline-container-orgb3207b0" class="outline-2">
<h2 id="orgb3207b0">设置</h2>
<div class="outline-text-2" id="text-orgb3207b0">
<ol class="org-ol">
<li><p>
网关设备开启 <b>IP 转发</b> 。在 <span class="underline">/etc/sysctl.conf</span> 文件添加一行 <span class="underline">net.ipv4.ip_forward=1</span> ，执行下列命令生效：
</p>
<div class="org-src-container">
<pre class="src src-sh">sysctl -p
</pre>
</div></li>
<li><p>
网关设备设置静态 IP，与路由器 LAN 口同一个网段，默认网关为路由器的 IP；进入路由器的管理后台，到 DHCP 设定将默认网关地址为网关设备的 IP
</p>
<pre class="example" id="orgee31044">
电脑手机等设备单独设置默认网关，然后电脑/手机重新连接到路由器测试是不是可以正常上网(这时还不能翻墙)，如果不能上网先去学习一个把这个搞定，否则接下来再怎么也同样上不了网

网关设备设定静态 IP 是为了避免重启后 IP 会发生变化导致其他设备无法联网

路由器设定 DHCP 默认网关地址是为了让接入到这个路由器的设备将上网的数据包发到网关设备，然后由网关设备转发
</pre></li>
<li><p>
在服务器和网关安装最新版本的 V2Ray
</p>
<pre class="example" id="org6b7c0ed">
一定要确定搭建的 V2Ray 能够正常使用

在网关执行 curl -x socks5://127.0.0.1:1080 google.com 测试配置的 V2Ray 是否可以翻墙(命令中 socks5 指 inbound 协议为 socks，1080 指该 inbound 端口是 1080)
</pre></li>
<li><p>
在网关的配置，添加 <span class="underline">dokodemo door</span> 协议的 <b>入站</b> 配置 ，并 <b>开启</b> <span class="underline">sniffing</span> 还要在所有 outbound 的 <span class="underline">streamSettins</span> 添加 <span class="underline">SO_MARK</span> ：
</p>
<div class="org-src-container">
<pre class="src src-js">{
    <span style="color: #ffa07a;">"routing"</span>: {...},
    <span style="color: #ffa07a;">"inbounds"</span>: [
        {
            ...
        },
        {
            <span style="color: #ffa07a;">"port"</span>: 12345, <span style="color: #ff4500;">//</span><span style="color: #ff4500;">&#24320;&#25918;&#30340;&#31471;&#21475;&#21495;</span>
            <span style="color: #ffa07a;">"protocol"</span>: <span style="color: #ffa07a;">"dokodemo-door"</span>,
            <span style="color: #ffa07a;">"settings"</span>: {
                <span style="color: #ffa07a;">"network"</span>: <span style="color: #ffa07a;">"tcp,udp"</span>,
                <span style="color: #ffa07a;">"followRedirect"</span>: <span style="color: #7fffd4;">true</span> <span style="color: #ff4500;">// </span><span style="color: #ff4500;">&#36825;&#37324;&#35201;&#20026; true &#25165;&#33021;&#25509;&#21463;&#26469;&#33258; iptables &#30340;&#27969;&#37327;</span>
            },
            <span style="color: #ffa07a;">"sniffing"</span>: {
                <span style="color: #ffa07a;">"enabled"</span>: <span style="color: #7fffd4;">true</span>,
                <span style="color: #ffa07a;">"destOverride"</span>: [<span style="color: #ffa07a;">"http"</span>, <span style="color: #ffa07a;">"tls"</span>]
            }
        }
    ],
    <span style="color: #ffa07a;">"outbounds"</span>: [
        {
            ...
                <span style="color: #ffa07a;">"streamSettings"</span>: {
                    ...
                        <span style="color: #ffa07a;">"sockopt"</span>: {
                            <span style="color: #ffa07a;">"mark"</span>: 255  <span style="color: #ff4500;">//</span><span style="color: #ff4500;">&#36825;&#37324;&#26159; SO_MARK&#65292;&#29992;&#20110; iptables &#35782;&#21035;&#65292;&#27599;&#20010; outbound &#37117;&#35201;&#37197;&#32622;&#65307;255&#21487;&#20197;&#25913;&#25104;&#20854;&#20182;&#25968;&#20540;&#65292;&#20294;&#35201;&#19982;&#19979;&#38754;&#30340; iptables &#35268;&#21017;&#23545;&#24212;&#65307;&#22914;&#26524;&#26377;&#22810;&#20010; outbound&#65292;&#26368;&#22909;&#23558;&#25152;&#26377; outbound &#30340; SO_MARK &#37117;&#35774;&#32622;&#25104;&#19968;&#26679;&#30340;&#25968;&#20540;</span>
                        }
                }
        }
        ...
    ]
}
</pre>
</div></li>
<li><p>
设定 TCP 透明代理的 iptables 规则，命令如下：
</p>
<div class="org-src-container">
<pre class="src src-sh">iptables -t nat -N V2RAY <span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#26032;&#24314;&#19968;&#20010;&#21517;&#20026; V2RAY &#30340;&#38142;</span>
iptables -t nat -A V2RAY -d 192.168.0.0/16 -j RETURN <span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#30452;&#36830; 192.168.0.0/16 </span>
iptables -t nat -A V2RAY -p tcp -j RETURN -m mark --mark 0xff <span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#30452;&#36830; SO_MARK &#20026; 0xff &#30340;&#27969;&#37327;(0xff &#26159; 16 &#36827;&#21046;&#25968;&#65292;&#25968;&#20540;&#19978;&#31561;&#21516;&#19982;&#19978;&#38754;&#37197;&#32622;&#30340; 255)&#65292;&#27492;&#35268;&#21017;&#30446;&#30340;&#26159;&#36991;&#20813;&#20195;&#29702;&#26412;&#26426;(&#32593;&#20851;)&#27969;&#37327;&#20986;&#29616;&#22238;&#29615;&#38382;&#39064;</span>
iptables -t nat -A V2RAY -p tcp -j REDIRECT --to-ports 12345 <span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#20854;&#20313;&#27969;&#37327;&#36716;&#21457;&#21040; 12345 &#31471;&#21475;&#65288;&#21363; V2Ray&#65289;</span>
iptables -t nat -A PREROUTING -p tcp -j V2RAY <span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#23545;&#23616;&#22495;&#32593;&#20854;&#20182;&#35774;&#22791;&#36827;&#34892;&#36879;&#26126;&#20195;&#29702;</span>
iptables -t nat -A OUTPUT -p tcp -j V2RAY <span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#23545;&#26412;&#26426;&#36827;&#34892;&#36879;&#26126;&#20195;&#29702;</span>

<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#35774;&#23450; UDP &#27969;&#37327;&#36879;&#26126;&#20195;&#29702;&#30340; iptables &#35268;&#21017;</span>
ip rule add fwmark 1 table 100
ip route add local 0.0.0.0/0 dev lo table 100
iptables -t mangle -N V2RAY_MASK
iptables -t mangle -A V2RAY_MASK -d 192.168.0.0/16 -j RETURN
iptables -t mangle -A V2RAY_MASK -p udp -j TPROXY --on-port 12345 --tproxy-mark 1
iptables -t mangle -A PREROUTING -p udp -j V2RAY_MASK
</pre>
</div></li>
<li>使用电脑/手机尝试直接访问被墙网站</li>
<li><p>
写开机自动加载上述的 iptables 的脚本
</p>
<pre class="example" id="org64e3325">
或者使用第三方软件(如 iptables-persistent)，否则网关重启后 iptables 会失效(即透明代理会失效)
</pre></li>
</ol>
</div>
</div>
<div id="outline-container-orgc43d737" class="outline-2">
<h2 id="orgc43d737">注意</h2>
<div class="outline-text-2" id="text-orgc43d737">
<ul class="org-ul">
<li><p>
在上面的设置中，假设访问了国外网站，如 Google 等，网关依然会使用的系统 DNS 进行查询，只不过返回的结果是污染过的
</p>
<pre class="example" id="orga499f83">
而 V2Ray 提供的 sniffing 能够从流量中提取域名信息交由 VPS 解析

也就是说，每次打算访问被墙的网站，DNS 提供商都知道，鉴于国内企业尿性，也许 GFW 也都知道，会不会将这些数据收集喂 AI 也未可知
</pre></li>
<li>sniffing 目前只能从 TLS 和 HTTP 流量中提取域名，如果上网流量有非这两种类型的慎用 sniffing 解决 DNS 污染</li>
<li>由于对 iptables 不熟，总感觉上面对 UDP 流量的透明代理的设置使用上有点问题</li>
<li>喜欢玩网游的朋友可能要失望了，使用 V2Ray 加速游戏效果不是很好</li>
<li>V2Ray 只能代理 TCP/UDP 的流量，ICMP 不支持，即就算透明代理成功了之后 ping Google 这类网站也是不通的</li>
<li>按照网上其他的透明代理教程，设置 iptables 肯定要 RETURN 127.0.0.0/8 这类私有地址，但我个人观点是放到 V2Ray 的路由里好一些</li>
</ul>
</div>
</div>

<div id="outline-container-orgc102ba8" class="outline-2">
<h2 id="orgc102ba8">TProxy</h2>
<div class="outline-text-2" id="text-orgc102ba8">
<p>
随着 V2Ray 的更新，V2Ray 推出了新的透明代理方式 <b>TPROXY</b> ，原来的叫 <span class="underline">REDIRECT</span> 。最近测试了一下 TPROXY ，效果还不错，主观感觉比 REDIRECT 好。并且在本文的透明代理中，DNS 服务将由 V2Ray 提供
</p>
<pre class="example" id="org762ded9">
不过这种方式需要 iptables 的 TPROXY 模块支持，有一些阉割版的系统会精简掉 TPROXY 模块
</pre>
</div>

<div id="outline-container-org24d4426" class="outline-3">
<h3 id="org24d4426">网关</h3>
<div class="outline-text-3" id="text-org24d4426">
<ol class="org-ol">
<li><p>
用网线将树莓派接入路由器 LAN 口
</p>
<pre class="example" id="orgd7ea1c9">
假设分给树莓派的 IP 是 192.168.1.22
</pre></li>
<li><p>
树莓派开启 IP 转发（需要开启 IP 转发才能作为网关）
</p>
<div class="org-src-container">
<pre class="src src-sh">$ echo net.ipv4.ip_forward=1 &gt;&gt; /etc/sysctl.conf &amp;&amp; sysctl -p

net.ipv4.ip_forward=1
</pre>
</div></li>
<li><p>
手动配置 PC 的网络，将默认网关指向树莓派的地址
</p>
<pre class="example" id="orgb5dc725">
即 192.168.1.22

此时 PC 应当能正常上网（由于还没设置代理，“正常”是指可以上国内的网站）
</pre></li>
</ol>
</div>
</div>

<div id="outline-container-org9612796" class="outline-3">
<h3 id="org9612796">安装V2ray</h3>
<div class="outline-text-3" id="text-org9612796">
<p>
略
</p>
</div>
</div>

<div id="outline-container-org0c55854" class="outline-3">
<h3 id="org0c55854">配置透明代理</h3>
<div class="outline-text-3" id="text-org0c55854">
</div>
<div id="outline-container-org4aafb24" class="outline-4">
<h4 id="org4aafb24">为 V2Ray 配置透明代理的入站和 DNS 分流</h4>
<div class="outline-text-4" id="text-org4aafb24">
<p>
以下是 V2Ray 透明代理的配置示例
</p>
<div class="org-src-container">
<pre class="src src-js">{
    <span style="color: #ffa07a;">"inbounds"</span>: [
        {
            <span style="color: #ffa07a;">"tag"</span>:<span style="color: #ffa07a;">"transparent"</span>,
            <span style="color: #ffa07a;">"port"</span>: 12345,
            <span style="color: #ffa07a;">"protocol"</span>: <span style="color: #ffa07a;">"dokodemo-door"</span>,
            <span style="color: #ffa07a;">"settings"</span>: {
                <span style="color: #ffa07a;">"network"</span>: <span style="color: #ffa07a;">"tcp,udp"</span>,
                <span style="color: #ffa07a;">"followRedirect"</span>: <span style="color: #7fffd4;">true</span>
            },
            <span style="color: #ffa07a;">"sniffing"</span>: {
                <span style="color: #ffa07a;">"enabled"</span>: <span style="color: #7fffd4;">true</span>,
                <span style="color: #ffa07a;">"destOverride"</span>: [
                    <span style="color: #ffa07a;">"http"</span>,
                    <span style="color: #ffa07a;">"tls"</span>
                ]
            },
            <span style="color: #ffa07a;">"streamSettings"</span>: {
                <span style="color: #ffa07a;">"sockopt"</span>: {
                    <span style="color: #ffa07a;">"tproxy"</span>: <span style="color: #ffa07a;">"tproxy"</span>, <span style="color: #ff4500;">// </span><span style="color: #ff4500;">&#36879;&#26126;&#20195;&#29702;&#20351;&#29992; TPROXY &#26041;&#24335;</span>
                    <span style="color: #ffa07a;">"mark"</span>:255
                }
            }
        },
        {
            <span style="color: #ffa07a;">"port"</span>: 1080, 
            <span style="color: #ffa07a;">"protocol"</span>: <span style="color: #ffa07a;">"socks"</span>, <span style="color: #ff4500;">// </span><span style="color: #ff4500;">&#20837;&#21475;&#21327;&#35758;&#20026; SOCKS 5</span>
            <span style="color: #ffa07a;">"sniffing"</span>: {
                <span style="color: #ffa07a;">"enabled"</span>: <span style="color: #7fffd4;">true</span>,
                <span style="color: #ffa07a;">"destOverride"</span>: [<span style="color: #ffa07a;">"http"</span>, <span style="color: #ffa07a;">"tls"</span>]
            },
            <span style="color: #ffa07a;">"settings"</span>: {
                <span style="color: #ffa07a;">"auth"</span>: <span style="color: #ffa07a;">"noauth"</span>
            }
        }
    ],
    <span style="color: #ffa07a;">"outbounds"</span>: [
        {
            <span style="color: #ffa07a;">"tag"</span>: <span style="color: #ffa07a;">"proxy"</span>,
            <span style="color: #ffa07a;">"protocol"</span>: <span style="color: #ffa07a;">"vmess"</span>, <span style="color: #ff4500;">// </span><span style="color: #ff4500;">&#20195;&#29702;&#26381;&#21153;&#22120;</span>
            <span style="color: #ffa07a;">"settings"</span>: {
                <span style="color: #ffa07a;">"vnext"</span>: [
                    ...
                ]
            },
            <span style="color: #ffa07a;">"streamSettings"</span>: {
                <span style="color: #ffa07a;">"sockopt"</span>: {
                    <span style="color: #ffa07a;">"mark"</span>: 255
                }
            },
            <span style="color: #ffa07a;">"mux"</span>: {
                <span style="color: #ffa07a;">"enabled"</span>: <span style="color: #7fffd4;">true</span>
            }
        },
        {
            <span style="color: #ffa07a;">"tag"</span>: <span style="color: #ffa07a;">"direct"</span>,
            <span style="color: #ffa07a;">"protocol"</span>: <span style="color: #ffa07a;">"freedom"</span>,
            <span style="color: #ffa07a;">"settings"</span>: {
                <span style="color: #ffa07a;">"domainStrategy"</span>: <span style="color: #ffa07a;">"UseIP"</span>
            },
            <span style="color: #ffa07a;">"streamSettings"</span>: {
                <span style="color: #ffa07a;">"sockopt"</span>: {
                    <span style="color: #ffa07a;">"mark"</span>: 255
                }
            }      
        },
        {
            <span style="color: #ffa07a;">"tag"</span>: <span style="color: #ffa07a;">"block"</span>,
            <span style="color: #ffa07a;">"protocol"</span>: <span style="color: #ffa07a;">"blackhole"</span>,
            <span style="color: #ffa07a;">"settings"</span>: {
                <span style="color: #ffa07a;">"response"</span>: {
                    <span style="color: #ffa07a;">"type"</span>: <span style="color: #ffa07a;">"http"</span>
                }
            }
        },
        {
            <span style="color: #ffa07a;">"tag"</span>: <span style="color: #ffa07a;">"dns-out"</span>,
            <span style="color: #ffa07a;">"protocol"</span>: <span style="color: #ffa07a;">"dns"</span>,
            <span style="color: #ffa07a;">"streamSettings"</span>: {
                <span style="color: #ffa07a;">"sockopt"</span>: {
                    <span style="color: #ffa07a;">"mark"</span>: 255
                }
            }  
        }
    ],
    <span style="color: #ffa07a;">"dns"</span>: {
        <span style="color: #ffa07a;">"servers"</span>: [
            {
                <span style="color: #ffa07a;">"address"</span>: <span style="color: #ffa07a;">"223.5.5.5"</span>, <span style="color: #ff4500;">//</span><span style="color: #ff4500;">&#20013;&#22269;&#22823;&#38470;&#22495;&#21517;&#20351;&#29992;&#38463;&#37324;&#30340; DNS</span>
                <span style="color: #ffa07a;">"port"</span>: 53,
                <span style="color: #ffa07a;">"domains"</span>: [
                    <span style="color: #ffa07a;">"geosite:cn"</span>,
                    <span style="color: #ffa07a;">"ntp.org"</span>,   <span style="color: #ff4500;">// </span><span style="color: #ff4500;">NTP &#26381;&#21153;&#22120;</span>
                    <span style="color: #ffa07a;">"$myserver.address"</span> <span style="color: #ff4500;">// </span><span style="color: #ff4500;">&#27492;&#22788;&#25913;&#20026;&#20320; VPS &#30340;&#22495;&#21517;</span>
                ]
            },
            {
                <span style="color: #ffa07a;">"address"</span>: <span style="color: #ffa07a;">"114.114.114.114"</span>, <span style="color: #ff4500;">//</span><span style="color: #ff4500;">&#20013;&#22269;&#22823;&#38470;&#22495;&#21517;&#20351;&#29992; 114 &#30340; DNS (&#22791;&#29992;)</span>
                <span style="color: #ffa07a;">"port"</span>: 53,
                <span style="color: #ffa07a;">"domains"</span>: [
                    <span style="color: #ffa07a;">"geosite:cn"</span>,
                    <span style="color: #ffa07a;">"ntp.org"</span>,   <span style="color: #ff4500;">// </span><span style="color: #ff4500;">NTP &#26381;&#21153;&#22120;</span>
                    <span style="color: #ffa07a;">"$myserver.address"</span> <span style="color: #ff4500;">// </span><span style="color: #ff4500;">&#27492;&#22788;&#25913;&#20026;&#20320; VPS &#30340;&#22495;&#21517;</span>
                ]
            },
            {
                <span style="color: #ffa07a;">"address"</span>: <span style="color: #ffa07a;">"8.8.8.8"</span>, <span style="color: #ff4500;">//</span><span style="color: #ff4500;">&#38750;&#20013;&#22269;&#22823;&#38470;&#22495;&#21517;&#20351;&#29992; Google &#30340; DNS</span>
                <span style="color: #ffa07a;">"port"</span>: 53,
                <span style="color: #ffa07a;">"domains"</span>: [
                    <span style="color: #ffa07a;">"geosite:geolocation-!cn"</span>
                ]
            },
            {
                <span style="color: #ffa07a;">"address"</span>: <span style="color: #ffa07a;">"1.1.1.1"</span>, <span style="color: #ff4500;">//</span><span style="color: #ff4500;">&#38750;&#20013;&#22269;&#22823;&#38470;&#22495;&#21517;&#20351;&#29992; Cloudflare &#30340; DNS</span>
                <span style="color: #ffa07a;">"port"</span>: 53,
                <span style="color: #ffa07a;">"domains"</span>: [
                    <span style="color: #ffa07a;">"geosite:geolocation-!cn"</span>
                ]
            }
        ]
    },
    <span style="color: #ffa07a;">"routing"</span>: {
        <span style="color: #ffa07a;">"domainStrategy"</span>: <span style="color: #ffa07a;">"IPOnDemand"</span>,
        <span style="color: #ffa07a;">"rules"</span>: [
            { <span style="color: #ff4500;">// </span><span style="color: #ff4500;">&#21163;&#25345; 53 &#31471;&#21475; UDP &#27969;&#37327;&#65292;&#20351;&#29992; V2Ray &#30340; DNS</span>
                <span style="color: #ffa07a;">"type"</span>: <span style="color: #ffa07a;">"field"</span>,
                <span style="color: #ffa07a;">"inboundTag"</span>: [
                    <span style="color: #ffa07a;">"transparent"</span>
                ],
                <span style="color: #ffa07a;">"port"</span>: 53,
                <span style="color: #ffa07a;">"network"</span>: <span style="color: #ffa07a;">"udp"</span>,
                <span style="color: #ffa07a;">"outboundTag"</span>: <span style="color: #ffa07a;">"dns-out"</span> 
            },    
            { <span style="color: #ff4500;">// </span><span style="color: #ff4500;">&#30452;&#36830; 123 &#31471;&#21475; UDP &#27969;&#37327;&#65288;NTP &#21327;&#35758;&#65289;</span>
                <span style="color: #ffa07a;">"type"</span>: <span style="color: #ffa07a;">"field"</span>,
                <span style="color: #ffa07a;">"inboundTag"</span>: [
                    <span style="color: #ffa07a;">"transparent"</span>
                ],
                <span style="color: #ffa07a;">"port"</span>: 123,
                <span style="color: #ffa07a;">"network"</span>: <span style="color: #ffa07a;">"udp"</span>,
                <span style="color: #ffa07a;">"outboundTag"</span>: <span style="color: #ffa07a;">"direct"</span> 
            },    
            {
                <span style="color: #ffa07a;">"type"</span>: <span style="color: #ffa07a;">"field"</span>, 
                <span style="color: #ffa07a;">"ip"</span>: [ 
                    <span style="color: #ff4500;">// </span><span style="color: #ff4500;">&#35774;&#32622; DNS &#37197;&#32622;&#20013;&#30340;&#22269;&#20869; DNS &#26381;&#21153;&#22120;&#22320;&#22336;&#30452;&#36830;&#65292;&#20197;&#36798;&#21040; DNS &#20998;&#27969;&#30446;&#30340;</span>
                    <span style="color: #ffa07a;">"223.5.5.5"</span>,
                    <span style="color: #ffa07a;">"114.114.114.114"</span>
                ],
                <span style="color: #ffa07a;">"outboundTag"</span>: <span style="color: #ffa07a;">"direct"</span>
            },
            {
                <span style="color: #ffa07a;">"type"</span>: <span style="color: #ffa07a;">"field"</span>,
                <span style="color: #ffa07a;">"ip"</span>: [ 
                    <span style="color: #ff4500;">// </span><span style="color: #ff4500;">&#35774;&#32622; DNS &#37197;&#32622;&#20013;&#30340;&#22269;&#22806; DNS &#26381;&#21153;&#22120;&#22320;&#22336;&#36208;&#20195;&#29702;&#65292;&#20197;&#36798;&#21040; DNS &#20998;&#27969;&#30446;&#30340;</span>
                    <span style="color: #ffa07a;">"8.8.8.8"</span>,
                    <span style="color: #ffa07a;">"1.1.1.1"</span>
                ],
                <span style="color: #ffa07a;">"outboundTag"</span>: <span style="color: #ffa07a;">"proxy"</span> <span style="color: #ff4500;">// </span><span style="color: #ff4500;">&#25913;&#20026;&#20320;&#33258;&#24049;&#20195;&#29702;&#30340;&#20986;&#31449; tag</span>
            },
            { <span style="color: #ff4500;">// </span><span style="color: #ff4500;">&#24191;&#21578;&#25318;&#25130;</span>
                <span style="color: #ffa07a;">"type"</span>: <span style="color: #ffa07a;">"field"</span>, 
                <span style="color: #ffa07a;">"domain"</span>: [
                    <span style="color: #ffa07a;">"geosite:category-ads-all"</span>
                ],
                <span style="color: #ffa07a;">"outboundTag"</span>: <span style="color: #ffa07a;">"block"</span>
            },
            { <span style="color: #ff4500;">// </span><span style="color: #ff4500;">BT &#27969;&#37327;&#30452;&#36830;</span>
                <span style="color: #ffa07a;">"type"</span>: <span style="color: #ffa07a;">"field"</span>,
                <span style="color: #ffa07a;">"protocol"</span>:[<span style="color: #ffa07a;">"bittorrent"</span>], 
                <span style="color: #ffa07a;">"outboundTag"</span>: <span style="color: #ffa07a;">"direct"</span>
            },
            { <span style="color: #ff4500;">// </span><span style="color: #ff4500;">&#30452;&#36830;&#20013;&#22269;&#22823;&#38470;&#20027;&#27969;&#32593;&#31449; ip &#21644; &#20445;&#30041; ip</span>
                <span style="color: #ffa07a;">"type"</span>: <span style="color: #ffa07a;">"field"</span>, 
                <span style="color: #ffa07a;">"ip"</span>: [
                    <span style="color: #ffa07a;">"geoip:private"</span>,
                    <span style="color: #ffa07a;">"geoip:cn"</span>
                ],
                <span style="color: #ffa07a;">"outboundTag"</span>: <span style="color: #ffa07a;">"direct"</span>
            },
            { <span style="color: #ff4500;">// </span><span style="color: #ff4500;">&#30452;&#36830;&#20013;&#22269;&#22823;&#38470;&#20027;&#27969;&#32593;&#31449;&#22495;&#21517;</span>
                <span style="color: #ffa07a;">"type"</span>: <span style="color: #ffa07a;">"field"</span>, 
                <span style="color: #ffa07a;">"domain"</span>: [
                    <span style="color: #ffa07a;">"geosite:cn"</span>
                ],
                <span style="color: #ffa07a;">"outboundTag"</span>: <span style="color: #ffa07a;">"direct"</span>
            }
        ]
    }
}
</pre>
</div>
<ul class="org-ul">
<li>dokodemo-door 是用来接收透明代理的入站协议，
<ul class="org-ul">
<li>followRedirect 须为 true</li>
<li>sockopt.tproxy 项须为 tproxy</li>
<li>建议开启 snifing，否则路由无法匹配域名</li>
</ul></li>
<li><p>
本节添加了 DNS 配置，用来对国内外域名进行 DNS 分流，需要 DNS 配置、DNS 入站、DNS 出站和路由四者配合
</p>
<pre class="example" id="org2f0cf60">
在本例中 DNS 入站直接使用透明代理入站，可参考DNS 及其应用 
</pre></li>
<li>在 DNS 配置中，依次配置了 Google、Cloudflare、114 和阿里的 DNS
<ul class="org-ul">
<li>由于在阿里的 DNS 中指定了 domain，所以匹配的域名会用阿里的 DNS 查询</li>
<li>其他的先查询 Google 的 DNS，如果查不到的话再依次查 Cloudflare 及 114 的。所以达到了国内外域名 DNS 分流，以及 DNS 备用</li>
<li>要注意把TP 服务器和你自己 VPS 域名也加入到直连的 DNS，否则会导致 V2Ray 无法与 VPS 正常连接；</li>
</ul></li>
<li>DNS 配置只是说明哪些域名查哪个 DNS，至于哪个 DNS 走代理哪个 DNS 直连要在 routing 里设置规则</li>
<li><p>
routing 也要设置 123 端口的 UDP 流量直连
</p>
<pre class="example" id="org631ebee">
不然的话要是时间误差超出允许范围(90s)，要使用 NTP 校准时间就要先连上代理，但是连代理又要确保时间准确

结果就是既连不上代理，也无法自动校准时间
</pre></li>
<li><p>
freedom 的出站设置 domainStrategy 为 UseIP
</p>
<pre class="example" id="orga713e97">
以避免直连时因为使用本机的 DNS 出现一些奇怪问题
</pre></li>
<li>要在 dokodemo inbound 和所有的 outbound 加一个 <span class="underline">255</span> 的 <b>mark</b> ，这个 mark 与下文 iptables 命令中 <span class="underline">iptables -t mangle -A V2RAY_MASK -j RETURN -m mark &#x2013;mark 0xff</span> 配合，以直连 V2Ray 发出的流量（blackhole 可以不配置 mark）</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org552ac4d" class="outline-3">
<h3 id="org552ac4d">配置透明代理规则</h3>
<div class="outline-text-3" id="text-org552ac4d">
<p>
此部分分为 iptables 和 nftables，两者作用相同，择其一即可
</p>
</div>

<div id="outline-container-org2b04ca1" class="outline-4">
<h4 id="org2b04ca1">iptables</h4>
<div class="outline-text-4" id="text-org2b04ca1">
<p>
执行下面的命令开启透明代理。由于使用了 TPROXY 方式的透明代理，所以 TCP 流量也是使用 mangle 表：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#35774;&#32622;&#31574;&#30053;&#36335;&#30001;</span>
ip rule add fwmark 1 table 100 
ip route add local 0.0.0.0/0 dev lo table 100

<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#20195;&#29702;&#23616;&#22495;&#32593;&#35774;&#22791;</span>
iptables -t mangle -N V2RAY
iptables -t mangle -A V2RAY -d 127.0.0.1/32 -j RETURN
iptables -t mangle -A V2RAY -d 224.0.0.0/4 -j RETURN 
iptables -t mangle -A V2RAY -d 255.255.255.255/32 -j RETURN 
iptables -t mangle -A V2RAY -d 192.168.0.0/16 -p tcp -j RETURN <span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#30452;&#36830;&#23616;&#22495;&#32593;&#65292;&#36991;&#20813; V2Ray &#26080;&#27861;&#21551;&#21160;&#26102;&#26080;&#27861;&#36830;&#32593;&#20851;&#30340; SSH&#65292;&#22914;&#26524;&#20320;&#37197;&#32622;&#30340;&#26159;&#20854;&#20182;&#32593;&#27573;&#65288;&#22914; 10.x.x.x &#31561;&#65289;&#65292;&#21017;&#20462;&#25913;&#25104;&#33258;&#24049;&#30340;</span>
iptables -t mangle -A V2RAY -d 192.168.0.0/16 -p udp ! --dport 53 -j RETURN <span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#30452;&#36830;&#23616;&#22495;&#32593;&#65292;53 &#31471;&#21475;&#38500;&#22806;&#65288;&#22240;&#20026;&#35201;&#20351;&#29992; V2Ray &#30340; DNS)</span>
iptables -t mangle -A V2RAY -j RETURN -m mark --mark 0xff    <span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#30452;&#36830; SO_MARK &#20026; 0xff &#30340;&#27969;&#37327;(0xff &#26159; 16 &#36827;&#21046;&#25968;&#65292;&#25968;&#20540;&#19978;&#31561;&#21516;&#19982;&#19978;&#38754;V2Ray &#37197;&#32622;&#30340; 255)&#65292;&#27492;&#35268;&#21017;&#30446;&#30340;&#26159;&#35299;&#20915;v2ray&#21344;&#29992;&#22823;&#37327;CPU&#65288;https://github.com/v2ray/v2ray-core/issues/2621&#65289;</span>
iptables -t mangle -A V2RAY -p udp -j TPROXY --on-ip 127.0.0.1 --on-port 12345 --tproxy-mark 1 <span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#32473; UDP &#25171;&#26631;&#35760; 1&#65292;&#36716;&#21457;&#33267; 12345 &#31471;&#21475;</span>
iptables -t mangle -A V2RAY -p tcp -j TPROXY --on-ip 127.0.0.1 --on-port 12345 --tproxy-mark 1 <span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#32473; TCP &#25171;&#26631;&#35760; 1&#65292;&#36716;&#21457;&#33267; 12345 &#31471;&#21475;</span>
iptables -t mangle -A PREROUTING -j V2RAY <span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#24212;&#29992;&#35268;&#21017;</span>

<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#20195;&#29702;&#32593;&#20851;&#26412;&#26426;</span>
iptables -t mangle -N V2RAY_MASK 
iptables -t mangle -A V2RAY_MASK -d 224.0.0.0/4 -j RETURN 
iptables -t mangle -A V2RAY_MASK -d 255.255.255.255/32 -j RETURN 
iptables -t mangle -A V2RAY_MASK -d 192.168.0.0/16 -p tcp -j RETURN <span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#30452;&#36830;&#23616;&#22495;&#32593;</span>
iptables -t mangle -A V2RAY_MASK -d 192.168.0.0/16 -p udp ! --dport 53 -j RETURN <span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#30452;&#36830;&#23616;&#22495;&#32593;&#65292;53 &#31471;&#21475;&#38500;&#22806;&#65288;&#22240;&#20026;&#35201;&#20351;&#29992; V2Ray &#30340; DNS&#65289;</span>
iptables -t mangle -A V2RAY_MASK -j RETURN -m mark --mark 0xff    <span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#30452;&#36830; SO_MARK &#20026; 0xff &#30340;&#27969;&#37327;(0xff &#26159; 16 &#36827;&#21046;&#25968;&#65292;&#25968;&#20540;&#19978;&#31561;&#21516;&#19982;&#19978;&#38754;V2Ray &#37197;&#32622;&#30340; 255)&#65292;&#27492;&#35268;&#21017;&#30446;&#30340;&#26159;&#36991;&#20813;&#20195;&#29702;&#26412;&#26426;(&#32593;&#20851;)&#27969;&#37327;&#20986;&#29616;&#22238;&#29615;&#38382;&#39064;</span>
iptables -t mangle -A V2RAY_MASK -p udp -j MARK --set-mark 1   <span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#32473; UDP &#25171;&#26631;&#35760;&#65292;&#37325;&#36335;&#30001;</span>
iptables -t mangle -A V2RAY_MASK -p tcp -j MARK --set-mark 1   <span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#32473; TCP &#25171;&#26631;&#35760;&#65292;&#37325;&#36335;&#30001;</span>
iptables -t mangle -A OUTPUT -j V2RAY_MASK <span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#24212;&#29992;&#35268;&#21017;</span>

<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#26032;&#24314; DIVERT &#35268;&#21017;&#65292;&#36991;&#20813;&#24050;&#26377;&#36830;&#25509;&#30340;&#21253;&#20108;&#27425;&#36890;&#36807; TPROXY&#65292;&#29702;&#35770;&#19978;&#26377;&#19968;&#23450;&#30340;&#24615;&#33021;&#25552;&#21319;</span>
iptables -t mangle -N DIVERT
iptables -t mangle -A DIVERT -j MARK --set-mark 1
iptables -t mangle -A DIVERT -j ACCEPT
iptables -t mangle -I PREROUTING -p tcp -m socket -j DIVERT
</pre>
</div>

<pre class="example" id="org1a5acfd">
执行了以上 ip 和 iptables 命令后，局域网同网段的设备以及网关本身就可以直接翻墙了
</pre>

<p>
在类 ss-redir 透明代理中，有两个观点非常深入人心：
</p>
<ol class="org-ol">
<li>UDP 只能 TPROXY</li>
<li>TPROXY 不能用于 OUTPUT 链</li>
</ol>

<p>
从这两个观点很容易得出一个推论：*无法在提供透明代理的本机(即本例中的网关)上对 UDP 透明代理* 。但实际上，在本例的配置中无论是 TCP 还是 UDP，都可以实现在本机上的透明代理，而且都是用 TPROXY。其实关键在于这三句命令：
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables -t mangle -A V2RAY_MASK -p udp -j MARK --set-mark 1
iptables -t mangle -A V2RAY_MASK -p tcp -j MARK --set-mark 1
iptables -t mangle -A OUTPUT -j V2RAY_MASK
</pre>
</div>

<p>
给 OUTPUT 链的 TCP 和 UDP 打个标记 1(OUTPUT 应用 V2RAY_MASK 链)。由于 Netfilter 的特性，在 OUTPUT 链打标记会使相应的包重路由到 PREROUTING 链上，在已经配置好了 PREROUTING 相关的透明代理的情况下，OUTPUT 链也可以透明代理了，也就是网关对自身的 UDP 流量透明代理自身
</p>

<pre class="example" id="org1a3c6e1">
因为这是 netfilter 本身的特性，Shadowsocks 应该也可以用同样的方法对本机的 UDP 透明代理
</pre>
</div>
</div>

<div id="outline-container-orgaa90987" class="outline-4">
<h4 id="orgaa90987">nftables</h4>
<div class="outline-text-4" id="text-orgaa90987">
<pre class="example" id="org73f1977">
nftables 与 iptables 同样基于 netfilter 框架，早在 2014 年就引入 Linux 内核中，旨在改进 iptables 的一些问题并且将之替换

目前有不少 Linux 发行版默认网络过滤以 nftables 替换了 iptables，但是直到 4.19 的 Linux 内核才有 nft_tproxy 模块，这个模块是透明代理所必须的

如果使用 nftables 配置透明代理，必须具备 nft_tproxy 和 nft_socket 模块，可通过命令 lsmod | grep nft 查看

尽管 nftables 是趋势，可以预见的是在相当长的时间里 iptables 仍将是主流

以下 nftables 规则仅在 Debian 11 测试通过，暂未发现问题
</pre>

<p>
以下是 nftables 规则语句，本质与 iptables 没什么差别：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#35774;&#32622;&#31574;&#30053;&#36335;&#30001;</span>
ip rule add fwmark 1 table 100 
ip route add local 0.0.0.0/0 dev lo table 100

<span style="color: #ff4500;">#</span><span style="color: #ff4500;">&#20195;&#29702;&#23616;&#22495;&#32593;&#35774;&#22791;</span>
nft add table v2ray
nft add chain v2ray prerouting { <span style="color: #b0c4de;">type</span> filter hook prerouting priority 0 <span style="color: #ffa07a;">\;</span> }
nft add rule v2ray prerouting ip daddr {127.0.0.1/32, 224.0.0.0/4, 255.255.255.255/32} <span style="color: #00ffff;">return</span>
nft add rule v2ray prerouting meta l4proto tcp ip daddr 192.168.0.0/16 return
nft add rule v2ray prerouting ip daddr 192.168.0.0/16 udp dport != 53 return
nft add rule v2ray prerouting mark 0xff return <span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#30452;&#36830; 0xff &#27969;&#37327;</span>
nft add rule v2ray prerouting meta l4proto {tcp, udp} mark set 1 tproxy to 127.0.0.1:12345 accept <span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#36716;&#21457;&#33267; V2Ray 12345 &#31471;&#21475;</span>

<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#20195;&#29702;&#32593;&#20851;&#26412;&#26426;</span>
nft add chain v2ray output { <span style="color: #b0c4de;">type</span> route hook output priority 0 <span style="color: #ffa07a;">\;</span> }
nft add rule v2ray output ip daddr {127.0.0.1/32, 224.0.0.0/4, 255.255.255.255/32} <span style="color: #00ffff;">return</span>
nft add rule v2ray output meta l4proto tcp ip daddr 192.168.0.0/16 return
nft add rule v2ray output ip daddr 192.168.0.0/16 udp dport != 53 return
nft add rule v2ray output mark 0xff return <span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#30452;&#36830; 0xff &#27969;&#37327;</span>
nft add rule v2ray output meta l4proto {tcp, udp} mark set 1 accept <span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#37325;&#36335;&#30001;&#33267; prerouting</span>

<span style="color: #ff4500;"># </span><span style="color: #ff4500;">DIVERT &#35268;&#21017;</span>
nft add table filter
nft add chain filter divert { <span style="color: #b0c4de;">type</span> filter hook prerouting priority -150 <span style="color: #ffa07a;">\;</span> }
nft add rule filter divert meta l4proto tcp socket transparent 1 meta mark set 1 accept
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org98bed64" class="outline-3">
<h3 id="org98bed64">开机自动运行透明代理规则</h3>
<div class="outline-text-3" id="text-org98bed64">
<p>
由于策略路由以及 iptables/nftables 有重启会失效的特性，所以当测试配置没有问题之后，需要再弄个服务在开机时自动配置策略路由和 iptables，否则每次开机的时候就要手动执行一遍：
</p>
<ol class="org-ol">
<li><p>
由于 iptables 命令有点多，所以先将 iptables 规则保存到 /etc/iptables/rules.v4 中
</p>
<div class="org-src-container">
<pre class="src src-sh">mkdir -p /etc/iptables &amp;&amp; iptables-save &gt; /etc/iptables/rules.v4

<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#22914;&#26524;&#26159; nftables&#65292;&#21017;&#25191;&#34892;&#65306;</span>
mkdir -p /etc/nftables &amp;&amp; nft list ruleset &gt; /etc/nftables/rules.v4
</pre>
</div></li>
<li><p>
在 <i>etc/systemd/system</i> 目录下创建一个名为 tproxyrule.service 的文件，然后添加以下内容并保存：
</p>
<div class="org-src-container">
<pre class="src src-sh">[Unit]
<span style="color: #eedd82;">Description</span>=Tproxy rule
<span style="color: #eedd82;">After</span>=network.target
<span style="color: #eedd82;">Wants</span>=network.target

[Service]

<span style="color: #eedd82;">Type</span>=oneshot
<span style="color: #eedd82;">RemainAfterExit</span>=yes
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#27880;&#24847;&#20998;&#21495;&#21069;&#21518;&#35201;&#26377;&#31354;&#26684;</span>
<span style="color: #eedd82;">ExecStart</span>=/sbin/ip rule add fwmark 1 table 100 ; /sbin/ip route add local 0.0.0.0/0 dev lo table 100 ; /sbin/iptables-restore /etc/iptables/rules.v4
<span style="color: #eedd82;">ExecStop</span>=/sbin/ip rule del fwmark 1 table 100 ; /sbin/ip route del local 0.0.0.0/0 dev lo table 100 ; /sbin/iptables -t mangle -F
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#22914;&#26524;&#26159; nftables&#65292;&#21017;&#25913;&#20026;&#20197;&#19979;&#21629;&#20196;</span>
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">ExecStart=/sbin/ip rule add fwmark 1 table 100 ; /sbin/ip route add local 0.0.0.0/0 dev lo table 100 ; /sbin/nft -f /etc/nftables/rules.v4</span>
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">ExecStop=/sbin/ip rule del fwmark 1 table 100 ; /sbin/ip route del local 0.0.0.0/0 dev lo table 100 ; /sbin/nft flush ruleset</span>

[Install]
<span style="color: #eedd82;">WantedBy</span>=multi-user.target
</pre>
</div></li>
<li><p>
执行下面的命令使 tproxyrule.service 可以开机自动运行：
</p>
<div class="org-src-container">
<pre class="src src-sh">systemctl enable tproxyrule
</pre>
</div></li>
</ol>
</div>
</div>

<div id="outline-container-org3a5d2f0" class="outline-3">
<h3 id="org3a5d2f0">其他</h3>
<div class="outline-text-3" id="text-org3a5d2f0">
</div>
<div id="outline-container-orge1cf5af" class="outline-4">
<h4 id="orge1cf5af">解决 too many open files 问题</h4>
<div class="outline-text-4" id="text-orge1cf5af">
<p>
对 UDP 透明代理比较容易出现“卡住”的情况，这个时候细心的朋友可能会发现日志中出现了非常多 <span class="underline">too many open files</span> 的语句，这主要是受到最大文件描述符数值的限制，把这个数值往大调就好了。设置步骤如下：
</p>
<ol class="org-ol">
<li><p>
修改 <span class="underline">/etc/systemd/system/v2ray.service</span> 文件，在 [Service] 下加入 <span class="underline">LimitNPROC=500</span> 和 <span class="underline">LimitNOFILE=1000000</span> ，修改后的内容如下：
</p>
<div class="org-src-container">
<pre class="src src-sh">[Unit]
<span style="color: #eedd82;">Description</span>=V2Ray Service
<span style="color: #eedd82;">Documentation</span>=https://www.v2fly.org/
<span style="color: #eedd82;">After</span>=network.target nss-lookup.target

[Service]
<span style="color: #eedd82;">User</span>=nobody
<span style="color: #eedd82;">CapabilityBoundingSet</span>=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
<span style="color: #eedd82;">AmbientCapabilities</span>=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
<span style="color: #eedd82;">NoNewPrivileges</span>=true
<span style="color: #eedd82;">ExecStart</span>=/usr/local/bin/v2ray -config /usr/local/etc/v2ray/config.json
<span style="color: #eedd82;">Restart</span>=on-failure
<span style="color: #eedd82;">RestartPreventExitStatus</span>=23
<span style="color: #eedd82;">LimitNPROC</span>=500
<span style="color: #eedd82;">LimitNOFILE</span>=1000000

[Install]
<span style="color: #eedd82;">WantedBy</span>=multi-user.target
</pre>
</div></li>
<li>执行 <span class="underline">systemctl daemon-reload &amp;&amp; systemctl restart v2ray</span> 生效</li>
</ol>
</div>
</div>
<div id="outline-container-org0602948" class="outline-4">
<h4 id="org0602948">备注</h4>
<div class="outline-text-4" id="text-org0602948">
<ol class="org-ol">
<li><p>
TPROXY 与 REDIRECT 是针对 TCP 而言的两种透明代理模式，两者的差异主要在于 TPROXY 可以透明代理 IPV6，而 REDIRECT 不行，本文主要是将透明代理模式改为 TPROXY 并且使用了 V2Ray 的 DNS
</p>
<pre class="example" id="org5344cfb">
但没有 IPV6 环境，无法进行测试，所以本文只适用于 IPV4
</pre></li>
<li>由于设计原因，V2Ray 不支持 Full Cone 类型的 NAT</li>
</ol>

<table border="1" cellspacing="0" cellpadding="6" rules="all" frame="boader">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left"><a href="reverse_proxy.html">Next：反向代理</a></td>
<td class="org-left"><a href="application.html">Home：应用</a></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

		  <br/>
		  <div class='ds-thread'></div>
		  <script>
		  var duoshuoQuery = {short_name:'klose911'};
		  (function() {
					  var dsThread = document.getElementsByClassName('ds-thread')[0];
					  dsThread.setAttribute('data-thread-key', document.title);
					  dsThread.setAttribute('data-title', document.title);
					  dsThread.setAttribute('data-url', window.location.href);
					  var ds = document.createElement('script');
					  ds.type = 'text/javascript';ds.async = true;
					  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
					  ds.charset = 'UTF-8';
					  (document.getElementsByTagName('head')[0] 
						|| document.getElementsByTagName('body')[0]).appendChild(ds);
					  })();
		  </script>
		  <script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
		  ga('create', 'UA-90850421-1', 'auto');
		  ga('send', 'pageview');
		  </script>
</div>
</body>
</html>
