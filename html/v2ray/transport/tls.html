<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TLS</title>
<meta name="author" content="Wu, Shanliang" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="../css/main.css" />
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="proxy_redirect.html"> UP </a>
 |
 <a accesskey="H" href="transport.html"> HOME </a>
</div><div id="content" class="content">
<h1 class="title">TLS</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org370c1b5">基础</a>
<ul>
<li><a href="#orge430c36">注册域名</a></li>
<li><a href="#org31eba3c">生成证书</a></li>
<li><a href="#org1ee1ae4">acme</a>
<ul>
<li><a href="#org514520f">安装</a></li>
<li><a href="#orgcc7b32d">生成证书</a></li>
<li><a href="#org71203be">更新证书</a></li>
</ul>
</li>
<li><a href="#org5c16cad">安装证书和密钥</a></li>
<li><a href="#org4e648bc">配置</a>
<ul>
<li><a href="#orgcab9c43">服务器</a></li>
<li><a href="#org315c8ff">客户端</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org23bb845">TCP + TLS + Web</a>
<ul>
<li><a href="#orga9e7c67">背景</a></li>
<li><a href="#orga20e0d1">原理</a></li>
<li><a href="#org2368061">实现</a></li>
<li><a href="#orgcd7adc6">效果</a></li>
<li><a href="#org8cc2703">讨论</a></li>
</ul>
</li>
<li><a href="#orgbc5ab60">TCP + TLS 分流器</a>
<ul>
<li><a href="#org7cbaa40">实现</a></li>
<li><a href="#org2c120ac">Domain Socket</a></li>
<li><a href="#org7bef5be">其他</a></li>
</ul>
</li>
</ul>
</div>
</div>
<p>
从 v1.19 起引入了 TLS，TLS 中文译名是传输层安全
</p>

<div id="outline-container-org370c1b5" class="outline-2">
<h2 id="org370c1b5">基础</h2>
<div class="outline-text-2" id="text-org370c1b5">
</div>
<div id="outline-container-orge430c36" class="outline-3">
<h3 id="orge430c36">注册域名</h3>
<div class="outline-text-3" id="text-orge430c36">
<pre class="example" id="org2a8576c">
如果已经注册有域名了可以跳过
</pre>
<p>
TLS 需要一个域名，域名有免费的和有付费的，如果不舍得为一个域名每年花点钱，用个免费域名也可以，但总体来说付费的会优于免费的
</p>

<pre class="example" id="org919711e">
为了方便，在本文中忽略如何注册购买域名了
</pre>

<p>
注册好域名之后务必记得添加一个 <b>A 记录</b> 指向你的 VPS!
</p>

<pre class="example" id="org41068fa">
以下假设注册的域名为 mydomain.me，请将之替换成自己的域名
</pre>
</div>
</div>

<div id="outline-container-org31eba3c" class="outline-3">
<h3 id="org31eba3c">生成证书</h3>
<div class="outline-text-3" id="text-org31eba3c">
<p>
TLS 是证书认证机制，所以使用 TLS 需要证书，证书也有免费付费的
</p>

<pre class="example" id="org6e465f5">
这里使用免费证书，证书认证机构为 Let's Encrypt 
</pre>

<p>
证书的生成有许多方法，这里使用的是比较简单的方法：使用 <span class="underline">acme.sh</span> 脚本生成
</p>

<pre class="example" id="org06de28e">
本部分说明部分内容参考于acme.sh README 
</pre>

<p>
证书有两种，一种是 ECC 证书（内置公钥是 ECDSA 公钥），一种是 RSA 证书（内置 RSA 公钥）
</p>

<pre class="example" id="org75cdc6e">
简单来说，同等长度 ECC 比 RSA 更安全,也就是说在具有同样安全性的情况下，ECC 的密钥长度比 RSA 短得多（加密解密会更快）

但问题是 ECC 的兼容性会差一些，Android 4.x 以下和 Windows XP 不支持。只要设备不是非常老的老古董，建议使用 ECC 证书
</pre>
</div>
</div>

<div id="outline-container-org1ee1ae4" class="outline-3">
<h3 id="org1ee1ae4">acme</h3>
<div class="outline-text-3" id="text-org1ee1ae4">
</div>
<div id="outline-container-org514520f" class="outline-4">
<h4 id="org514520f">安装</h4>
<div class="outline-text-4" id="text-org514520f">
<p>
执行以下命令，acme.sh 会安装到 ~/.acme.sh 目录下
</p>

<div class="org-src-container">
<pre class="src src-sh">$ curl  https://get.acme.sh | sh
% Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
Dload  Upload   Total   Spent    Left  Speed
100   671  100   671    0     0    680      0 --:--:-- --:--:-- --:--:--   679
% Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
Dload  Upload   Total   Spent    Left  Speed
100  112k  100  112k    0     0   690k      0 --:--:-- --:--:-- --:--:--  693k
[Fri 30 Dec 01:03:32 GMT 2016] Installing from online archive.
[Fri 30 Dec 01:03:32 GMT 2016] Downloading https://github.com/Neilpang/acme.sh/archive/master.tar.gz
[Fri 30 Dec 01:03:33 GMT 2016] Extracting master.tar.gz
[Fri 30 Dec 01:03:33 GMT 2016] Installing to /home/user/.acme.sh
[Fri 30 Dec 01:03:33 GMT 2016] Installed to /home/user/.acme.sh/acme.sh
[Fri 30 Dec 01:03:33 GMT 2016] Installing alias to <span style="color: #ffa07a;">'/home/user/.profile'</span>
[Fri 30 Dec 01:03:33 GMT 2016] OK, Close and reopen your terminal to start using acme.sh
[Fri 30 Dec 01:03:33 GMT 2016] Installing cron job
no crontab for user
no crontab for user
[Fri 30 Dec 01:03:33 GMT 2016] Good, bash is found, so change the shebang to use bash as preferred.
[Fri 30 Dec 01:03:33 GMT 2016] OK
[Fri 30 Dec 01:03:33 GMT 2016] Install success!
</pre>
</div>

<pre class="example" id="orgaaa0807">
安装成功后执行 source ~/.bashrc 以确保脚本所设置的命令别名生效
</pre>
<p>
如果安装报错，那么可能是因为系统缺少 acme.sh 所需要的依赖项 ，acme.sh 的依赖项主要是 <span class="underline">socat</span> ，通过以下命令来安装这些依赖项，然后重新安装一遍 acme.sh:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ sudo apt-get install openssl cron socat curl
</pre>
</div>
</div>
</div>


<div id="outline-container-orgcc7b32d" class="outline-4">
<h4 id="orgcc7b32d">生成证书</h4>
<div class="outline-text-4" id="text-orgcc7b32d">
<p>
执行以下命令生成证书：
</p>
<div class="org-src-container">
<pre class="src src-sh">$ ~/.acme.sh/acme.sh --issue -d mydomain.me --standalone --keylength ec-256 --force
[Fri Dec 30 08:59:12 HKT 2016] Standalone mode.
[Fri Dec 30 08:59:12 HKT 2016] Single <span style="color: #eedd82;">domain</span>=<span style="color: #ffa07a;">'mydomain.me'</span>
[Fri Dec 30 08:59:12 HKT 2016] Getting domain auth token for each domain
[Fri Dec 30 08:59:12 HKT 2016] Getting webroot for <span style="color: #eedd82;">domain</span>=<span style="color: #ffa07a;">'mydomain.me'</span>
[Fri Dec 30 08:59:12 HKT 2016] <span style="color: #eedd82;">_w</span>=<span style="color: #ffa07a;">'no'</span>
[Fri Dec 30 08:59:12 HKT 2016] Getting new-authz for <span style="color: #eedd82;">domain</span>=<span style="color: #ffa07a;">'mydomain.me'</span>
[Fri Dec 30 08:59:14 HKT 2016] The new-authz request is ok.
[Fri Dec 30 08:59:14 HKT 2016] mydomain.me is already verified, skip.
[Fri Dec 30 08:59:14 HKT 2016] mydomain.me is already verified, skip http-01.
[Fri Dec 30 08:59:14 HKT 2016] mydomain.me is already verified, skip http-01.
[Fri Dec 30 08:59:14 HKT 2016] Verify finished, start to sign.
[Fri Dec 30 08:59:16 HKT 2016] Cert success.
-----BEGIN CERTIFICATE-----
MIIEMTCCAxmgAwIBAgISA1+gJF5zwUDjNX/6Xzz5fo3lMA0GCSqGSIb3DQEBCwUA
MEoxCzAJBgNVBAYTAlVTMRYwFAYDVQQKEw1MZXQncyBFbmNyeXB0MSMwIQYDVQQD
ExpMZXQncyBFbmNyeXB0IEF1dGhvcml0eSBYMzAeFw0xNjEyMjkyMzU5MDBaFw0x
NzAzMjkyMzU5MDBaMBcxFTATBgNVBAMTDHdlYWtzYW5kLmNvbTBZMBMGByqGSM49
****************************************************************
4p40tm0aMB837XQ9jeAXvXulhVH/7/wWZ8/vkUUvuHSCYHagENiq/3DYj4a85Iw9
+6u1r7atYHJ2VwqSamiyTGDQuhc5wdXIQxY/YQQqkAmn5tLsTZnnOavc4plANT40
zweiG8vcIvMVnnkM0TSz8G1yzv1nOkruN3ozQkLMu6YS7lk/ENBN7DBtYVSmJeU2
VAXE+zgRaP7JFOqK6DrOwhyE2LSgae83Wq/XgXxjfIo1Zmn2UmlE0sbdNKBasnf9
gPUI45eltrjcv8FCSTOUcT7PWCa3
-----END CERTIFICATE-----
[Fri Dec 30 08:59:16 HKT 2016] Your cert is<span style="color: #00ffff;"> in</span>  /root/.acme.sh/mydomain.me_ecc/mydomain.me.cer
[Fri Dec 30 08:59:16 HKT 2016] Your cert key is<span style="color: #00ffff;"> in</span>  /root/.acme.sh/mydomain.me_ecc/mydomain.me.key
[Fri Dec 30 08:59:16 HKT 2016] The intermediate CA cert is<span style="color: #00ffff;"> in</span>  /root/.acme.sh/mydomain.me_ecc/ca.cer
[Fri Dec 30 08:59:16 HKT 2016] And the full chain certs is there:  /root/.acme.sh/mydomain.me_ecc/fullchain.cer
</pre>
</div>


<p>
<span class="underline">&#x2013;keylength</span> 表示密钥长度，后面的值可以是 ec-256 、ec-384、2048、3072、4096、8192
</p>

<pre class="example" id="org24e0a5e">
带有 ec 表示生成的是 ECC 证书，没有则是 RSA 证书

在安全性上 256 位的 ECC 证书等同于 3072 位的 RSA 证书
</pre>
</div>
</div>

<div id="outline-container-org71203be" class="outline-4">
<h4 id="org71203be">更新证书</h4>
<div class="outline-text-4" id="text-org71203be">
<pre class="example" id="orgad0f56b">
由于 Let's Encrypt 的证书有效期只有 3 个月，因此需要 90 天至少要更新一次证书
</pre>
<p>
acme.sh 脚本会每 60 天自动更新证书。也可以手动更新：
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ~/.acme.sh/acme.sh --renew -d mydomain.com --force --ecc
</pre>
</div>

<pre class="example" id="org7389294">
由于本例中将证书生成到 /etc/v2ray/ 文件夹，更新证书之后还得把新证书生成到 /etc/v2ray
</pre>
</div>
</div>
</div>

<div id="outline-container-org5c16cad" class="outline-3">
<h3 id="org5c16cad">安装证书和密钥</h3>
<div class="outline-text-3" id="text-org5c16cad">
<p>
将证书和密钥安装到 /etc/v2ray 中：
</p>
<div class="org-src-container">
<pre class="src src-sh">$ sudo ~/.acme.sh/acme.sh --installcert -d mydomain.me --ecc <span style="color: #ffa07a;">\</span>
  --fullchain-file /etc/v2ray/v2ray.crt <span style="color: #ffa07a;">\</span>
  --key-file /etc/v2ray/v2ray.key
</pre>
</div>
<p>
注意：无论什么情况，密钥(即上面的 v2ray.key)都不能泄漏
</p>
<pre class="example" id="org1eff022">
如果不幸泄漏了密钥，可以使用 acme.sh 将原证书吊销，再生成新的证书

吊销方法请自行参考 acme.sh 的手册
</pre>
</div>
</div>

<div id="outline-container-org4e648bc" class="outline-3">
<h3 id="org4e648bc">配置</h3>
<div class="outline-text-3" id="text-org4e648bc">
</div>
<div id="outline-container-orgcab9c43" class="outline-4">
<h4 id="orgcab9c43">服务器</h4>
<div class="outline-text-4" id="text-orgcab9c43">
<div class="org-src-container">
<pre class="src src-js">{
    <span style="color: #ffa07a;">"inbounds"</span>: [
        {
            <span style="color: #ffa07a;">"port"</span>: 443, <span style="color: #ff4500;">// </span><span style="color: #ff4500;">&#24314;&#35758;&#20351;&#29992; 443 &#31471;&#21475;</span>
            <span style="color: #ffa07a;">"protocol"</span>: <span style="color: #ffa07a;">"vmess"</span>,    
            <span style="color: #ffa07a;">"settings"</span>: {
                <span style="color: #ffa07a;">"clients"</span>: [
                    {
                        <span style="color: #ffa07a;">"id"</span>: <span style="color: #ffa07a;">"23ad6b10-8d1a-40f7-8ad0-e3e35cd38297"</span>,  
                        <span style="color: #ffa07a;">"alterId"</span>: 64
                    }
                ]
            },
            <span style="color: #ffa07a;">"streamSettings"</span>: {
                <span style="color: #ffa07a;">"network"</span>: <span style="color: #ffa07a;">"tcp"</span>,
                <span style="color: #ffa07a;">"security"</span>: <span style="color: #ffa07a;">"tls"</span>, <span style="color: #ff4500;">// </span><span style="color: #ff4500;">security &#35201;&#35774;&#32622;&#20026; tls &#25165;&#20250;&#21551;&#29992; TLS</span>
                <span style="color: #ffa07a;">"tlsSettings"</span>: {
                    <span style="color: #ffa07a;">"certificates"</span>: [
                        {
                            <span style="color: #ffa07a;">"certificateFile"</span>: <span style="color: #ffa07a;">"/etc/v2ray/v2ray.crt"</span>, <span style="color: #ff4500;">// </span><span style="color: #ff4500;">&#35777;&#20070;&#25991;&#20214;</span>
                            <span style="color: #ffa07a;">"keyFile"</span>: <span style="color: #ffa07a;">"/etc/v2ray/v2ray.key"</span> <span style="color: #ff4500;">// </span><span style="color: #ff4500;">&#23494;&#38053;&#25991;&#20214;</span>
                        }
                    ]
                }
            }
        }
    ],
    <span style="color: #ffa07a;">"outbounds"</span>: [
        {
            <span style="color: #ffa07a;">"protocol"</span>: <span style="color: #ffa07a;">"freedom"</span>,
            <span style="color: #ffa07a;">"settings"</span>: {}
        }
    ]
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org315c8ff" class="outline-4">
<h4 id="org315c8ff">客户端</h4>
<div class="outline-text-4" id="text-org315c8ff">
<div class="org-src-container">
<pre class="src src-js">{
    <span style="color: #ffa07a;">"inbounds"</span>: [
        {
            <span style="color: #ffa07a;">"port"</span>: 1080,
            <span style="color: #ffa07a;">"protocol"</span>: <span style="color: #ffa07a;">"socks"</span>,
            <span style="color: #ffa07a;">"sniffing"</span>: {
                <span style="color: #ffa07a;">"enabled"</span>: <span style="color: #7fffd4;">true</span>,
                <span style="color: #ffa07a;">"destOverride"</span>: [<span style="color: #ffa07a;">"http"</span>, <span style="color: #ffa07a;">"tls"</span>]
            },
            <span style="color: #ffa07a;">"settings"</span>: {
                <span style="color: #ffa07a;">"auth"</span>: <span style="color: #ffa07a;">"noauth"</span>
            }
        }
    ],
    <span style="color: #ffa07a;">"outbounds"</span>: [
        {
            <span style="color: #ffa07a;">"protocol"</span>: <span style="color: #ffa07a;">"vmess"</span>,
            <span style="color: #ffa07a;">"settings"</span>: {
                <span style="color: #ffa07a;">"vnext"</span>: [
                    {
                        <span style="color: #ffa07a;">"address"</span>: <span style="color: #ffa07a;">"mydomain.me"</span>, <span style="color: #ff4500;">// </span><span style="color: #ff4500;">tls &#38656;&#35201;&#22495;&#21517;&#65292;&#25152;&#20197;&#36825;&#37324;&#24212;&#35813;&#22635;&#33258;&#24049;&#30340;&#22495;&#21517;</span>
                        <span style="color: #ffa07a;">"port"</span>: 443,
                        <span style="color: #ffa07a;">"users"</span>: [
                            {
                                <span style="color: #ffa07a;">"id"</span>: <span style="color: #ffa07a;">"23ad6b10-8d1a-40f7-8ad0-e3e35cd38297"</span>,
                                <span style="color: #ffa07a;">"alterId"</span>: 64
                            }
                        ]
                    }
                ]
            },
            <span style="color: #ffa07a;">"streamSettings"</span>: {
                <span style="color: #ffa07a;">"network"</span>: <span style="color: #ffa07a;">"tcp"</span>,
                <span style="color: #ffa07a;">"security"</span>: <span style="color: #ffa07a;">"tls"</span> <span style="color: #ff4500;">// </span><span style="color: #ff4500;">&#23458;&#25143;&#31471;&#30340; security &#20063;&#35201;&#35774;&#32622;&#20026; tls</span>
            }
        }
    ]
}
</pre>
</div>
<pre class="example" id="org7dbc141">
V2Ray 的 TLS 不是伪装或混淆，这是完整、真正的 TLS。因此才需要域名和证书

后文提到的 WS(WebSocket) 也不是伪装
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org23bb845" class="outline-2">
<h2 id="org23bb845">TCP + TLS + Web</h2>
<div class="outline-text-2" id="text-org23bb845">
<pre class="example" id="orgfdc6418">
新手建议使用 TLS 分流器 
</pre>
</div>
<div id="outline-container-orga9e7c67" class="outline-3">
<h3 id="orga9e7c67">背景</h3>
<div class="outline-text-3" id="text-orga9e7c67">
<pre class="example" id="org9c401d0">
目前 Vmess + WebSocket + TLS （以下简称 wss）方式，因其特征如同 HTTPS 流量

可以隐藏 V2Ray 路径，主动侦测会得到正常 HTTP 网站响应，具有良好的伪装能力，目前被广泛用于反审查
</pre>
<p>
但是如此强大的伪装能力，需要付出严重的性能代价：TLS 1.3 握手需要消耗 1-rtt，WS 握手也需要消耗 1-rtt，增大了握手延迟
</p>

<pre class="example" id="org9d528d7">
V2Ray 增加了 mux 以减少握手的发生，然而实际使用中 mux 体验并不好，很多用户选择关闭
</pre>
<p>
最近兴起了一个新的反审查工具 Trojan，这个工具将一个类似 Socks 的协议直接通过 TLS 传输，并将认证失败的流量交由 Web 服务器处理。降低 WS 延迟的同时，提供与 wss 方式一样的伪装能力
</p>
<pre class="example" id="org844fce0">
但是该工具较为年轻，没有路由功能，各平台图形化客户端也不完善
</pre>

<p>
因此，这里尝试用 V2Ray 实现类似功能，即 Vmess + TCP + TLS 并网站伪装，省下 WS 的握手延迟
</p>
</div>
</div>
<div id="outline-container-orga20e0d1" class="outline-3">
<h3 id="orga20e0d1">原理</h3>
<div class="outline-text-3" id="text-orga20e0d1">
<p>
HaProxy 监听 443 端口，处理 TLS 之后，将 HTTP 流量交由 Web 服务器处理，非 HTTP 流量交由 V2Ray 按 Vmess 处理
</p>
</div>
</div>
<div id="outline-container-org2368061" class="outline-3">
<h3 id="org2368061">实现</h3>
<div class="outline-text-3" id="text-org2368061">
<p>
本次方案使用 HaProxy，Nginx（Web 服务器的使用不是本教程的重点），V2Ray
</p>
<ol class="org-ol">
<li><p>
安装 HaProxy
</p>
<div class="org-src-container">
<pre class="src src-sh">apt install haproxy
</pre>
</div>
<pre class="example" id="org8fddfe5">
为了较好的支持 TLS1.3，HaProxy 版本应大于 1.8.15，OpenSSl 版本应大于 1.1.1

如果使用的发行版仓库自带的版本较低，需要自行编译安装
</pre></li>
<li><p>
安装 Web 服务器，Nginx
</p>
<div class="org-src-container">
<pre class="src src-sh">apt install nginx
</pre>
</div></li>
<li>安装 V2Ray，可以使用官方脚本官方脚本</li>
<li><p>
修改 V2Ray 配置文件，以 <span class="underline">Vmess + TCP</span> 方式 <b>监听</b> <span class="underline">40001</span> 端口
</p>
<div class="org-src-container">
<pre class="src src-js">{
    <span style="color: #ffa07a;">"inbounds"</span>: [
        {
            <span style="color: #ffa07a;">"protocol"</span>: <span style="color: #ffa07a;">"vmess"</span>,
            <span style="color: #ffa07a;">"listen"</span>: <span style="color: #ffa07a;">"127.0.0.1"</span>,
            <span style="color: #ffa07a;">"port"</span>: 40001,
            <span style="color: #ffa07a;">"settings"</span>: {
                <span style="color: #ffa07a;">"clients"</span>: [
                    {
                        <span style="color: #ffa07a;">"id"</span>: <span style="color: #ffa07a;">"f2435e5c-9ad9-4367-836a-8341117d0a5f"</span>
                    }
                ]
            },
            <span style="color: #ffa07a;">"streamSettings"</span>: {
                <span style="color: #ffa07a;">"network"</span>: <span style="color: #ffa07a;">"tcp"</span>
            }
        }
    ],
    <span style="color: #ffa07a;">"outbounds"</span>: [
        {
            <span style="color: #ffa07a;">"protocol"</span>: <span style="color: #ffa07a;">"freedom"</span>
        }
    ]
}
</pre>
</div></li>
<li><p>
修改 Web 服务器配置文件，部署 HTTP 服务于 8080 端口：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #ff4500;"># </span><span style="color: #ff4500;">Nginx &#22312; http{} &#37324;&#38754;&#28155;&#21152;</span>

server {
    listen 8080;
    server_name example.com;
    root /var/www/html;
}
</pre>
</div>
<pre class="example" id="orgb4884a4">
/var/www/html 是静态网站目录

实际服务请根据需要部署，也可以用 httpd 之类的替代

似乎很多 Trojan 教程直接监听 80 端口，其实很多 HTTPS 网站 80 端口通常是重定向到 HTTPS
</pre></li>
<li><p>
修改 HaProxy 配置文件：
</p>
<div class="org-src-container">
<pre class="src src-sh">global
<span style="color: #b0c4de;">log</span> /dev/log local0
<span style="color: #b0c4de;">log</span> /dev/log local1 notice
chroot /var/lib/haproxy
stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
stats timeout 30s
user haproxy
group haproxy
daemon
ca-base /etc/ssl/certs
crt-base /etc/ssl/private

<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#20165;&#20351;&#29992;&#25903;&#25345; FS &#21644; AEAD &#30340;&#21152;&#23494;&#22871;&#20214;</span>
ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#31105;&#29992; TLS 1.2 &#20043;&#21069;&#30340; TLS</span>
ssl-default-bind-options no-sslv3 no-tlsv10 no-tlsv11

tune.ssl.default-dh-param 2048

defaults
<span style="color: #b0c4de;">log</span> global
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#25105;&#20204;&#38656;&#35201;&#20351;&#29992; tcp &#27169;&#24335;</span>
mode tcp
option dontlognull
timeout connect 5s
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#31354;&#38386;&#36830;&#25509;&#31561;&#24453;&#26102;&#38388;&#65292;&#36825;&#37324;&#20351;&#29992;&#19982; V2Ray &#40664;&#35748; connIdle &#19968;&#33268;&#30340; 300s</span>
timeout client  300s
timeout server  300s

frontend tls-in
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#30417;&#21548; 443 tls&#65292;tfo &#26681;&#25454;&#33258;&#36523;&#24773;&#20917;&#20915;&#23450;&#26159;&#21542;&#24320;&#21551;&#65292;&#35777;&#20070;&#25918;&#32622;&#20110; /etc/ssl/private/example.com.pem</span>
bind *:443 tfo ssl crt /etc/ssl/private/example.com.pem
tcp-request inspect-delay 5s
tcp-request content accept if HTTP
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#23558; HTTP &#27969;&#37327;&#21457;&#32473; web &#21518;&#31471;</span>
use_backend web if HTTP
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#23558;&#20854;&#20182;&#27969;&#37327;&#21457;&#32473; vmess &#21518;&#31471;</span>
default_backend vmess

backend web
server server1 127.0.0.1:8080

backend vmess
server server1 127.0.0.1:40001
</pre>
</div>
<pre class="example" id="orgbcc6221">
与 Nginx 不同，HaProxy 的证书和密钥放于同一个文件

可以使用命令 cat example.com.crt example.com.key &gt; example.com.pem 合成证书
</pre></li>
<li><p>
重启服务
</p>
<div class="org-src-container">
<pre class="src src-sh">systemctl restart haproxy
systemctl restart nginx
systemctl restart v2ray
</pre>
</div></li>
<li><p>
客户端连接 <span class="underline">example.com:443 vmess tls</span> 即可
</p>
<div class="org-src-container">
<pre class="src src-js">{
    <span style="color: #ffa07a;">"inbounds"</span>: [
        {
            <span style="color: #ffa07a;">"port"</span>: 1080,
            <span style="color: #ffa07a;">"listen"</span>: <span style="color: #ffa07a;">"127.0.0.1"</span>,
            <span style="color: #ffa07a;">"protocol"</span>: <span style="color: #ffa07a;">"socks"</span>
        }
    ],
    <span style="color: #ffa07a;">"outbounds"</span>: [
        {
            <span style="color: #ffa07a;">"protocol"</span>: <span style="color: #ffa07a;">"vmess"</span>,
            <span style="color: #ffa07a;">"settings"</span>: {
                <span style="color: #ffa07a;">"vnext"</span>: [
                    {
                        <span style="color: #ffa07a;">"address"</span>: <span style="color: #ffa07a;">"example.com"</span>,
                        <span style="color: #ffa07a;">"port"</span>: 443,
                        <span style="color: #ffa07a;">"users"</span>: [
                            {
                                <span style="color: #ffa07a;">"id"</span>: <span style="color: #ffa07a;">"f2435e5c-9ad9-4367-836a-8341117d0a5f"</span>,
                                <span style="color: #ffa07a;">"security"</span>: <span style="color: #ffa07a;">"none"</span>
                            }
                        ]
                    }
                ]
            },
            <span style="color: #ffa07a;">"streamSettings"</span>: {
                <span style="color: #ffa07a;">"network"</span>: <span style="color: #ffa07a;">"tcp"</span>,
                <span style="color: #ffa07a;">"security"</span>: <span style="color: #ffa07a;">"tls"</span>
            }
        }
    ]
}
</pre>
</div></li>
</ol>
</div>
</div>
<div id="outline-container-orgcd7adc6" class="outline-3">
<h3 id="orgcd7adc6">效果</h3>
<div class="outline-text-3" id="text-orgcd7adc6">

<div id="org70eec61" class="figure">
<p><img src="../pic/tQyKPD45fmAFl9x.jpg" alt="tQyKPD45fmAFl9x.jpg" width="90%" />
</p>
</div>

<p>
测试工具为 <a href="https://github.com/v2fly/vmessping">vmessping</a> ，可见 Vmess + TCP + TLS（左）延迟低于 Vmess + WSS（右）
</p>
</div>
</div>
<div id="outline-container-org8cc2703" class="outline-3">
<h3 id="org8cc2703">讨论</h3>
<div class="outline-text-3" id="text-org8cc2703">
<ul class="org-ul">
<li><p>
HaProxy，V2Ray，Nginx 都是支持 Domain Socket 的，流量较大或数据包较多时使用 ds 可以提高性能
</p>
<pre class="example" id="org86cc941">
这里不做展开，可以参考这篇文章 https://gist.github.com/liberal-boy/b2d5597285b4202b6d607faaa1078d27
</pre></li>
<li>可以使用<a href="https://github.com/pierky/haproxy-ocsp-stapling-updater">这个工具</a> 开启 OCSP Stapling 减少客户端验证证书的时间</li>
<li>该方法的隐蔽性是否比 wss 低？
<ul class="org-ul">
<li>中间人看来，该方法在建立 TLS 连接后，比 wss 少一次握手，即 TLS 建立后直接发送请求并获得响应，该行为是符合正常的 HTTPS 请求的</li>
<li>主动探测时：
<ul class="org-ul">
<li>如 TLS 建立后发送 HTTP 请求，则被发给 Web 服务器按正常 HTTP 请求处理</li>
<li>如发送非 HTTP 请求，会被发给 V2Ray 处理，如 Vmess 认证失败，连接将被关闭，向 HTTPS 服务器发送非 HTTPS 请求，连接被关闭是正常的行为。</li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgbc5ab60" class="outline-2">
<h2 id="orgbc5ab60">TCP + TLS 分流器</h2>
<div class="outline-text-2" id="text-orgbc5ab60">
<pre class="example" id="org1928a18">
这是 TCP + TLS + Web 的简易实现

不需要处理 HaProxy 和 OpenSSL 的版本问题，也不需要自己申请证书，也不需要额外安装 Web 服务器
</pre>
</div>
<div id="outline-container-org7cbaa40" class="outline-3">
<h3 id="org7cbaa40">实现</h3>
<div class="outline-text-3" id="text-org7cbaa40">
<ol class="org-ol">
<li>安装 V2Ray，可以使用官方脚本官方脚本</li>
<li>安装 <a href="https://github.com/liberal-boy/tls-shunt-proxy">TLS 分流器</a> ，见 <a href="https://github.com/liberal-boy/tls-shunt-proxy#%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85">安装说明</a></li>
<li><p>
修改 TLS 分流器配置文件，位于 <span class="underline">/etc/tls-shunt-proxy/config.yaml</span>
</p>
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #eedd82;">listen</span>: 0.0.0.0:443
<span style="color: #eedd82;">vhosts</span>:
  <span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#23558; example.com &#25913;&#20026;&#20320;&#30340;&#22495;&#21517;</span>
  - <span style="color: #eedd82;">name</span>: example.com
    <span style="color: #eedd82;">tlsoffloading</span>: <span style="color: #7fffd4;">true</span>
    <span style="color: #eedd82;">managedcert</span>: <span style="color: #7fffd4;">true</span>
    <span style="color: #eedd82;">alpn</span>: h2,http/1.1
    <span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#22914;&#26524;&#19981;&#38656;&#35201;&#20860;&#23481; tls12, &#21487;&#25913;&#20026; tls13</span>
    <span style="color: #eedd82;">protocols</span>: tls12,tls13
    <span style="color: #eedd82;">http</span>:
      <span style="color: #eedd82;">handler</span>: fileServer
      <span style="color: #ff4500;"># </span><span style="color: #ff4500;">/var/www/html &#26159;&#38745;&#24577;&#32593;&#31449;&#30446;&#24405;</span>
      <span style="color: #eedd82;">args</span>: /var/www/html
      <span style="color: #eedd82;">default</span>:
        <span style="color: #eedd82;">handler</span>: proxyPass
        <span style="color: #eedd82;">args</span>: 127.0.0.1:40001
</pre>
</div></li>
<li><p>
修改服务器 V2Ray 配置文件 <span class="underline">/etc/v2ray/config.json</span> ，同 TCP + TLS + Web 方式
</p>
<div class="org-src-container">
<pre class="src src-js">{
    <span style="color: #ffa07a;">"inbounds"</span>: [
        {
            <span style="color: #ffa07a;">"protocol"</span>: <span style="color: #ffa07a;">"vmess"</span>,
            <span style="color: #ffa07a;">"listen"</span>: <span style="color: #ffa07a;">"127.0.0.1"</span>,
            <span style="color: #ffa07a;">"port"</span>: 40001,
            <span style="color: #ffa07a;">"settings"</span>: {
                <span style="color: #ffa07a;">"clients"</span>: [
                    {
                        <span style="color: #ffa07a;">"id"</span>: <span style="color: #ffa07a;">"f2435e5c-9ad9-4367-836a-8341117d0a5f"</span>
                    }
                ]
            },
            <span style="color: #ffa07a;">"streamSettings"</span>: {
                <span style="color: #ffa07a;">"network"</span>: <span style="color: #ffa07a;">"tcp"</span>
            }
        }
    ],
    <span style="color: #ffa07a;">"outbounds"</span>: [
        {
            <span style="color: #ffa07a;">"protocol"</span>: <span style="color: #ffa07a;">"freedom"</span>
        }
    ]
}
</pre>
</div></li>
<li><p>
重启服务
</p>
<div class="org-src-container">
<pre class="src src-sh">systemctl restart tls-shunt-proxy
systemctl restart v2ray
</pre>
</div></li>
<li><p>
客户端连接 example.com:443 vmess tls 即可
</p>
<div class="org-src-container">
<pre class="src src-js">{
    <span style="color: #ffa07a;">"inbounds"</span>: [
        {
            <span style="color: #ffa07a;">"port"</span>: 1080,
            <span style="color: #ffa07a;">"listen"</span>: <span style="color: #ffa07a;">"127.0.0.1"</span>,
            <span style="color: #ffa07a;">"protocol"</span>: <span style="color: #ffa07a;">"socks"</span>
        }
    ],
    <span style="color: #ffa07a;">"outbounds"</span>: [
        {
            <span style="color: #ffa07a;">"protocol"</span>: <span style="color: #ffa07a;">"vmess"</span>,
            <span style="color: #ffa07a;">"settings"</span>: {
                <span style="color: #ffa07a;">"vnext"</span>: [
                    {
                        <span style="color: #ffa07a;">"address"</span>: <span style="color: #ffa07a;">"example.com"</span>,
                        <span style="color: #ffa07a;">"port"</span>: 443,
                        <span style="color: #ffa07a;">"users"</span>: [
                            {
                                <span style="color: #ffa07a;">"id"</span>: <span style="color: #ffa07a;">"f2435e5c-9ad9-4367-836a-8341117d0a5f"</span>,
                                <span style="color: #ffa07a;">"security"</span>: <span style="color: #ffa07a;">"none"</span>
                            }
                        ]
                    }
                ]
            },
            <span style="color: #ffa07a;">"streamSettings"</span>: {
                <span style="color: #ffa07a;">"network"</span>: <span style="color: #ffa07a;">"tcp"</span>,
                <span style="color: #ffa07a;">"security"</span>: <span style="color: #ffa07a;">"tls"</span>
            }
        }
    ]
}
</pre>
</div></li>
</ol>
</div>
</div>
<div id="outline-container-org2c120ac" class="outline-3">
<h3 id="org2c120ac">Domain Socket</h3>
<div class="outline-text-3" id="text-org2c120ac">
<p>
相比 TCP，Domain Socket (以下简称 DS) 更为高效
</p>
<pre class="example" id="org7fa2693">
根据测试反馈，速度超过 50Mbps 时，通常会有较明显的性能差距
</pre>
<p>
DS 仅限分流器与服务端 V2Ray 连接，客户端连接服务器仍然使用 TCP, 即：
</p>
<pre class="example" id="org904500a">
	      TLS over TCP                DS
客户端 V2Ray --------------- TLS 分流器 -------- 服务端 V2Ray
</pre>

<ol class="org-ol">
<li><p>
修改分流器配置文件 <span class="underline">/etc/tls-shunt-proxy/config.yaml</span>
</p>
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #eedd82;">listen</span>: 0.0.0.0:443
<span style="color: #eedd82;">vhosts</span>:
  <span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#23558; example.com &#25913;&#20026;&#20320;&#30340;&#22495;&#21517;</span>
  - <span style="color: #eedd82;">name</span>: example.com
    <span style="color: #eedd82;">tlsoffloading</span>: <span style="color: #7fffd4;">true</span>
    <span style="color: #eedd82;">managedcert</span>: <span style="color: #7fffd4;">true</span>
    <span style="color: #eedd82;">alpn</span>: h2,http/1.1
    <span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#22914;&#26524;&#19981;&#38656;&#35201;&#20860;&#23481; tls12, &#21487;&#25913;&#20026; tls13</span>
    <span style="color: #eedd82;">protocols</span>: tls12,tls13
    <span style="color: #eedd82;">http</span>:
      <span style="color: #eedd82;">handler</span>: fileServer
      <span style="color: #ff4500;"># </span><span style="color: #ff4500;">/var/www/html &#26159;&#38745;&#24577;&#32593;&#31449;&#30446;&#24405;</span>
      <span style="color: #eedd82;">args</span>: /var/www/html
      <span style="color: #eedd82;">default</span>:
        <span style="color: #eedd82;">handler</span>: proxyPass
        <span style="color: #eedd82;">args</span>: unix:@v2ray.sock
</pre>
</div></li>
<li><p>
修改服务器 V2Ray 配置文件 <span class="underline">/etc/v2ray/config.json</span>
</p>
<div class="org-src-container">
<pre class="src src-js">{
    <span style="color: #ffa07a;">"inbounds"</span>: [
        {
            <span style="color: #ffa07a;">"protocol"</span>: <span style="color: #ffa07a;">"vmess"</span>,
            <span style="color: #ffa07a;">"listen"</span>: <span style="color: #ffa07a;">"127.0.0.1"</span>,
            <span style="color: #ffa07a;">"port"</span>: 40001,
            <span style="color: #ffa07a;">"settings"</span>: {
                <span style="color: #ffa07a;">"clients"</span>: [
                    {
                        <span style="color: #ffa07a;">"id"</span>: <span style="color: #ffa07a;">"f2435e5c-9ad9-4367-836a-8341117d0a5f"</span>
                    }
                ]
            },
            <span style="color: #ffa07a;">"streamSettings"</span>: {
                <span style="color: #ffa07a;">"network"</span>: <span style="color: #ffa07a;">"ds"</span>,
                <span style="color: #ffa07a;">"dsSettings"</span>: {
                    <span style="color: #ffa07a;">"path"</span>: <span style="color: #ffa07a;">"@v2ray.sock"</span>,
                    <span style="color: #ffa07a;">"abstract"</span>: <span style="color: #7fffd4;">true</span>
                }

            }
        }
    ],
    <span style="color: #ffa07a;">"outbounds"</span>: [
        {
            <span style="color: #ffa07a;">"protocol"</span>: <span style="color: #ffa07a;">"freedom"</span>
        }
    ]
}
</pre>
</div></li>
<li><p>
重启服务
</p>
<div class="org-src-container">
<pre class="src src-sh">systemctl daemon-reload
systemctl restart v2ray
systemctl restart tls-shunt-proxy
</pre>
</div></li>
</ol>
</div>
</div>
<div id="outline-container-org7bef5be" class="outline-3">
<h3 id="org7bef5be">其他</h3>
<div class="outline-text-3" id="text-org7bef5be">
<pre class="example" id="org01a4586">
TLS 分流器还可以实现 vmess + TLS + Web 和 trojan 共享端口

具体配置参数请参阅项目 https://github.com/liberal-boy/tls-shunt-proxy/blob/master/README.md
</pre>

<table border="1" cellspacing="0" cellpadding="6" rules="all" frame="boader">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left"><a href="websocket.html">Next: Websocket</a></td>
<td class="org-left"><a href="proxy_redirect.html">Previous：代理转发</a></td>
<td class="org-left"><a href="transport.html">Home：传输</a></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

		  <br/>
		  <div class='ds-thread'></div>
		  <script>
		  var duoshuoQuery = {short_name:'klose911'};
		  (function() {
					  var dsThread = document.getElementsByClassName('ds-thread')[0];
					  dsThread.setAttribute('data-thread-key', document.title);
					  dsThread.setAttribute('data-title', document.title);
					  dsThread.setAttribute('data-url', window.location.href);
					  var ds = document.createElement('script');
					  ds.type = 'text/javascript';ds.async = true;
					  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
					  ds.charset = 'UTF-8';
					  (document.getElementsByTagName('head')[0] 
						|| document.getElementsByTagName('body')[0]).appendChild(ds);
					  })();
		  </script>
		  <script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
		  ga('create', 'UA-90850421-1', 'auto');
		  ga('send', 'pageview');
		  </script>
</div>
</body>
</html>
