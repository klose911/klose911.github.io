<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>寄存求值器</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wu, Shanliang" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="css/main.css" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">寄存求值器</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org88906f6">内存管理</a>
<ul>
<li><a href="#org9da2204">向量模拟内存</a>
<ul>
<li><a href="#orgc947912">Scheme 序对的表示</a></li>
<li><a href="#org2efd4e9">基本表操作实现</a></li>
<li><a href="#org8b2a60e">栈实现</a></li>
</ul>
</li>
<li><a href="#org356076d">垃圾回收机制</a>
<ul>
<li><a href="#org54aa9cc">垃圾回收算法</a>
<ul>
<li><a href="#org34c053c">复制垃圾回收算法的实现</a></li>
<li><a href="#org76d662f">寄存器语言实现垃圾回收</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgc6bb2aa">寄存求值器</a>
<ul>
<li><a href="#org20f14cd">寄存器和操作</a></li>
<li><a href="#org382e3cd">显式求值器的实现</a>
<ul>
<li><a href="#org349d2d9">核心代码</a></li>
<li><a href="#orga798f61">简单表达式的求值</a></li>
<li><a href="#org8543a13">过程应用的求值</a></li>
<li><a href="#org4f24f3d">过程应用</a></li>
<li><a href="#org4717f50">序列求值</a>
<ul>
<li><a href="#org805b9d1">尾递归</a></li>
</ul>
</li>
<li><a href="#org11dbf11">条件表达式</a></li>
<li><a href="#org74c06b4">赋值表达式</a></li>
<li><a href="#org657f1cb">定义表达式</a></li>
<li><a href="#org6476f43">驱动循环</a></li>
<li><a href="#org6159b71">构造求值器对应的寄存器机器模型</a></li>
</ul>
</li>
<li><a href="#orgd5cdca1">显示求值器的运行</a>
<ul>
<li><a href="#org33b1252">监视求值器的执行</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<p>
用 <span class="underline">寄存器语言</span> 实现 <span class="underline">求值器</span> 是低层次的工作，能揭示 Scheme 程序解释中的许多前面无法涉及的控制细节，包括：
</p>
<ul class="org-ul">
<li>过程调用时 <b>参数值的传递</b> 和 <b>结果返回</b></li>
<li><b>尾递归</b> 的实现</li>
</ul>

<pre class="example">
  这里还可以继续用前面求值器的基本数据结构和语法过程

  完全可以用更基本的操作实现，做出一个可以直接对应到常规高级语言或常规机器语言的求值器
</pre>
<div id="outline-container-org88906f6" class="outline-2">
<h2 id="org88906f6">内存管理</h2>
<div class="outline-text-2" id="text-org88906f6">
<p>
为简化讨论，先假定有一个 <b>表结构</b> 的内存， <span class="underline">表操作</span> 都是基本操作
</p>
<pre class="example">
    这种抽象使人能集中精力考虑求值器的关键特征

    但表存储是 Scheme 的基础，不理解它，对系统的理解有缺陷

    为完整起见，下面先讨论怎样在常规的内存上实现表存储结构
</pre>

<p>
表结构的实现要考虑两个问题：
</p>
<ol class="org-ol">
<li>表示： 如何只用典型计算机的 <span class="underline">存储单元</span> 和 <span class="underline">寻址</span> 功能，把 <b>序对</b> 的 <span class="underline">指针盒子</span> 结构映射到常规计算机的连续内存</li>
<li>实现： 把管理内存的工作实现为一个计算过程</li>
</ol>
<pre class="example">
    要支持 Scheme 程序的执行，系统必须能随时创建对象，包括：

    程序里用的序对和其他对象
    支持程序执行而隐式创建的对象，如环境、框架和参数表等

    程序执行中可能创建很多对象，创建的数量并没有限制
</pre>

<p>
如果计算机的存储无穷大，就可以创建任意多个对象。但 <b>实际计算机的存储总有限</b> ，因此需要有一种自动机制：利用有限的存储制造一种无穷假象， <b>当已分配的对象不再需要时自动将其回收</b> 。这就是 <span class="underline">垃圾回收</span> 
</p>
</div>
<div id="outline-container-org9da2204" class="outline-3">
<h3 id="org9da2204">向量模拟内存</h3>
<div class="outline-text-3" id="text-org9da2204">
<p>
常规计算机的内存是一串很小的单元：
</p>
<ul class="org-ul">
<li>每个单元里可保存一点信息，有一个唯一的名字称为 <span class="underline">地址</span></li>
<li>典型操作：
<ul class="org-ul">
<li><b>读特定单元的内容</b></li>
<li><b>给特定单元赋新值</b></li>
</ul></li>
<li>通过 <span class="underline">地址增量</span> 操作可以 <b>顺序地访问</b> 一批单元</li>
</ul>
<pre class="example">
     有些操作（指针）要求把地址作为数据，将其存入内存单元，或在寄存器里对地址做各种运算

     “表处理”是指针运算的典型实例
</pre>

<p>
为模拟计算机内存，下面介绍一种新数据结构称为 <b>向量</b> 。向量是一种复合数据对象，其元素可通过 <b>整数下标</b> 访问，访问所需时间与元素位置无关。用两个过程描述向量操作：
</p>
<ol class="org-ol">
<li><span class="underline">(vector-ref &lt;vector&gt; &lt;n&gt;)</span> : 返回向量里的第 n 个元素</li>
<li><span class="underline">(vector-set! &lt;vector&gt; &lt;n&gt; &lt;value&gt;)</span> : 向量里第 n 个元素赋值为 &lt;v&gt;</li>
</ol>

<p>
对计算机内存单元的访问可以通过 <b>地址算术</b> 实现（用 <span class="underline">向量基址</span> 加 <span class="underline">特定元素的偏移量</span> ） 
</p>

<pre class="example">
     新型计算机内存已很难用简单向量表现

     它们有复杂的缓存系统，复杂的缓存一致性算法
     多核的加入使情况进一步复杂化，理解其细节行为变得更加困难，需要通过复杂的模拟

     但这种抽象模型仍反映了它的一部分情况和性质
</pre>
</div>
<div id="outline-container-orgc947912" class="outline-4">
<h4 id="orgc947912">Scheme 序对的表示</h4>
<div class="outline-text-4" id="text-orgc947912">
<p>
用向量实现表存储器所需的序对结构：
</p>
<ol class="org-ol">
<li>设想两个向量 <span class="underline">the-cars</span> 和 <span class="underline">the-cdrs</span></li>
<li><span class="underline">指向序对的指针</span> 用 <b>向量的下标</b> 表示， <span class="underline">序对的 car</span> 就是 <span class="underline">向量 the-cars</span> 里 <b>特定元素的内容</b> ，cdr 类似</li>
</ol>


<div class="figure">
<p><img src="pic/pair-representaion.gif" alt="pair-representaion.gif" width="60%" /> 
</p>
</div>

<p>
非序对数据用 <b>带类型指针</b> 表示。为此要扩充指针增加类型信息：
</p>
<ul class="org-ul">
<li>可以在指针里加 <span class="underline">标志位</span></li>
<li>如果有带标志位的硬件机器，也可利用地址中不用的位</li>
</ul>

<pre class="example">
eq? 就是比较指向序对的指针的值是否相同
</pre>
<p>
<b>符号</b> 用 <span class="underline">带类型指针</span> 表示：
</p>
<ul class="org-ul">
<li>实际的 Scheme 系统里有一个 <b>符号表</b> ，称为 <span class="underline">对象表</span> 
<ul class="org-ul">
<li>读入遇到新符号时 <span class="underline">创建表项</span> ，取得 <span class="underline">符号指针</span></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org2efd4e9" class="outline-4">
<h4 id="org2efd4e9">基本表操作实现</h4>
<div class="outline-text-4" id="text-org2efd4e9">
<pre class="example">
      有了序对的上述表示，基本表操作都可以“代换”为向量操作
</pre>
<p>
下面假定有 <span class="underline">向量访问</span> 和 <span class="underline">赋值</span> ， <span class="underline">指针算术运算</span> ： 
</p>

<p>
寄存器机器支持的 <span class="underline">赋值</span>  指令 ：
</p>

<pre class="example">
;;; reg2 寄存器中存放了一个序对在向量数组的下标，把这个序对的car内容放入到 reg1 寄存器
(assign &lt;reg1&gt; (op car) (reg &lt;reg2&gt;))

;;; reg2 寄存器中存放了一个序对在向量数组的下标，把这个序对的car内容放入到 reg1 寄存器
(assign &lt;reg1&gt; (op cdr) (reg &lt;reg2&gt;))
</pre>

<p>
可以实现为： 
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">&#31867;&#20284;&#20110;&#35843;&#29992; (vector-ref the-cars reg2)</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">the-cars &#23492;&#23384;&#22120;:  cars &#21521;&#37327;&#30340;&#22522;&#30784;&#22320;&#22336;</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">reg2 &#23492;&#23384;&#22120;: &#24207;&#23545;&#22312;&#21521;&#37327;&#25968;&#32452;&#30340;&#19979;&#26631;</span>
<span style="color: #696969;">(</span>assign <span style="color: #98f5ff;">&lt;reg1&gt;</span> <span style="color: #696969;">(</span>op vector-ref<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg the-cars<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg <span style="color: #98f5ff;">&lt;reg2&gt;</span><span style="color: #696969;">))</span>

<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">&#31867;&#20284;&#20110;&#35843;&#29992; (vector-ref the-cdrs reg2)</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">the-cdrs &#23492;&#23384;&#22120;:  cdrs &#21521;&#37327;&#30340;&#22522;&#30784;&#22320;&#22336;</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">reg2 &#23492;&#23384;&#22120;: &#24207;&#23545;&#22312;&#21521;&#37327;&#25968;&#32452;&#30340;&#19979;&#26631;</span>
<span style="color: #696969;">(</span>assign <span style="color: #98f5ff;">&lt;reg1&gt;</span> <span style="color: #696969;">(</span>op vector-ref<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg the-cdrs<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg <span style="color: #98f5ff;">&lt;reg2&gt;</span><span style="color: #696969;">))</span>
</pre>
</div>

<p>
寄存器机器的 <span class="underline">执行</span> 指令：
</p>

<pre class="example">
;;; 把 reg1 寄存器的内容 赋值给 reg2寄存器对应的序对的car上
(perform (op set-car!) (reg &lt;reg1&gt;) (reg &lt;reg2&gt;))

;;; 把 reg1 寄存器的内容 赋值给 reg2寄存器对应的序对的cdr上
(perform (op set-cdr!) (reg &lt;reg1&gt;) (reg &lt;reg2&gt;))
</pre>

<p>
实现为： 
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">&#36825;&#37324;&#35843;&#29992; (vector-set! the-cars reg2 reg1)</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">the-cars &#23492;&#23384;&#22120;&#65306;cars&#21521;&#37327;&#30340;&#22522;&#30784;&#22320;&#22336;</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">reg1 &#23492;&#23384;&#22120;: &#36171;&#20540;&#20869;&#23481;</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">reg2 &#23492;&#23384;&#22120;: &#24207;&#23545;&#19979;&#26631;</span>
<span style="color: #696969;">(</span>perform
 <span style="color: #696969;">(</span>op vector-set!<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg the-cars<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg <span style="color: #98f5ff;">&lt;reg1&gt;</span><span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg <span style="color: #98f5ff;">&lt;reg2&gt;</span><span style="color: #696969;">))</span>

<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">&#36825;&#37324;&#35843;&#29992; (vector-set! the-cdrs reg2 reg1)</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">the-cdrs &#23492;&#23384;&#22120;&#65306;cdrs&#21521;&#37327;&#30340;&#22522;&#30784;&#22320;&#22336;</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">reg1 &#23492;&#23384;&#22120;: &#36171;&#20540;&#20869;&#23481;</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">reg2 &#23492;&#23384;&#22120;: &#24207;&#23545;&#19979;&#26631;</span>
<span style="color: #696969;">(</span>perform
 <span style="color: #696969;">(</span>op vector-set!<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg the-cdrs<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg <span style="color: #98f5ff;">&lt;reg1&gt;</span><span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg <span style="color: #98f5ff;">&lt;reg2&gt;</span><span style="color: #696969;">))</span>
</pre>
</div>

<p>
执行 cons 时 <b>创建</b> 新序对单元，分别存入相应的 <span class="underline">car</span> 和 <span class="underline">cdr</span> 。假定特殊寄存器 <b>free</b>  总指向一个空闲下标，增加其值可得到下一可用下标（要
求空闲位置连续）。这时 <span class="underline">cons</span> 指令 可以实现为： 
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">(vector-set! the-cars free reg2) </span>
<span style="color: #696969;">(</span>perform
 <span style="color: #696969;">(</span>op vector-set!<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg the-cars<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg free<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg <span style="color: #98f5ff;">&lt;reg2&gt;</span><span style="color: #696969;">))</span>

<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">(vector-set! the-cdrs free reg3) </span>
<span style="color: #696969;">(</span>perform
 <span style="color: #696969;">(</span>op vector-set!<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg the-cdrs<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg free<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg <span style="color: #98f5ff;">&lt;reg3&gt;</span><span style="color: #696969;">))</span>

<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">free &#36171;&#20540;&#32473; reg1  </span>
<span style="color: #696969;">(</span>assign <span style="color: #98f5ff;">&lt;reg1&gt;</span> <span style="color: #696969;">(</span>reg free<span style="color: #696969;">))</span>

<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">free &#30340;&#20540;&#22686;&#21152; 1 </span>
<span style="color: #696969;">(</span>assign free <span style="color: #696969;">(</span>op +<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg free<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>const 1<span style="color: #696969;">))</span>
</pre>
</div>

<p>
<span class="underline">eq?</span> 操作只是简单比较 reg1 和 reg2 的值是否相同（向量中的下标值是否相同） 
</p>
<pre class="example">
(op eq?) (reg &lt;reg1&gt;) (reg &lt;reg2&gt;) 
</pre>

<p>
<span class="underline">pair?</span> ,  <span class="underline">null?</span> ,  <span class="underline">symbol?</span> ,  <span class="underline">number?</span> 等操作还必须检查 <b>指针的类型</b> 是否相同
</p>
</div>
</div>
<div id="outline-container-org8b2a60e" class="outline-4">
<h4 id="org8b2a60e">栈实现</h4>
<div class="outline-text-4" id="text-org8b2a60e">
<p>
寄存器机器需要的 <span class="underline">栈</span> 可以用 <b>表</b> 模拟， <span class="underline">栈头序对</span> 在 <span class="underline">向量中的下标</span> （栈顶地址）用一个特殊寄存器 <b>the-stack</b> 来存放
</p>

<pre class="example">
      这些操作都可以基于前面使用向量模拟的内存

      实际系统里考虑实现效率，常另用一个向量来实现栈，压栈和出栈操作用改变栈顶寄存器的指针值来实现
</pre>

<p>
压栈    <span class="underline">(save &lt;reg&gt;)</span> 可以实现为： 
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">(cons reg the-stack) </span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">reg &#23492;&#23384;&#22120;: &#24207;&#23545;&#30340;&#19979;&#26631;</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">the stack &#23492;&#23384;&#22120;: &#26632;&#39030;&#23545;&#24212;&#30340;&#19979;&#26631;</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">cons&#36820;&#22238;&#30340;&#26032;&#30340;&#24207;&#23545;&#30340;&#19979;&#26631;&#20250;&#34987;&#36171;&#20540;&#32473; the-stack &#23492;&#23384;&#22120;&#65292;&#36825;&#30456;&#24403;&#20110;&#20462;&#25913;&#20102;&#26632;&#39030;&#25351;&#38024;</span>
<span style="color: #696969;">(</span>assign the-stack <span style="color: #696969;">(</span>op cons<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg <span style="color: #98f5ff;">&lt;reg&gt;</span><span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg the-stack<span style="color: #696969;">))</span>
</pre>
</div>

<p>
出栈    <span class="underline">(restore &lt;reg&gt;)</span> 实现为： 
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">&#20174;&#26632;&#39030;&#35835;&#21462;&#20540;</span>
<span style="color: #696969;">(</span>assign <span style="color: #98f5ff;">&lt;reg&gt;</span> <span style="color: #696969;">(</span>op car<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg the-stack<span style="color: #696969;">))</span>

<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">&#8220;&#26632;&#39030;&#23492;&#23384;&#22120;&#8221;&#36171;&#20540;&#20026;&#8220;&#24403;&#21069;&#26632;&#39030;&#24207;&#23545;&#30340;cdr&#8221;&#30340;&#8220;&#21521;&#37327;&#19979;&#26631;&#8221;</span>
<span style="color: #696969;">(</span>assign the-stack <span style="color: #696969;">(</span>op cdr<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg the-stack<span style="color: #696969;">))</span>
</pre>
</div>

<p>
初始化栈    <span class="underline">(perform (op initialize-stack))</span> 实现为：
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span>assign the-stack <span style="color: #696969;">(</span>const <span style="color: #696969;">()))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org356076d" class="outline-3">
<h3 id="org356076d">垃圾回收机制</h3>
<div class="outline-text-3" id="text-org356076d">
<pre class="example">
     表结构的实现问题已经解决了，但有前提：保证执行 cons 时总有可用的自由空间，为此需要无穷大的存储

     而在实际计算中不断执行 cons，最终将用尽整个序对空间
</pre>

<p>
观察到： 所建立的序对里的很多都是用于保存各种 <b>临时</b> 数据
</p>
<ul class="org-ul">
<li>中间结果</li>
<li>临时建立的环境框架</li>
<li>&#x2026;&#x2026;</li>
</ul>
<p>
相关数据用过后可以被丢弃，其存储也没有必要继续保留 
</p>

<pre class="example">
(accumulate + 0 (filter odd? (enumerate-interval 0 n)))

执行过程中构造了两个表：枚举表和奇数表，求和完成后都不再需要了
</pre>

<p>
系统需要做出一种安排， <span class="underline">周期性</span> 地 <b>回收</b> <span class="underline">已分配但不再有用</span> 的内存。如果回收与分配的速度相当，而且程序每个时刻实际使用的单元不多于可供应的单元，系统就可以永远运转。这造成了一种无穷大存储的假象
</p>

<pre class="example">
     要回收不用的序对，需要确定那些需对确实没用了，也就是说，其（内容）存在与否对后面的计算没有任何影响
</pre>
<p>
下面提出的方法称为 <b>垃圾收集</b> ，其基本思想：
</p>
<ol class="org-ol">
<li>确定所有的有用单元：从 <span class="underline">当前所有寄存器的内容</span> 出发，通过一系列的 <span class="underline">car/cdr 操作</span>  <b>可以到达</b> 的单元</li>
<li>不可达的单元都可以回收</li>
</ol>

<pre class="example">
     典型的基本垃圾回收方法有两类，后来有许多发展：
     包括分代式垃圾回收，并行垃圾回收，以及各种更复杂的环境里的垃圾回收等

     垃圾回收已经成为支持软件系统运行的基本技术
</pre>

<p>
简单的垃圾回收工作周期性地进行：
</p>
<ul class="org-ul">
<li>当时工作存储区满时中断计算，启动新一轮垃圾回收</li>
<li>回收完成后重启暂停的计算工作</li>
</ul>
</div>

<div id="outline-container-org54aa9cc" class="outline-4">
<h4 id="org54aa9cc">垃圾回收算法</h4>
<div class="outline-text-4" id="text-org54aa9cc">
<p>
最早的技术称为“标记和清扫”(mark and sweep)，工作方式：
</p>
<ol class="org-ol">
<li>从寄存器出发沿car 和 cdr 指针周游单元存储区，给单元加标记</li>
<li>扫描整个存储器，回收无标记单元</li>
</ol>
<pre class="example">
      标记清除算法最主要的缺点是会形成内存碎片
</pre>
<p>
另一种技术 (stop-and-move)，基于复制有用对象（搬迁有用的对象），基本想法：把一片存储区里的有用对象都搬走，使得整个存储区都可以重用了
</p>
<ul class="org-ul">
<li>存储区分为相等的两个半区 <span class="underline">工作存储区</span> 和 <span class="underline">自由存储区</span></li>
<li>cons 总在 <span class="underline">工作存储区</span> 里顺序分配，每次分配下一位置</li>
<li><span class="underline">工作存储区</span> 满时做垃圾收集，把 所有 <b>有用序对</b> 搬到 <span class="underline">自由存储区</span> 
<ul class="org-ul">
<li>从所有寄存器出发追踪 <span class="underline">car</span>  和 <span class="underline">cdr</span> 指针</li>
</ul></li>
<li>如果工作存储区里存在无用单元，搬迁完成后自由存储区应 <b>剩下可用于分配的空闲单元</b></li>
<li>完成一次搬迁后 <b>交换</b> <span class="underline">工作存储区</span> 和 <span class="underline">自由存储区</span> 的地位</li>
</ul>

<pre class="example">
      复制算法的优点是效率更高，缺点是可用内存减少为一半
</pre>
</div>

<div id="outline-container-org34c053c" class="outline-5">
<h5 id="org34c053c">复制垃圾回收算法的实现</h5>
<div class="outline-text-5" id="text-org34c053c">
<ul class="org-ul">
<li>假定寄存器 root 值为一个指针，从所指的结构可以到达所有在用单元</li>
<li><span class="underline">the-cars</span> 和 <span class="underline">the-cdrs</span> 指向的两个向量是 <b>工作区</b></li>
<li><span class="underline">new-cars</span> 和 <span class="underline">new-cdrs</span> 指的两个向量是 <b>自由区</b></li>
<li><span class="underline">free</span> 指向 <span class="underline">工作区里第一个空闲单元</span> ，它的值随着分配移动，到达存储器右端时：空闲单元已用完</li>
<li>废料收集前后情况如图</li>
<li><p>
收集完成后 <b>交换两对向量指针</b> ，实现存储区的 <span class="underline">切换</span> 
</p>


<div class="figure">
<p><img src="pic/stop-and-move.gif" alt="stop-and-move.gif" width="70%" /> 
</p>
</div></li>
</ul>

<p>
收集过程维护两个指针 <b>free</b> 和 <b>scan</b> ，收集的 <span class="underline">初始化</span> 操作：
</p>
<ol class="org-ol">
<li>把 free 和 scan 设置为指向 <span class="underline">自由区起点</span></li>
<li>把 <span class="underline">root 所指单元</span> 复制到 <span class="underline">自由区的第一个单元</span></li>
<li><span class="underline">root 所指单元的 car</span> 设一个 <b>特殊标志</b> ， <span class="underline">root 所指单元的 cdr</span>  设为 <b>free</b>  (单元新位置)</li>
<li><span class="underline">root</span>  指向 <b>新位置</b> ，更新 free 使之指向 <b>下一空单元</b></li>
</ol>

<pre class="example">
       注意：scan 指向已移入新区(收集前的 自由区 ) 的单元，但其 car 和 cdr 所指单元可能还在老的工作区
</pre>

<p>
收集过程: 若scan &lt; free，反复做： 
</p>
<ul class="org-ul">
<li>若 scan 所指单元的 car 还在老区就将它搬到新区 free 处。设置原单元的 car 为特殊标志，cdr 为 free，将 free 增加一个单元</li>
<li>若 scan 所指单元的 cdr还在老区就将它搬到新区free 处。置原单元的 car 为特殊标志，cdr 为 free，将 free 增加一个单元</li>
<li>若发现被 scan 所指单元的 car/cdr 所指的老区单元有特殊标志，则更新这个 car/cdr，使之正确指向该单元的新位置</li>
<li>反复上述操作至 <span class="underline">scan</span> 和 <span class="underline">free</span>  <b>相等时</b> 收集完成</li>
</ul>
</div>
</div>

<div id="outline-container-org76d662f" class="outline-5">
<h5 id="org76d662f">寄存器语言实现垃圾回收</h5>
<div class="outline-text-5" id="text-org76d662f">
<p>
用寄存器机器语言描述算法。关键代码段 <b>relocate-old-result-in-new</b> 给表单元确定新位置，被移对象由寄存器 <span class="underline">old</span> 当时的值确定，新位置由
寄存器 <span class="underline">free</span> 当前值确定。将新位置存入寄存器 <span class="underline">new</span> 并更新 <b>free</b> 。最后根据寄存器 <span class="underline">relocate-continue</span> 的值转跳返回
</p>

<p>
启动垃圾收集后首先设置 <span class="underline">scan</span> 和 <span class="underline">free</span> ，而后调用上述子程序先为 root 所指单元重新分配位置
</p>

<div class="org-src-container">
<pre class="src src-scheme">begin-garbage-collection
<span style="color: #696969;">(</span>assign free <span style="color: #696969;">(</span>const 0<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>assign scan <span style="color: #696969;">(</span>const 0<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>assign old <span style="color: #696969;">(</span>reg root<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#35753; old &#25351;&#21521;&#32769;&#24037;&#20316;&#21306;&#37324;&#34987;&#22788;&#29702;&#30340;&#21333;&#20803; </span>
<span style="color: #696969;">(</span>assign relocate-continue <span style="color: #696969;">(</span>label reassign-root<span style="color: #696969;">))</span> 
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label relocate-old-result-in-new<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#23558; root &#21333;&#20803;&#25644;&#21040;&#26032;&#21306;</span>

reassign-root
<span style="color: #696969;">(</span>assign root <span style="color: #696969;">(</span>reg new<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#35753; root &#25351;&#21521;&#32467;&#28857;&#30340;&#26032;&#20301;&#32622;</span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label gc-loop<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;;  </span><span style="color: #5f9ea0; font-style: italic;">&#35843;&#29992;&#22522;&#26412; gc &#24490;&#29615;</span>
</pre>
</div>

<p>
gc-loop 主循环：
</p>
<div class="org-src-container">
<pre class="src src-scheme">gc-loop
<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#26816;&#26597;&#26159;&#21542;&#36824;&#26377;&#26410;&#25195;&#25551;&#21333;&#20803; (scan &#19981;&#31561;&#20110; free)</span>
<span style="color: #696969;">(</span>test <span style="color: #696969;">(</span>op =<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg scan<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg free<span style="color: #696969;">))</span> 
<span style="color: #696969;">(</span>branch <span style="color: #696969;">(</span>label gc-flip<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#22522;&#26412;&#25910;&#38598;&#24490;&#29615;&#32467;&#26463;&#65292;&#26368;&#21518;&#25910;&#23614;</span>
<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#23558; old &#35774;&#20026;&#26032;&#21306;&#20013; scan &#25351;&#21521;&#30340;&#21333;&#20803;&#30340; car &#25152;&#25351;&#30340;&#21333;&#20803;&#65288;&#21487;&#33021;&#26159;&#38656;&#35201;&#25644;&#36801;&#30340;&#19979;&#19968;&#20010;&#32769;&#21306;&#21333;&#20803;&#65292;&#20063;&#21487;&#33021;&#24050;&#32463;&#25644;&#36807;&#26469;&#20102;&#65289;</span>
<span style="color: #696969;">(</span>assign old <span style="color: #696969;">(</span>op vector-ref<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg new-cars<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg scan<span style="color: #696969;">))</span>
<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#23558; relocate-continue &#23492;&#23384;&#22120;&#35774;&#32622;&#20026; update-car &#65306;&#22240;&#20026;&#22797;&#21046;&#23436;&#32769;&#30340;car&#21518;&#65292;&#36824;&#24517;&#39035;&#26356;&#26032;&#24207;&#23545;&#30340;car&#30340;&#20540;&#65288;&#26032;&#24037;&#20316;&#21306;&#30340;&#19979;&#26631;&#20540;&#65289;</span>
<span style="color: #696969;">(</span>assign relocate-continue <span style="color: #696969;">(</span>label update-car<span style="color: #696969;">))</span>
<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#25191;&#34892; relocate-old-result-in-new &#26631;&#21495;&#20301;&#32622;&#30340;&#20195;&#30721;&#65306;&#23454;&#38469;&#22788;&#29702;scan&#25351;&#21521;&#30340;car&#21333;&#20803;&#30340;&#25644;&#36801;&#24037;&#20316;</span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label relocate-old-result-in-new<span style="color: #696969;">))</span> 
</pre>
</div>

<p>
update-car 操作： 
</p>
<div class="org-src-container">
<pre class="src src-scheme">update-car
<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#23558; scan &#25152;&#25351;&#21333;&#20803;&#30340; car &#35774;&#32622;&#20026; new</span>
<span style="color: #696969;">(</span>perform <span style="color: #696969;">(</span>op vector-set!<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg new-cars<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg scan<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg new<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;;  </span><span style="color: #5f9ea0; font-style: italic;">&#23492;&#23384;&#22120; new &#37324;&#26159; car &#25152;&#25351;&#21333;&#20803;&#30340;&#26032;&#20301;&#32622;</span>
<span style="color: #5f9ea0; font-style: italic;">;;  </span><span style="color: #5f9ea0; font-style: italic;">&#23558; old &#35774;&#20026;&#26032;&#21306;&#20013; scan &#25351;&#21521;&#30340;&#21333;&#20803;&#30340; cdr &#25152;&#25351;&#30340;&#21333;&#20803;&#65288;&#21487;&#33021;&#26159;&#38656;&#35201;&#25644;&#36801;&#30340;&#19979;&#19968;&#20010;&#32769;&#21306;&#21333;&#20803;&#65292;&#20063;&#21487;&#33021;&#24050;&#32463;&#25644;&#36807;&#26469;&#20102;&#65289;</span>
<span style="color: #696969;">(</span>assign old <span style="color: #696969;">(</span>op vector-ref<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg new-cdrs<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg scan<span style="color: #696969;">))</span>
<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#23558; relocate-continue &#23492;&#23384;&#22120;&#35774;&#32622;&#20026; update-cdr &#65306;&#22240;&#20026;&#22797;&#21046;&#23436;&#32769;&#30340;cdr&#21518;&#65292;&#36824;&#24517;&#39035;&#26356;&#26032;&#24207;&#23545;&#30340;cdr&#30340;&#20540;&#65288;&#26032;&#24037;&#20316;&#21306;&#30340;&#19979;&#26631;&#20540;&#65289;</span>
<span style="color: #696969;">(</span>assign relocate-continue <span style="color: #696969;">(</span>label update-cdr<span style="color: #696969;">))</span>
<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#22788;&#29702;scan&#25351;&#21521;&#30340;cdr&#21333;&#20803;&#30340;&#25644;&#36801;&#24037;&#20316;</span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label relocate-old-result-in-new<span style="color: #696969;">))</span> 
</pre>
</div>

<p>
update-cdr 操作：
</p>
<div class="org-src-container">
<pre class="src src-scheme">update-cdr
  <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#23558; scan &#25152;&#25351;&#21333;&#20803;&#30340; cdr &#35774;&#32622;&#20026; new</span>
  <span style="color: #696969;">(</span>perform <span style="color: #696969;">(</span>op vector-set!<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg new-cdrs<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg scan<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg new<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#23492;&#23384;&#22120; new &#37324;&#26159; car &#25152;&#25351;&#21333;&#20803;&#30340;&#26032;&#20301;&#32622;</span>
  <span style="color: #696969;">(</span>assign scan <span style="color: #696969;">(</span>op +<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg scan<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>const 1<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">scan &#33258;&#22686; 1 </span>
  <span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label gc-loop<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#37325;&#21551;&#22403;&#22334;&#25910;&#38598;&#20027;&#24490;&#29615;</span>
</pre>
</div>

<p>
relocate-old-result-in-new 核心过程：
</p>
<div class="org-src-container">
<pre class="src src-scheme">relocate-old-result-in-new
<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#27979;&#35797;&#25351;&#38024;&#31867;&#22411;&#26159;&#21542;&#26159;&#8220;&#24207;&#23545;&#8221;</span>
<span style="color: #696969;">(</span>test <span style="color: #696969;">(</span>op pointer-to-pair?<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg old<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>branch <span style="color: #696969;">(</span>label pair<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>assign new <span style="color: #696969;">(</span>reg old<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>reg relocate-continue<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#38750;&#24207;&#23545;&#23545;&#35937;&#65292;&#30452;&#25509;&#36820;&#22238; </span>

pair
<span style="color: #696969;">(</span>assign oldcr <span style="color: #696969;">(</span>op vector-ref<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg the-cars<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg old<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>test <span style="color: #696969;">(</span>op broken-heart?<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg oldcr<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#36825;&#20010;&#23545;&#35937;&#26159;&#21542;&#24050;&#32463;&#22238;&#25910;&#36807;&#65311; </span>
<span style="color: #696969;">(</span>branch <span style="color: #696969;">(</span>label already-moved<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>assign new <span style="color: #696969;">(</span>reg free<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">; </span><span style="color: #5f9ea0; font-style: italic;">new &#23492;&#23384;&#22120;&#35774;&#32622;&#20026; free &#23492;&#23384;&#22120;&#30340;&#20540;</span>
<span style="color: #696969;">(</span>assign free <span style="color: #696969;">(</span>op +<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg free<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>const 1<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">free &#23492;&#23384;&#22120;&#33258;&#22686; 1 </span>
<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#23558;&#36825;&#20010;&#21333;&#20803;&#30340; car &#21644; cdr &#25335;&#36125;&#21040;&#26032;&#20301;&#32622;</span>
<span style="color: #696969;">(</span>perform <span style="color: #696969;">(</span>op vector-set!<span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span>reg new-cars<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg new<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg oldcr<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>assign oldcr <span style="color: #696969;">(</span>op vector-ref<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg the-cdrs<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg old<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>perform <span style="color: #696969;">(</span>op vector-set!<span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span>reg new-cdrs<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg new<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg oldcr<span style="color: #696969;">))</span> 
<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#26500;&#24314; broken heart&#65306;&#22312;&#21407;&#20301;&#32622;&#35774;&#32622;&#30340; car &#35774;&#25644;&#36801;&#26631;&#24535;&#65292;cdr &#35774;&#32034;&#24341;&#25351;&#38024;</span>
<span style="color: #696969;">(</span>perform <span style="color: #696969;">(</span>op vector-set!<span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span>reg the-cars<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg old<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>const broken-heart<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>perform
 <span style="color: #696969;">(</span>op vector-set!<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg the-cdrs<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg old<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg new<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>reg relocate-continue<span style="color: #696969;">))</span>

already-moved
<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#21333;&#20803;&#24050;&#22312;&#26032;&#21306;&#65292;&#30452;&#25509;&#35774;&#32622; new &#21518;&#36820;&#22238;</span>
<span style="color: #696969;">(</span>assign new <span style="color: #696969;">(</span>op vector-ref<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg the-cdrs<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg old<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>reg relocate-continue<span style="color: #696969;">))</span>
</pre>
</div>

<p>
收尾工作 gc-flip ：交换两个（半）存储区的地位
</p>
<div class="org-src-container">
<pre class="src src-scheme">gc-flip
  <span style="color: #696969;">(</span>assign temp <span style="color: #696969;">(</span>reg the-cdrs<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span>assign the-cdrs <span style="color: #696969;">(</span>reg new-cdrs<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span>assign new-cdrs <span style="color: #696969;">(</span>reg temp<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span>assign temp <span style="color: #696969;">(</span>reg the-cars<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span>assign the-cars <span style="color: #696969;">(</span>reg new-cars<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span>assign new-cars <span style="color: #696969;">(</span>reg temp<span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-orgc6bb2aa" class="outline-2">
<h2 id="orgc6bb2aa">寄存求值器</h2>
<div class="outline-text-2" id="text-orgc6bb2aa">
<pre class="example">
    前面研究过把简单 Scheme 程序变换到寄存器机器描述

    下面考虑变换元循环求值器：基于eval 和 apply 实现的 Scheme 解释器
</pre>

<ul class="org-ul">
<li>这一工作的结果是一个 <b>显式控制</b> 的求值器，求值中过程调用的 <span class="underline">参数传递</span> 都基于 <b>寄存器</b> 和 <b>栈描述</b></li>
<li>这个寄存器语言描述接近 <span class="underline">常规机器语言</span> ，可以反映实际 Scheme 实现的许多情况，可用 <span class="underline">寄存器机器模拟器</span> 运行</li>
</ul>
<pre class="example">
  它反映了用常规机器语言实现 Scheme 解释器的基本结构

  可以从它出发实现真正能用的 Scheme 解释器，或者从它出发做出能解释 Scheme 程序的硬件处理器

Java 虚拟机（JVM）或其他脚本语言虚拟机，具有类似结构和功能
</pre>
</div>

<div id="outline-container-org20f14cd" class="outline-3">
<h3 id="org20f14cd">寄存器和操作</h3>
<div class="outline-text-3" id="text-org20f14cd">
<pre class="example">
     元循环求值器用了一些语法过程，如 quoted?, make-procedure 等

     如果做一个真正完整的寄存器机器，实际上需要把这些过程都展开为表操作。但那样做出的代码将非常长
</pre>

<p>
为简化描述，下面仍以 <span class="underline">元循环求值器</span> 的语法过程和 <span class="underline">表示环境</span> 的过程作为寄存器机器的基本过程。要真正实现这个求值器，还需基于 <b>更基本的操
作</b> 将这些操作展开，并使用前面讨论的 <b>表结构</b> 表示 
</p>

<p>
下面求值器里用一个 <span class="underline">栈</span> 和 7 个 <span class="underline">寄存器</span> ：
</p>
<ul class="org-ul">
<li><b>exp</b>  :  <span class="underline">表达式</span></li>
<li><b>val</b> : 在指定环境里求值表达式得到的 <span class="underline">结果</span></li>
<li><b>env</b>  : 当时 <span class="underline">环境</span></li>
<li><b>continue</b> : 用于实现 <span class="underline">递归</span></li>
<li>三个寄存器用于组合式的实现
<ul class="org-ul">
<li><b>proc</b> :  <span class="underline">过程对象</span></li>
<li><b>argl</b> : <span class="underline">实参值表</span></li>
<li><b>unev</b> :  辅助寄存器，意为 <span class="underline">未求值的表达式</span></li>
</ul></li>
</ul>

<p>
具体操作隐含在控制器代码里，不专门列出（不明确写数据通路） 
</p>
</div>
</div>

<div id="outline-container-org382e3cd" class="outline-3">
<h3 id="org382e3cd">显式求值器的实现</h3>
<div class="outline-text-3" id="text-org382e3cd">
</div>
<div id="outline-container-org349d2d9" class="outline-4">
<h4 id="org349d2d9">核心代码</h4>
<div class="outline-text-4" id="text-org349d2d9">
<p>
求值器核心部分从 <b>eval-dispatch</b> 开始：
</p>
<ol class="org-ol">
<li>基于 <span class="underline">env</span>  环境对 <span class="underline">exp</span>  求值</li>
<li>求出的值存在 <span class="underline">val</span></li>
<li>求值完成后按 <span class="underline">continue</span> 寄存器转移</li>
</ol>

<div class="org-src-container">
<pre class="src src-scheme">eval-dispatch <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#27714;&#20540;&#22120;&#26680;&#24515;&#20195;&#30721;</span>
<span style="color: #696969;">(</span>test <span style="color: #696969;">(</span>op self-evaluating?<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg exp<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#33258;&#27714;&#20540;&#34920;&#36798;&#24335;</span>
<span style="color: #696969;">(</span>branch <span style="color: #696969;">(</span>label ev-self-eval<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>test <span style="color: #696969;">(</span>op variable?<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg exp<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#21464;&#37327;&#34920;&#36798;&#24335;</span>
<span style="color: #696969;">(</span>branch <span style="color: #696969;">(</span>label ev-variable<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>test <span style="color: #696969;">(</span>op quoted?<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg exp<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#24341;&#29992;&#34920;&#36798;&#24335;</span>
<span style="color: #696969;">(</span>branch <span style="color: #696969;">(</span>label ev-quoted<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>test <span style="color: #696969;">(</span>op assignment?<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg exp<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#36171;&#20540;&#34920;&#36798;&#24335;</span>
<span style="color: #696969;">(</span>branch <span style="color: #696969;">(</span>label ev-assignment<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>test <span style="color: #696969;">(</span>op definition?<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg exp<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#23450;&#20041;&#34920;&#36798;&#24335;</span>
<span style="color: #696969;">(</span>branch <span style="color: #696969;">(</span>label ev-definition<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>test <span style="color: #696969;">(</span>op if?<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg exp<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#26465;&#20214;&#34920;&#36798;&#24335;</span>
<span style="color: #696969;">(</span>branch <span style="color: #696969;">(</span>label ev-if<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>test <span style="color: #696969;">(</span>op lambda?<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg exp<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">lambda &#34920;&#36798;&#24335;</span>
<span style="color: #696969;">(</span>branch <span style="color: #696969;">(</span>label ev-lambda<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>test <span style="color: #696969;">(</span>op begin?<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg exp<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">begin &#34920;&#36798;&#24335;</span>
<span style="color: #696969;">(</span>branch <span style="color: #696969;">(</span>label ev-begin<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>test <span style="color: #696969;">(</span>op application?<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg exp<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#36807;&#31243;&#34920;&#36798;&#24335;</span>
<span style="color: #696969;">(</span>branch <span style="color: #696969;">(</span>label ev-application<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label unknown-expression-type<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#26080;&#27861;&#27714;&#20540;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orga798f61" class="outline-4">
<h4 id="orga798f61">简单表达式的求值</h4>
<div class="outline-text-4" id="text-orga798f61">
<p>
下面几段代码处理各种简单表达式：
</p>
<div class="org-src-container">
<pre class="src src-scheme">ev-self-eval
<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">exp &#23492;&#23384;&#22120;&#30340;&#20540;&#30452;&#25509;&#25918;&#20837; val &#23492;&#23384;&#22120;</span>
<span style="color: #696969;">(</span>assign val <span style="color: #696969;">(</span>reg exp<span style="color: #696969;">))</span> 
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>reg continue<span style="color: #696969;">))</span>

ev-variable
<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">env &#29615;&#22659;&#20013;&#26597;&#25214; exp &#21464;&#37327;&#65292;&#32467;&#26524;&#25918;&#20837; val &#23492;&#23384;&#22120;</span>
<span style="color: #696969;">(</span>assign val <span style="color: #696969;">(</span>op lookup-variable-value<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg exp<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg env<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>reg continue<span style="color: #696969;">))</span>

ev-quoted
<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">exp &#23492;&#23384;&#22120;&#20013;&#30340;&#34920;&#36798;&#24335; &#20316;&#20026;&#21442;&#25968;&#35843;&#29992; text-of-quotation &#36807;&#31243;&#65292;&#25226;&#20540;&#25918;&#20837;&#21040; val &#23492;&#23384;&#22120;&#20316;&#20026;&#32467;&#26524;</span>
<span style="color: #696969;">(</span>assign val <span style="color: #696969;">(</span>op text-of-quotation<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg exp<span style="color: #696969;">))</span> 
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>reg continue<span style="color: #696969;">))</span>

ev-lambda
<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">exp &#34920;&#36798;&#24335;&#20013;&#33719;&#24471;&#24418;&#21442;&#34920;&#25918;&#20837;&#21040; unev &#23492;&#23384;&#22120;</span>
<span style="color: #696969;">(</span>assign unev <span style="color: #696969;">(</span>op lambda-parameters<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg exp<span style="color: #696969;">))</span>
<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">exp &#34920;&#36798;&#24335;&#20013;&#33719;&#24471;&#36807;&#31243;&#20307;&#25918;&#20837;&#21040; exp &#23492;&#23384;&#22120;</span>
<span style="color: #696969;">(</span>assign exp <span style="color: #696969;">(</span>op lambda-body<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg exp<span style="color: #696969;">))</span>
<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#24418;&#21442;&#34920;&#65292;&#36807;&#31243;&#20307;&#65292;&#24403;&#21069;&#29615;&#22659;&#35843;&#29992; make-procedure &#36807;&#31243;&#65292;&#21019;&#24314;&#19968;&#20010;&#26032;&#30340;&#21311;&#21517;&#36807;&#31243;&#65292;&#25918;&#20837;&#21040; val &#23492;&#23384;&#22120;</span>
<span style="color: #696969;">(</span>assign val <span style="color: #696969;">(</span>op make-procedure<span style="color: #696969;">)</span>
        <span style="color: #696969;">(</span>reg unev<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg exp<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg env<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>reg continue<span style="color: #696969;">))</span>
</pre>
</div>
<p>
处理 lambda 时：
</p>
<ol class="org-ol">
<li>先把 <span class="underline">形式参数表</span> 和 <span class="underline">过程体</span> 分别存入unev 和 exp</li>
<li>调用 <span class="underline">make-procedure</span> 构造过程对象</li>
</ol>
</div>
</div>

<div id="outline-container-org8543a13" class="outline-4">
<h4 id="org8543a13">过程应用的求值</h4>
<div class="outline-text-4" id="text-org8543a13">
<p>
过程应用是组合式，其参数是 <span class="underline">运算符</span> 和 <span class="underline">运算对象</span> ：
</p>
<ol class="org-ol">
<li>需要先求值 <span class="underline">运算符</span> 和 <span class="underline">运算对象</span></li>
<li>调用 <span class="underline">apply</span> 实现过程应用</li>
</ol>
<pre class="example">
      显式求值时也要做同样工作

      递归调用同样是利用栈实现，调用前保存一些寄存器，需要仔细考虑要保存哪些信息，怎样保存
</pre>

<p>
ev-application 指令： 过程应用的入口
</p>
<div class="org-src-container">
<pre class="src src-scheme">ev-application
<span style="color: #696969;">(</span>save continue<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#20445;&#23384;&#32493;&#28857;&#65292;&#22240;&#20026;&#20043;&#21518;&#20250;&#35774;&#32622;&#32493;&#28857;&#20026; ev-appl-did-operator</span>
<span style="color: #696969;">(</span>save env<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#20445;&#23384;&#29615;&#22659;&#65292;&#22240;&#20026;&#21518;&#38754;&#23545; operands &#27714;&#20540;&#38656;&#35201;</span>
<span style="color: #696969;">(</span>assign unev <span style="color: #696969;">(</span>op operands<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg exp<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#25226; operands &#34920;&#36798;&#24335;&#32531;&#23384;&#21040; unev </span>
<span style="color: #696969;">(</span>save unev<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#20445;&#23384; operands &#34920;&#36798;&#24335;</span>
<span style="color: #696969;">(</span>assign exp <span style="color: #696969;">(</span>op operator<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg exp<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#25226;&#36816;&#31639;&#31526; operator &#25918;&#20837;&#21040; exp&#23492;&#23384;&#22120; </span>
<span style="color: #696969;">(</span>assign continue <span style="color: #696969;">(</span>label ev-appl-did-operator<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#23545;&#36816;&#31639;&#31526;&#27714;&#20540;&#21518;&#65292;&#36716;&#21435;&#25191;&#34892; ev-appl-did-operator</span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label eval-dispatch<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#35843;&#29992; eval-dispatch &#26469;&#23545;&#36816;&#31639;&#31526;&#36827;&#34892;&#27714;&#20540;</span>
</pre>
</div>

<p>
上面代码把 ev-appl-did-operator 设为续点， <span class="underline">求值运算符表达式</span> 后转去执行 <span class="underline">ev-appl-did-operator</span> ，去求值各实参表达式。此时 ：
</p>
<ul class="org-ul">
<li>寄存器
<ul class="org-ul">
<li><span class="underline">val</span> ：求出的运算符对象的值</li>
</ul></li>
<li>栈：
<ul class="org-ul">
<li>第一项：运算参数表 (save unev)</li>
<li>第二项：环境 (save env)</li>
<li>地三项： ev-application 被调用时的 continue 寄存器的值 (save continue)</li>
</ul></li>
</ul>

<p>
ev-appl-did-operator ： 求值实参表达式 
</p>
<div class="org-src-container">
<pre class="src src-scheme">ev-appl-did-operator
<span style="color: #696969;">(</span>restore unev<span style="color: #696969;">)</span>  <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#24674;&#22797;&#36807;&#31243;&#21442;&#25968;&#34920;                </span>
<span style="color: #696969;">(</span>restore env<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#24674;&#22797;&#29615;&#22659;&#34920;</span>
<span style="color: #696969;">(</span>assign argl <span style="color: #696969;">(</span>op empty-arglist<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">argl &#23492;&#23384;&#22120;&#21021;&#22987;&#21270;&#20026;&#31354;&#21015;&#34920;</span>
<span style="color: #696969;">(</span>assign proc <span style="color: #696969;">(</span>reg val<span style="color: #696969;">))</span>  <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#23558;&#36816;&#31639;&#31526;&#36807;&#31243;&#23384;&#20837; proc &#23492;&#23384;&#22120;</span>
<span style="color: #696969;">(</span>test <span style="color: #696969;">(</span>op no-operands?<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg unev<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#27979;&#35797;&#36807;&#31243;&#21442;&#25968;&#34920;&#26159;&#21542;&#20026;&#31354;</span>
<span style="color: #696969;">(</span>branch <span style="color: #696969;">(</span>label apply-dispatch<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#22914;&#26524;&#36807;&#31243;&#21442;&#25968;&#34920;&#20026;&#31354;&#65292;&#21017;&#31435;&#21051;&#35843;&#29992; proc &#36816;&#31639;&#31526;</span>
<span style="color: #696969;">(</span>save proc<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#20445;&#23384;&#27714;&#20986;&#30340;&#36816;&#31639;&#31526;&#36807;&#31243;&#65292;&#32780;&#21518;&#21521;&#19979;&#27714;&#20540;&#36816;&#31639;&#23545;&#35937;</span>
ev-appl-operand-loop
  <span style="color: #696969;">(</span>save argl<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#20445;&#23384;&#23454;&#21442;&#34920;</span>
  <span style="color: #696969;">(</span>assign exp <span style="color: #696969;">(</span>op first-operand<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg unev<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#21462;&#20986;&#31532;&#19968;&#20010;&#36816;&#31639;&#23545;&#35937;&#34920;&#36798;&#24335; -&gt; exp &#23492;&#23384;&#22120;</span>
  <span style="color: #696969;">(</span>test <span style="color: #696969;">(</span>op last-operand?<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg unev<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#27979;&#35797;&#36825;&#20010;&#34920;&#36798;&#24335;&#26159;&#21542;&#26159;&#26368;&#21518;&#19968;&#20010;&#34920;&#36798;&#24335;</span>
  <span style="color: #696969;">(</span>branch <span style="color: #696969;">(</span>label ev-appl-last-arg<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#22914;&#26524;&#26159;&#36716;&#32780;&#25191;&#34892; ev-appl-last-arg </span>
  <span style="color: #696969;">(</span>save env<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#20445;&#23384;&#24403;&#21069;&#29615;&#22659;</span>
  <span style="color: #696969;">(</span>save unev<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#20445;&#23384;&#8220;&#25972;&#20010;&#23454;&#21442;&#34920;&#36798;&#24335;&#8221;&#32452;&#25104;&#30340;&#34920;</span>
  <span style="color: #696969;">(</span>assign continue <span style="color: #696969;">(</span>label ev-appl-accumulate-arg<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#32493;&#28857;&#35774;&#32622;&#20026; "ev-appl-accumulate-arg"&#65292;&#32047;&#21152;&#27714;&#20986;&#30340;&#23454;&#21442;&#20540;</span>
  <span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label eval-dispatch<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#27714;&#20540;&#31532;&#19968;&#20010;&#36816;&#31639;&#23545;&#35937;</span>
</pre>
</div>

<p>
ev-appl-accumulate-arg : 累加求值后的实参值
</p>
<div class="org-src-container">
<pre class="src src-scheme">ev-appl-accumulate-arg
  <span style="color: #696969;">(</span>restore unev<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#24674;&#22797;&#20445;&#23384;&#30340;&#23454;&#21442;&#34920;&#36798;&#24335;&#32452;&#25104;&#30340;&#34920; -&gt; unev </span>
  <span style="color: #696969;">(</span>restore env<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#24674;&#22797;&#29615;&#22659; -&gt; env </span>
  <span style="color: #696969;">(</span>restore argl<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#24674;&#22797;&#20445;&#23384;&#30340;&#24050;&#32463;&#27714;&#20540;&#36807;&#30340;&#23454;&#21442;&#20540;&#32452;&#25104;&#30340;&#34920; -&gt; argl </span>
  <span style="color: #696969;">(</span>assign argl <span style="color: #696969;">(</span>op adjoin-arg<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg val<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg argl<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#25226;&#27714;&#20986;&#30340;&#23454;&#21442;&#20540;&#28155;&#21152;&#21040;&#8220;&#24050;&#32463;&#27714;&#20540;&#30340;&#23454;&#21442;&#20540;&#32452;&#25104;&#30340;&#34920;&#8221; -&gt; argl &#23492;&#23384;&#22120;</span>
  <span style="color: #696969;">(</span>assign unev <span style="color: #696969;">(</span>op rest-operands<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg unev<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#8220;&#23454;&#21442;&#34920;&#36798;&#24335;&#32452;&#25104;&#30340;&#34920;&#8221;&#20013;&#21435;&#25481;&#24050;&#32463;&#21018;&#25165;&#27714;&#20540;&#30340;&#34920;&#36798;&#24335; -&gt; unev &#23492;&#23384;&#22120;</span>
  <span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label ev-appl-operand-loop<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#27714;&#20540;&#19979;&#19968;&#20010;&#23454;&#21442;&#34920;&#36798;&#24335;</span>
</pre>
</div>

<p>
ev-appl-last-arg : 求值最后一个实参表达式
</p>
<div class="org-src-container">
<pre class="src src-scheme">ev-appl-last-arg
<span style="color: #696969;">(</span>assign continue <span style="color: #696969;">(</span>label ev-appl-accum-last-arg<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#27714;&#20540;&#23436;&#26368;&#21518;&#19968;&#20010;&#36816;&#31639;&#23545;&#35937;&#21518;&#36716;&#21040; 'ev-appl-accum-last-arg' </span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label eval-dispatch<span style="color: #696969;">))</span>
ev-appl-accum-last-arg 
<span style="color: #696969;">(</span>restore argl<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#24674;&#22797;&#8220;&#24050;&#32463;&#27714;&#20540;&#30340;&#23454;&#21442;&#20540;&#34920;&#8220; -&gt; argl </span>
<span style="color: #696969;">(</span>assign argl <span style="color: #696969;">(</span>op adjoin-arg<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg val<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg argl<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#25226;&#26368;&#21518;&#19968;&#20010;&#35745;&#31639;&#20986;&#26469;&#30340;&#23454;&#21442;&#20540;&#28155;&#21152;&#21040;&#8220;&#24050;&#32463;&#27714;&#20540;&#30340;&#23454;&#21442;&#20540;&#34920;&#8220;  -&gt; argl </span>
<span style="color: #696969;">(</span>restore proc<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#24674;&#22797;&#27714;&#20540;&#36807;&#30340;&#36816;&#31639;&#31526;&#23545;&#35937; -&gt; proc </span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label apply-dispatch<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#35843;&#29992; apply &#36807;&#31243;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4f24f3d" class="outline-4">
<h4 id="org4f24f3d">过程应用</h4>
<div class="outline-text-4" id="text-org4f24f3d">
<p>
实际应用过程的工作，根据是 <span class="underline">基本过程</span> 还是 <span class="underline">复合过程</span> 分别处理。这时： 
</p>
<ul class="org-ul">
<li>寄存器
<ul class="org-ul">
<li><b>proc</b> : 运算符过程对象</li>
<li><b>argl</b>  : 实际参数表</li>
</ul></li>
<li>栈
<ul class="org-ul">
<li>第一项： apply 完成后应该转去的继续点（当初在 ev-application时候保存的 continue 寄存器的值）</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-scheme">apply-dispatch
  <span style="color: #696969;">(</span>test <span style="color: #696969;">(</span>op primitive-procedure?<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg proc<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#27979;&#35797;&#26159;&#21542;&#26159;&#22522;&#26412;&#36807;&#31243;</span>
  <span style="color: #696969;">(</span>branch <span style="color: #696969;">(</span>label primitive-apply<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span>test <span style="color: #696969;">(</span>op compound-procedure?<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg proc<span style="color: #696969;">))</span>  <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#27979;&#35797;&#26159;&#21542;&#26159;&#22797;&#21512;&#36807;&#31243;</span>
  <span style="color: #696969;">(</span>branch <span style="color: #696969;">(</span>label compound-apply<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label unknown-procedure-type<span style="color: #696969;">))</span>
</pre>
</div>

<p>
基本过程求值： 直接用 apply-primitive-procedure 完成过程应用
</p>
<div class="org-src-container">
<pre class="src src-scheme">primitive-apply
  <span style="color: #696969;">(</span>assign val <span style="color: #696969;">(</span>op apply-primitive-procedure<span style="color: #696969;">)</span>
              <span style="color: #696969;">(</span>reg proc<span style="color: #696969;">)</span>
              <span style="color: #696969;">(</span>reg argl<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span>restore continue<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>reg continue<span style="color: #696969;">))</span>
</pre>
</div>

<p>
复合过程：
</p>
<ol class="org-ol">
<li>先从 proc 里取出过程的 <span class="underline">形参表</span> 和 <span class="underline">环境</span></li>
<li>将 <span class="underline">env</span> 设置为 <b>扩充后的环境</b></li>
<li>取出过程体，转到 <b>序列求值</b> 代码的入口 <span class="underline">ev-sequence</span></li>
</ol>

<div class="org-src-container">
<pre class="src src-scheme">compound-apply 
<span style="color: #696969;">(</span>assign unev <span style="color: #696969;">(</span>op procedure-parameters<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg proc<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#21462;&#20986;&#36816;&#31639;&#31526;&#23545;&#35937;&#30340;&#24418;&#21442;&#34920; -&gt; unev </span>
<span style="color: #696969;">(</span>assign env <span style="color: #696969;">(</span>op procedure-environment<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg proc<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#21462;&#20986;&#36816;&#31639;&#31526;&#23545;&#35937;&#30340;&#29615;&#22659; -&gt; env </span>
<span style="color: #696969;">(</span>assign env <span style="color: #696969;">(</span>op extend-environment<span style="color: #696969;">)</span> 
        <span style="color: #696969;">(</span>reg unev<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg argl<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg env<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#25193;&#20805;&#36816;&#31639;&#31526;&#23545;&#35937;&#30340;&#29615;&#22659;&#65306;&#32465;&#23450;&#24418;&#21442;&#34920;&#21644;&#23454;&#21442;&#34920;</span>
<span style="color: #696969;">(</span>assign unev <span style="color: #696969;">(</span>op procedure-body<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg proc<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#21462;&#20986;&#36816;&#31639;&#31526;&#23545;&#35937;&#30340;&#36807;&#31243;&#20307; -&gt; unev </span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label ev-sequence<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#35843;&#29992;&#8220;&#24207;&#21015;&#27714;&#20540;&#8221;&#20195;&#30721;&#20837;&#21475;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4717f50" class="outline-4">
<h4 id="org4717f50">序列求值</h4>
<div class="outline-text-4" id="text-org4717f50">
<p>
序列表达式求值（eval-sequence）有两种情况：
</p>
<ol class="org-ol">
<li>要求值的是个表达式序列，如 <span class="underline">过程体</span></li>
<li>要求值的是 <span class="underline">begin 表达式</span> ，去掉 begin 后，可以统一到前一情况</li>
</ol>

<p>
对 begin 表达式的处理由 <span class="underline">ev-begin</span> 入口：
</p>
<div class="org-src-container">
<pre class="src src-scheme">ev-begin
<span style="color: #696969;">(</span>assign unev <span style="color: #696969;">(</span>op begin-actions<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg exp<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#21462;&#20986; begin &#30340;&#23454;&#38469;&#24207;&#21015;</span>
<span style="color: #696969;">(</span>save continue<span style="color: #696969;">)</span>  <span style="color: #5f9ea0; font-style: italic;">;;  </span><span style="color: #5f9ea0; font-style: italic;">&#20445;&#23384;&#27714;&#20540;&#23436;&#30340;&#32487;&#32493;&#28857;&#65292;&#19982;&#20854;&#20182;&#20837;&#21475;&#19968;&#33268;</span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label ev-sequence<span style="color: #696969;">))</span>
</pre>
</div>

<p>
其他地方来的由 <span class="underline">ev-sequence</span> 入口：
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">&#24207;&#21015;&#34920;&#36798;&#24335;&#27714;&#20540;&#20837;&#21475;</span>
ev-sequence <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#27492;&#26102; unev &#23492;&#23384;&#22120;&#20013;&#26159;&#24453;&#27714;&#20540;&#30340;&#34920;&#36798;&#24335;&#24207;&#21015;</span>
<span style="color: #696969;">(</span>assign exp <span style="color: #696969;">(</span>op first-exp<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg unev<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#21462;&#20986;&#24207;&#21015;&#20013;&#31532;&#19968;&#20010;&#34920;&#36798;&#24335; </span>
<span style="color: #696969;">(</span>test <span style="color: #696969;">(</span>op last-exp?<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg unev<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#27979;&#35797;&#26159;&#21542;&#26159;&#26368;&#21518;&#19968;&#20010;&#34920;&#36798;&#24335;</span>
<span style="color: #696969;">(</span>branch <span style="color: #696969;">(</span>label ev-sequence-last-exp<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#36339;&#36716;&#21040;&#26368;&#21518;&#19968;&#20010;&#34920;&#36798;&#24335;&#30340;&#29305;&#27530;&#22788;&#29702; ev-sequence-last-exp </span>
<span style="color: #696969;">(</span>save unev<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#20445;&#23384;&#34920;&#36798;&#24335;&#24207;&#21015;</span>
<span style="color: #696969;">(</span>save env<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#20445;&#23384;&#25191;&#34892;&#34920;&#36798;&#24335;&#30340;&#29615;&#22659;</span>
<span style="color: #696969;">(</span>assign continue <span style="color: #696969;">(</span>label ev-sequence-continue<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#35774;&#32622;&#27714;&#23436;&#24403;&#21069;&#34920;&#36798;&#24335;&#21518;&#30340;&#32493;&#28857; ev-sequence-continue &#65288;&#27714;&#20540;&#20313;&#19979;&#30340;&#34920;&#36798;&#24335;&#65289; </span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label eval-dispatch<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#27714;&#20540;&#24403;&#21069;&#34920;&#36798;&#24335;</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">&#24403;&#21069;&#34920;&#36798;&#24335;&#27714;&#20540;&#23436;&#27605;</span>
ev-sequence-continue 
<span style="color: #696969;">(</span>restore env<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#24674;&#22797;&#21407;&#26469;&#30340;&#29615;&#22659;</span>
<span style="color: #696969;">(</span>restore unev<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#24674;&#22797;&#34920;&#36798;&#24335;&#21015;&#34920;</span>
<span style="color: #696969;">(</span>assign unev <span style="color: #696969;">(</span>op rest-exps<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg unev<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#20174;&#34920;&#36798;&#24335;&#21015;&#34920;&#21435;&#25481;&#24050;&#32463;&#27714;&#20540;&#36807;&#30340;&#34920;&#36798;&#24335; -&gt; unev &#23492;&#23384;&#22120;</span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label ev-sequence<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#32487;&#32493;&#25191;&#34892;&#20313;&#19979;&#34920;&#36798;&#24335;&#24207;&#21015;&#27714;&#20540;</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">&#20570;&#24207;&#21015;&#20013;&#26368;&#21518;&#19968;&#20010;&#34920;&#36798;&#24335;&#30340;&#27714;&#20540;</span>
ev-sequence-last-exp 
<span style="color: #696969;">(</span>restore continue<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;;  </span><span style="color: #5f9ea0; font-style: italic;">&#24674;&#22797;&#32493;&#28857;&#23492;&#23384;&#22120;&#65288;&#35843;&#29992; ev-sequence &#21069;&#30340; continue &#23492;&#23384;&#22120;&#20013;&#30340;&#20540;&#65289;</span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label eval-dispatch<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#27714;&#20540;&#26368;&#21518;&#19968;&#20010;&#34920;&#36798;&#24335;</span>
</pre>
</div>
</div>

<div id="outline-container-org805b9d1" class="outline-5">
<h5 id="org805b9d1">尾递归</h5>
<div class="outline-text-5" id="text-org805b9d1">
<p>
前面说过，下面过程的形式是递归，但产生 <span class="underline">线性迭代</span> 计算：
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">sqrt-iter</span> guess x<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">if</span> <span style="color: #696969;">(</span>good-enough? guess x<span style="color: #696969;">)</span>
      guess
      <span style="color: #696969;">(</span>sqrt-iter <span style="color: #696969;">(</span>improve guess x<span style="color: #696969;">)</span>
                 x<span style="color: #696969;">)))</span>
</pre>
</div>

<p>
原因是 <b>调用自身时不用保存任何信息</b> ，因此存储需求是常量。如果一个求值器在执行这种过程时可以 <b>不分配存储</b> ，称该求值器是 <b>尾递归</b> 的
</p>
<pre class="example">
       元循环求值器是否尾递归的情况看不清，因为其求值细节依赖于基础系统

       对于现在这个求值器，情况可以看得很清楚：
       现在实现的求值器是尾递归的，因为它直接转去求值序列的最后一个表达式，没在栈里保存任何信息，没使用新的空间
</pre>

<p>
如果不要尾递归（优化），可以统一处理所有子表达式（包括最后的子表达式）。得到的代码简单些，但丧失了尾递归性质：
</p>
<div class="org-src-container">
<pre class="src src-scheme">ev-sequence
<span style="color: #696969;">(</span>test <span style="color: #696969;">(</span>op no-more-exps?<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg unev<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#26816;&#26597;&#24207;&#21015;&#34920;&#36798;&#24335;&#26159;&#21542;&#20026;&#31354;</span>
<span style="color: #696969;">(</span>branch <span style="color: #696969;">(</span>label ev-sequence-end<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#22914;&#26524;&#20026;&#31354;&#21017;&#36339;&#36716;&#25191;&#34892; ev-serquence-end &#65288;&#36820;&#22238;&#21407;&#26469;&#30340;&#32493;&#28857;&#65289;</span>
<span style="color: #696969;">(</span>assign exp <span style="color: #696969;">(</span>op first-exp<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg unev<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#33719;&#24471;&#31532;&#19968;&#20010;&#34920;&#36798;&#24335; -&gt; exp </span>
<span style="color: #696969;">(</span>save unev<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#24207;&#21015;&#34920;&#36798;&#24335;&#20837;&#26632;</span>
<span style="color: #696969;">(</span>save env<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#29615;&#22659;&#20837;&#26632;</span>
<span style="color: #696969;">(</span>assign continue <span style="color: #696969;">(</span>label ev-sequence-continue<span style="color: #696969;">))</span> 
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label eval-dispatch<span style="color: #696969;">))</span>
ev-sequence-continue
<span style="color: #696969;">(</span>restore env<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#29615;&#22659;&#20986;&#26632;</span>
<span style="color: #696969;">(</span>restore unev<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#24207;&#21015;&#34920;&#36798;&#24335;&#20986;&#26632;</span>
<span style="color: #696969;">(</span>assign unev <span style="color: #696969;">(</span>op rest-exps<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg unev<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#20002;&#25481;&#24050;&#32463;&#27714;&#20540;&#36807;&#30340;&#34920;&#36798;&#24335;</span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label ev-sequence<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#32487;&#32493;&#27714;&#20540;&#19979;&#19968;&#20010;&#34920;&#21333;&#24335;</span>
ev-sequence-end <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#25152;&#26377;&#23376;&#34920;&#36798;&#24335;&#37117;&#24050;&#23436;&#25104;&#27714;&#20540; </span>
<span style="color: #696969;">(</span>restore continue<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#24674;&#22797;&#35843;&#29992; ev-sequence &#21069;&#30340;&#32493;&#28857;&#23492;&#23384;&#22120;&#30340;&#20540;</span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>reg continue<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#36339;&#36716;&#21040;&#35843;&#29992; ev-sequence &#21069;&#30340;&#32493;&#28857;</span>
</pre>
</div>

<p>
看上去这和前面求值器只有一点区别：
</p>
<ul class="org-ul">
<li>前面的求值器：最后一个表达式的求值并不和其他的表达式求值在一个循环中</li>
<li>这里的求值器：最后一个表达式的求值和其他表达式是统一处理的（包含在一个save-restore的循环中）</li>
</ul>

<pre class="example">
虽然对于相同的表达式，两个求值器的结果是一致的

但是非递归求值器必须先做完最后一个表达式
然后返回到前一个表达式
然后返回到再前前一个表达式
....
</pre>

<p>
对于某些过程来说，是否尾递归可能非常致命： 
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">count</span> n<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>newline<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>display n<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>count <span style="color: #696969;">(</span>+ n 1<span style="color: #696969;">)))</span>
</pre>
</div>
<ul class="org-ul">
<li>尾递归：会一直迭代下去</li>
<li>非尾递归：由于栈空间不够，会爆栈</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org11dbf11" class="outline-4">
<h4 id="org11dbf11">条件表达式</h4>
<div class="outline-text-4" id="text-org11dbf11">
<p>
if 表达式：
</p>
<ul class="org-ul">
<li>先求值其 <span class="underline">谓词</span> 部分，基于其值确定随后的求值</li>
<li>求值谓词之前保存 <span class="underline">整个 if 表达式</span> 以便后面使用，也要保存 <span class="underline">环境</span> 和 <span class="underline">继续点</span></li>
</ul>

<div class="org-src-container">
<pre class="src src-scheme">ev-if
  <span style="color: #696969;">(</span>save exp<span style="color: #696969;">)</span>                    <span style="color: #5f9ea0; font-style: italic;">; </span><span style="color: #5f9ea0; font-style: italic;">&#20445;&#23384;&#25972;&#20010; if &#34920;&#36798;&#24335;&#20379;&#21518;&#38754;&#20351;&#29992;</span>
  <span style="color: #696969;">(</span>save env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>save continue<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>assign continue <span style="color: #696969;">(</span>label ev-if-decide<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#35859;&#35789;&#27714;&#20540;&#21518;&#65292;&#36716;&#32780;&#25191;&#34892; ev-if-decide</span>
  <span style="color: #696969;">(</span>assign exp <span style="color: #696969;">(</span>op if-predicate<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg exp<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#33719;&#24471;&#35859;&#35789;&#34920;&#36798;&#24335;</span>
  <span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label eval-dispatch<span style="color: #696969;">))</span>  <span style="color: #5f9ea0; font-style: italic;">; </span><span style="color: #5f9ea0; font-style: italic;">&#23545;&#35859;&#35789;&#36827;&#34892;&#27714;&#20540;</span>
</pre>
</div>

<p>
根据谓词表达式的结果跳转：
</p>
<div class="org-src-container">
<pre class="src src-scheme">ev-if-decide
<span style="color: #696969;">(</span>restore continue<span style="color: #696969;">)</span>
<span style="color: #696969;">(</span>restore env<span style="color: #696969;">)</span>
<span style="color: #696969;">(</span>restore exp<span style="color: #696969;">)</span>
<span style="color: #696969;">(</span>test <span style="color: #696969;">(</span>op true?<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg val<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">; &#26816;&#27979;&#32467;&#26524;&#26159;&#21542;&#20026;&#30495;</span>
<span style="color: #696969;">(</span>branch <span style="color: #696969;">(</span>label ev-if-consequent<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#26159;&#30495;&#30340;&#26102;&#20505;&#65292;&#36186;&#21462;&#25191;&#34892; ev-if-consequent </span>
ev-if-alternative
<span style="color: #696969;">(</span>assign exp <span style="color: #696969;">(</span>op if-alternative<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg exp<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#33719;&#24471; if &#34920;&#36798;&#24335;&#20013;&#8220;&#35859;&#35789;&#20026;&#20551;&#8221;&#23545;&#24212;&#30340;&#34920;&#36798;&#24335; -&gt; exp </span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label eval-dispatch<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#23545; alternative &#34920;&#36798;&#24335;&#36827;&#34892;&#27714;&#20540;</span>
ev-if-consequent
<span style="color: #696969;">(</span>assign exp <span style="color: #696969;">(</span>op if-consequent<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg exp<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#33719;&#24471; if &#34920;&#36798;&#24335;&#20013;&#8220;&#35859;&#35789;&#20026;&#30495;&#8221;&#23545;&#24212;&#30340;&#34920;&#36798;&#24335; -&gt; exp </span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label eval-dispatch<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#23545; consequent &#34920;&#36798;&#24335;&#36827;&#34892;&#27714;&#20540;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org74c06b4" class="outline-4">
<h4 id="org74c06b4">赋值表达式</h4>
<div class="outline-text-4" id="text-org74c06b4">
<p>
赋值表达式用下面代码段处理：
</p>
<div class="org-src-container">
<pre class="src src-scheme">ev-assignment
<span style="color: #696969;">(</span>assign unev <span style="color: #696969;">(</span>op assignment-variable<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg exp<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#36171;&#20540;&#34920;&#36798;&#24335;&#30340;&#21464;&#37327;&#21517; -&gt; unev &#23492;&#23384;&#22120;</span>
<span style="color: #696969;">(</span>save unev<span style="color: #696969;">)</span>                   <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#21464;&#37327;&#21517;&#21387;&#26632;&#20026;&#20197;&#21518;&#20351;&#29992;</span>
<span style="color: #696969;">(</span>assign exp <span style="color: #696969;">(</span>op assignment-value<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg exp<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#36171;&#20540;&#34920;&#36798;&#24335;&#30340;&#8220;&#20540;&#34920;&#36798;&#24335;&#8221; -&gt; exp &#23492;&#23384;&#22120;</span>
<span style="color: #696969;">(</span>save env<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#29615;&#22659;&#20837;&#26632;</span>
<span style="color: #696969;">(</span>save continue<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#32493;&#28857;&#21387;&#26632;</span>
<span style="color: #696969;">(</span>assign continue <span style="color: #696969;">(</span>label ev-assignment-1<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#8220;&#21464;&#37327;&#20540;&#34920;&#36798;&#24335;&#8221;&#27714;&#20540;&#20197;&#21518;&#36716;&#32780;&#25191;&#34892; ev-assignment-1 </span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label eval-dispatch<span style="color: #696969;">))</span>  <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#23545;&#20540;&#34920;&#36798;&#24335;&#36827;&#34892;&#27714;&#20540;</span>
ev-assignment-1
<span style="color: #696969;">(</span>restore continue<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#32493;&#28857;&#24674;&#22797;</span>
<span style="color: #696969;">(</span>restore env<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#29615;&#22659;&#24674;&#22797;</span>
<span style="color: #696969;">(</span>restore unev<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#21464;&#37327;&#24674;&#22797;</span>
<span style="color: #696969;">(</span>perform
 <span style="color: #696969;">(</span>op set-variable-value!<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg unev<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg val<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg env<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#25191;&#34892;&#36171;&#20540;&#25805;&#20316;(set-variable-value!) &#65292;&#20462;&#25913;&#29615;&#22659;&#20013;&#30340;&#21464;&#37327;&#32465;&#23450;</span>
<span style="color: #696969;">(</span>assign val <span style="color: #696969;">(</span>const ok<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#24120;&#37327;"ok" -&gt; &#32467;&#26524;&#23492;&#23384;&#22120; val </span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>reg continue<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#32487;&#32493;&#25191;&#34892;&#35843;&#29992; ev-assignment &#21069;&#30340;&#32493;&#28857;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org657f1cb" class="outline-4">
<h4 id="org657f1cb">定义表达式</h4>
<div class="outline-text-4" id="text-org657f1cb">
<p>
定义表达式和赋值处理类似：
</p>
<div class="org-src-container">
<pre class="src src-scheme">ev-definition
  <span style="color: #696969;">(</span>assign unev <span style="color: #696969;">(</span>op definition-variable<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg exp<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span>save unev<span style="color: #696969;">)</span>                   
  <span style="color: #696969;">(</span>assign exp <span style="color: #696969;">(</span>op definition-value<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg exp<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span>save env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>save continue<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>assign continue <span style="color: #696969;">(</span>label ev-definition-1<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label eval-dispatch<span style="color: #696969;">))</span>  
ev-definition-1
  <span style="color: #696969;">(</span>restore continue<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>restore env<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>restore unev<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>perform
   <span style="color: #696969;">(</span>op define-variable!<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg unev<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg val<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg env<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#35843;&#29992; scheme &#23454;&#29616;&#30340;&#23450;&#20041;&#25805;&#20316;(define-variable!) &#23454;&#29616;&#22312;&#29615;&#22659;&#20013;&#23450;&#20041;&#21464;&#37327;</span>
  <span style="color: #696969;">(</span>assign val <span style="color: #696969;">(</span>const ok<span style="color: #696969;">))</span>
  <span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>reg continue<span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6476f43" class="outline-4">
<h4 id="org6476f43">驱动循环</h4>
<div class="outline-text-4" id="text-org6476f43">
<p>
要理解求值器的行为，需要执行它，监视其行为。先做一个驱动循环：
</p>
<ol class="org-ol">
<li>打印提示语</li>
<li>读取输入</li>
<li>调用eval-dispatch 来对输入进行求值</li>
<li>打印求值结果</li>
<li>重复循环</li>
</ol>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5f9ea0; font-style: italic;">;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#26174;&#31034;&#27714;&#20540;&#22120;&#30340; repl &#24490;&#29615; ;;</span>
<span style="color: #5f9ea0; font-style: italic;">;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
read-eval-print-loop
<span style="color: #696969;">(</span>perform <span style="color: #696969;">(</span>op initialize-stack<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#21021;&#22987;&#21270;&#26632;</span>
<span style="color: #696969;">(</span>perform
 <span style="color: #696969;">(</span>op prompt-for-input<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>const <span style="color: #deb887;">";;; EC-Eval input:"</span><span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#25171;&#21360;&#25552;&#31034;&#35821;</span>
<span style="color: #696969;">(</span>assign exp <span style="color: #696969;">(</span>op read<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#35835;&#21462;&#36755;&#20837; -&gt; exp &#23492;&#23384;&#22120;</span>
<span style="color: #696969;">(</span>assign env <span style="color: #696969;">(</span>op get-global-environment<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#35835;&#21462; global env -&gt; env &#23492;&#23384;&#22120;</span>
<span style="color: #696969;">(</span>assign continue <span style="color: #696969;">(</span>label print-result<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">print-result &#25351;&#20196;&#26631;&#21495; -&gt; continue &#23492;&#23384;&#22120;</span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label eval-dispatch<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#36186;&#21462;&#25191;&#34892; eval-dispatch &#23545; env &#23492;&#23384;&#22120;&#20013;&#30340;&#34920;&#36798;&#24335;&#36827;&#34892;&#27714;&#20540;</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">&#25171;&#21360;&#27714;&#20540;&#32467;&#26524;</span>
print-result 
<span style="color: #696969;">(</span>perform
 <span style="color: #696969;">(</span>op announce-output<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>const <span style="color: #deb887;">";;; EC-Eval value:"</span><span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#25171;&#21360;&#25552;&#31034;&#35821;</span>
<span style="color: #696969;">(</span>perform <span style="color: #696969;">(</span>op user-print<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg val<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#35843;&#29992; user-print &#30495;&#23454;&#25171;&#21360; val&#23492;&#23384;&#22120;&#20013;&#30340;&#27714;&#20540;&#32467;&#26524;</span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label read-eval-print-loop<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#37325;&#26032;&#24320;&#22987; repl &#24490;&#29615;</span>
</pre>
</div>

<p>
需要处理遇到的错误，出现错误时打印信息并回到驱动循环：
</p>
<div class="org-src-container">
<pre class="src src-scheme">     <span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">&#26410;&#30693;&#34920;&#36798;&#24335;&#31867;&#22411;</span>
unknown-expression-type
<span style="color: #696969;">(</span>assign val <span style="color: #696969;">(</span>const unknown-expression-type-error<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label signal-error<span style="color: #696969;">))</span>
     <span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">&#26410;&#30693;&#36807;&#31243;&#31867;&#22411;</span>
unknown-procedure-type
<span style="color: #696969;">(</span>restore continue<span style="color: #696969;">)</span>    <span style="color: #5f9ea0; font-style: italic;">; </span><span style="color: #5f9ea0; font-style: italic;">clean up stack (from apply-dispatch)</span>
<span style="color: #696969;">(</span>assign val <span style="color: #696969;">(</span>const unknown-procedure-type-error<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label signal-error<span style="color: #696969;">))</span>
     <span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">&#25171;&#21360;&#20986;&#38169;&#31867;&#22411;</span>
signal-error
<span style="color: #696969;">(</span>perform <span style="color: #696969;">(</span>op user-print<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg val<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label read-eval-print-loop<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">&#22238;&#21040;&#22522;&#26412;&#27714;&#20540;&#24490;&#29615;&#26102;&#23558;&#26632;&#32622;&#31354;&#65292;&#37325;&#26032;&#24320;&#22987;&#26032;&#19968;&#27425;&#24490;&#29615;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6159b71" class="outline-4">
<h4 id="org6159b71">构造求值器对应的寄存器机器模型</h4>
<div class="outline-text-4" id="text-org6159b71">
<p>
为完成这一机器，需要把本节的所有代码收集起来，调用前面寄存器机器模拟器的操作，构造一个机器模型
</p>

<ul class="org-ul">
<li>创建机器的操作列表，把所有要用的操作加入（取自元循环求值器）：</li>
</ul>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #daa520; font-weight: bold;">eceval-operations</span>
  <span style="color: #696969;">(</span>list <span style="color: #696969;">(</span>list 'self-evaluating? self-evaluating<span style="color: #696969;">)</span>
        <span style="color: #98f5ff;">&lt;&#26426;&#22120;&#30340;&#23436;&#25972;&#25805;&#20316;&#34920;&gt;</span><span style="color: #696969;">))</span> 
</pre>
</div>

<ul class="org-ul">
<li>构造机器模型的代码框架，其中应填入前面求值器的所有代码：</li>
</ul>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #daa520; font-weight: bold;">eceval</span>
  <span style="color: #696969;">(</span>make-machine
   '<span style="color: #696969;">(</span>exp env val proc argl continue unev<span style="color: #696969;">)</span>
   eceval-operations
   '<span style="color: #696969;">(</span>read-eval-print-loop
     <span style="color: #98f5ff;">&lt;&#19978;&#38754;&#32473;&#20986;&#30340;&#27714;&#20540;&#22120;&#26426;&#22120;&#20195;&#30721;&gt;</span><span style="color: #696969;">)))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgd5cdca1" class="outline-3">
<h3 id="orgd5cdca1">显示求值器的运行</h3>
<div class="outline-text-3" id="text-orgd5cdca1">
<p>
运行前创建环境，而后启动这个求值器：
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #daa520; font-weight: bold;">the-global-environment</span> <span style="color: #696969;">(</span>setup-environment<span style="color: #696969;">))</span>
</pre>
</div>

<pre class="example">
(start eceval)

;;; EC-Eval input:
(define (append x y)
  (if (null? x)
      y
      (cons (car x)
	    (append (cdr x) y))))

;;; EC-Eval value:
ok

;;; EC-Eval input:
(append '(a b c) '(d e f))

;;; EC-Eval value:
(a b c d e f)
</pre>
</div>

<div id="outline-container-org33b1252" class="outline-4">
<h4 id="org33b1252">监视求值器的执行</h4>
<div class="outline-text-4" id="text-org33b1252">
<p>
在驱动循环里增加一段代码：
</p>
<div class="org-src-container">
<pre class="src src-scheme">print-result
  <span style="color: #696969;">(</span>perform <span style="color: #696969;">(</span>op print-stack-statistics<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#22312;&#25805;&#20316;&#34920;&#37324;&#21152;&#20837;&#32479;&#35745;&#25805;&#20316;</span>
  <span style="color: #696969;">(</span>perform
   <span style="color: #696969;">(</span>op announce-output<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>const <span style="color: #deb887;">";;; EC-Eval value:"</span><span style="color: #696969;">))</span>
<span style="color: #5f9ea0; font-style: italic;">;;;  </span><span style="color: #5f9ea0; font-style: italic;">... ; same as before</span>
</pre>
</div>

<p>
监视实例：
</p>
<pre class="example">
;;; EC-Eval input:
(define (factorial n)
  (if (= n 1)
      1
      (* (factorial (- n 1)) n)))
(total-pushes = 3 maximum-depth = 3)

;;; EC-Eval value:
ok

;;; EC-Eval input:
(factorial 5)

(total-pushes = 144 maximum-depth = 28)
;;; EC-Eval value:
120
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

		  <br/>
		  <div class='ds-thread'></div>
		  <script>
		  var duoshuoQuery = {short_name:'klose911'};
		  (function() {
					  var dsThread = document.getElementsByClassName('ds-thread')[0];
					  dsThread.setAttribute('data-thread-key', document.title);
					  dsThread.setAttribute('data-title', document.title);
					  dsThread.setAttribute('data-url', window.location.href);
					  var ds = document.createElement('script');
					  ds.type = 'text/javascript';ds.async = true;
					  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
					  ds.charset = 'UTF-8';
					  (document.getElementsByTagName('head')[0] 
						|| document.getElementsByTagName('body')[0]).appendChild(ds);
					  })();
		  </script>
		  <script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
		  ga('create', 'UA-90850421-1', 'auto');
		  ga('send', 'pageview');
		  </script>
</div>
</body>
</html>
