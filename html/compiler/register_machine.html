<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>寄存器机器</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wu, Shanliang" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="css/main.css" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">寄存器机器</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org1db0306">寄存器机器</a>
<ul>
<li><a href="#org79e690e">寄存器机器描述语言</a>
<ul>
<li><a href="#orga36149b">GCD 语言描述</a></li>
<li><a href="#org62b1748">GCD 机器扩展</a></li>
</ul>
</li>
<li><a href="#org4503710">机器语言设计抽象</a></li>
<li><a href="#orgaf49d50">子程序</a></li>
<li><a href="#orgdc23a2a">递归</a>
<ul>
<li><a href="#org4ec116e">阶乘递归机器</a></li>
<li><a href="#org805c066">斐波纳契数递归机器</a></li>
</ul>
</li>
<li><a href="#org66cae60">指令总结</a></li>
</ul>
</li>
<li><a href="#orgee18268">寄存器机器模拟器</a>
<ul>
<li><a href="#org70a852b">GCD 模拟器实例</a></li>
<li><a href="#org7556d92">机器模型</a>
<ul>
<li><a href="#orgad139a9">寄存器</a></li>
<li><a href="#org5413a1e">栈</a></li>
<li><a href="#org2514462">基础机器</a></li>
</ul>
</li>
<li><a href="#org9b7f1f6">汇编器</a>
<ul>
<li><a href="#orga85b3fa">接口程序</a></li>
<li><a href="#org92556cd">生成指令的执行过程</a>
<ul>
<li><a href="#org86a634d">assign 指令</a></li>
<li><a href="#orgc70b18b">test 指令</a></li>
<li><a href="#orga86fd34">branch 指令</a></li>
<li><a href="#orgbf209cc">goto 指令</a></li>
<li><a href="#org095e5f0">save &amp; restore 指令</a></li>
<li><a href="#org0a20cf9">perform 指令</a></li>
<li><a href="#org8298d5a">基本表达式执行过程</a></li>
<li><a href="#org808a31e">子表达式</a></li>
</ul>
</li>
<li><a href="#org2c12e29">监控效率</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<p>
前面研究了计算和用Lisp过程描述计算的相关问题，提出了几个 <b>解释器</b> 求值模型：
</p>
<ul class="org-ul">
<li><span class="underline">代换</span> 模型</li>
<li><span class="underline">环境</span> 模型</li>
<li><span class="underline">元循环</span> 模型</li>
</ul>

<pre class="example">
  元循环模型表现出求值过程的许多细节，但仍然有一些遗漏，主要是没解释 Lisp 系统里的基本控制动作。例如：

  在子表达式求出值之后，如何把值送给使用值的表达式？
  为什么有些递归过程会产生迭代型计算过程（只需常量空间），而另一些却产生递归型计算过程（需要线性以上的空间）？
</pre>

<p>
原因： <b>求值器本身是 Lisp 程序</b> ，继承并利用了基础系统的结构。要进一步理解 Lisp 求值器的控制，必须转到更低的层面，研究更多实现细节
</p>

<div id="outline-container-org1db0306" class="outline-2">
<h2 id="org1db0306">寄存器机器</h2>
<div class="outline-text-2" id="text-org1db0306">
<p>
寄存器机器的功能是 <b>顺序执行一条条指令</b> ， <b>操作一组存储单元</b> （寄存器）。一般包含：
</p>
<ul class="org-ul">
<li><span class="underline">数据通路</span> ：寄存器和操作</li>
<li><span class="underline">控制器</span> ：确定操作顺序</li>
</ul>

<p>
GCD 算法：
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">gcd</span> a b<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">if</span> <span style="color: #696969;">(</span>= b 0<span style="color: #696969;">)</span>
      a
      <span style="color: #696969;">(</span>gcd b <span style="color: #696969;">(</span>remainder a b<span style="color: #696969;">))))</span>
</pre>
</div>

<p>
执行本算法的机器必须维护 <span class="underline">a</span> 和 <span class="underline">b</span> 的轨迹，假定两个值存于 <b>寄存器</b> a 和 b 。所需操作：
</p>
<ul class="org-ul">
<li>判断 b 是否 0，计算 a 除以 b 的余数（假定有计算设备）</li>
<li>每一次循环迭代需要同时更新 a 和 b。由于一条简单指令只能更新一个寄存器，因此引进了 <b>辅助寄存器</b> <span class="underline">t</span></li>
</ul>

<p>
它的 <span class="underline">数据通路</span> 如图：
</p>

<div class="figure">
<p><img src="pic/gcd_data_flow.gif" alt="gcd_data_flow.gif" width="30%" /> 
</p>
</div>

<p>
为了寄存器机器能正确工作，必须 <b>正确控制</b> 其中各 <b>按钮的开闭顺序</b> 。下图是 GCD 机器的 <span class="underline">控制器</span> ，用流程图表示：
</p>
<ul class="org-ul">
<li>方框是动作</li>
<li>菱形框是判断</li>
<li><p>
控制按箭头方向运行，进入判断后的流向由数据通路图中的检测决定
</p>
<ul class="org-ul">
<li>控制到达 done 时工作结束，寄存器 a 里存放着计算结果</li>
</ul>


<div class="figure">
<p><img src="pic/gcd_controller.gif" alt="gcd_controller.gif" width="30%" /> 
</p>
</div></li>
</ul>
</div>

<div id="outline-container-org79e690e" class="outline-3">
<h3 id="org79e690e">寄存器机器描述语言</h3>
<div class="outline-text-3" id="text-org79e690e">
<pre class="example">
     用这种图形描述很小的机器还可以，但难用于描述大型机器

     为方便使用，可以考虑一种描述寄存器机器的文本语言
</pre>

<p>
一种设计是提供两套描述方式，分别用于描述 <span class="underline">数据通路</span> 和 <span class="underline">控制器</span> ：
</p>
<ul class="org-ul">
<li>数据通路描述： <b>寄存器</b> 和 <b>操作</b> 
<ul class="org-ul">
<li><span class="underline">寄存器命名</span></li>
<li>寄存器赋值的 <span class="underline">按钮命名</span> 
<ul class="org-ul">
<li>受其控制的数据传输的 <b>数据源</b> （寄存器/常量/操作）。也需给 <span class="underline">操作命名</span> ，并说明其输入</li>
</ul></li>
</ul></li>
<li>控制器是 <b>指令序列</b> ，加上一些 <b>表示控制入口点</b> 的 <span class="underline">标号</span> 
<ul class="org-ul">
<li>指令可为：
<ul class="org-ul">
<li>数据通路的一个 <span class="underline">按钮</span> ： 指定 <b>寄存器赋值</b> 动作</li>
<li><span class="underline">test</span> 指令：完成 <b>检测</b></li>
<li><span class="underline">branch</span> 指令:  <b>条件转跳</b> 指令，基于前面检测结果
<ul class="org-ul">
<li>检测为 <span class="underline">真</span> ：  <b>跳转</b> 到 <span class="underline">指定标号</span> 的指令</li>
<li>检测为 <span class="underline">假</span> ： <b>继续</b> 下一条指令</li>
</ul></li>
<li><span class="underline">goto</span> 指令： <b>无条件跳转</b> 到 <span class="underline">指定标号</span></li>
</ul></li>
<li>标号：branch 和 goto 的 <b>目标</b></li>
</ul></li>
</ul>
</div>

<div id="outline-container-orga36149b" class="outline-4">
<h4 id="orga36149b">GCD 语言描述</h4>
<div class="outline-text-4" id="text-orga36149b">
<p>
数据通路：
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span>data-paths
 <span style="color: #696969;">(</span>registers
  <span style="color: #696969;">((</span>name a<span style="color: #696969;">)</span>
   <span style="color: #696969;">(</span>buttons <span style="color: #696969;">((</span>name a&lt;-b<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>source <span style="color: #696969;">(</span>register b<span style="color: #696969;">)))))</span>
  <span style="color: #696969;">((</span>name b<span style="color: #696969;">)</span>
   <span style="color: #696969;">(</span>buttons <span style="color: #696969;">((</span>name b&lt;-t<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>source <span style="color: #696969;">(</span>register t<span style="color: #696969;">)))))</span>
  <span style="color: #696969;">((</span>name t<span style="color: #696969;">)</span>
   <span style="color: #696969;">(</span>buttons <span style="color: #696969;">((</span>name t&lt;-r<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>source <span style="color: #696969;">(</span>operation rem<span style="color: #696969;">))))))</span>

 <span style="color: #696969;">(</span>operations
  <span style="color: #696969;">((</span>name rem<span style="color: #696969;">)</span>
   <span style="color: #696969;">(</span>inputs <span style="color: #696969;">(</span>register a<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>register b<span style="color: #696969;">)))</span>
  <span style="color: #696969;">((</span>name =<span style="color: #696969;">)</span>
   <span style="color: #696969;">(</span>inputs <span style="color: #696969;">(</span>register b<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>constant 0<span style="color: #696969;">)))))</span>
</pre>
</div>
<p>
控制器：
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span>controller
 test-b                           <span style="color: #5f9ea0; font-style: italic;">; </span><span style="color: #5f9ea0; font-style: italic;">label</span>
 <span style="color: #696969;">(</span>test =<span style="color: #696969;">)</span>                       <span style="color: #5f9ea0; font-style: italic;">; </span><span style="color: #5f9ea0; font-style: italic;">test</span>
 <span style="color: #696969;">(</span>branch <span style="color: #696969;">(</span>label gcd-done<span style="color: #696969;">))</span>      <span style="color: #5f9ea0; font-style: italic;">; </span><span style="color: #5f9ea0; font-style: italic;">conditional branch</span>
 <span style="color: #696969;">(</span>t&lt;-r<span style="color: #696969;">)</span>                         <span style="color: #5f9ea0; font-style: italic;">; </span><span style="color: #5f9ea0; font-style: italic;">button push</span>
 <span style="color: #696969;">(</span>a&lt;-b<span style="color: #696969;">)</span>                         <span style="color: #5f9ea0; font-style: italic;">; </span><span style="color: #5f9ea0; font-style: italic;">button push</span>
 <span style="color: #696969;">(</span>b&lt;-t<span style="color: #696969;">)</span>                         <span style="color: #5f9ea0; font-style: italic;">; </span><span style="color: #5f9ea0; font-style: italic;">button push</span>
 <span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label test-b<span style="color: #696969;">))</span>          <span style="color: #5f9ea0; font-style: italic;">; </span><span style="color: #5f9ea0; font-style: italic;">unconditional branch</span>
 gcd-done<span style="color: #696969;">)</span>                        <span style="color: #5f9ea0; font-style: italic;">; </span><span style="color: #5f9ea0; font-style: italic;">label</span>
</pre>
</div>

<pre class="example">
      这种描述很难读：要理解控制器里的指令，必须仔细对照数据通路的按钮和操作的名字
</pre>
<p>
一种改进是把 <b>数据通路描述融入控制器描述</b> ，在指令里直接说做什么
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span>controller
 test-b
 <span style="color: #696969;">(</span>test <span style="color: #696969;">(</span>op =<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg b<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>const 0<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>branch <span style="color: #696969;">(</span>label gcd-done<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>assign t <span style="color: #696969;">(</span>op rem<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg a<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg b<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>assign a <span style="color: #696969;">(</span>reg b<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>assign b <span style="color: #696969;">(</span>reg t<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label test-b<span style="color: #696969;">))</span>
 gcd-done<span style="color: #696969;">)</span>
</pre>
</div>

<pre class="example">
改造后语言清晰多了，但还有缺点，如：

1. 较罗嗦，如果指令里多次提到某数据通路元素，就要多次写出其完整描述（上例简单，无此情况）。重复出现使实际数据通路结构不
够清晰，看不清有多少寄存器操作按钮，及其互连关系

2. 虽然指令用 Lisp 表达式表示，但实际上这里只能写合法指令
</pre>
<p>
虽然有这些缺点，下面还是准备用这套寄存器机器语言
</p>
<pre class="example">
      在这里比起数据通路的内部结构来说我们更关心控制器的

      反过来如果设计一台真实的计算机，最核心的部分却是如何设计数据通路
</pre>
</div>
</div>

<div id="outline-container-org62b1748" class="outline-4">
<h4 id="org62b1748">GCD 机器扩展</h4>
<div class="outline-text-4" id="text-org62b1748">
<p>
作为例子，现在想修改前面的 GCD 机器，使得能给它 <b>输入</b> 想求 GCD 的数，并能 <b>打印</b> 出计算结果
</p>
<pre class="example">
      这里不准备研究读入或输出的实现
</pre>
<p>
只假定有两个基本操作：
</p>
<ul class="org-ul">
<li><span class="underline">read</span> :  <b>产生可存入寄存器的值</b> ，值来自机器之外</li>
<li><span class="underline">print</span> :  <b>给环境产生某种效果</b> 
<ul class="org-ul">
<li>图形上给 print 关联一个按钮，按压导致 print 执行。指令形式：</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span>perform <span style="color: #696969;">(</span>op print<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg a<span style="color: #696969;">))</span>
</pre>
</div>

<pre class="example">
print 和前面讨论的操作不同，它并不会把任何的计算结果保存到寄存器

因此这里新增一个特殊的指令 perform 来标识触发 print 这样的动作
</pre>

<p>
扩充后的 GCD 机器控制器的工作过程：
</p>
<ol class="org-ol">
<li>反复读入一对对数值</li>
<li>求出两个数的 GCD</li>
<li>输出</li>
</ol>

<p>
扩充后的 GCD 寄存器模型：
</p>

<div class="figure">
<p><img src="pic/gcd_extended.gif" alt="gcd_extended.gif" width="30%" /> 
</p>
</div>

<p>
扩充后的 GCD 控制器指令序列：
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span>controller
 gcd-loop
 <span style="color: #696969;">(</span>assign a <span style="color: #696969;">(</span>op read<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>assign b <span style="color: #696969;">(</span>op read<span style="color: #696969;">))</span>
 test-b
 <span style="color: #696969;">(</span>test <span style="color: #696969;">(</span>op =<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg b<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>const 0<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>branch <span style="color: #696969;">(</span>label gcd-done<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>assign t <span style="color: #696969;">(</span>op rem<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg a<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg b<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>assign a <span style="color: #696969;">(</span>reg b<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>assign b <span style="color: #696969;">(</span>reg t<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label test-b<span style="color: #696969;">))</span>
 gcd-done
 <span style="color: #696969;">(</span>perform <span style="color: #696969;">(</span>op print<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg a<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label gcd-loop<span style="color: #696969;">)))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org4503710" class="outline-3">
<h3 id="org4503710">机器语言设计抽象</h3>
<div class="outline-text-3" id="text-org4503710">
<pre class="example">
     一部机器的定义总是基于一组基本操作，有些操作本身很复杂

     可能考虑把 Scheme 环境提供的操作作为基本操作
</pre>
<p>
基于复杂操作定义机器，可以将注意力集中到某些关键方面，隐藏不关注的细节。必要时再 <b>基于更基本的操作构造这些操作</b> ，说明它们可实现。例如，
GCD 机器的一个操作是计算 a 除以 b 的余数赋给 t。如果希望机器不以它作为基本操作，需考虑 <span class="underline">基于更简单的操作计算余数</span> ，可以只用减法写出求余数过程：
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">remainder</span> n d<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">if</span> <span style="color: #696969;">(</span>&lt; n d<span style="color: #696969;">)</span>
      n
      <span style="color: #696969;">(</span>remainder <span style="color: #696969;">(</span>- n d<span style="color: #696969;">)</span> d<span style="color: #696969;">)))</span>
</pre>
</div>

<pre class="example">
     可以用一个减法操作和一个比较代替前面机器里的求余数
</pre>

<p>
新GCD 控制器代码（用减法实现求余）：
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span>controller
 test-b
 <span style="color: #696969;">(</span>test <span style="color: #696969;">(</span>op =<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg b<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>const 0<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>branch <span style="color: #696969;">(</span>label gcd-done<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>assign t <span style="color: #696969;">(</span>reg a<span style="color: #696969;">))</span>
 rem-loop
 <span style="color: #696969;">(</span>test <span style="color: #696969;">(</span>op &lt;<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg t<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg b<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>branch <span style="color: #696969;">(</span>label rem-done<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>assign t <span style="color: #696969;">(</span>op -<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg t<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg b<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label rem-loop<span style="color: #696969;">))</span>
 rem-done
 <span style="color: #696969;">(</span>assign a <span style="color: #696969;">(</span>reg b<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>assign b <span style="color: #696969;">(</span>reg t<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label test-b<span style="color: #696969;">))</span>
 gcd-done<span style="color: #696969;">)</span>
</pre>
</div>

<p>
新 GCD 的数据通路和控制器：
</p>


<div class="figure">
<p><img src="pic/gcd_substraction.gif" alt="gcd_substraction.gif" width="30%" /> 
</p>
</div>

<pre class="example">
这里是把原来的 (assign t (op rem) (reg a) (reg b)) 替换成下面的循环：

rem-loop
   (test (op &lt;) (reg t) (reg b))
   (branch (label rem-done))
   (assign t (op -) (reg t) (reg b))
   (goto (label rem-loop))
 rem-done
</pre>
</div>
</div>

<div id="outline-container-orgaf49d50" class="outline-3">
<h3 id="orgaf49d50">子程序</h3>
<div class="outline-text-3" id="text-orgaf49d50">
<pre class="example">
     用基于更基本操作的结构代替原复杂操作后，得到的控制器将更复杂

     下面希望能做某种安排，使相同的计算不必重复构造（以简化机器结构）
</pre>

<p>
如果机器两次用 GCD，分别算 <span class="underline">a 与 b</span> 和 <span class="underline">c 与 d</span> 的 GCD，数据通路将包含两个 GCD 块，控制器也包含两段类似代码 :-( 
</p>

<div class="org-src-container">
<pre class="src src-scheme">gcd-1
 <span style="color: #696969;">(</span>test <span style="color: #696969;">(</span>op =<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg b<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>const 0<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>branch <span style="color: #696969;">(</span>label after-gcd-1<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>assign t <span style="color: #696969;">(</span>op rem<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg a<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg b<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>assign a <span style="color: #696969;">(</span>reg b<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>assign b <span style="color: #696969;">(</span>reg t<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label gcd-1<span style="color: #696969;">))</span>
after-gcd-1

gcd-2
 <span style="color: #696969;">(</span>test <span style="color: #696969;">(</span>op =<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg d<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>const 0<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>branch <span style="color: #696969;">(</span>label after-gcd-2<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>assign s <span style="color: #696969;">(</span>op rem<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg c<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg d<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>assign c <span style="color: #696969;">(</span>reg d<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>assign d <span style="color: #696969;">(</span>reg s<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label gcd-2<span style="color: #696969;">))</span>
after-gcd-2
</pre>
</div>

<p>
两台 GCD 的机器模型如下：
</p>


<div class="figure">
<p><img src="pic/two_gcds.gif" alt="two_gcds.gif" width="30%" /> 
</p>
</div>

<pre class="example">
     多次出现同样部分不经济

     现在考虑如何只用一个 GCD 部件实现
</pre>

<p>
计算 c 和 d 的GCD时，寄存器中 a 和 b 里 的值没有用（如有用可以把它们移到其他寄存器），因此可以修改机器：
</p>
<ol class="org-ol">
<li>计算 c 和 d 的GCD时，先把c 和 d 的值分别移到 a 和 b</li>
<li>用第一个GCD通路完成计算</li>
</ol>

<p>
这就删去了一个算GCD 的通路，控制器代码如下：
</p>

<div class="org-src-container">
<pre class="src src-scheme">gcd-1
<span style="color: #696969;">(</span>test <span style="color: #696969;">(</span>op =<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg b<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>const 0<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>branch <span style="color: #696969;">(</span>label after-gcd-1<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>assign t <span style="color: #696969;">(</span>op rem<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg a<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg b<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>assign a <span style="color: #696969;">(</span>reg b<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>assign b <span style="color: #696969;">(</span>reg t<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label gcd-1<span style="color: #696969;">))</span>
after-gcd-1
<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#36825;&#37324;&#25226;&#27714; GCD &#30340;&#25968;&#25454; c &#21644; d &#31227;&#20837; a &#21644;b </span>
gcd-2
<span style="color: #696969;">(</span>test <span style="color: #696969;">(</span>op =<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg b<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>const 0<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>branch <span style="color: #696969;">(</span>label after-gcd-2<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>assign t <span style="color: #696969;">(</span>op rem<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg a<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg b<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>assign a <span style="color: #696969;">(</span>reg b<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>assign b <span style="color: #696969;">(</span>reg t<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label gcd-2<span style="color: #696969;">))</span>
after-gcd-2
</pre>
</div>

<pre class="example">
     现在两个代码片段基本相同，只是入口和出口标号不同

     这里还有一些重复的控制器代码，下面考虑如何消去它们
</pre>

<ol class="org-ol">
<li>调用在进入 GCD 代码前把一个 <span class="underline">continue 寄存器</span> 设为不同值</li>
<li>在 GCD 代码出口根据 continue 寄存器 <b>跳到正确执行位置</b></li>
</ol>

<p>
得到的代码如下所示，其中只有一段计算 GCD 的代码：
</p>

<div class="org-src-container">
<pre class="src src-scheme">gcd
<span style="color: #696969;">(</span>test <span style="color: #696969;">(</span>op =<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg b<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>const 0<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>branch <span style="color: #696969;">(</span>label gcd-done<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>assign t <span style="color: #696969;">(</span>op rem<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg a<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg b<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>assign a <span style="color: #696969;">(</span>reg b<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>assign b <span style="color: #696969;">(</span>reg t<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label gcd<span style="color: #696969;">))</span>
gcd-done
<span style="color: #696969;">(</span>test <span style="color: #696969;">(</span>op =<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg continue<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>const 0<span style="color: #696969;">))</span>       
<span style="color: #696969;">(</span>branch <span style="color: #696969;">(</span>label after-gcd-1<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label after-gcd-2<span style="color: #696969;">))</span>

<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#22312;&#31532;&#19968;&#27425;&#35843;&#29992; gcd &#20043;&#21069;&#65292;&#25226; continue &#23492;&#23384;&#22120;&#35774;&#32622;&#20026; 0 </span>
<span style="color: #696969;">(</span>assign continue <span style="color: #696969;">(</span>const 0<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label gcd<span style="color: #696969;">))</span>
after-gcd-1

<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#22312;&#31532;&#20108;&#27425;&#35843;&#29992; gcd &#20043;&#21069;&#65292;&#25226; continue &#23492;&#23384;&#22120;&#35774;&#32622;&#20026; 1 </span>
<span style="color: #696969;">(</span>assign continue <span style="color: #696969;">(</span>const 1<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label gcd<span style="color: #696969;">))</span>
after-gcd-2
</pre>
</div>

<pre class="example">
     这种技术可满足本程序需要（一段代码，正确返回）

     但如果程序里有许多GCD 计算，代码会很复杂，难写也难维护

     需要考虑更一般的实现模式
</pre>

<p>
新的思路是基于 <span class="underline">代码指针</span> ，也就是在寄存器里 <b>保存控制信息</b> ：
</p>
<ul class="org-ul">
<li>用一个寄存器 continue 保存 <b>返回地址</b> ，GCD 代码最后按它的内容跳转</li>
<li>扩充 <span class="underline">goto</span> 指令功能：
<ul class="org-ul">
<li>参数是 <span class="underline">标号</span> ：（直接）跳</li>
<li>参数是 <span class="underline">寄存器</span> ： <b>跳到寄存器中保存的标号</b> （寄存器间接跳）</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-scheme">gcd
<span style="color: #696969;">(</span>test <span style="color: #696969;">(</span>op =<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg b<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>const 0<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>branch <span style="color: #696969;">(</span>label gcd-done<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>assign t <span style="color: #696969;">(</span>op rem<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg a<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg b<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>assign a <span style="color: #696969;">(</span>reg b<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>assign b <span style="color: #696969;">(</span>reg t<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label gcd<span style="color: #696969;">))</span>
gcd-done
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>reg continue<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#38388;&#25509;&#36339;&#36716;&#21040;&#23492;&#23384;&#22120;&#20013;&#20445;&#23384;&#30340;&#26631;&#21495;</span>

<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">continue &#23492;&#23384;&#22120;&#20445;&#23384;&#26631;&#21495;</span>
<span style="color: #696969;">(</span>assign continue <span style="color: #696969;">(</span>label after-gcd-1<span style="color: #696969;">))</span> 
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label gcd<span style="color: #696969;">))</span>
after-gcd-1

<span style="color: #696969;">(</span>assign continue <span style="color: #696969;">(</span>label after-gcd-2<span style="color: #696969;">))</span> 
<span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label gcd<span style="color: #696969;">))</span>
after-gcd-2
</pre>
</div>

<p>
这样就实现了子程序和子程序调用
</p>
<pre class="example">
     多个子程序调用相互无关时可以共用一个 continue 寄存器

     如果子程序里还有子程序调用，就需要多个continue 寄存器，否则会丢失外层调用的返回标号
</pre>
</div>
</div>

<div id="outline-container-orgdc23a2a" class="outline-3">
<h3 id="orgdc23a2a">递归</h3>
<div class="outline-text-3" id="text-orgdc23a2a">
<p>
考虑阶乘过程：
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">factorial</span> n<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">if</span> <span style="color: #696969;">(</span>= n 1<span style="color: #696969;">)</span>
      1
      <span style="color: #696969;">(</span>* <span style="color: #696969;">(</span>factorial <span style="color: #696969;">(</span>- n 1<span style="color: #696969;">))</span> n<span style="color: #696969;">)))</span>
</pre>
</div>

<p>
粗看这和计算 gcd 类似： 
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">gcd</span> a b<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">if</span> <span style="color: #696969;">(</span>= b 0<span style="color: #696969;">)</span>
      a
      <span style="color: #696969;">(</span>gcd b <span style="color: #696969;">(</span>remainder a b<span style="color: #696969;">))))</span>
</pre>
</div>

<p>
但两者有重要的区别：
</p>
<ul class="org-ul">
<li>最后一次调用 gcd 的结果就是最终需要的结果</li>
<li>阶乘子问题的结果并不是原问题的结果，返回后还要乘以 n</li>
</ul>

<pre class="example">
     如采用前面设计，减值后求 n-1 的阶乘，原来的 n 值就丢了，没办法再找回来求乘积

     另外做一个机器解决子问题也不行：
     子问题还可能有子问题，初始时 n 为任意整数，因此子问题可以有任意层嵌套，
     有穷个部件无法构造出所需要的机器

     计算阶乘需要做一种安排，使所有计算能通过同一机器完成。
</pre>

<p>
表面看需要嵌套的无穷多部机器，但任何时刻实际上只用一部，因此可以在遇到子问题时 <b>挂起当前计算</b> ，解决子问题后回来继续原计算。注意：
</p>
<ul class="org-ul">
<li>进入 <b>子问题时的状态与原问题不同</b> （如 n 变成 n-1）</li>
<li>为了以后能继续做中断的计算，必须 <b>保存状态</b> （当时n 的值）</li>
</ul>

<pre class="example">
还有控制问题，子程序结束后返回哪里？

continue 保存返回位置，但是递归使用同一机器时又需要用这个寄存器，赋以新值就会丢掉将来要返回的位置
</pre>

<p>
由于不知道递归的深度，需要准备保存任意多个寄存器值：
</p>
<ul class="org-ul">
<li>这些值的 <b>使用顺序</b> 与 <b>保存顺序</b> 相反， <b>后存先用</b></li>
<li>用一个 <b>后进先出</b> 数据结构 <b>栈</b></li>
</ul>

<p>
为保证正确返回，调用前也要把 <span class="underline">continue</span>  的值 <b>入栈</b> 
</p>
</div>

<div id="outline-container-org4ec116e" class="outline-4">
<h4 id="org4ec116e">阶乘递归机器</h4>
<div class="outline-text-4" id="text-org4ec116e">
<p>
假定有栈操作 <span class="underline">save</span> / <span class="underline">restore</span> ，就可以重用同一阶乘机器，完成所有子阶乘计算：
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span>controller
 <span style="color: #696969;">(</span>assign continue <span style="color: #696969;">(</span>label fact-done<span style="color: #696969;">))</span>     <span style="color: #5f9ea0; font-style: italic;">; </span><span style="color: #5f9ea0; font-style: italic;">&#35774;&#32622;&#26368;&#32456;&#36820;&#22238;&#30340;&#25191;&#34892;&#22320;&#22336;</span>
 fact-loop
 <span style="color: #696969;">(</span>test <span style="color: #696969;">(</span>op =<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg n<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>const 1<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>branch <span style="color: #696969;">(</span>label base-case<span style="color: #696969;">))</span>
 <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#20026;&#20102;&#25191;&#34892;&#36882;&#24402;&#65292;&#20445;&#23384; continue &#21644; n &#30340;&#20540;</span>
 <span style="color: #696969;">(</span>save continue<span style="color: #696969;">)</span>
 <span style="color: #696969;">(</span>save n<span style="color: #696969;">)</span>
 <span style="color: #696969;">(</span>assign n <span style="color: #696969;">(</span>op -<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg n<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>const 1<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>assign continue <span style="color: #696969;">(</span>label after-fact<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">fact-loop &#23376;&#31243;&#24207;&#36820;&#22238;&#21518;&#24674;&#22797;&#65292;&#20351;&#35745;&#31639;&#21487;&#20197;&#32487;&#32493;&#25191;&#34892; after-fact </span>
 <span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label fact-loop<span style="color: #696969;">))</span>
 after-fact
 <span style="color: #696969;">(</span>restore n<span style="color: #696969;">)</span>
 <span style="color: #696969;">(</span>restore continue<span style="color: #696969;">)</span>
 <span style="color: #696969;">(</span>assign val <span style="color: #696969;">(</span>op *<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg n<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg val<span style="color: #696969;">))</span>   <span style="color: #5f9ea0; font-style: italic;">; </span><span style="color: #5f9ea0; font-style: italic;">val now contains n(n - 1)!</span>
 <span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>reg continue<span style="color: #696969;">))</span>                   <span style="color: #5f9ea0; font-style: italic;">; </span><span style="color: #5f9ea0; font-style: italic;">return to caller &#25345;&#32493;&#35843;&#29992; after-fact &#26368;&#21518;&#19968;&#27425;&#35843;&#29992; fact-done </span>
 base-case
 <span style="color: #696969;">(</span>assign val <span style="color: #696969;">(</span>const 1<span style="color: #696969;">))</span>                  <span style="color: #5f9ea0; font-style: italic;">; </span><span style="color: #5f9ea0; font-style: italic;">base case: 1! = 1</span>
 <span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>reg continue<span style="color: #696969;">))</span>                   <span style="color: #5f9ea0; font-style: italic;">; </span><span style="color: #5f9ea0; font-style: italic;">return to caller &#36882;&#24402;&#35843;&#29992;&#21069;&#20445;&#23384;&#36820;&#22238;&#30340;&#20301;&#32622; after-fact</span>
 fact-done<span style="color: #696969;">)</span>
</pre>
</div>


<div class="figure">
<p><img src="pic/fact_recursive_machine.gif" alt="fact_recursive_machine.gif" width="50%" /> 
</p>
</div>

<pre class="example">
      原则上说，实现递归计算需要无穷机器。这里用有穷机器实现

      但其中还是有无穷的东西：栈的存储空间没有上界
      实际机器里栈的规模有限，这就限制了机器递归的深度，也限制了能求解的阶乘的大小
</pre>

<p>
处理递归的一般方法：
</p>
<ul class="org-ul">
<li>用一部常规寄存器机器加一个 <b>栈</b></li>
<li>遇到递归调用时，把从 <span class="underline">子程序返回</span> 后还 <span class="underline">需要的寄存器的值</span> 存 <b>入栈</b> 
<ul class="org-ul">
<li>特别是必须保存当时continue 寄存器的值，将来返回一定需要</li>
</ul></li>
</ul>

<pre class="example">
	    可以把所有子程序调用都统一到这一模式

	    前面说的在子程序里调用子程序的麻烦也一起解决了
</pre>
</div>
</div>

<div id="outline-container-org805c066" class="outline-4">
<h4 id="org805c066">斐波纳契数递归机器</h4>
<div class="outline-text-4" id="text-org805c066">
<p>
考虑双递归，以过程 fib 为例：
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">fib</span> n<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">if</span> <span style="color: #696969;">(</span>&lt; n 2<span style="color: #696969;">)</span>
      n
      <span style="color: #696969;">(</span>+ <span style="color: #696969;">(</span>fib <span style="color: #696969;">(</span>- n 1<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>fib <span style="color: #696969;">(</span>- n 2<span style="color: #696969;">))))))</span> 
</pre>
</div>

<p>
斐波纳契数计算可以实现为寄存器机器：两个递归调用都用同一机器完成。调用前设置 continue 寄存器，指明完成计算后返回的位置
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span>controller
 <span style="color: #696969;">(</span>assign continue <span style="color: #696969;">(</span>label fib-done<span style="color: #696969;">))</span>
 fib-loop
 <span style="color: #696969;">(</span>test <span style="color: #696969;">(</span>op &lt;<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg n<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>const 2<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>branch <span style="color: #696969;">(</span>label immediate-answer<span style="color: #696969;">))</span>
 <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">set up to compute Fib(n - 1)</span>
 <span style="color: #696969;">(</span>save continue<span style="color: #696969;">)</span>
 <span style="color: #696969;">(</span>assign continue <span style="color: #696969;">(</span>label afterfib-n-1<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>save n<span style="color: #696969;">)</span>                           <span style="color: #5f9ea0; font-style: italic;">; </span><span style="color: #5f9ea0; font-style: italic;">save old value of n</span>
 <span style="color: #696969;">(</span>assign n <span style="color: #696969;">(</span>op -<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg n<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>const 1<span style="color: #696969;">))</span><span style="color: #5f9ea0; font-style: italic;">; </span><span style="color: #5f9ea0; font-style: italic;">clobber n to n - 1</span>
 <span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label fib-loop<span style="color: #696969;">))</span>            <span style="color: #5f9ea0; font-style: italic;">; </span><span style="color: #5f9ea0; font-style: italic;">perform recursive call</span>
 afterfib-n-1                         <span style="color: #5f9ea0; font-style: italic;">; </span><span style="color: #5f9ea0; font-style: italic;">upon return, val contains Fib(n - 1)</span>
 <span style="color: #696969;">(</span>restore n<span style="color: #696969;">)</span>
 <span style="color: #696969;">(</span>restore continue<span style="color: #696969;">)</span>
 <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">set up to compute Fib(n - 2)</span>
 <span style="color: #696969;">(</span>assign n <span style="color: #696969;">(</span>op -<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg n<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>const 2<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>save continue<span style="color: #696969;">)</span>
 <span style="color: #696969;">(</span>assign continue <span style="color: #696969;">(</span>label afterfib-n-2<span style="color: #696969;">))</span>
 <span style="color: #696969;">(</span>save val<span style="color: #696969;">)</span>                         <span style="color: #5f9ea0; font-style: italic;">; </span><span style="color: #5f9ea0; font-style: italic;">save Fib(n - 1)</span>
 <span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label fib-loop<span style="color: #696969;">))</span>
 afterfib-n-2                         <span style="color: #5f9ea0; font-style: italic;">; </span><span style="color: #5f9ea0; font-style: italic;">upon return, val contains Fib(n - 2)</span>
 <span style="color: #696969;">(</span>assign n <span style="color: #696969;">(</span>reg val<span style="color: #696969;">))</span>               <span style="color: #5f9ea0; font-style: italic;">; </span><span style="color: #5f9ea0; font-style: italic;">n now contains Fib(n - 2)</span>
 <span style="color: #696969;">(</span>restore val<span style="color: #696969;">)</span>                      <span style="color: #5f9ea0; font-style: italic;">; </span><span style="color: #5f9ea0; font-style: italic;">val now contains Fib(n - 1)</span>
 <span style="color: #696969;">(</span>restore continue<span style="color: #696969;">)</span>
 <span style="color: #696969;">(</span>assign val                        <span style="color: #5f9ea0; font-style: italic;">;  </span><span style="color: #5f9ea0; font-style: italic;">Fib(n - 1) +  Fib(n - 2)</span>
         <span style="color: #696969;">(</span>op +<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg val<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg n<span style="color: #696969;">))</span> 
 <span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>reg continue<span style="color: #696969;">))</span>              <span style="color: #5f9ea0; font-style: italic;">; </span><span style="color: #5f9ea0; font-style: italic;">return to caller, answer is in val</span>
 immediate-answer
 <span style="color: #696969;">(</span>assign val <span style="color: #696969;">(</span>reg n<span style="color: #696969;">))</span>               <span style="color: #5f9ea0; font-style: italic;">; </span><span style="color: #5f9ea0; font-style: italic;">base case:  Fib(n) = n</span>
 <span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>reg continue<span style="color: #696969;">))</span>
 fib-done<span style="color: #696969;">)</span>
</pre>
</div>

<pre class="example">
      调用 afterfib-n-1 前必须保存 n 寄存器，因为计算 fib(n -2) 需要 n

      调用 afterfib-n-2 前必须保存 val 寄存器，此时 val 寄存器中的值是 fib(n -1)
      因为计算完 fib(n - 2) 以后需要 fib(n - 1) 做加法
</pre>
</div>
</div>
</div>


<div id="outline-container-org66cae60" class="outline-3">
<h3 id="org66cae60">指令总结</h3>
<div class="outline-text-3" id="text-org66cae60">
<p>
寄存器机器指令总结，其中 &lt;inputi&gt; 可以是 (reg &lt;register-name&gt;) 或者 (const &lt;constant-value&gt;) ：
</p>
<pre class="example">
(assign &lt;register-name&gt; (reg &lt;register-name&gt;))

(assign &lt;register-name&gt; (const &lt;constant-value&gt;))

(assign &lt;register-name&gt; (op &lt;operation-name&gt;) &lt;input1&gt; ... &lt;inputn&gt;)

(perform (op &lt;operation-name&gt;) &lt;input1&gt; ... &lt;inputn&gt;)

(test (op &lt;operation-name&gt;) &lt;input1&gt; ... &lt;inputn&gt;)

(branch (label &lt;label-name&gt;))

(goto (label &lt;label-name&gt;))
</pre>

<p>
将 <span class="underline">标号存入寄存器</span> 和 <span class="underline">通过寄存器间接跳转</span> ：
</p>

<pre class="example">
(assign &lt;register-name&gt; (label &lt;label-name&gt;))

(goto (reg &lt;register-name&gt;))
</pre>

<p>
压栈和出栈指令：
</p>
<pre class="example">
(save &lt;register-name&gt;)

(restore &lt;register-name&gt;)
</pre>

<p>
前面的 &lt;constant-value&gt; 都是 <span class="underline">数值</span> ，还可能用到 <b>字符串</b> 、 <b>符号</b> 和 <b>表常量</b> ： 
</p>

<pre class="example">
     字符串：(const "abc") 
     符号：(const abc) 
     列表：(const (a b c)) 
     空表：(const ()) 
</pre>
</div>
</div>
</div>

<div id="outline-container-orgee18268" class="outline-2">
<h2 id="orgee18268">寄存器机器模拟器</h2>
<div class="outline-text-2" id="text-orgee18268">
<pre class="example">
    为了更好的理解前面设计的寄存器机器，必须测试机器是否如预计地运行

    有一种方式就是如上面一样用手工来模拟控制器动作，但哪怕是之前那些最简单的程序，这项工作仍然是非常单调乏味的！
</pre>

<p>
下面开发的寄存器模拟器是一个Scheme 程序，有 4 个 <span class="underline">接口过程</span> ：
</p>
<ol class="org-ol">
<li><p>
根据被 <b>模拟机器的描述</b> （ <span class="underline">寄存器</span> 、 <span class="underline">操作</span> 和 <span class="underline">控制器</span> ）构造出一个可以 <b>模拟执行的机器模型</b> 
</p>
<pre class="example">
(make-machine &lt;register-names&gt; &lt;operations&gt; &lt;controller&gt;)
</pre></li>
<li><p>
把一个 <span class="underline">值</span> <b>存入</b> 指定的 <span class="underline">寄存器</span> 
</p>
<pre class="example">
(set-register-contents! &lt;machine-model&gt; &lt;register-name&gt; &lt;value&gt;)
</pre></li>
<li><p>
取出一个寄存器的内容
</p>
<pre class="example">
(get-register-contents &lt;machine-model&gt; &lt;register-name&gt;)
</pre></li>
<li><p>
让机器开始运行
</p>
<pre class="example">
(start &lt;machine-model&gt;)
</pre></li>
</ol>
</div>

<div id="outline-container-org70a852b" class="outline-3">
<h3 id="org70a852b">GCD 模拟器实例</h3>
<div class="outline-text-3" id="text-org70a852b">
<p>
make-machine 参数：
</p>
<ul class="org-ul">
<li>寄存器表： <span class="underline">( a b t)</span></li>
<li>操作表：每个子表给出  
<ul class="org-ul">
<li>操作名 : <span class="underline">rem</span></li>
<li>实现操作的 Scheme 过程: <span class="underline">remainder</span></li>
</ul></li>
<li>控制器代码</li>
</ul>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #daa520; font-weight: bold;">gcd-machine</span>
  <span style="color: #696969;">(</span>make-machine
   '<span style="color: #696969;">(</span>a b t<span style="color: #696969;">)</span>
   <span style="color: #696969;">(</span>list <span style="color: #696969;">(</span>list 'rem remainder<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>list '= =<span style="color: #696969;">))</span>
   '<span style="color: #696969;">(</span>test-b
     <span style="color: #696969;">(</span>test <span style="color: #696969;">(</span>op =<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg b<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>const 0<span style="color: #696969;">))</span>
     <span style="color: #696969;">(</span>branch <span style="color: #696969;">(</span>label gcd-done<span style="color: #696969;">))</span>
     <span style="color: #696969;">(</span>assign t <span style="color: #696969;">(</span>op rem<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg a<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg b<span style="color: #696969;">))</span>
     <span style="color: #696969;">(</span>assign a <span style="color: #696969;">(</span>reg b<span style="color: #696969;">))</span>
     <span style="color: #696969;">(</span>assign b <span style="color: #696969;">(</span>reg t<span style="color: #696969;">))</span>
     <span style="color: #696969;">(</span>goto <span style="color: #696969;">(</span>label test-b<span style="color: #696969;">))</span>
     gcd-done<span style="color: #696969;">)))</span>
</pre>
</div>

<p>
计算：设置寄存器，然后启动
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span>set-register-contents! gcd-machine 'a 206<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">done</span>
<span style="color: #696969;">(</span>set-register-contents! gcd-machine 'b 40<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">done</span>

<span style="color: #696969;">(</span>start gcd-machine<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">done</span>

<span style="color: #696969;">(</span>get-register-contents gcd-machine 'a<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">=&gt; 2</span>
</pre>
</div>

<pre class="example">
     这个计算会比 用 Scheme实现的 gcd 过程慢得多，因为模拟底层机器语言（类似assign语句），需要许多非常复杂的操作才行 
</pre>
</div>
</div>
<div id="outline-container-org7556d92" class="outline-3">
<h3 id="org7556d92">机器模型</h3>
<div class="outline-text-3" id="text-org7556d92">
<p>
机器模型是 <b>包含局部变量</b> 的 <span class="underline">过程</span> ，采用 <span class="underline">消息传递</span> 技术
</p>
<ol class="org-ol">
<li>make-new-machine: 构造出所有寄存器机器都有的 <b>公共部分</b> ，包括
<ul class="org-ul">
<li>若干内部 <span class="underline">寄存器</span></li>
<li>一个 <span class="underline">栈</span></li>
<li>一个 <span class="underline">执行器</span></li>
</ul></li>
<li>扩充该模型：
<ul class="org-ul">
<li>加入 <b>具体机器</b> 的 <span class="underline">寄存器</span> 和 <span class="underline">操作</span></li>
<li>用一个 <b>汇编器</b> 把 <span class="underline">控制器表</span>  <b>翻译成</b> 易于解释的 <span class="underline">指令序列</span> 并 <b>安装到机器</b> 里</li>
</ul></li>
</ol>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">make-machine</span> register-names ops controller-text<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">let</span> <span style="color: #696969;">((</span>machine <span style="color: #696969;">(</span>make-new-machine<span style="color: #696969;">)))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#26500;&#36896;&#20986;&#19968;&#21488;&#36890;&#29992;&#30340;&#23492;&#23384;&#22120;&#26426;&#22120;</span>
    <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#21152;&#20837;&#20855;&#20307;&#26426;&#22120;&#30340;&#23492;&#23384;&#22120;</span>
    <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">for-each</span> <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>register-name<span style="color: #696969;">)</span> 
                <span style="color: #696969;">((</span>machine 'allocate-register<span style="color: #696969;">)</span> register-name<span style="color: #696969;">))</span> 
              register-names<span style="color: #696969;">)</span>
    <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#23433;&#35013;&#26426;&#22120;&#30340;&#25805;&#20316;</span>
    <span style="color: #696969;">((</span>machine 'install-operations<span style="color: #696969;">)</span> ops<span style="color: #696969;">)</span>
    <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#27719;&#32534;&#22120;&#32763;&#35793;&#25104;&#25351;&#20196;&#65292;&#24182;&#23433;&#35013;&#21040;&#26426;&#22120;&#37324;</span>
    <span style="color: #696969;">((</span>machine 'install-instruction-sequence<span style="color: #696969;">)</span>
     <span style="color: #696969;">(</span>assemble controller-text machine<span style="color: #696969;">))</span>
    machine<span style="color: #696969;">))</span>
</pre>
</div>
</div>
<div id="outline-container-orgad139a9" class="outline-4">
<h4 id="orgad139a9">寄存器</h4>
<div class="outline-text-4" id="text-orgad139a9">
<p>
寄存器：有 <b>局部状态</b> 的 <span class="underline">过程</span> ，可以 <span class="underline">保存</span> 值、 <span class="underline">访问</span> 或 <span class="underline">修改</span> 
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">make-register</span> name<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">let</span> <span style="color: #696969;">((</span>contents '*unassigned*<span style="color: #696969;">))</span>
    <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">dispatch</span> message<span style="color: #696969;">)</span>
      <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">cond</span> <span style="color: #696969;">((</span>eq? message 'get<span style="color: #696969;">)</span> contents<span style="color: #696969;">)</span>
            <span style="color: #696969;">((</span>eq? message 'set<span style="color: #696969;">)</span>
             <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>value<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>set! contents value<span style="color: #696969;">)))</span>
            <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">else</span>
             <span style="color: #696969;">(</span>error <span style="color: #deb887;">"Unknown request -- REGISTER"</span> message<span style="color: #696969;">))))</span>
    dispatch<span style="color: #696969;">))</span>
</pre>
</div>

<p>
访问寄存器的过程：
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">get-contents</span> register<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>register 'get<span style="color: #696969;">))</span>

<span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">set-contents!</span> register value<span style="color: #696969;">)</span>
  <span style="color: #696969;">((</span>register 'set<span style="color: #696969;">)</span> value<span style="color: #696969;">))</span>

<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">(define test-register (make-register 'test))</span>
<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">(get-contents test-register) ;; *unassigned*</span>
<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">(set-contents! test-register 10)</span>
<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">(get-contents test-register) ;; 10</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org5413a1e" class="outline-4">
<h4 id="org5413a1e">栈</h4>
<div class="outline-text-4" id="text-org5413a1e">
<p>
栈和寄存器类似，也是有局部状态的过程：
</p>
<ul class="org-ul">
<li>make-stack : 创建栈，接收消息：
<ul class="org-ul">
<li>push :  压栈</li>
<li>pop : 出栈</li>
<li>initialize : 初始化</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">make-stack</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">let</span> <span style="color: #696969;">((</span>s '<span style="color: #696969;">()))</span>
    <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">push</span> x<span style="color: #696969;">)</span>
      <span style="color: #696969;">(</span>set! s <span style="color: #696969;">(</span>cons x s<span style="color: #696969;">)))</span>
    <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">pop</span><span style="color: #696969;">)</span>
      <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">if</span> <span style="color: #696969;">(</span>null? s<span style="color: #696969;">)</span>
          <span style="color: #696969;">(</span>error <span style="color: #deb887;">"Empty stack -- POP"</span><span style="color: #696969;">)</span>
          <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">let</span> <span style="color: #696969;">((</span>top <span style="color: #696969;">(</span>car s<span style="color: #696969;">)))</span>
            <span style="color: #696969;">(</span>set! s <span style="color: #696969;">(</span>cdr s<span style="color: #696969;">))</span>
            top<span style="color: #696969;">)))</span>
    <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">initialize</span><span style="color: #696969;">)</span>
      <span style="color: #696969;">(</span>set! s '<span style="color: #696969;">())</span>
      'done<span style="color: #696969;">)</span>
    <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">dispatch</span> message<span style="color: #696969;">)</span>
      <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">cond</span> <span style="color: #696969;">((</span>eq? message 'push<span style="color: #696969;">)</span> push<span style="color: #696969;">)</span>
            <span style="color: #696969;">((</span>eq? message 'pop<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>pop<span style="color: #696969;">))</span>
            <span style="color: #696969;">((</span>eq? message 'initialize<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>initialize<span style="color: #696969;">))</span>
            <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">else</span> <span style="color: #696969;">(</span>error <span style="color: #deb887;">"Unknown request -- STACK"</span>
                         message<span style="color: #696969;">))))</span>
    dispatch<span style="color: #696969;">))</span>
</pre>
</div>

<p>
访问栈的过程：
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">pop</span> stack<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>stack 'pop<span style="color: #696969;">))</span>

<span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">push</span> stack value<span style="color: #696969;">)</span>
  <span style="color: #696969;">((</span>stack 'push<span style="color: #696969;">)</span> value<span style="color: #696969;">))</span>

<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">(define test-stack (make-stack))</span>
<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">(pop test-stack) ;;  Empty stack -- POP</span>
<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">(push test-stack 1)</span>
<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">(pop test-stack) ;;  1</span>
<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">(pop test-stack) ;;  Empty stack -- POP</span>
<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">(push test-stack 2) ;;</span>
<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">(test-stack 'initialize) ;; done</span>
<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">(pop test-stack) ;;  Empty stack -- POP</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org2514462" class="outline-4">
<h4 id="org2514462">基础机器</h4>
<div class="outline-text-4" id="text-org2514462">
<p>
基础机器模型的 <b>局部状态变量</b> 包含：
</p>
<ul class="org-ul">
<li>一个寄存器表：register-table 
<ul class="org-ul">
<li>指令寄存器： pc</li>
<li>标志寄存器：flag</li>
</ul></li>
<li>一个栈：stack</li>
<li>一个操作列表： the-ops 
<ul class="org-ul">
<li>初始化栈操作：initialize-stack</li>
</ul></li>
<li>一个初始为空的指令列表：the-instruction-sequence</li>
</ul>

<p>
基础机器模型的包含的过程：
</p>
<ul class="org-ul">
<li>allocate-register : 添加新的寄存器到寄存器表</li>
<li>lookup-register: 在寄存器表中获取对应寄存器的值</li>
<li>execute: 执行指令：
<ul class="org-ul">
<li>取 pc 指向的指令
<ul class="org-ul">
<li>如果 pc 中的指令不为空
<ol class="org-ol">
<li>执行指令：</li>
<li>执行结束改变 pc 寄存器的值
<ul class="org-ul">
<li>branch 和 goto 指令会直接改变 pc 寄存器中的值</li>
<li>其他情况简单的使 pc 指向指令列表中的下一个元素</li>
</ul></li>
<li>递归调用 execute</li>
</ol></li>
<li>如果 pc 中的指令为空：结束执行</li>
</ul></li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">make-new-machine</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">let</span> <span style="color: #696969;">((</span>pc <span style="color: #696969;">(</span>make-register 'pc<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#25351;&#20196;&#23492;&#23384;&#22120;</span>
        <span style="color: #696969;">(</span>flag <span style="color: #696969;">(</span>make-register 'flag<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#26631;&#24535;&#23492;&#23384;&#22120;</span>
        <span style="color: #696969;">(</span>stack <span style="color: #696969;">(</span>make-stack<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#26632;</span>
        <span style="color: #696969;">(</span>the-instruction-sequence '<span style="color: #696969;">()))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#25351;&#20196;&#21015;&#34920;</span>
    <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">let</span> <span style="color: #696969;">((</span>the-ops <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#25805;&#20316;&#21015;&#34920;</span>
           <span style="color: #696969;">(</span>list <span style="color: #696969;">(</span>list 'initialize-stack
                       <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">lambda</span> <span style="color: #696969;">()</span> <span style="color: #696969;">(</span>stack 'initialize<span style="color: #696969;">)))))</span>
          <span style="color: #696969;">(</span>register-table <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#23492;&#23384;&#22120;&#21015;&#34920;</span>
           <span style="color: #696969;">(</span>list <span style="color: #696969;">(</span>list 'pc pc<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>list 'flag flag<span style="color: #696969;">))))</span>
      <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#28155;&#21152;&#26032;&#30340;&#23492;&#23384;&#22120;</span>
      <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">allocate-register</span> name<span style="color: #696969;">)</span> 
        <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">if</span> <span style="color: #696969;">(</span>assoc name register-table<span style="color: #696969;">)</span>
            <span style="color: #696969;">(</span>error <span style="color: #deb887;">"Multiply defined register: "</span> name<span style="color: #696969;">)</span>
            <span style="color: #696969;">(</span>set! register-table
                  <span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>list name <span style="color: #696969;">(</span>make-register name<span style="color: #696969;">))</span>
                        register-table<span style="color: #696969;">)))</span>
        'register-allocated<span style="color: #696969;">)</span>
      <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#20174;&#23492;&#23384;&#22120;&#21015;&#34920;&#33719;&#24471;&#29305;&#23450;&#23492;&#23384;&#22120;</span>
      <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">lookup-register</span> name<span style="color: #696969;">)</span>
        <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">let</span> <span style="color: #696969;">((</span>val <span style="color: #696969;">(</span>assoc name register-table<span style="color: #696969;">)))</span>
          <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">if</span> val
              <span style="color: #696969;">(</span>cadr val<span style="color: #696969;">)</span>
              <span style="color: #696969;">(</span>error <span style="color: #deb887;">"Unknown register:"</span> name<span style="color: #696969;">))))</span>
      <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#25191;&#34892;&#25351;&#20196;</span>
      <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">execute</span><span style="color: #696969;">)</span>
        <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">let</span> <span style="color: #696969;">((</span>insts <span style="color: #696969;">(</span>get-contents pc<span style="color: #696969;">)))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#33719;&#24471; pc &#23492;&#23384;&#22120;&#30340;&#20540;</span>
          <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">if</span> <span style="color: #696969;">(</span>null? insts<span style="color: #696969;">)</span>
              'done
              <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">begin</span>
                <span style="color: #696969;">((</span>instruction-execution-proc <span style="color: #696969;">(</span>car insts<span style="color: #696969;">)))</span>
                <span style="color: #696969;">(</span>execute<span style="color: #696969;">)))))</span>
      <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">dispatch</span> message<span style="color: #696969;">)</span>
        <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">cond</span> <span style="color: #696969;">((</span>eq? message 'start<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#21551;&#21160;&#26426;&#22120;</span>
               <span style="color: #696969;">(</span>set-contents! pc the-instruction-sequence<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">pc &#23492;&#23384;&#22120;&#25351;&#21521;&#25351;&#20196;&#21015;&#34920;</span>
               <span style="color: #696969;">(</span>execute<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#25191;&#34892;&#25351;&#20196;</span>
              <span style="color: #696969;">((</span>eq? message 'install-instruction-sequence<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#23433;&#35013;&#25351;&#20196;&#21015;&#34920; </span>
               <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>seq<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>set! the-instruction-sequence seq<span style="color: #696969;">)))</span> 
              <span style="color: #696969;">((</span>eq? message 'allocate-register<span style="color: #696969;">)</span> allocate-register<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#28155;&#21152;&#23492;&#23384;&#22120;</span>
              <span style="color: #696969;">((</span>eq? message 'get-register<span style="color: #696969;">)</span> lookup-register<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#26597;&#35810;&#23492;&#23384;&#22120;</span>
              <span style="color: #696969;">((</span>eq? message 'install-operations<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#23433;&#35013;&#25805;&#20316;&#36807;&#31243;</span>
               <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>ops<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>set! the-ops <span style="color: #696969;">(</span>append the-ops ops<span style="color: #696969;">))))</span>
              <span style="color: #696969;">((</span>eq? message 'stack<span style="color: #696969;">)</span> stack<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#36820;&#22238;&#26632;</span>
              <span style="color: #696969;">((</span>eq? message 'operations<span style="color: #696969;">)</span> the-ops<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#36820;&#22238;&#25805;&#20316;&#21015;&#34920;</span>
              <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">else</span> <span style="color: #696969;">(</span>error <span style="color: #deb887;">"Unknown request -- MACHINE"</span> message<span style="color: #696969;">))))</span>
      dispatch<span style="color: #696969;">)))</span>
</pre>
</div>

<p>
基本机器的一些接口过程：
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#21551;&#21160;&#26426;&#22120;</span>
<span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">start</span> machine<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>machine 'start<span style="color: #696969;">))</span>

<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#33719;&#24471;&#23492;&#23384;&#22120;&#20013;&#30340;&#20540;</span>
<span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">get-register-contents</span> machine register-name<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>get-contents <span style="color: #696969;">(</span>get-register machine register-name<span style="color: #696969;">)))</span>

<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#35774;&#32622;&#23492;&#23384;&#22120;&#20013;&#30340;&#20540;</span>
<span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">set-register-contents!</span> machine register-name value<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>set-contents! <span style="color: #696969;">(</span>get-register machine register-name<span style="color: #696969;">)</span> value<span style="color: #696969;">)</span>
  'done<span style="color: #696969;">)</span>

<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#21462;&#25351;&#23450;&#23492;&#23384;&#22120;&#20449;&#24687;</span>
<span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">get-register</span> machine reg-name<span style="color: #696969;">)</span>
  <span style="color: #696969;">((</span>machine 'get-register<span style="color: #696969;">)</span> reg-name<span style="color: #696969;">))</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org9b7f1f6" class="outline-3">
<h3 id="org9b7f1f6">汇编器</h3>
<div class="outline-text-3" id="text-org9b7f1f6">
<p>
最重要的部分是一个 <b>汇编器</b> 程序，它把给定的机器 <b>控制器</b> 翻译为一个 <b>指令序列</b> ，每条指令带着相应的 <b>执行过程</b> 
</p>
<pre class="example">
     与分析求值器类似，但这里处理的是寄存器机器语言
</pre>
<p>
虽然不知道表达式值和寄存器内容，也可以做许多分析和优化，如：
</p>
<ul class="org-ul">
<li>用 <span class="underline">指向寄存器对象的指针</span> 代替 <span class="underline">寄存器引用</span></li>
<li>用 <span class="underline">指向指令序列里具体位置的指针</span> 代替 <span class="underline">标号引用</span></li>
</ul>

<pre class="example">
     这和之前实现的“分析解释器”类似，都是不知道变量具体值的时候就可以做的优化（比如，避免多次分析表达式语法结构等）
</pre>

<p>
生成执行过程前要确定 <b>标号的位置</b> ，工作方式：
</p>
<ol class="org-ol">
<li>扫描控制器， <b>识别</b> 序列里的 <span class="underline">标号</span> ，构造：
<ul class="org-ul">
<li>一个 <span class="underline">指令表</span></li>
<li>一个 <span class="underline">标号位置关联表</span> ：把每个标号关联到指令表的一个位置</li>
</ul></li>
<li>再次扫描控制器， <b>生成</b> 并 <b>设置</b>  <span class="underline">指令表</span> 里各指令的 <span class="underline">执行过程</span></li>
</ol>
</div>
<div id="outline-container-orga85b3fa" class="outline-4">
<h4 id="orga85b3fa">接口程序</h4>
<div class="outline-text-4" id="text-orga85b3fa">
<p>
汇编程序的入口是 <span class="underline">assemble</span> ：
</p>
<ul class="org-ul">
<li>参数：一个 <span class="underline">控制器代码</span> 和一个 <span class="underline">基本机器模型</span></li>
<li>返回： <b>可以放入机器模型</b> 的 <span class="underline">指令序列</span></li>
</ul>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">assemble</span> controller-text machine<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>extract-labels controller-text <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#26500;&#36896;&#21021;&#22987;&#25351;&#20196;&#34920;&#21644;&#26631;&#21495;&#34920;</span>
                  <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>insts labels<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#25351;&#20196;&#34920;&#65292;&#26631;&#21495;&#34920;&#20316;&#20026;&#21442;&#25968;</span>
                    <span style="color: #696969;">(</span>update-insts! insts labels machine<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#20197;&#25351;&#20196;&#34920;&#12289;&#26631;&#21495;&#34920;&#21644;&#26426;&#22120;&#20026;&#21442;&#25968;&#65292;&#29983;&#25104;&#21508;&#26465;&#25351;&#20196;&#30340;&#25191;&#34892;&#36807;&#31243;&#21152;&#20837;&#25351;&#20196;&#34920;</span>
                    insts<span style="color: #696969;">)))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#36820;&#22238;&#25351;&#20196;&#34920;</span>
</pre>
</div>

<p>
构造和使用 <span class="underline">指令表</span> 的过程：
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#26500;&#36896;&#25351;&#20196;&#34920;</span>
<span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">make-instruction</span> text<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>cons text '<span style="color: #696969;">()))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#26500;&#36896;&#25351;&#20196;&#34920;&#26102;&#65292;&#25191;&#34892;&#36807;&#31243;&#26242;&#26102;&#29992;&#19968;&#20010;&#31354;&#34920;&#65292;&#21518;&#38754;&#23558;&#22635;&#20837;&#23454;&#38469;&#25191;&#34892;&#36807;&#31243;</span>
<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#33719;&#21462;&#25351;&#20196;</span>
<span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">instruction-text</span> inst<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>car inst<span style="color: #696969;">))</span>
<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#33719;&#24471;&#25351;&#20196;&#25191;&#34892;&#36807;&#31243;</span>
<span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">instruction-execution-proc</span> inst<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>cdr inst<span style="color: #696969;">))</span>
<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#35774;&#32622;&#25351;&#20196;&#25191;&#34892;&#36807;&#31243;</span>
<span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">set-instruction-execution-proc!</span> inst proc<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>set-cdr! inst proc<span style="color: #696969;">))</span>
</pre>
</div>

<p>
构造和查询 <span class="underline">标号关联表</span> 相关过程：
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#25226;&#26631;&#21495;&#21644;&#25351;&#20196;&#20570;&#20851;&#32852;</span>
<span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">make-label-entry</span> label-name insts<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>cons label-name insts<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#26631;&#21495;&#34920;&#39033;&#23601;&#26159;&#24207;&#23545;</span>

<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#26597;&#35810;&#26576;&#20010;&#26631;&#21495;&#20851;&#32852;&#34920;&#19979;&#26576;&#20010;&#26631;&#21495;&#23545;&#24212;&#30340;&#25351;&#20196;</span>
<span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">lookup-label</span> labels label-name<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">let</span> <span style="color: #696969;">((</span>val <span style="color: #696969;">(</span>assoc label-name labels<span style="color: #696969;">)))</span>
    <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">if</span> val
        <span style="color: #696969;">(</span>cdr val<span style="color: #696969;">)</span>
        <span style="color: #696969;">(</span>error <span style="color: #deb887;">"Undefined label -- ASSEMBLE"</span> label-name<span style="color: #696969;">))))</span>

</pre>
</div>

<p>
<span class="underline">extract-labels</span> : 逐项检查指令表内容， <b>提取</b> 其中的 <span class="underline">标号</span> ：
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#36880;&#39033;&#26816;&#26597;&#25351;&#20196;&#34920;&#20869;&#23481;&#65292;&#25552;&#21462;&#20854;&#20013;&#30340;&#26631;&#21495;</span>
<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">text: &#25511;&#21046;&#22120;&#20195;&#30721;</span>
<span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">receive: &#20989;&#25968;&#21442;&#25968; </span>
<span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">extract-labels</span> text receive<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">if</span> <span style="color: #696969;">(</span>null? text<span style="color: #696969;">)</span>
      <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">receive</span> '<span style="color: #696969;">()</span> '<span style="color: #696969;">())</span>
      <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#36882;&#24402;&#22788;&#29702;&#25511;&#21046;&#22120;&#27491;&#25991;&#24207;&#21015;&#30340; cdr</span>
      <span style="color: #696969;">(</span>extract-labels <span style="color: #696969;">(</span>cdr text<span style="color: #696969;">)</span>
                      <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>insts labels<span style="color: #696969;">)</span>
                        <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">let</span> <span style="color: #696969;">((</span>next-inst <span style="color: #696969;">(</span>car text<span style="color: #696969;">)))</span> 
                          <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">if</span> <span style="color: #696969;">(</span>symbol? next-inst<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#26816;&#26597; car &#26159;&#21542;&#26159;&#26631;&#21495;</span>
                              <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">receive</span> insts <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#22914;&#26524;&#26159;&#26631;&#21495;&#65292;&#21152;&#20837;&#26631;&#21495;&#39033;</span>
                                  <span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>make-label-entry next-inst
                                                          insts<span style="color: #696969;">)</span>
                                        labels<span style="color: #696969;">))</span>
                              <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">receive</span> <span style="color: #696969;">(</span>cons <span style="color: #696969;">(</span>make-instruction next-inst<span style="color: #696969;">)</span>
                                             insts<span style="color: #696969;">)</span>  <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#21453;&#20043;&#21152;&#20837;&#25351;&#20196;&#34920;&#39033;</span>
                                  labels<span style="color: #696969;">)))))))</span>
</pre>
</div>

<p>
<span class="underline">undate-insts!</span>  : 修改指令表。原来每个位置只有指令正文，执行过程用空表占位，现在 <b>添加</b> 实际的 <span class="underline">执行过程</span> 
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">&#21407;&#26469;&#27599;&#20010;&#20301;&#32622;&#21482;&#26377;&#25351;&#20196;&#27491;&#25991;&#65292;&#25191;&#34892;&#36807;&#31243;&#29992;&#31354;&#34920;&#21344;&#20301;&#65292;&#29616;&#22312;&#21152;&#20837;&#23454;&#38469;&#30340;&#25191;&#34892;&#36807;&#31243;</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">insts: &#25351;&#20196;&#34920;</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">labels: &#26631;&#21495;&#20851;&#32852;&#34920;</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">machine: &#26426;&#22120;&#27169;&#22411;</span>
<span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">update-insts!</span> insts labels machine<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">let</span> <span style="color: #696969;">((</span>pc <span style="color: #696969;">(</span>get-register machine 'pc<span style="color: #696969;">))</span>
        <span style="color: #696969;">(</span>flag <span style="color: #696969;">(</span>get-register machine 'flag<span style="color: #696969;">))</span>
        <span style="color: #696969;">(</span>stack <span style="color: #696969;">(</span>machine 'stack<span style="color: #696969;">))</span>
        <span style="color: #696969;">(</span>ops <span style="color: #696969;">(</span>machine 'operations<span style="color: #696969;">)))</span>
    <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">for-each</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#32473;&#19968;&#26465;&#25351;&#20196;&#35774;&#32622;&#25191;&#34892;&#36807;&#31243;</span>
     <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>inst<span style="color: #696969;">)</span>
       <span style="color: #696969;">(</span>set-instruction-execution-proc! 
        inst
        <span style="color: #696969;">(</span>make-execution-procedure <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#26500;&#36896;&#19968;&#26465;&#25351;&#20196;&#30340;&#25191;&#34892;&#36807;&#31243;</span>
         <span style="color: #696969;">(</span>instruction-text inst<span style="color: #696969;">)</span> labels machine
         pc flag stack ops<span style="color: #696969;">)))</span>
     insts<span style="color: #696969;">)))</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org92556cd" class="outline-4">
<h4 id="org92556cd">生成指令的执行过程</h4>
<div class="outline-text-4" id="text-org92556cd">
<p>
生成指令的执行过程的方式类似求值器的 <span class="underline">analyze</span> 过程：
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">&#29983;&#25104;&#19968;&#26465;&#25351;&#20196;&#30340;&#25191;&#34892;&#36807;&#31243;</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">inst: &#25351;&#20196;</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">labels: &#26631;&#21495;&#34920;</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">machine: &#26426;&#22120;&#27169;&#22411;</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">pc: &#25351;&#20196;&#23492;&#23384;&#22120;</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">flag: &#26631;&#24535;&#23492;&#23384;&#22120;</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">stack: &#26632;</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">ops: &#25805;&#20316;&#34920;</span>
<span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">make-execution-procedure</span> inst labels machine
                                  pc flag stack ops<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">cond</span> <span style="color: #696969;">((</span>eq? <span style="color: #696969;">(</span>car inst<span style="color: #696969;">)</span> 'assign<span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span>make-assign inst machine labels ops pc<span style="color: #696969;">))</span>
        <span style="color: #696969;">((</span>eq? <span style="color: #696969;">(</span>car inst<span style="color: #696969;">)</span> 'test<span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span>make-test inst machine labels ops flag pc<span style="color: #696969;">))</span>
        <span style="color: #696969;">((</span>eq? <span style="color: #696969;">(</span>car inst<span style="color: #696969;">)</span> 'branch<span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span>make-branch inst machine labels flag pc<span style="color: #696969;">))</span>
        <span style="color: #696969;">((</span>eq? <span style="color: #696969;">(</span>car inst<span style="color: #696969;">)</span> 'goto<span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span>make-goto inst machine labels pc<span style="color: #696969;">))</span>
        <span style="color: #696969;">((</span>eq? <span style="color: #696969;">(</span>car inst<span style="color: #696969;">)</span> 'save<span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span>make-save inst machine stack pc<span style="color: #696969;">))</span>
        <span style="color: #696969;">((</span>eq? <span style="color: #696969;">(</span>car inst<span style="color: #696969;">)</span> 'restore<span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span>make-restore inst machine stack pc<span style="color: #696969;">))</span>
        <span style="color: #696969;">((</span>eq? <span style="color: #696969;">(</span>car inst<span style="color: #696969;">)</span> 'perform<span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span>make-perform inst machine labels ops pc<span style="color: #696969;">))</span>
        <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">else</span> <span style="color: #696969;">(</span>error <span style="color: #deb887;">"Unknown instruction type -- ASSEMBLE"</span>
                     inst<span style="color: #696969;">))))</span>
</pre>
</div>

<pre class="example">
      每种指令有一个执行过程的生成过程，根据具体指令的语法和意义确定

      用数据抽象技术隔离指令的具体表示和对指令的操作
</pre>
</div>
<div id="outline-container-org86a634d" class="outline-5">
<h5 id="org86a634d">assign 指令</h5>
<div class="outline-text-5" id="text-org86a634d">
<p>
生成赋值指令的执行过程：
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">make-assign</span> inst machine labels operations pc<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">let</span> <span style="color: #696969;">((</span>target <span style="color: #696969;">(</span>get-register machine <span style="color: #696969;">(</span>assign-reg-name inst<span style="color: #696969;">)))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#20174;&#25351;&#20196;&#20013;&#21462;&#20986;&#34987;&#36171;&#20540;&#30340;&#23492;&#23384;&#22120;</span>
        <span style="color: #696969;">(</span>value-exp <span style="color: #696969;">(</span>assign-value-exp inst<span style="color: #696969;">)))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#20174;&#25351;&#20196;&#20013;&#21462;&#20986;&#34987;&#36171;&#20540;&#30340;&#20540;&#34920;&#36798;&#24335;</span>
    <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">let</span> <span style="color: #696969;">((</span>value-proc <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#27714;&#20540;&#30340;&#25191;&#34892;&#36807;&#31243;</span>
           <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">if</span> <span style="color: #696969;">(</span>operation-exp? value-exp<span style="color: #696969;">)</span>
               <span style="color: #696969;">(</span>make-operation-exp
                value-exp machine labels operations<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#26500;&#36896;&#19968;&#33324; op &#34920;&#36798;&#24335;&#30340;&#25191;&#34892;&#36807;&#31243;</span>
               <span style="color: #696969;">(</span>make-primitive-exp
                <span style="color: #696969;">(</span>car value-exp<span style="color: #696969;">)</span> machine labels<span style="color: #696969;">))))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#26500;&#36896;&#22522;&#26412;&#34920;&#36798;&#24335;&#30340; &#25191;&#34892;&#36807;&#31243;&#12290;&#22522;&#26412;&#34920;&#36798;&#24335;&#21253;&#25324; reg, label, const</span>
      <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">lambda</span> <span style="color: #696969;">()</span>                <span style="color: #5f9ea0; font-style: italic;">; </span><span style="color: #5f9ea0; font-style: italic;">assign &#30340;&#25191;&#34892;&#36807;&#31243;</span>
        <span style="color: #696969;">(</span>set-contents! target <span style="color: #696969;">(</span>value-proc<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#35843;&#29992; value-proc &#36807;&#31243;&#65292;&#24182;&#25226;&#32467;&#26524;&#36171;&#20540;&#32473;&#23545;&#24212;&#30340;&#23492;&#23384;&#22120;</span>
        <span style="color: #696969;">(</span>advance-pc pc<span style="color: #696969;">)))))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">pc &#23492;&#23384;&#22120;&#33258;&#22686; </span>
</pre>
</div>

<p>
assign 指令的辅助过程
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">&#33719;&#24471; assign &#25351;&#20196;&#20013;&#30340;&#23492;&#23384;&#22120;&#34920;&#36798;&#24335;</span>
<span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">assign-reg-name</span> assign-instruction<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>cadr assign-instruction<span style="color: #696969;">))</span>

<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">&#33719;&#24471; assign &#25351;&#20196;&#20013;&#30340;&#36171;&#20540;&#34920;&#36798;&#24335;</span>
<span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">assign-value-exp</span> assign-instruction<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>cddr assign-instruction<span style="color: #696969;">))</span>
</pre>
</div>

<p>
通用的指令计数器的更新过程：指向指令表的下一条指令
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">&#36890;&#29992;&#30340;&#25351;&#20196;&#35745;&#25968;&#22120;&#30340;&#26356;&#26032;&#36807;&#31243;</span>
<span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">advance-pc</span> pc<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>set-contents! pc <span style="color: #696969;">(</span>cdr <span style="color: #696969;">(</span>get-contents pc<span style="color: #696969;">))))</span>
</pre>
</div>

<pre class="example">
       除了 goto 和 branch , 其他的指令执行过程都会使用通用的指令计数器更新过程
</pre>
</div>
</div>
<div id="outline-container-orgc70b18b" class="outline-5">
<h5 id="orgc70b18b">test 指令</h5>
<div class="outline-text-5" id="text-orgc70b18b">
<ol class="org-ol">
<li>设置flag 寄存器</li>
<li>更新 pc</li>
</ol>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">&#29983;&#25104; test &#25351;&#20196;&#30340;&#25191;&#34892;&#36807;&#31243;</span>
<span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">make-test</span> inst machine labels operations flag pc<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">let</span> <span style="color: #696969;">((</span>condition <span style="color: #696969;">(</span>test-condition inst<span style="color: #696969;">)))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#33719;&#24471;&#26465;&#20214;&#30340;&#27714;&#20540;&#34920;&#36798;&#24335;</span>
    <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">if</span> <span style="color: #696969;">(</span>operation-exp? condition<span style="color: #696969;">)</span>
        <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">let</span> <span style="color: #696969;">((</span>condition-proc 
               <span style="color: #696969;">(</span>make-operation-exp <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#20135;&#29983;&#26465;&#20214;&#30340;&#27714;&#20540;&#36807;&#31243;</span>
                condition machine labels operations<span style="color: #696969;">)))</span>
          <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">lambda</span> <span style="color: #696969;">()</span>
            <span style="color: #696969;">(</span>set-contents! flag <span style="color: #696969;">(</span>condition-proc<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#35843;&#29992; condition-proc &#36807;&#31243;&#65292;&#25226;&#32467;&#26524;&#35774;&#32622;&#21040; flag &#23492;&#23384;&#22120;</span>
            <span style="color: #696969;">(</span>advance-pc pc<span style="color: #696969;">)))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#26356;&#26032; pc &#23492;&#23384;&#22120;</span>
        <span style="color: #696969;">(</span>error <span style="color: #deb887;">"Bad TEST instruction -- ASSEMBLE"</span> inst<span style="color: #696969;">))))</span>
</pre>
</div>

<p>
test 指令的辅助过程：
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">test-condition</span> test-instruction<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>cdr test-instruction<span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orga86fd34" class="outline-5">
<h5 id="orga86fd34">branch 指令</h5>
<div class="outline-text-5" id="text-orga86fd34">
<p>
根据 flag 更新 pc ： 
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">&#29983;&#25104; branch &#25351;&#20196;&#30340;&#25191;&#34892;&#36807;&#31243;</span>
<span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">make-branch</span> inst machine labels flag pc<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">let</span> <span style="color: #696969;">((</span>dest <span style="color: #696969;">(</span>branch-dest inst<span style="color: #696969;">)))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#33719;&#21462;&#36716;&#36339;&#25351;&#20196;&#37324;&#30340;&#26631;&#21495;</span>
    <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">if</span> <span style="color: #696969;">(</span>label-exp? dest<span style="color: #696969;">)</span>
        <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">let</span> <span style="color: #696969;">((</span>insts <span style="color: #696969;">(</span>lookup-label labels <span style="color: #696969;">(</span>label-exp-label dest<span style="color: #696969;">))))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#20174;&#26631;&#21495;&#34920;&#37324;&#25214;&#20986;&#26631;&#21495;&#22312;&#25351;&#20196;&#24207;&#21015;&#37324;&#30340;&#20301;&#32622;</span>
          <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">lambda</span> <span style="color: #696969;">()</span>
            <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">if</span> <span style="color: #696969;">(</span>get-contents flag<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#26681;&#25454; flag &#30340;&#20540;&#20915;&#23450;&#22914;&#20309;&#26356;&#26032; pc</span>
                <span style="color: #696969;">(</span>set-contents! pc insts<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">flag &#20026;&#30495;&#65292;&#21017;&#25226;&#25351;&#20196;&#23492;&#23384;&#22120;&#26356;&#26032;&#20026;&#26631;&#21495;&#22312;&#25351;&#20196;&#24207;&#21015;&#20013;&#30340;&#20301;&#32622;</span>
                <span style="color: #696969;">(</span>advance-pc pc<span style="color: #696969;">))))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">flag &#20026;&#20551;&#65292;&#25353;&#29031;&#36890;&#29992;&#26041;&#24335;&#26356;&#26032;&#25351;&#20196;&#23492;&#23384;&#22120;</span>
        <span style="color: #696969;">(</span>error <span style="color: #deb887;">"Bad BRANCH instruction -- ASSEMBLE"</span> inst<span style="color: #696969;">))))</span>
</pre>
</div>

<p>
branch 指令的辅助过程：
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">branch-dest</span> branch-instruction<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>cadr branch-instruction<span style="color: #696969;">))</span>
</pre>
</div>

<pre class="example">
注意：
1. branch 指令中只能用标号，不能用寄存器间接跳转，而 goto 指令支持寄存器间接跳转
2. branch 指令中的标号在指令序列中的位置，只会在 assemble 过程中取一次，动态执行时候不会再去取
</pre>
</div>
</div>
<div id="outline-container-orgbf209cc" class="outline-5">
<h5 id="orgbf209cc">goto 指令</h5>
<div class="outline-text-5" id="text-orgbf209cc">
<p>
goto 的特殊情况：转跳位置可能用 <span class="underline">标号</span> 或 <span class="underline">寄存器</span> 描述， 需要分别处理：
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">&#29983;&#25104; goto &#25351;&#20196;&#30340;&#25191;&#34892;&#36807;&#31243;</span>
<span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">make-goto</span> inst machine labels pc<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">let</span> <span style="color: #696969;">((</span>dest <span style="color: #696969;">(</span>goto-dest inst<span style="color: #696969;">)))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#33719;&#21462;&#36716;&#36339;&#25351;&#20196;&#37324;&#30340;&#30446;&#30340;</span>
    <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">cond</span> <span style="color: #696969;">((</span>label-exp? dest<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#26631;&#21495;&#22788;&#29702;&#31867;&#20284;&#20110; branch </span>
           <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">let</span> <span style="color: #696969;">((</span>insts
                  <span style="color: #696969;">(</span>lookup-label labels
                                <span style="color: #696969;">(</span>label-exp-label dest<span style="color: #696969;">))))</span>
             <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">lambda</span> <span style="color: #696969;">()</span> <span style="color: #696969;">(</span>set-contents! pc insts<span style="color: #696969;">))))</span>
          <span style="color: #696969;">((</span>register-exp? dest<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#23492;&#23384;&#22120;&#38388;&#25509;&#36339;&#36716;</span>
           <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">let</span> <span style="color: #696969;">((</span>reg
                  <span style="color: #696969;">(</span>get-register machine
                                <span style="color: #696969;">(</span>register-exp-reg dest<span style="color: #696969;">))))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#20174;&#26426;&#22120;&#23492;&#23384;&#22120;&#34920;&#20013;&#33719;&#24471;&#23545;&#24212;&#30340;&#23492;&#23384;&#22120;&#21464;&#37327;</span>
             <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">lambda</span> <span style="color: #696969;">()</span>
               <span style="color: #696969;">(</span>set-contents! pc <span style="color: #696969;">(</span>get-contents reg<span style="color: #696969;">)))))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#20174;&#23492;&#23384;&#22120;&#21464;&#37327;&#20013;&#33719;&#24471;&#23545;&#24212;&#30340;&#20540;&#65292;&#24182;&#25226;&#20540;&#36171;&#32473;&#25351;&#20196;&#23492;&#23384;&#22120; pc </span>
          <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">else</span> <span style="color: #696969;">(</span>error <span style="color: #deb887;">"Bad GOTO instruction -- ASSEMBLE"</span>
                       inst<span style="color: #696969;">)))))</span>
</pre>
</div>

<p>
goto 指令的辅助过程：
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">goto-dest</span> goto-instruction<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>cadr goto-instruction<span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org095e5f0" class="outline-5">
<h5 id="org095e5f0">save &amp; restore 指令</h5>
<div class="outline-text-5" id="text-org095e5f0">
<p>
这两条指令针对特定寄存器使用栈，并更新 pc：
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">&#29983;&#25104; save &#25351;&#20196;&#30340;&#25191;&#34892;&#36807;&#31243;&#65288;&#23492;&#23384;&#22120;&#20013;&#30340;&#20869;&#23481;&#21387;&#26632;&#65289;</span>
<span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">make-save</span> inst machine stack pc<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">let</span> <span style="color: #696969;">((</span>reg <span style="color: #696969;">(</span>get-register machine
                           <span style="color: #696969;">(</span>stack-inst-reg-name inst<span style="color: #696969;">))))</span>
    <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">lambda</span> <span style="color: #696969;">()</span>
      <span style="color: #696969;">(</span>push stack <span style="color: #696969;">(</span>get-contents reg<span style="color: #696969;">))</span>
      <span style="color: #696969;">(</span>advance-pc pc<span style="color: #696969;">))))</span>

<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">&#29983;&#25104; restore &#25351;&#20196;&#30340;&#25191;&#34892;&#36807;&#31243;&#65288;&#26632;&#19978;&#30340;&#20869;&#23481;&#20986;&#26632;&#21040;&#23492;&#23384;&#22120;&#65289;</span>
<span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">make-restore</span> inst machine stack pc<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">let</span> <span style="color: #696969;">((</span>reg <span style="color: #696969;">(</span>get-register machine
                           <span style="color: #696969;">(</span>stack-inst-reg-name inst<span style="color: #696969;">))))</span>
    <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">lambda</span> <span style="color: #696969;">()</span>
      <span style="color: #696969;">(</span>set-contents! reg <span style="color: #696969;">(</span>pop stack<span style="color: #696969;">))</span>    
      <span style="color: #696969;">(</span>advance-pc pc<span style="color: #696969;">))))</span>
</pre>
</div>

<p>
栈指令辅助过程：
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">stack-inst-reg-name</span> stack-instruction<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>cadr stack-instruction<span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org0a20cf9" class="outline-5">
<h5 id="org0a20cf9">perform 指令</h5>
<div class="outline-text-5" id="text-org0a20cf9">
<p>
在实际模拟中执行对应动作并更新 pc ：
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">&#20026; perform &#25351;&#20196;&#29983;&#25104;&#25191;&#34892;&#36807;&#31243;</span>
<span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">make-perform</span> inst machine labels operations pc<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">let</span> <span style="color: #696969;">((</span>action <span style="color: #696969;">(</span>perform-action inst<span style="color: #696969;">)))</span>
    <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">if</span> <span style="color: #696969;">(</span>operation-exp? action<span style="color: #696969;">)</span>
        <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">let</span> <span style="color: #696969;">((</span>action-proc
               <span style="color: #696969;">(</span>make-operation-exp
                action machine labels operations<span style="color: #696969;">)))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#26500;&#36896; op  &#34920;&#36798;&#24335;&#30340;&#25191;&#34892;&#36807;&#31243;</span>
          <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">lambda</span> <span style="color: #696969;">()</span>
            <span style="color: #696969;">(</span>action-proc<span style="color: #696969;">)</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#25191;&#34892; op &#34920;&#36798;&#24335;&#30340;&#25191;&#34892;&#36807;&#31243;</span>
            <span style="color: #696969;">(</span>advance-pc pc<span style="color: #696969;">)))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#26356;&#26032;&#25351;&#20196;&#23492;&#23384;&#22120; pc </span>
        <span style="color: #696969;">(</span>error <span style="color: #deb887;">"Bad PERFORM instruction -- ASSEMBLE"</span> inst<span style="color: #696969;">))))</span>
</pre>
</div>

<p>
perform 指令的辅助过程：
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">perform-action</span> inst<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>cdr inst<span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org8298d5a" class="outline-5">
<h5 id="org8298d5a">基本表达式执行过程</h5>
<div class="outline-text-5" id="text-org8298d5a">
<p>
<b>reg</b> 、 <b>label</b>  或 <b>const</b> ，这些是基本表达式，生成相应的执行过程：
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">&#29983;&#25104;&#22522;&#26412;&#34920;&#36798;&#24335;&#30340;&#25191;&#34892;&#36807;&#31243;</span>
<span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">make-primitive-exp</span> exp machine labels<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">cond</span> <span style="color: #696969;">((</span>constant-exp? exp<span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">let</span> <span style="color: #696969;">((</span>c <span style="color: #696969;">(</span>constant-exp-value exp<span style="color: #696969;">)))</span>
           <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">lambda</span> <span style="color: #696969;">()</span> c<span style="color: #696969;">)))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#36820;&#22238;&#24120;&#37327;&#20540;</span>
        <span style="color: #696969;">((</span>label-exp? exp<span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">let</span> <span style="color: #696969;">((</span>insts
                <span style="color: #696969;">(</span>lookup-label labels
                              <span style="color: #696969;">(</span>label-exp-label exp<span style="color: #696969;">))))</span> 
           <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">lambda</span> <span style="color: #696969;">()</span> insts<span style="color: #696969;">)))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#36820;&#22238;&#26631;&#21495;&#22312;&#26631;&#21495;&#25351;&#20196;&#20851;&#32852;&#34920;&#20013;&#23545;&#24212;&#30340;&#25351;&#20196;</span>
        <span style="color: #696969;">((</span>register-exp? exp<span style="color: #696969;">)</span>
         <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">let</span> <span style="color: #696969;">((</span>r <span style="color: #696969;">(</span>get-register machine
                                <span style="color: #696969;">(</span>register-exp-reg exp<span style="color: #696969;">))))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#33719;&#21462;&#23492;&#23384;&#22120;&#34920;&#20013;&#30340;&#23545;&#24212;&#23492;&#23384;&#22120;&#21464;&#37327;</span>
           <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">lambda</span> <span style="color: #696969;">()</span> <span style="color: #696969;">(</span>get-contents r<span style="color: #696969;">))))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#36820;&#22238;&#23545;&#24212;&#23492;&#23384;&#22120;&#21464;&#37327;&#20013;&#30340;&#20869;&#23481;</span>
        <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">else</span>
         <span style="color: #696969;">(</span>error <span style="color: #deb887;">"Unknown expression type -- ASSEMBLE"</span> exp<span style="color: #696969;">))))</span>
</pre>
</div>

<p>
基本表达式的语法过程：
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">register-exp?</span> exp<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>tagged-list? exp 'reg<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">register-exp-reg</span> exp<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>cadr exp<span style="color: #696969;">))</span>

<span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">constant-exp?</span> exp<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>tagged-list? exp 'const<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">constant-exp-value</span> exp<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>cadr exp<span style="color: #696969;">))</span>

<span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">label-exp?</span> exp<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>tagged-list? exp 'label<span style="color: #696969;">))</span>
<span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">label-exp-label</span> exp<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>cadr exp<span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org808a31e" class="outline-5">
<h5 id="org808a31e">子表达式</h5>
<div class="outline-text-5" id="text-org808a31e">
<p>
<span class="underline">assign</span>  、 <span class="underline">perform</span> 和 <span class="underline">test</span> 指令的执行过程都将 <b>机器操作</b> 应用于 <b>操作对象</b> （ <span class="underline">reg表达式</span> 或 <span class="underline">const 表达式</span> ），这种操作的执行过程：
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">&#29983;&#25104;&#23376;&#34920;&#36798;&#24335;&#30340;&#25191;&#34892;&#36807;&#31243;</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">exp: &#23376;&#34920;&#36798;&#24335;</span>
<span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">make-operation-exp</span> exp machine labels operations<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">let</span> <span style="color: #696969;">((</span>op <span style="color: #696969;">(</span>lookup-prim <span style="color: #696969;">(</span>operation-exp-op exp<span style="color: #696969;">)</span> operations<span style="color: #696969;">))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#20174;&#25805;&#20316;&#34920;&#20013;&#26597;&#25214;&#23545;&#24212;&#25805;&#20316;&#21517;&#30340;&#20989;&#25968;&#36807;&#31243;&#65292;&#27604;&#22914; + , = , remainder&#31561;</span>
        <span style="color: #696969;">(</span>aprocs
         <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">map</span> <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>e<span style="color: #696969;">)</span>
                <span style="color: #696969;">(</span>make-primitive-exp e machine labels<span style="color: #696969;">))</span>
              <span style="color: #696969;">(</span>operation-exp-operands exp<span style="color: #696969;">))))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#20026;&#27599;&#20010;&#25805;&#20316;&#30340;&#21442;&#25968;&#23545;&#35937;&#29983;&#25104;&#19968;&#20010;&#25191;&#34892;&#36807;&#31243;</span>
    <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">lambda</span> <span style="color: #696969;">()</span>
      <span style="color: #696969;">(</span>apply op <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">map</span> <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">lambda</span> <span style="color: #696969;">(</span>p<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>p<span style="color: #696969;">))</span> aprocs<span style="color: #696969;">)))))</span> <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#35843;&#29992;&#27599;&#20010;&#25805;&#20316;&#21442;&#25968;&#23545;&#35937;&#30340;&#25191;&#34892;&#36807;&#31243;&#65292;&#24471;&#21040;&#23427;&#20204;&#30340;&#20540;&#65307;&#32780;&#21518;&#24212;&#29992;&#20110;&#25805;&#20316;&#26412;&#36523;&#30340;&#25191;&#34892;&#36807;&#31243;</span>
</pre>
</div>

<p>
用操作名到从机器的操作表里查找对应的操作：
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">&#29992;&#25805;&#20316;&#21517;&#21040;&#20174;&#26426;&#22120;&#30340;&#25805;&#20316;&#34920;&#37324;&#26597;&#25214;&#23545;&#24212;&#30340;&#25805;&#20316;</span>
<span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">lookup-prim</span> symbol operations<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">let</span> <span style="color: #696969;">((</span>val <span style="color: #696969;">(</span>assoc symbol operations<span style="color: #696969;">)))</span>
    <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">if</span> val
        <span style="color: #696969;">(</span>cadr val<span style="color: #696969;">)</span>
        <span style="color: #696969;">(</span>error <span style="color: #deb887;">"Unknown operation -- ASSEMBLE"</span> symbol<span style="color: #696969;">))))</span>
</pre>
</div>

<pre class="example">
       注意：这样找到的是对应的 Scheme 过程，而后用 apply 调用它
</pre>

<p>
相应的语法过程：
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">operation-exp?</span> exp<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">and</span> <span style="color: #696969;">(</span>pair? exp<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>tagged-list? <span style="color: #696969;">(</span>car exp<span style="color: #696969;">)</span> 'op<span style="color: #696969;">)))</span>
<span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">operation-exp-op</span> operation-exp<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>cadr <span style="color: #696969;">(</span>car operation-exp<span style="color: #696969;">)))</span>
<span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">operation-exp-operands</span> operation-exp<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>cdr operation-exp<span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org2c12e29" class="outline-4">
<h4 id="org2c12e29">监控效率</h4>
<div class="outline-text-4" id="text-org2c12e29">
<pre class="example">
      模拟器不仅可以验证所定义机器的正确性，还能够考查其性能
</pre>

<p>
给模拟程序安装一些 <span class="underline">测量仪器</span> 。例如记录 <b>栈操作的次数</b> 等，需要给基本机器模型增加一个操作：
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span>list <span style="color: #696969;">(</span>list 'initialize-stack
            <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">lambda</span> <span style="color: #696969;">()</span> <span style="color: #696969;">(</span>stack 'initialize<span style="color: #696969;">)))</span>
      <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#22686;&#21152;&#19968;&#20010;&#26032;&#30340;&#25171;&#21360;&#26632;&#32479;&#35745;&#20449;&#24687;&#30340;&#25805;&#20316;</span>
      <span style="color: #696969;">(</span>list 'print-stack-statistics
            <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">lambda</span> <span style="color: #696969;">()</span> <span style="color: #696969;">(</span>stack 'print-statistics<span style="color: #696969;">))))</span>
</pre>
</div>

<p>
修改 <span class="underline">make-stack</span> 的定义，加入 <b>计数</b> 和 <b>输出统计结果</b> 的功能：
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">make-stack</span><span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">let</span> <span style="color: #696969;">((</span>s '<span style="color: #696969;">())</span>
        <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#28155;&#21152;&#32479;&#35745;&#20449;&#24687;</span>
        <span style="color: #696969;">(</span>number-pushes 0<span style="color: #696969;">)</span>
        <span style="color: #696969;">(</span>max-depth 0<span style="color: #696969;">)</span>
        <span style="color: #696969;">(</span>current-depth 0<span style="color: #696969;">))</span>
    <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">push</span> x<span style="color: #696969;">)</span>
      <span style="color: #696969;">(</span>set! s <span style="color: #696969;">(</span>cons x s<span style="color: #696969;">))</span>
      <span style="color: #696969;">(</span>set! number-pushes <span style="color: #696969;">(</span>+ 1 number-pushes<span style="color: #696969;">))</span>
      <span style="color: #696969;">(</span>set! current-depth <span style="color: #696969;">(</span>+ 1 current-depth<span style="color: #696969;">))</span>
      <span style="color: #696969;">(</span>set! max-depth <span style="color: #696969;">(</span>max current-depth max-depth<span style="color: #696969;">)))</span>
    <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">pop</span><span style="color: #696969;">)</span>
      <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">if</span> <span style="color: #696969;">(</span>null? s<span style="color: #696969;">)</span>
          <span style="color: #696969;">(</span>error <span style="color: #deb887;">"Empty stack -- POP"</span><span style="color: #696969;">)</span>
          <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">let</span> <span style="color: #696969;">((</span>top <span style="color: #696969;">(</span>car s<span style="color: #696969;">)))</span>
            <span style="color: #696969;">(</span>set! s <span style="color: #696969;">(</span>cdr s<span style="color: #696969;">))</span>
            <span style="color: #696969;">(</span>set! current-depth <span style="color: #696969;">(</span>- current-depth 1<span style="color: #696969;">))</span>
            top<span style="color: #696969;">)))</span>    
    <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">initialize</span><span style="color: #696969;">)</span>
      <span style="color: #696969;">(</span>set! s '<span style="color: #696969;">())</span>
      <span style="color: #696969;">(</span>set! number-pushes 0<span style="color: #696969;">)</span>
      <span style="color: #696969;">(</span>set! max-depth 0<span style="color: #696969;">)</span>
      <span style="color: #696969;">(</span>set! current-depth 0<span style="color: #696969;">)</span>
      'done<span style="color: #696969;">)</span>
    <span style="color: #5f9ea0; font-style: italic;">;; </span><span style="color: #5f9ea0; font-style: italic;">&#25171;&#21360;&#32479;&#35745;&#20449;&#24687;</span>
    <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">print-statistics</span><span style="color: #696969;">)</span>
      <span style="color: #696969;">(</span>newline<span style="color: #696969;">)</span>
      <span style="color: #696969;">(</span>display <span style="color: #696969;">(</span>list 'total-pushes  '= number-pushes
                     'maximum-depth '= max-depth<span style="color: #696969;">)))</span>
    <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">define</span> <span style="color: #696969;">(</span><span style="color: #daa520; font-weight: bold;">dispatch</span> message<span style="color: #696969;">)</span>
      <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">cond</span> <span style="color: #696969;">((</span>eq? message 'push<span style="color: #696969;">)</span> push<span style="color: #696969;">)</span>
            <span style="color: #696969;">((</span>eq? message 'pop<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>pop<span style="color: #696969;">))</span>
            <span style="color: #696969;">((</span>eq? message 'initialize<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>initialize<span style="color: #696969;">))</span>
            <span style="color: #696969;">((</span>eq? message 'print-statistics<span style="color: #696969;">)</span>
             <span style="color: #696969;">(</span>print-statistics<span style="color: #696969;">))</span>
            <span style="color: #696969;">(</span><span style="color: #00bfff; font-weight: bold;">else</span>
             <span style="color: #696969;">(</span>error <span style="color: #deb887;">"Unknown request -- STACK"</span> message<span style="color: #696969;">))))</span>
    dispatch<span style="color: #696969;">))</span>
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

		  <br/>
		  <div class='ds-thread'></div>
		  <script>
		  var duoshuoQuery = {short_name:'klose911'};
		  (function() {
					  var dsThread = document.getElementsByClassName('ds-thread')[0];
					  dsThread.setAttribute('data-thread-key', document.title);
					  dsThread.setAttribute('data-title', document.title);
					  dsThread.setAttribute('data-url', window.location.href);
					  var ds = document.createElement('script');
					  ds.type = 'text/javascript';ds.async = true;
					  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
					  ds.charset = 'UTF-8';
					  (document.getElementsByTagName('head')[0] 
						|| document.getElementsByTagName('body')[0]).appendChild(ds);
					  })();
		  </script>
		  <script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
		  ga('create', 'UA-90850421-1', 'auto');
		  ga('send', 'pageview');
		  </script>
</div>
</body>
</html>
