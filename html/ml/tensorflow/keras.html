<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TensorFlow2.0教程-Keras 快速入门</title>
<meta name="author" content="Wu, Shanliang" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="../css/main.css" />
</head>
<body>
<div id="content" class="content">
<h1 class="title">TensorFlow2.0教程-Keras 快速入门</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org75d853f">导入tf.keras</a></li>
<li><a href="#orgd010d8e">构建简单模型</a>
<ul>
<li><a href="#orga4da9d4">模型堆叠</a></li>
<li><a href="#org7c09801">网络配置</a></li>
</ul>
</li>
<li><a href="#org0523ec1">训练和评估</a>
<ul>
<li><a href="#org1b0c994">设置训练流程</a></li>
<li><a href="#orgadc5329">输入Numpy数据</a></li>
<li><a href="#org98d5a57">tf.data输入数据</a></li>
<li><a href="#org558e2cd">评估与预测</a></li>
</ul>
</li>
<li><a href="#org3601cfe">构建高级模型</a>
<ul>
<li><a href="#org4253f9b">函数式API</a></li>
<li><a href="#orgf252c32">模型子类化</a></li>
<li><a href="#org6dce7f5">自定义层</a></li>
<li><a href="#org94f53ed">回调</a></li>
</ul>
</li>
<li><a href="#orgba04085">保存和恢复</a>
<ul>
<li><a href="#org09c71d1">权重</a></li>
<li><a href="#org33348db">网络结构</a></li>
<li><a href="#orgcf6fa0d">整个模型</a></li>
</ul>
</li>
<li><a href="#org7a60deb">将keras用于Estimator</a></li>
</ul>
</div>
</div>
<p>
Keras 是一个用于 <b>构建</b> 和 <b>训练</b> 深度学习模型的 <span class="underline">高阶 API</span> 。它可用于快速设计原型、高级研究和生产。
</p>

<p>
keras的3个优点： 
</p>
<ol class="org-ol">
<li>方便用户使用</li>
<li>模块化</li>
<li>可组合、易于扩展</li>
</ol>

<div id="outline-container-org75d853f" class="outline-2">
<h2 id="org75d853f">导入tf.keras</h2>
<div class="outline-text-2" id="text-org75d853f">
<p>
tensorflow2推荐使用keras构建网络，常见的神经网络都包含在 <span class="underline">keras.layer</span> 中:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #00ffff;">import</span> tensorflow <span style="color: #00ffff;">as</span> tf
<span style="color: #00ffff;">from</span> tensorflow.keras <span style="color: #00ffff;">import</span> layers

<span style="color: #b0c4de;">print</span>(tf.__version__)
<span style="color: #b0c4de;">print</span>(tf.keras.__version__)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd010d8e" class="outline-2">
<h2 id="orgd010d8e">构建简单模型</h2>
<div class="outline-text-2" id="text-orgd010d8e">
</div>
<div id="outline-container-orga4da9d4" class="outline-3">
<h3 id="orga4da9d4">模型堆叠</h3>
<div class="outline-text-3" id="text-orga4da9d4">
<p>
最常见的模型类型是层的堆叠： <span class="underline">tf.keras.Sequential</span> 模型
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #eedd82;">model</span> = tf.keras.Sequential()
model.add(layers.Dense(32, activation=<span style="color: #ffa07a;">'relu'</span>))
model.add(layers.Dense(32, activation=<span style="color: #ffa07a;">'relu'</span>))
model.add(layers.Dense(10, activation=<span style="color: #ffa07a;">'softmax'</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-org7c09801" class="outline-3">
<h3 id="org7c09801">网络配置</h3>
<div class="outline-text-3" id="text-org7c09801">
<ul class="org-ul">
<li>activation：设置层的 <b>激活</b> 函数</li>
</ul>
<pre class="example" id="orgd97db66">
此参数由内置函数的名称指定，或指定为可调用对象

默认情况下，系统不会应用任何激活函数
</pre>
<ul class="org-ul">
<li>kernel_initializer 和 bias_initializer：创建层 <b>权重（核和偏差）的初始化</b> 方案</li>
</ul>
<pre class="example" id="org6f10f68">
此参数是一个名称或可调用对象

默认为 "Glorot uniform" 初始化器
</pre>
<ul class="org-ul">
<li>kernel_regularizer 和 bias_regularizer：应用层 <b>权重（核和偏差）的正则化</b> 方案</li>
</ul>
<pre class="example" id="org549728d">
例如 L1 或 L2 正则化

默认情况下，系统不会应用正则化函数
</pre>

<div class="org-src-container">
<pre class="src src-python">layers.Dense(32, activation=<span style="color: #ffa07a;">'sigmoid'</span>)
layers.Dense(32, activation=tf.sigmoid)
layers.Dense(32, kernel_initializer=<span style="color: #ffa07a;">'orthogonal'</span>)
layers.Dense(32, kernel_initializer=tf.keras.initializers.glorot_normal)
layers.Dense(32, kernel_regularizer=tf.keras.regularizers.l2(0.01))
layers.Dense(32, kernel_regularizer=tf.keras.regularizers.l1(0.01))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org0523ec1" class="outline-2">
<h2 id="org0523ec1">训练和评估</h2>
<div class="outline-text-2" id="text-org0523ec1">
</div>
<div id="outline-container-org1b0c994" class="outline-3">
<h3 id="org1b0c994">设置训练流程</h3>
<div class="outline-text-3" id="text-org1b0c994">
<p>
构建好模型后，通过调用 <span class="underline">compile</span> 方法配置该模型的学习流程：
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #eedd82;">model</span> = tf.keras.Sequential()
model.add(layers.Dense(32, activation=<span style="color: #ffa07a;">'relu'</span>))
model.add(layers.Dense(32, activation=<span style="color: #ffa07a;">'relu'</span>))
model.add(layers.Dense(10, activation=<span style="color: #ffa07a;">'softmax'</span>))
model.<span style="color: #b0c4de;">compile</span>(optimizer=tf.keras.optimizers.Adam(0.001),
              loss=tf.keras.losses.categorical_crossentropy,
              metrics=[tf.keras.metrics.categorical_accuracy])
</pre>
</div>
</div>
</div>
<div id="outline-container-orgadc5329" class="outline-3">
<h3 id="orgadc5329">输入Numpy数据</h3>
<div class="outline-text-3" id="text-orgadc5329">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #00ffff;">import</span> numpy <span style="color: #00ffff;">as</span> np

<span style="color: #eedd82;">train_x</span> = np.random.random((1000, 72))
<span style="color: #eedd82;">train_y</span> = np.random.random((1000, 10))

<span style="color: #eedd82;">val_x</span> = np.random.random((200, 72))
<span style="color: #eedd82;">val_y</span> = np.random.random((200, 10))

model.fit(train_x, train_y, epochs=10, batch_size=100,
          validation_data=(val_x, val_y))
</pre>
</div>
</div>
</div>
<div id="outline-container-org98d5a57" class="outline-3">
<h3 id="org98d5a57">tf.data输入数据</h3>
<div class="outline-text-3" id="text-org98d5a57">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #eedd82;">dataset</span> = tf.data.Dataset.from_tensor_slices((train_x, train_y))
<span style="color: #eedd82;">dataset</span> = dataset.batch(32)
<span style="color: #eedd82;">dataset</span> = dataset.repeat()
<span style="color: #eedd82;">val_dataset</span> = tf.data.Dataset.from_tensor_slices((val_x, val_y))
<span style="color: #eedd82;">val_dataset</span> = val_dataset.batch(32)
<span style="color: #eedd82;">val_dataset</span> = val_dataset.repeat()

model.fit(dataset, epochs=10, steps_per_epoch=30,
          validation_data=val_dataset, validation_steps=3)
</pre>
</div>
</div>
</div>
<div id="outline-container-org558e2cd" class="outline-3">
<h3 id="org558e2cd">评估与预测</h3>
<div class="outline-text-3" id="text-org558e2cd">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #eedd82;">test_x</span> = np.random.random((1000, 72))
<span style="color: #eedd82;">test_y</span> = np.random.random((1000, 10))
model.evaluate(test_x, test_y, batch_size=32)
test_data = tf.data.Dataset.from_tensor_slices((test_x, test_y))
test_data = test_data.batch(32).repeat()
model.evaluate(test_data, steps=30)
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">predict</span>
result = model.predict(test_x, batch_size=32)
<span style="color: #b0c4de;">print</span>(result)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org3601cfe" class="outline-2">
<h2 id="org3601cfe">构建高级模型</h2>
<div class="outline-text-2" id="text-org3601cfe">
</div>
<div id="outline-container-org4253f9b" class="outline-3">
<h3 id="org4253f9b">函数式API</h3>
<div class="outline-text-3" id="text-org4253f9b">
<pre class="example" id="org7cc751a">
tf.keras.Sequential 模型是层的简单堆叠，无法表示任意模型
</pre>

<p>
使用 Keras 函数式 API 可以构建复杂的模型拓扑，例如：
</p>
<ul class="org-ul">
<li>多输入模型</li>
<li>多输出模型</li>
<li>具有共享层的模型（同一层被调用多次）</li>
<li>具有非序列数据流的模型（例如，残差连接）</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #eedd82;">input_x</span> = tf.keras.Input(shape=(72,))
hidden1 = layers.Dense(32, activation=<span style="color: #ffa07a;">'relu'</span>)(input_x)
hidden2 = layers.Dense(16, activation=<span style="color: #ffa07a;">'relu'</span>)(hidden1)
pred = layers.Dense(10, activation=<span style="color: #ffa07a;">'softmax'</span>)(hidden2)

model = tf.keras.Model(inputs=input_x, outputs=pred)
model.<span style="color: #b0c4de;">compile</span>(optimizer=tf.keras.optimizers.Adam(0.001),
             loss=tf.keras.losses.categorical_crossentropy,
             metrics=[<span style="color: #ffa07a;">'accuracy'</span>])
model.fit(train_x, train_y, batch_size=32, epochs=5)
</pre>
</div>
<p>
使用函数式 API 构建的模型具有以下特征：
</p>
<ul class="org-ul">
<li>层实例可调用并返回张量</li>
<li>输入张量和输出张量用于定义 tf.keras.Model 实例</li>
<li>此模型的训练方式和 Sequential 模型一样</li>
</ul>
</div>
</div>

<div id="outline-container-orgf252c32" class="outline-3">
<h3 id="orgf252c32">模型子类化</h3>
<div class="outline-text-3" id="text-orgf252c32">
<p>
通过对 <span class="underline">tf.keras.Model</span> 进行 <b>子类化</b> 并定义您自己的 <b>前向传播</b> 来构建完全可自定义的模型：
</p>
<ul class="org-ul">
<li>在 <span class="underline">init</span> 方法中 <b>创建层</b> 并将它们设置为 <b>类实例的属性</b></li>
<li>在 <span class="underline">call</span> 方法中定义 <b>前向传播</b></li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #00ffff;">class</span> <span style="color: #98fb98;">MyModel</span>(tf.keras.Model):
    <span style="color: #00ffff;">def</span> <span style="color: #87cefa;">__init__</span>(<span style="color: #00ffff;">self</span>, num_classes=10):
        <span style="color: #b0c4de;">super</span>(MyModel, <span style="color: #00ffff;">self</span>).__init__(name=<span style="color: #ffa07a;">'my_model'</span>)
        <span style="color: #00ffff;">self</span>.num_classes = num_classes
        <span style="color: #00ffff;">self</span>.layer1 = layers.Dense(32, activation=<span style="color: #ffa07a;">'relu'</span>)
        <span style="color: #00ffff;">self</span>.layer2 = layers.Dense(num_classes, activation=<span style="color: #ffa07a;">'softmax'</span>)

    <span style="color: #00ffff;">def</span> <span style="color: #87cefa;">call</span>(<span style="color: #00ffff;">self</span>, inputs):
        h1 = <span style="color: #00ffff;">self</span>.layer1(inputs)
        out = <span style="color: #00ffff;">self</span>.layer2(h1)
        <span style="color: #00ffff;">return</span> out

    <span style="color: #00ffff;">def</span> <span style="color: #87cefa;">compute_output_shape</span>(<span style="color: #00ffff;">self</span>, input_shape):
        shape = tf.TensorShape(input_shape).as_list()
        shape[-1] = <span style="color: #00ffff;">self</span>.num_classes
        <span style="color: #00ffff;">return</span> tf.TensorShape(shape)

model = MyModel(num_classes=10)
model.<span style="color: #b0c4de;">compile</span>(optimizer=tf.keras.optimizers.RMSprop(0.001),
             loss=tf.keras.losses.categorical_crossentropy,
             metrics=[<span style="color: #ffa07a;">'accuracy'</span>])

model.fit(train_x, train_y, batch_size=16, epochs=5)
</pre>
</div>
</div>
</div>
<div id="outline-container-org6dce7f5" class="outline-3">
<h3 id="org6dce7f5">自定义层</h3>
<div class="outline-text-3" id="text-org6dce7f5">
<p>
通过对 <span class="underline">tf.keras.layers.Layer</span> 进行子类化并实现以下方法来创建自定义层：
</p>
<ul class="org-ul">
<li><span class="underline">build</span> ：创建层的 <b>权重</b> 
<ul class="org-ul">
<li>使用 add_weight 方法添加权重</li>
</ul></li>
<li><span class="underline">call</span> ：定义 <b>前向传播</b></li>
<li><span class="underline">compute_output_shape</span> ：指定在给定输入形状的情况下如何 <b>计算层的输出形状</b> 
<ul class="org-ul">
<li>或者可以通过实现 get_config 方法和 from_config 类方法序列化层</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #00ffff;">class</span> <span style="color: #98fb98;">MyLayer</span>(layers.Layer):
    <span style="color: #00ffff;">def</span> <span style="color: #87cefa;">__init__</span>(<span style="color: #00ffff;">self</span>, output_dim, **kwargs):
        <span style="color: #00ffff;">self</span>.<span style="color: #eedd82;">output_dim</span> = output_dim
        <span style="color: #b0c4de;">super</span>(MyLayer, <span style="color: #00ffff;">self</span>).__init__(**kwargs)

    <span style="color: #00ffff;">def</span> <span style="color: #87cefa;">build</span>(<span style="color: #00ffff;">self</span>, input_shape):
        <span style="color: #eedd82;">shape</span> = tf.TensorShape((input_shape[1], <span style="color: #00ffff;">self</span>.output_dim))
        <span style="color: #00ffff;">self</span>.<span style="color: #eedd82;">kernel</span> = <span style="color: #00ffff;">self</span>.add_weight(name=<span style="color: #ffa07a;">'kernel1'</span>, shape=shape,
                                   initializer=<span style="color: #ffa07a;">'uniform'</span>, trainable=<span style="color: #7fffd4;">True</span>)
        <span style="color: #b0c4de;">super</span>(MyLayer, <span style="color: #00ffff;">self</span>).build(input_shape)

    <span style="color: #00ffff;">def</span> <span style="color: #87cefa;">call</span>(<span style="color: #00ffff;">self</span>, inputs):
        <span style="color: #00ffff;">return</span> tf.matmul(inputs, <span style="color: #00ffff;">self</span>.kernel)

    <span style="color: #00ffff;">def</span> <span style="color: #87cefa;">compute_output_shape</span>(<span style="color: #00ffff;">self</span>, input_shape):
        shape = tf.TensorShape(input_shape).as_list()
        shape[-1] = <span style="color: #00ffff;">self</span>.output_dim
        <span style="color: #00ffff;">return</span> tf.TensorShape(shape)

    <span style="color: #00ffff;">def</span> <span style="color: #87cefa;">get_config</span>(<span style="color: #00ffff;">self</span>):
        base_config = <span style="color: #b0c4de;">super</span>(MyLayer, <span style="color: #00ffff;">self</span>).get_config()
        base_config[<span style="color: #ffa07a;">'output_dim'</span>] = <span style="color: #00ffff;">self</span>.output_dim
        <span style="color: #00ffff;">return</span> base_config

    @<span style="color: #b0c4de;">classmethod</span>
    <span style="color: #00ffff;">def</span> <span style="color: #87cefa;">from_config</span>(cls, config):
        <span style="color: #00ffff;">return</span> cls(**config)

model = tf.keras.Sequential(
[
    MyLayer(10),
    layers.Activation(<span style="color: #ffa07a;">'softmax'</span>)
])


model.<span style="color: #b0c4de;">compile</span>(optimizer=tf.keras.optimizers.RMSprop(0.001),
             loss=tf.keras.losses.categorical_crossentropy,
             metrics=[<span style="color: #ffa07a;">'accuracy'</span>])

model.fit(train_x, train_y, batch_size=16, epochs=5)
</pre>
</div>
</div>
</div>
<div id="outline-container-org94f53ed" class="outline-3">
<h3 id="org94f53ed">回调</h3>
<div class="outline-text-3" id="text-org94f53ed">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #eedd82;">callbacks</span> = [
    tf.keras.callbacks.EarlyStopping(patience=2, monitor=<span style="color: #ffa07a;">'val_loss'</span>),
    tf.keras.callbacks.TensorBoard(log_dir=<span style="color: #ffa07a;">'./logs'</span>)
]
model.fit(train_x, train_y, batch_size=16, epochs=5,
         callbacks=callbacks, validation_data=(val_x, val_y))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgba04085" class="outline-2">
<h2 id="orgba04085">保存和恢复</h2>
<div class="outline-text-2" id="text-orgba04085">
</div>
<div id="outline-container-org09c71d1" class="outline-3">
<h3 id="org09c71d1">权重</h3>
<div class="outline-text-3" id="text-org09c71d1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #eedd82;">model</span> = tf.keras.Sequential([
layers.Dense(64, activation=<span style="color: #ffa07a;">'relu'</span>),
layers.Dense(10, activation=<span style="color: #ffa07a;">'softmax'</span>)])

model.<span style="color: #b0c4de;">compile</span>(optimizer=tf.keras.optimizers.Adam(0.001),
              loss=<span style="color: #ffa07a;">'categorical_crossentropy'</span>,
              metrics=[<span style="color: #ffa07a;">'accuracy'</span>])

model.save_weights(<span style="color: #ffa07a;">'./weights/model'</span>)
model.load_weights(<span style="color: #ffa07a;">'./weights/model'</span>)
model.save_weights(<span style="color: #ffa07a;">'./model.h5'</span>)
model.load_weights(<span style="color: #ffa07a;">'./model.h5'</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-org33348db" class="outline-3">
<h3 id="org33348db">网络结构</h3>
<div class="outline-text-3" id="text-org33348db">
<div class="org-src-container">
<pre class="src src-python">
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#24207;&#21015;&#21270;&#25104;json</span>
<span style="color: #00ffff;">import</span> json
<span style="color: #00ffff;">import</span> pprint
<span style="color: #eedd82;">json_str</span> = model.to_json()
pprint.pprint(json.loads(json_str))
<span style="color: #eedd82;">fresh_model</span> = tf.keras.models.model_from_json(json_str)
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#20445;&#25345;&#20026;yaml&#26684;&#24335;  #&#38656;&#35201;&#25552;&#21069;&#23433;&#35013;pyyaml</span>

<span style="color: #eedd82;">yaml_str</span> = model.to_yaml()
<span style="color: #b0c4de;">print</span>(yaml_str)
<span style="color: #eedd82;">fresh_model</span> = tf.keras.models.model_from_yaml(yaml_str)
</pre>
</div>
</div>
</div>
<div id="outline-container-orgcf6fa0d" class="outline-3">
<h3 id="orgcf6fa0d">整个模型</h3>
<div class="outline-text-3" id="text-orgcf6fa0d">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #eedd82;">model</span> = tf.keras.Sequential([
  layers.Dense(10, activation=<span style="color: #ffa07a;">'softmax'</span>, input_shape=(72,)),
  layers.Dense(10, activation=<span style="color: #ffa07a;">'softmax'</span>)
])
model.<span style="color: #b0c4de;">compile</span>(optimizer=<span style="color: #ffa07a;">'rmsprop'</span>,
              loss=<span style="color: #ffa07a;">'categorical_crossentropy'</span>,
              metrics=[<span style="color: #ffa07a;">'accuracy'</span>])
model.fit(train_x, train_y, batch_size=32, epochs=5)
model.save(<span style="color: #ffa07a;">'all_model.h5'</span>)
model = tf.keras.models.load_model(<span style="color: #ffa07a;">'all_model.h5'</span>)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org7a60deb" class="outline-2">
<h2 id="org7a60deb">将keras用于Estimator</h2>
<div class="outline-text-2" id="text-org7a60deb">
<p>
Estimator API 用于针对 <b>分布式环境</b> 训练模型
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #eedd82;">model</span> = tf.keras.Sequential([layers.Dense(10,activation=<span style="color: #ffa07a;">'softmax'</span>),
                          layers.Dense(10,activation=<span style="color: #ffa07a;">'softmax'</span>)])

model.<span style="color: #b0c4de;">compile</span>(optimizer=tf.keras.optimizers.RMSprop(0.001),
              loss=<span style="color: #ffa07a;">'categorical_crossentropy'</span>,
              metrics=[<span style="color: #ffa07a;">'accuracy'</span>])

estimator = tf.keras.estimator.model_to_estimator(model)
</pre>
</div>

<pre class="example" id="orgcb6c969">
它适用于一些行业使用场景，例如用大型数据集进行分布式训练并导出模型以用于生产
</pre>
</div>
</div>
</div>
<div id="postamble" class="status">

		  <br/>
		  <div class='ds-thread'></div>
		  <script>
		  var duoshuoQuery = {short_name:'klose911'};
		  (function() {
					  var dsThread = document.getElementsByClassName('ds-thread')[0];
					  dsThread.setAttribute('data-thread-key', document.title);
					  dsThread.setAttribute('data-title', document.title);
					  dsThread.setAttribute('data-url', window.location.href);
					  var ds = document.createElement('script');
					  ds.type = 'text/javascript';ds.async = true;
					  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
					  ds.charset = 'UTF-8';
					  (document.getElementsByTagName('head')[0] 
						|| document.getElementsByTagName('body')[0]).appendChild(ds);
					  })();
		  </script>
		  <script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
		  ga('create', 'UA-90850421-1', 'auto');
		  ga('send', 'pageview');
		  </script>
</div>
</body>
</html>
