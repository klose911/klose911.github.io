<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OTP应用系统</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wu, Shanliang" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="css/main.css" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="otp.html"> UP </a>
 |
 <a accesskey="H" href="concurrency.html"> HOME </a>
</div><div id="content">
<h1 class="title">OTP应用系统</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgfc1cba8">通用事件处理</a></li>
<li><a href="#orgcb20f3e">错误记录器</a>
<ul>
<li><a href="#org9926784">记录错误</a></li>
<li><a href="#orgc0f0842">配置错误记录器</a>
<ul>
<li><a href="#org75566d8">标准错误记录器</a></li>
<li><a href="#orgdd9d85f">无配置SASL</a></li>
<li><a href="#orgfa6f9c8">控制记录内容</a></li>
<li><a href="#org7eb4591">文本文件和shell</a></li>
<li><a href="#org046d770">滚动日志和shell</a></li>
<li><a href="#orgd90f5ab">生产环境</a></li>
</ul>
</li>
<li><a href="#org47fe1b1">分析错误</a></li>
</ul>
</li>
<li><a href="#orgfa3c311">警报管理</a>
<ul>
<li><a href="#orgbf82e5f">读取日志</a></li>
</ul>
</li>
<li><a href="#org53e623a">应用程序服务器</a>
<ul>
<li><a href="#orga09134a">质数服务器</a></li>
<li><a href="#orgf573389">面积服务器</a></li>
</ul>
</li>
<li><a href="#org20c3171">监控树</a></li>
<li><a href="#orgd88058a">启动系统</a></li>
<li><a href="#org9052d82">应用程序</a></li>
<li><a href="#orgbc22648">代码组织方式</a></li>
<li><a href="#org521f3d6">深入探索</a></li>
</ul>
</div>
</div>
<pre class="example">
    这一章将构建一个系统,把它作为一家网络公司的后端,这家公司销售两种商品:质数和面积

    顾客可以从这里购买质数,也可以请我们计算某个几何对象的面积
</pre>

<p>
将编写两个服务器:一个生成质数,另一个计算面积。并使用上一章讨论的 gen_server 框架来实现它们 
</p>

<pre class="example">
  在构建系统时必须考虑到错误，即使彻底测试了软件,也不一定能捕获所有的bug

  假设其中一个服务器带有会导致服务器崩溃的致命错误，确切地说,故意引入一个错误来使其中一个服务器崩溃
</pre>

<p>
当服务器崩溃时,需要一种机制来检测这种情况并重启它,为此将用到 <span class="underline">监控树</span> (supervision tree)这个概念。创建一个监控器来管理服务器,如果服务器崩溃就重启它们
</p>

<pre class="example">
  当然,如果服务器确实崩溃了,希望知道它崩溃的原因,这样就能在未来修复这个问题
</pre>

<p>
为了记录所有错误,可以使用OTP的 <span class="underline">错误记录器</span> 。会展示如何配置错误记录器,以及如何根据错误日志生成错误报告 
</p>

<pre class="example">
  计算质数(特别是大质数)时,CPU可能会过热,这就需要开启一个强力风扇来避免这种情况
</pre>

<p>
要做到这一点,需要考虑 <span class="underline">警报</span> 。我们会用 <span class="underline">OTP事件处理框架</span> 来生成和处理警报
</p>

<pre class="example">
  所有这些主题(创建服务器、监控服务器、记录错误和检测警报)是一切生产系统都必须解决的典型问题

  因此,虽然公司前途未卜,却可以在许多系统里重复使用这种架构。事实上,许多在商业上获得成功的公司都在使用这种架构
</pre>

<p>
最后,当一切都能正常工作时,所有代码都会被打包到一个 <span class="underline">OTP应用程序</span> 里。这是一种把围绕某个问题的事物组合到一起的专用方法,让OTP系统自身来启动、停止和管理它
</p>

<pre class="example">
  要决定按什么顺序呈现这些材料并不容易,因为许多领域之间存在循环依赖关系

  错误记录只是事件管理的一个特例，警报就是一种消息,错误记录器是一个被监控进程,但是进程监控器可以调用错误记录器
</pre>

<p>
会尝试理出某种顺序,把这些主题相对有条理地呈现出来。将做下面这些事
</p>
<ol class="org-ol">
<li>熟悉通用事件处理器里用到的概念</li>
<li>了解错误记录器的工作方式</li>
<li>添加警报管理功能</li>
<li>编写两个应用程序服务器</li>
<li>制作一个监控树,并给它添加服务器</li>
<li>把这一切打包成一个应用程序</li>
</ol>
<div id="outline-container-orgfc1cba8" class="outline-2">
<h2 id="orgfc1cba8">通用事件处理</h2>
<div class="outline-text-2" id="text-orgfc1cba8">
<pre class="example">
    事件就是已发生的事情:它是值得注意的,程序员认为有人应该对它做些什么
</pre>
<p>
如果在编程的时候发生了一件值得注意的事,就会发送一个 <span class="underline">event 消息</span> 给某个 <span class="underline">注册进程</span> ,就像这样:
</p>

<div class="org-src-container">
<pre class="src src-erlang">RegProcName ! {event, <span style="color: #eedd82;">E</span>}
</pre>
</div>

<ul class="org-ul">
<li>E: 是 <b>事件</b> (可以是任意Erlang数据类型)</li>
<li>RegProcName: 是 <span class="underline">注册进程名</span></li>
</ul>

<pre class="example">
    发送消息后我们不知道(也不关心)它的命运

    只是完成自己的任务,告诉其他人有什么事发生
</pre>

<p>
现在把注意力转向 <b>接收事件消息</b> 的 <span class="underline">进程</span> ,它被称为 <span class="underline">事件处理器</span> 。最简单的事件处理器就是一个“什么都不做”的处理器。当它收到一个 {event, X} 消息时不会对它做任何处理,只会把它丢弃。下面是对通用事件处理程序的首次尝试：
</p>

<div class="org-src-container">
<pre class="src src-erlang"><span style="color: #7fffd4;">-module</span>(event_handler).
<span style="color: #7fffd4;">-export</span>([<span style="color: #98fb98;">make/1</span>, <span style="color: #98fb98;">add_handler/2</span>, <span style="color: #98fb98;">event/2</span>]).
<span style="color: #ff4500;">%% </span><span style="color: #ff4500;">make a new event handler called Name</span>
<span style="color: #ff4500;">%% </span><span style="color: #ff4500;">the handler function is no_op -- so we do nothing with the event</span>
<span style="color: #87cefa;">make</span>(<span style="color: #eedd82;">Name</span>) -&gt;
    <span style="color: #b0c4de;">register</span>(<span style="color: #eedd82;">Name</span>, <span style="color: #b0c4de;">spawn</span>(<span style="color: #00ffff;">fun</span>() -&gt;<span style="color: #87cefa;"> </span><span style="color: #98fb98;">my_handler</span>(<span style="color: #00ffff;">fun</span> <span style="color: #98fb98;">no_op/1</span>) <span style="color: #00ffff;">end</span>)).
<span style="color: #87cefa;">add_handler</span>(<span style="color: #eedd82;">Name</span>, <span style="color: #eedd82;">Fun</span>) -&gt;<span style="color: #87cefa;"> </span><span style="color: #eedd82;">Name</span> ! {add, <span style="color: #eedd82;">Fun</span>}.

<span style="color: #ff4500;">%% </span><span style="color: #ff4500;">generate an event</span>
<span style="color: #87cefa;">event</span>(<span style="color: #eedd82;">Name</span>, <span style="color: #eedd82;">X</span>) -&gt;<span style="color: #87cefa;"> </span><span style="color: #eedd82;">Name</span> ! {event, <span style="color: #eedd82;">X</span>}.

<span style="color: #87cefa;">my_handler</span>(<span style="color: #eedd82;">Fun</span>) -&gt;
    <span style="color: #00ffff;">receive</span>
        {add, <span style="color: #eedd82;">Fun1</span>} -&gt;
            <span style="color: #98fb98;">my_handler</span>(<span style="color: #eedd82;">Fun1</span>);
        {event, <span style="color: #eedd82;">Any</span>} -&gt;
            (<span style="color: #00ffff;">catch</span> <span style="color: #eedd82;">Fun</span>(<span style="color: #eedd82;">Any</span>)),
            <span style="color: #98fb98;">my_handler</span>(<span style="color: #eedd82;">Fun</span>)
    <span style="color: #00ffff;">end</span>.
<span style="color: #87cefa;">no_op</span>(<span style="color: #eedd82;">_</span>) -&gt;<span style="color: #87cefa;"> </span>void.
</pre>
</div>

<p>
这个事件处理器的API如下：
</p>

<div class="org-src-container">
<pre class="src src-erlang"><span style="color: #98fb98;">event_handler</span>:<span style="color: #98fb98;">make</span>(<span style="color: #eedd82;">Name</span>)
</pre>
</div>

<p>
产生一个“什么都不干”的事件处理器 Name (一个原子)。这样消息就有地方发送了 
</p>

<div class="org-src-container">
<pre class="src src-erlang"><span style="color: #98fb98;">event_handler</span>:<span style="color: #98fb98;">event</span>(<span style="color: #eedd82;">Name</span>, <span style="color: #eedd82;">X</span>)
</pre>
</div>

<p>
发送消息 X 到名为 Name 的事件处理器 
</p>

<div class="org-src-container">
<pre class="src src-erlang"><span style="color: #98fb98;">event_handler</span>:<span style="color: #98fb98;">add_handler</span>(<span style="color: #eedd82;">Name</span>, <span style="color: #eedd82;">Fun</span>)
</pre>
</div>

<p>
给名为 Name 的事件处理器添加一个处理函数 Fun 。这样当事件 X 发生时,事件处理器就会执行 Fun(X) 
</p>

<p>
现在创建一个事件处理器并生成一个错误：
</p>

<div class="org-src-container">
<pre class="src src-sh">2&gt; event_handler:make(errors) <span style="color: #b0c4de;">.</span> 
true

3&gt; event_handler:event(errors, hi) <span style="color: #b0c4de;">.</span> 
{event,hi}
</pre>
</div>

<pre class="example">
    没什么特别的事发生,因为还没有给事件处理器安装回调模块
</pre>

<p>
要让事件处理器能做点什么,必须编写一个 <span class="underline">回调模块</span> 并把它 <b>安装</b> 到 <span class="underline">事件处理器</span> 里。这是一个事件处理器回调模块的代码:
</p>

<div class="org-src-container">
<pre class="src src-erlang"><span style="color: #7fffd4;">-module</span>(motor_controller).
<span style="color: #7fffd4;">-export</span>([<span style="color: #98fb98;">add_event_handler/0</span>]).

<span style="color: #87cefa;">add_event_handler</span>() -&gt;
    <span style="color: #98fb98;">event_handler</span>:<span style="color: #98fb98;">add_handler</span>(errors, <span style="color: #00ffff;">fun</span> <span style="color: #98fb98;">controller/1</span>).
<span style="color: #87cefa;">controller</span>(too_hot) -&gt;
    <span style="color: #98fb98;">io</span>:<span style="color: #98fb98;">format</span>(<span style="color: #ffa07a;">"Turn off the motor~n"</span>);
<span style="color: #87cefa;">controller</span>(<span style="color: #eedd82;">X</span>) -&gt;
    <span style="color: #98fb98;">io</span>:<span style="color: #98fb98;">format</span>(<span style="color: #ffa07a;">"~w ignored event: ~p~n"</span>,[?<span style="color: #7fffd4;">MODULE</span>, <span style="color: #eedd82;">X</span>]).
</pre>
</div>

<p>
编译之后就可以安装它了 
</p>

<div class="org-src-container">
<pre class="src src-sh">4&gt; c (motor_controller) <span style="color: #b0c4de;">.</span> 
{ok,motor_controller}

5&gt; motor_controller:add_event_handler() <span style="color: #b0c4de;">.</span> 
{add,#Fun&lt;motor_controller.0.125151531&gt;}
</pre>
</div>

<p>
现在再发送事件消息给处理器时,函数 <span class="underline">motor_controller:controller/1</span> 会处理这些消息：
</p>

<div class="org-src-container">
<pre class="src src-sh">6&gt; event_handler:event(errors, cool) <span style="color: #b0c4de;">.</span> 
motor_controller ignored event: cool
{event,cool}

7&gt; event_handler:event(errors, too_hot) <span style="color: #b0c4de;">.</span>  
Turn off the motor
{event,too_hot}
</pre>
</div>
<p>
这个实例有两个目的：
</p>
<ul class="org-ul">
<li>提供一个名称来作为消息发送的目的地,也就是名为 errors 的注册进程，定义一个协议来发送事件给这个注册进程,但并没有说明消息到达后会发生什么
<ul class="org-ul">
<li>事实上,唯一发生的事就是执行了 no_Op(X)</li>
</ul></li>
<li>安装一个自定义的事件处理器</li>
</ul>

<p>
这么做本质上是把 <span class="underline">事件生成</span> 和 <span class="underline">事件处理</span> <b>分开</b> 进行,这样就能暂不决定如何处理事件,同时又不影响事件生成。这里的要点在于 <b>事件处理器提供了一种架构,可以安装自定义的处理器</b> 
</p>

<pre class="example">
    错误记录器的架构遵循事件处理器的模式，可以在错误记录器里安装不同的处理器来让它做不同的事情

    警报处理架构同样遵循这一模式
</pre>
</div>
</div>
<div id="outline-container-orgcb20f3e" class="outline-2">
<h2 id="orgcb20f3e">错误记录器</h2>
<div class="outline-text-2" id="text-orgcb20f3e">
<p>
OTP系统自带一个可定制的错误记录器。可以从三个角度看待错误记录器:
</p>
<ul class="org-ul">
<li>程序员视角：关心程序员为了记录错误而在代码里中做的函数调用</li>
<li>配置视角：关心错误记录器在何处以及如何保存数据</li>
<li>报告视角：关心对已发生错误的分析</li>
</ul>

<pre class="example">
    假设编写一个对程序员隐藏 event_handler:event 方法的函数,例如下面这个:
       too_hot() -&gt;
	   event_handler:event(errors, too_hot).

    然后告诉程序员在出问题时要调用代码里的 lib_misc:too_hot()

    在大多数编程语言里,对函数 too_hot 的调用会被静态或动态链接到调用该函数的代码上。一旦链接完成,它就会根据代码要求执行固定任务

    如果后来改变主意要做其他的事,就没有什么简单的办法能改变系统行为了
</pre>

<p>
Erlang处理事件的方法则完全不一样。它允许把 <span class="underline">事件生成</span> 和 <span class="underline">事件处理</span> 分开进行。任何时候都可以修改处理方法,只需向事件处理器发送一个新的处理函数即可。不存在什么静态链接,只要愿意,事件处理函数可以随时更换
</p>

<pre class="example">
    通过这种机制,可以构建与时俱进的系统,永远不需要停止它们来升级代码

    注意:这不是“后期绑定”,而是“超后期绑定,以后还可以改主意”
</pre>
</div>
<div id="outline-container-org9926784" class="outline-3">
<h3 id="org9926784">记录错误</h3>
<div class="outline-text-3" id="text-org9926784">
<p>
对程序员来说,这个错误记录器的API很简单。以下是一个简单的API子集: 
</p>
<ul class="org-ul">
<li>向错误记录器发送一个错误消息</li>
</ul>
<div class="org-src-container">
<pre class="src src-erlang"><span style="color: #7fffd4;">-spec</span> <span style="color: #98fb98;">error_logger</span>:<span style="color: #98fb98;">error_msg</span>(<span style="color: #eedd82;">String</span>) -&gt;<span style="color: #87cefa;"> </span>ok 
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">1&gt; error_logger:error_msg(<span style="color: #ffa07a;">"An error has occured\n"</span>) <span style="color: #b0c4de;">.</span> 
ok

=ERROR <span style="color: #eedd82;">REPORT</span>==== 13-Apr-2021::10:52:05 ===
An error has occured
</pre>
</div>
<ul class="org-ul">
<li>向错误记录器发送一个错误消息。它的参数和 <span class="underline">io:format(Format, Data)</span> 相同</li>
</ul>
<div class="org-src-container">
<pre class="src src-erlang"><span style="color: #7fffd4;">-spec</span> <span style="color: #98fb98;">error_logger</span>:<span style="color: #98fb98;">error_msg</span>(<span style="color: #eedd82;">Format</span>, <span style="color: #eedd82;">Data</span>) -&gt;<span style="color: #87cefa;"> </span>ok 
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">2&gt; error_logger:error_msg(<span style="color: #ffa07a;">"~s, An error has occured\n"</span>, [<span style="color: #ffa07a;">"joe"</span>]) <span style="color: #b0c4de;">.</span>  

=ERROR <span style="color: #eedd82;">REPORT</span>==== 13-Apr-2021::10:53:45 ===
joe, An error has occured
ok
</pre>
</div>
<ul class="org-ul">
<li>向错误记录器发送一个标准错误报告</li>
</ul>
<div class="org-src-container">
<pre class="src src-erlang"><span style="color: #7fffd4;">-spec</span> <span style="color: #98fb98;">error_logger</span>:<span style="color: #98fb98;">error_report</span>(<span style="color: #eedd82;">Report</span>) -&gt;<span style="color: #87cefa;"> </span>ok 

<span style="color: #7fffd4;">-type</span> <span style="color: #eedd82;">Report</span> = [{<span style="color: #eedd82;">Tag</span>, <span style="color: #eedd82;">Data</span>} | <span style="color: #b0c4de;">term</span>() | <span style="color: #b0c4de;">string</span>() ].
<span style="color: #7fffd4;">-type</span> <span style="color: #eedd82;">Tag</span> = <span style="color: #b0c4de;">term</span>().
<span style="color: #7fffd4;">-type</span> <span style="color: #eedd82;">Data</span> = <span style="color: #b0c4de;">term</span>().
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">3&gt; error_logger:error_report([{tag1, data}, a_term, {tag2, data}]) <span style="color: #b0c4de;">.</span> 

=ERROR <span style="color: #eedd82;">REPORT</span>==== 13-Apr-2021::10:59:25 ===
    tag1: data
    a_term
    tag2: data
ok
</pre>
</div>

<pre class="example">
     这只是全部可用API的一个子集
</pre>
</div>
</div>
<div id="outline-container-orgc0f0842" class="outline-3">
<h3 id="orgc0f0842">配置错误记录器</h3>
<div class="outline-text-3" id="text-orgc0f0842">
<p>
有多种方式可用来配置错误记录器：
</p>
<ul class="org-ul">
<li>可以让Erlang shell显示所有错误(如果没有特别设置的话就是默认值)</li>
<li>可以把shell里报告的所有错误写入一个格式化文本文件</li>
<li>可以创建一个滚动日志(rotating log)：把滚动日志看作是一个大型循环缓冲区,内含错误记录器生成的消息。新消息进来后会被附加到日志的末尾,如果日志满了,最早的条目就会被删除</li>
</ul>


<pre class="example">
     滚动日志极其有用：

     用户决定日志应当占据多少个文件,以及每个日志文件能有多大,然后系统负责在一个大型循环缓冲区里删除旧日志文件和创建新文件

     可以调整日志的大小来保存最近几天的操作记录,这通常足以应付大多数用途了
</pre>
</div>

<div id="outline-container-org75566d8" class="outline-4">
<h4 id="org75566d8">标准错误记录器</h4>
<div class="outline-text-4" id="text-org75566d8">
<p>
在启动Erlang时可以给系统提供一个启动参数：
</p>

<div class="org-src-container">
<pre class="src src-sh">$ erl -boot start_clean
</pre>
</div>

<p>
它会创建一个适合进行程序开发的环境,只提供一种简单的错误记录形式 
</p>

<pre class="example">
      不带启动参数的 erl 命令就等于 erl -boot start_clean 
</pre>

<div class="org-src-container">
<pre class="src src-sh">$ erl -boot start_sasl
</pre>
</div>
<p>
它会创建一个适合运行生产系统的环境。系统架构支持库(System Architecture SupportLibraries,简称SASL)将负责错误记录和过载保护等工作
</p>

<pre class="example">
      日志文件的配置最好通过配置文件实现,因为没人能记住记录器的全部参数

      接下来将看看默认系统的工作方式,以及改变错误记录器工作方式的四种特定配置
</pre>
</div>
</div>

<div id="outline-container-orgdd9d85f" class="outline-4">
<h4 id="orgdd9d85f">无配置SASL</h4>
<div class="outline-text-4" id="text-orgdd9d85f">
<p>
不带配置文件启动SASL时会发生下面这些事:
</p>
<div class="org-src-container">
<pre class="src src-sh">$ erl -boot start_sasl 
  Erlang/OTP 18 [erts-7.3] [source] [64-bit] [smp:6:6] [async-threads:10] [kernel-poll:false]


  =PROGRESS <span style="color: #eedd82;">REPORT</span>==== 13-Apr-2021::11:06:58 ===
            supervisor: {<span style="color: #b0c4de;">local</span>,sasl_safe_sup}
               started: [{pid,&lt;0.35.0&gt;},
                         {id,alarm_handler},
                         {mfargs,{alarm_handler,start_link,[]}},
                         {restart_type,permanent},
                         {shutdown,2000},
                         {child_type,worker}]

  =PROGRESS <span style="color: #eedd82;">REPORT</span>==== 13-Apr-2021::11:06:58 ===
            supervisor: {<span style="color: #b0c4de;">local</span>,sasl_safe_sup}
               started: [{pid,&lt;0.36.0&gt;},
                         {id,overload},
                         {mfargs,{overload,start_link,[]}},
                         {restart_type,permanent},
                         {shutdown,2000},
                         {child_type,worker}]

  =PROGRESS <span style="color: #eedd82;">REPORT</span>==== 13-Apr-2021::11:06:58 ===
            supervisor: {<span style="color: #b0c4de;">local</span>,sasl_sup}
               started: [{pid,&lt;0.34.0&gt;},
                         {id,sasl_safe_sup},
                         {mfargs,
                             {supervisor,start_link,
                                 [{<span style="color: #b0c4de;">local</span>,sasl_safe_sup},sasl,safe]}},
                         {restart_type,permanent},
                         {shutdown,infinity},
                         {child_type,supervisor}]

  =PROGRESS <span style="color: #eedd82;">REPORT</span>==== 13-Apr-2021::11:06:59 ===
            supervisor: {<span style="color: #b0c4de;">local</span>,sasl_sup}
               started: [{pid,&lt;0.37.0&gt;},
                         {id,release_handler},
                         {mfargs,{release_handler,start_link,[]}},
                         {restart_type,permanent},
                         {shutdown,2000},
                         {child_type,worker}]

  =PROGRESS <span style="color: #eedd82;">REPORT</span>==== 13-Apr-2021::11:06:59 ===
           application: sasl
            started_at: nonode@nohost
  Eshell V7.3  (abort with ^G)
</pre>
</div>

<p>
现在调用 error_logger 里的某个方法来报告一个错误：
</p>

<div class="org-src-container">
<pre class="src src-sh">1&gt; error_logger:error_msg(<span style="color: #ffa07a;">"An error has occured\n"</span>) <span style="color: #b0c4de;">.</span> 

=ERROR <span style="color: #eedd82;">REPORT</span>==== 13-Apr-2021::11:08:17 ===
An error has occured
ok
</pre>
</div>

<pre class="example">
      请注意,错误是在Erlang shell里报告的，错误的报告位置由错误记录器配置决定
</pre>
</div>
</div>

<div id="outline-container-orgfa6f9c8" class="outline-4">
<h4 id="orgfa6f9c8">控制记录内容</h4>
<div class="outline-text-4" id="text-orgfa6f9c8">
<p>
错误记录器会生成多种报告类型：
</p>
<ul class="org-ul">
<li>监控器报告：这些报告会在OTP监控器启动或停止被监控进程时生成</li>
<li>进度报告：这些报告会在OTP监控器启动或停止时生成</li>
<li>崩溃报告：如果某个被OTP行为启动的进程因为 normal 或 shutdown 以外的原因终止,这些报告就会生成</li>
</ul>

<pre class="example">
    这三种报告会自动生成,程序员无须做任何事
</pre>
<p>
可以显式调用 error_logger 模块里的方法来生成三种类型的日志报告。这能够记录错误、警告和信息消息
</p>

<pre class="example">
      这三个名词没什么语义含义,只是一些标签,程序员用它们来提示错误日志条目的性质

      后面分析错误日志时,可以用这些标签来帮助决定该调查哪些日志条目

      在配置错误记录器时可以选择只保存错误,丢弃其他所有类型的条目
</pre>

<p>
现在,编写配置文件 elog1.config 来配置错误记录器：
</p>

<div class="org-src-container">
<pre class="src src-erlang"><span style="color: #ff4500;">%% </span><span style="color: #ff4500;">no tty </span>
[{sasl, [
         {sasl_error_logger, false}
        ]}].
</pre>
</div>

<pre class="example">
      如果用这个配置文件启动系统,就只会得到错误报告,不会有进度和其他报告

      所有这些错误报告只会出现在shell里
</pre>

<div class="org-src-container">
<pre class="src src-sh">$ erl -boot start_sasl -config elog1 
Erlang/OTP 18 [erts-7.3] [source] [64-bit] [smp:6:6] [async-threads:10] [kernel-poll:false]

Eshell V7.3  (abort with ^G)
1&gt; error_logger:error_msg(<span style="color: #ffa07a;">"An error has occured\n"</span>) <span style="color: #b0c4de;">.</span>
ok

=ERROR <span style="color: #eedd82;">REPORT</span>==== 13-Apr-2021::11:16:30 ===
An error has occured
</pre>
</div>
</div>
</div>

<div id="outline-container-org7eb4591" class="outline-4">
<h4 id="org7eb4591">文本文件和shell</h4>
<div class="outline-text-4" id="text-org7eb4591">
<p>
接下来的配置文件会在shell里列出错误报告,所有的进度报告则会保存在一个文件里：
</p>

<div class="org-src-container">
<pre class="src src-erlang"><span style="color: #ff4500;">%% </span><span style="color: #ff4500;">single text file - minimal tty</span>

[{sasl, [
         <span style="color: #ff4500;">%% </span><span style="color: #ff4500;">All reports go to this file</span>
         {sasl_error_logger, {file, <span style="color: #ffa07a;">"/tmp/THELOG"</span>}}
        ]}].
</pre>
</div>

<p>
要测试它,可以启动Erlang,生成一个错误消息,然后查看日志文件：
</p>

<div class="org-src-container">
<pre class="src src-sh">$ erl -boot start_sasl -config elog2 
Erlang/OTP 18 [erts-7.3] [source] [64-bit] [smp:6:6] [async-threads:10] [kernel-poll:false]

Eshell V7.3  (abort with ^G)
1&gt; error_logger:error_msg(<span style="color: #ffa07a;">"An error has occured\n"</span>) <span style="color: #b0c4de;">.</span> 

=ERROR <span style="color: #eedd82;">REPORT</span>==== 13-Apr-2021::11:22:26 ===
An error has occured
ok
</pre>
</div>

<p>
现在查看 /tmp/THELOG: 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cat /tmp/THELOG  

  =PROGRESS <span style="color: #eedd82;">REPORT</span>==== 13-Apr-2021::11:22:19 ===
            supervisor: {<span style="color: #b0c4de;">local</span>,sasl_safe_sup}
               started: [{pid,&lt;0.36.0&gt;},
                         {id,alarm_handler},
                         {mfargs,{alarm_handler,start_link,[]}},
                         {restart_type,permanent},
                         {shutdown,2000},
                         {child_type,worker}]

  ......
</pre>
</div>
<p>
这里只列出了进度报告,而它们原本应该出现在shell里。进度报告是关于大事件的,比如启动和停止应用程序
</p>

<pre class="example">
      但是 error_logger:error_msg/1 报告的错误没有保存在日志里,为此必须配置一个滚动日志
</pre>
</div>
</div>

<div id="outline-container-org046d770" class="outline-4">
<h4 id="org046d770">滚动日志和shell</h4>
<div class="outline-text-4" id="text-org046d770">
<p>
下面的配置既能提供shell输出,又能把写入shell的所有信息复制到一个滚动日志文件里：
</p>

<div class="org-src-container">
<pre class="src src-erlang"><span style="color: #ff4500;">%% </span><span style="color: #ff4500;">rotating log and minimal tty</span>
[{sasl, [
         {sasl_error_logger, false},    
         <span style="color: #ff4500;">%% </span><span style="color: #ff4500;">define the parameters of the rotating log</span>
         <span style="color: #ff4500;">%% </span><span style="color: #ff4500;">the log file directory</span>
         {error_logger_mf_dir,<span style="color: #ffa07a;">"/tmp/error_logs"</span>},       
         <span style="color: #ff4500;">%% </span><span style="color: #ff4500;"># bytes per logfile</span>
         {error_logger_mf_maxbytes,10485760}, <span style="color: #ff4500;">% </span><span style="color: #ff4500;">10 MB</span>
         <span style="color: #ff4500;">%% </span><span style="color: #ff4500;">maximum number of logfiles</span>
         {error_logger_mf_maxfiles, 10}
        ]}].
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">$ erl -boot start_sasl -config elog3  
Erlang/OTP 18 [erts-7.3] [source] [64-bit] [smp:6:6] [async-threads:10] [kernel-poll:false]

Eshell V7.3  (abort with ^G)
1&gt; error_logger:error_msg(<span style="color: #ffa07a;">"An error has occured\n"</span>) <span style="color: #b0c4de;">.</span>  
ok

=ERROR <span style="color: #eedd82;">REPORT</span>==== 13-Apr-2021::11:29:26 ===
An error has occured
</pre>
</div>

<p>
这个日志的最大文件大小是10MB,达到10MB时会回滚 
</p>

<pre class="example">
      这是一个非常有用的配置，运行系统时,所有的错误都会写入一个滚动错误日志
</pre>
</div>
</div>

<div id="outline-container-orgd90f5ab" class="outline-4">
<h4 id="orgd90f5ab">生产环境</h4>
<div class="outline-text-4" id="text-orgd90f5ab">
<p>
在生产环境里,我们真正感兴趣的只有错误,而非进度或信息报告,所以只让错误记录器报告错误。如果没有这个设置,系统也许就会被信息和进度报告所淹没
</p>

<div class="org-src-container">
<pre class="src src-erlang"><span style="color: #ff4500;">%% </span><span style="color: #ff4500;">rotating log and errors</span>
[{sasl, [        
         <span style="color: #ff4500;">%% </span><span style="color: #ff4500;">minimise shell error logging</span>
         {sasl_error_logger, false},
         <span style="color: #ff4500;">%% </span><span style="color: #ff4500;">only report errors</span>
         {errlog_type, error},
         <span style="color: #ff4500;">%% </span><span style="color: #ff4500;">define the parameters of the rotating log</span>
         <span style="color: #ff4500;">%% </span><span style="color: #ff4500;">the log file directory</span>
         {error_logger_mf_dir,<span style="color: #ffa07a;">"/Users/joe/error_logs"</span>}, 
         <span style="color: #ff4500;">%% </span><span style="color: #ff4500;"># bytes per logfile</span>
         {error_logger_mf_maxbytes,10485760}, <span style="color: #ff4500;">% </span><span style="color: #ff4500;">10 MB</span>
         <span style="color: #ff4500;">%% </span><span style="color: #ff4500;">maximum number of</span>
         {error_logger_mf_maxfiles, 10}
        ]}].
</pre>
</div>

<p>
运行它会产生与之前例子类似的输出,区别在于错误日志里只会有错误报告
</p>
</div>
</div>
</div>

<div id="outline-container-org47fe1b1" class="outline-3">
<h3 id="org47fe1b1">分析错误</h3>
<div class="outline-text-3" id="text-org47fe1b1">
<p>
阅读错误日志是 rb 模块的责任,它的接口极其简单：
</p>

<div class="org-src-container">
<pre class="src src-sh">$ erl -boot start_sasl -config elog3
......

1&gt; rb:help() <span style="color: #b0c4de;">.</span>  
Report Browser Tool - usage
===========================
2&gt; rb:start() <span style="color: #b0c4de;">.</span> 
rb: reading report...done.
rb: reading report...done.
{ok,&lt;0.44.0&gt;}
</pre>
</div>

<p>
首先必须用正确的配置文件启动Erlang,这样才能定位错误日志;然后启动报告浏览器,告诉它要读取多少日志条目(在这个案例里是最后20条)
</p>

<div class="org-src-container">
<pre class="src src-sh">1&gt; rb:start([{max,20}]) <span style="color: #b0c4de;">.</span>  
rb: reading report...done.
rb: reading report...done.
rb: reading report...done.
{ok,&lt;0.43.0&gt;}
</pre>
</div>
<p>
现在列出日志里的条目：
</p>

<div class="org-src-container">
<pre class="src src-sh">2&gt; rb:list() <span style="color: #b0c4de;">.</span> 
  No                Type   Process       Date     Time
  ==                ====   =======       ====     ====
  17            progress  &lt;0.31.0&gt; 2021-04-13 11:29:18
  16            progress  &lt;0.31.0&gt; 2021-04-13 11:29:18
  15            progress  &lt;0.31.0&gt; 2021-04-13 11:29:18
  14            progress  &lt;0.31.0&gt; 2021-04-13 11:29:18
  13            progress  &lt;0.24.0&gt; 2021-04-13 11:29:18
  12               error  &lt;0.25.0&gt; 2021-04-13 11:29:26
  11            progress  &lt;0.31.0&gt; 2021-04-13 11:34:30
  10            progress  &lt;0.31.0&gt; 2021-04-13 11:34:30
   9            progress  &lt;0.31.0&gt; 2021-04-13 11:34:30
   8            progress  &lt;0.31.0&gt; 2021-04-13 11:34:30
   7            progress  &lt;0.24.0&gt; 2021-04-13 11:34:30
   6            progress  &lt;0.31.0&gt; 2021-04-13 11:37:09
   5            progress  &lt;0.31.0&gt; 2021-04-13 11:39:21
   4            progress  &lt;0.31.0&gt; 2021-04-13 11:39:21
   3            progress  &lt;0.31.0&gt; 2021-04-13 11:39:21
   2            progress  &lt;0.31.0&gt; 2021-04-13 11:39:21
   1            progress  &lt;0.24.0&gt; 2021-04-13 11:39:21
ok
</pre>
</div>

<p>
调用 error_logger:error_msg/1 产生的错误日志条目消息最终成为日志里的第12条。可以像这样检查它:
</p>

<div class="org-src-container">
<pre class="src src-sh">3&gt; rb:show(12) <span style="color: #b0c4de;">.</span> 

ERROR REPORT  &lt;0.41.0&gt;                                      2021-04-13 11:29:26
===============================================================================

An error has occured
ok
</pre>
</div>
<p>
要分离出某个错误,可以使用 <span class="underline">rb:grep(RegExp)</span> 这样的命令,它会找出所有匹配正则表达式 RegExp 的报告
</p>

<pre class="example">
     不想详尽介绍如何分析错误日志,最好的做法是花一点时间与 rb 交互来看看它能做什么

     请注意,实际上永远不需要删除任何一个错误报告,因为滚动机制最终会删除那些老的错误报告

     如果想保留所有的错误日志,就必须定期轮询错误报告并移除你感兴趣的信息
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfa3c311" class="outline-2">
<h2 id="orgfa3c311">警报管理</h2>
<div class="outline-text-2" id="text-orgfa3c311">
<pre class="example">
    我们编写的应用程序只需要一个警报,这个警报会在CPU因为计算超大质数而温度过热时抛出(别忘了我们正在建设一家销售质数的公司)

    这次将使用真正的OTP警报处理器
</pre>

<p>
这个警报处理器是OTP <span class="underline">gen_event</span> 行为的回调模块,它的代码如下：
</p>

<div class="org-src-container">
<pre class="src src-erlang"><span style="color: #7fffd4;">-module</span>(my_alarm_handler).
<span style="color: #7fffd4;">-behaviour</span>(gen_event).

<span style="color: #ff4500;">%% </span><span style="color: #ff4500;">gen_event callbacks</span>
<span style="color: #7fffd4;">-export</span>([<span style="color: #98fb98;">init/1</span>, <span style="color: #98fb98;">code_change/3</span>, <span style="color: #98fb98;">handle_event/2</span>, <span style="color: #98fb98;">handle_call/2</span>, 
         <span style="color: #98fb98;">handle_info/2</span>, <span style="color: #98fb98;">terminate/2</span>]).

<span style="color: #ff4500;">%% </span><span style="color: #ff4500;">init(Args) must return {ok, State}</span>
<span style="color: #87cefa;">init</span>(<span style="color: #eedd82;">Args</span>) -&gt;
    <span style="color: #98fb98;">io</span>:<span style="color: #98fb98;">format</span>(<span style="color: #ffa07a;">"*** my_alarm_handler init:~p~n"</span>,[<span style="color: #eedd82;">Args</span>]),
    {ok, 0}.

<span style="color: #87cefa;">handle_event</span>({set_alarm, tooHot}, <span style="color: #eedd82;">N</span>) -&gt;
    <span style="color: #98fb98;">error_logger</span>:<span style="color: #98fb98;">error_msg</span>(<span style="color: #ffa07a;">"*** Tell the Engineer to turn on the fan~n"</span>),
    {ok, <span style="color: #eedd82;">N</span>+1};
<span style="color: #87cefa;">handle_event</span>({clear_alarm, tooHot}, <span style="color: #eedd82;">N</span>) -&gt;
    <span style="color: #98fb98;">error_logger</span>:<span style="color: #98fb98;">error_msg</span>(<span style="color: #ffa07a;">"*** Danger over. Turn off the fan~n"</span>),
    {ok, <span style="color: #eedd82;">N</span>};
<span style="color: #87cefa;">handle_event</span>(<span style="color: #eedd82;">Event</span>, <span style="color: #eedd82;">N</span>) -&gt;
    <span style="color: #98fb98;">io</span>:<span style="color: #98fb98;">format</span>(<span style="color: #ffa07a;">"*** unmatched event:~p~n"</span>,[<span style="color: #eedd82;">Event</span>]),
    {ok, <span style="color: #eedd82;">N</span>}.

<span style="color: #87cefa;">handle_call</span>(<span style="color: #eedd82;">_Request</span>, <span style="color: #eedd82;">N</span>) -&gt;<span style="color: #87cefa;"> </span><span style="color: #eedd82;">Reply</span> = <span style="color: #eedd82;">N</span>, {ok, <span style="color: #eedd82;">Reply</span>,  <span style="color: #eedd82;">N</span>}.
<span style="color: #87cefa;">handle_info</span>(<span style="color: #eedd82;">_Info</span>, <span style="color: #eedd82;">N</span>)    -&gt;<span style="color: #87cefa;"> </span>{ok, <span style="color: #eedd82;">N</span>}.

<span style="color: #87cefa;">terminate</span>(<span style="color: #eedd82;">_Reason</span>, <span style="color: #eedd82;">_N</span>)   -&gt;<span style="color: #87cefa;"> </span>ok.
<span style="color: #87cefa;">code_change</span>(<span style="color: #eedd82;">_OldVsn</span>, <span style="color: #eedd82;">State</span>, <span style="color: #eedd82;">_Extra</span>) -&gt;<span style="color: #87cefa;"> </span>{ok, <span style="color: #eedd82;">State</span>}.
</pre>
</div>

<pre class="example">
  这段代码非常像之前看到的 gen_server 回调代码
</pre>
<p>
其中值得注意的方法是 <span class="underline">handle_event(Event, State)</span> : 
</p>
<ul class="org-ul">
<li>它应当返回 <span class="underline">{ok, NewState}</span></li>
<li><span class="underline">Event</span> : 一个 <span class="underline">{EventType, Event-Arg}</span> 形式的元组
<ul class="org-ul">
<li><span class="underline">EventType</span> : <span class="underline">set_event</span> 或 <span class="underline">clear_event</span></li>
<li><span class="underline">EventArg</span> : 一个用户提供的参数</li>
</ul></li>
</ul>

<p>
现在来启动系统,生成一个警报,安装警报处理器,再生成一个警报&#x2026;&#x2026;
</p>

<div class="org-src-container">
<pre class="src src-sh">$ erl -boot start_sasl -config elog3 
1&gt; alarm_handler:set_alarm(tooHot) <span style="color: #b0c4de;">.</span> 
ok

=INFO <span style="color: #eedd82;">REPORT</span>==== 14-Apr-2021::09:39:29 ===
    alarm_handler: {<span style="color: #b0c4de;">set</span>,tooHot}
2&gt; 
2&gt; gen_event:swap_handler(alarm_handler, {alarm_handler, swap}, {my_alarm_handler, xyz}) <span style="color: #b0c4de;">.</span> 
*** my_alarm_handler init:{xyz,{alarm_handler,[tooHot]}}
ok
3&gt; 
3&gt; alarm_handler:set_alarm(tooHot) <span style="color: #b0c4de;">.</span>                                                       
=ERROR <span style="color: #eedd82;">REPORT</span>==== 14-Apr-2021::09:41:46 ===
*** Tell the Engineer to turn on the fan
ok
4&gt; 
4&gt; alarm_handler:clear_alarm(tooHot) <span style="color: #b0c4de;">.</span> 

=ERROR <span style="color: #eedd82;">REPORT</span>==== 14-Apr-2021::09:42:08 ===
*** Danger over. Turn off the fan
ok
</pre>
</div>

<p>
刚才发生了以下这些事情：
</p>
<ol class="org-ol">
<li>用 -boot start_sasl 启动了Erlang。这么做就得到了一个标准警报处理器。当设置或清除警报时,什么事都不会发生。这就类似于之前讨论过的“什么都不干”的事件处理器</li>
<li>设置警报(第1行)后只得到了一个信息报告。这个警报没有得到特别处理</li>
<li>安装了一个自定义警报处理器(第2行)
<ul class="org-ul">
<li>my_alarm_handler 的参数 <span class="underline">xyz</span> 没什么特殊含义,只不过语法要求这里有一个值。但因为我们没有用值而是用了原子 xyz ,所以能在参数打印出来时识别它</li>
<li>** my_alarm_handler_init: &#x2026; 这段打印输出来自我们的回调模块</li>
</ul></li>
<li>设置并清除了一个 tooHot 警报(第3和第4行) 
<ul class="org-ul">
<li>自定义警报处理器对其进行了处理,shell打印输出能证明这一点</li>
</ul></li>
</ol>
</div>

<div id="outline-container-orgbf82e5f" class="outline-3">
<h3 id="orgbf82e5f">读取日志</h3>
<div class="outline-text-3" id="text-orgbf82e5f">
<p>
回到错误记录器里去看看发生了什么 
</p>

<div class="org-src-container">
<pre class="src src-sh">5&gt; rb:start([{max, 20}]) <span style="color: #b0c4de;">.</span> 
rb: reading report...done.
{ok,&lt;0.47.0&gt;}


6&gt; rb:list() <span style="color: #b0c4de;">.</span> 
  No                Type   Process       Date     Time
  ==                ====   =======       ====     ====
   8            progress  &lt;0.31.0&gt; 2021-04-14 09:49:53
   7            progress  &lt;0.31.0&gt; 2021-04-14 09:49:53
   6            progress  &lt;0.31.0&gt; 2021-04-14 09:49:53
   5            progress  &lt;0.31.0&gt; 2021-04-14 09:49:53
   4            progress  &lt;0.24.0&gt; 2021-04-14 09:49:53
   3         info_report  &lt;0.31.0&gt; 2021-04-14 09:56:41
   2               error  &lt;0.31.0&gt; 2021-04-14 09:57:11
   1               error  &lt;0.31.0&gt; 2021-04-14 09:57:25
ok

7&gt; rb:show(1) <span style="color: #b0c4de;">.</span> 

ERROR REPORT  &lt;0.35.0&gt;                                      2021-04-14 09:57:25
===============================================================================

*** Danger over. Turn off the fan
ok

8&gt; rb:show(2) <span style="color: #b0c4de;">.</span> 

ERROR REPORT  &lt;0.35.0&gt;                                      2021-04-14 09:57:11
===============================================================================

*** Tell the Engineer to turn on the fan
ok
</pre>
</div>
<p>
可以看到错误记录机制运行正常
</p>

<pre class="example">
在实践中,会确保错误日志大到足够支持几天或几周的运作。每隔几天(或几周)就会检查错误日志并调查所有错误

rb 模块里有一些函数能选择特定类型的错误或把它们提取到文件里。因此,分析错误日志的过程可以实现完全自动化
</pre>
</div>
</div>
</div>

<div id="outline-container-org53e623a" class="outline-2">
<h2 id="org53e623a">应用程序服务器</h2>
<div class="outline-text-2" id="text-org53e623a">
<pre class="example">
    我们的应用程序有两个服务器:一个质数服务器和一个面积服务器
</pre>
</div>

<div id="outline-container-orga09134a" class="outline-3">
<h3 id="orga09134a">质数服务器</h3>
<div class="outline-text-3" id="text-orga09134a">
<p>
这里是质数服务器的代码,它是用 gen_server 行为编写的
</p>

<div class="org-src-container">
<pre class="src src-erlang"><span style="color: #7fffd4;">-module</span>(prime_server).
<span style="color: #7fffd4;">-behaviour</span>(gen_server).
<span style="color: #7fffd4;">-export</span>([<span style="color: #98fb98;">new_prime/1</span>, <span style="color: #98fb98;">start_link/0</span>]).

<span style="color: #ff4500;">%% </span><span style="color: #ff4500;">gen_server callbacks</span>
<span style="color: #7fffd4;">-export</span>([<span style="color: #98fb98;">init/1</span>, <span style="color: #98fb98;">handle_call/3</span>, <span style="color: #98fb98;">handle_cast/2</span>, <span style="color: #98fb98;">handle_info/2</span>,
         <span style="color: #98fb98;">terminate/2</span>, <span style="color: #98fb98;">code_change/3</span>]).

<span style="color: #87cefa;">start_link</span>() -&gt;
    <span style="color: #98fb98;">gen_server</span>:<span style="color: #98fb98;">start_link</span>({local, ?<span style="color: #7fffd4;">MODULE</span>}, ?<span style="color: #7fffd4;">MODULE</span>, [], []).

<span style="color: #87cefa;">new_prime</span>(<span style="color: #eedd82;">N</span>) -&gt;
    <span style="color: #ff4500;">%% </span><span style="color: #ff4500;">20000 is a timeout (ms)</span>
    <span style="color: #98fb98;">gen_server</span>:<span style="color: #98fb98;">call</span>(?<span style="color: #7fffd4;">MODULE</span>, {prime, <span style="color: #eedd82;">N</span>}, 20000).

<span style="color: #87cefa;">init</span>([]) -&gt;
    <span style="color: #ff4500;">%% </span><span style="color: #ff4500;">Note we must set trap_exit = true if we </span>
    <span style="color: #ff4500;">%% </span><span style="color: #ff4500;">want terminate/2 to be called when the application</span>
    <span style="color: #ff4500;">%% </span><span style="color: #ff4500;">is stopped</span>

    <span style="color: #b0c4de;">process_flag</span>(trap_exit, true),
    <span style="color: #98fb98;">io</span>:<span style="color: #98fb98;">format</span>(<span style="color: #ffa07a;">"~p starting~n"</span>,[?<span style="color: #7fffd4;">MODULE</span>]),
    {ok, 0}.

<span style="color: #87cefa;">handle_call</span>({prime, <span style="color: #eedd82;">K</span>}, <span style="color: #eedd82;">_From</span>, <span style="color: #eedd82;">N</span>) -&gt;<span style="color: #87cefa;"> </span>
    {reply, <span style="color: #98fb98;">make_new_prime</span>(<span style="color: #eedd82;">K</span>), <span style="color: #eedd82;">N</span>+1}.

<span style="color: #87cefa;">handle_cast</span>(<span style="color: #eedd82;">_Msg</span>, <span style="color: #eedd82;">N</span>)  -&gt;<span style="color: #87cefa;"> </span>{noreply, <span style="color: #eedd82;">N</span>}.

<span style="color: #87cefa;">handle_info</span>(<span style="color: #eedd82;">_Info</span>, <span style="color: #eedd82;">N</span>)  -&gt;<span style="color: #87cefa;"> </span>{noreply, <span style="color: #eedd82;">N</span>}.

<span style="color: #87cefa;">terminate</span>(<span style="color: #eedd82;">_Reason</span>, <span style="color: #eedd82;">_N</span>) -&gt;<span style="color: #87cefa;"> </span>
    <span style="color: #98fb98;">io</span>:<span style="color: #98fb98;">format</span>(<span style="color: #ffa07a;">"~p stopping~n"</span>,[?<span style="color: #7fffd4;">MODULE</span>]),
    ok.

<span style="color: #87cefa;">code_change</span>(<span style="color: #eedd82;">_OldVsn</span>, <span style="color: #eedd82;">N</span>, <span style="color: #eedd82;">_Extra</span>) -&gt;<span style="color: #87cefa;"> </span>{ok, <span style="color: #eedd82;">N</span>}.

<span style="color: #87cefa;">make_new_prime</span>(<span style="color: #eedd82;">K</span>) -&gt;
    <span style="color: #00ffff;">if</span>
        <span style="color: #eedd82;">K</span> &gt; 100 -&gt;
            <span style="color: #98fb98;">alarm_handler</span>:<span style="color: #98fb98;">set_alarm</span>(tooHot),
            <span style="color: #eedd82;">N</span> = <span style="color: #98fb98;">lib_primes</span>:<span style="color: #98fb98;">make_prime</span>(<span style="color: #eedd82;">K</span>),
            <span style="color: #98fb98;">alarm_handler</span>:<span style="color: #98fb98;">clear_alarm</span>(tooHot),
            <span style="color: #eedd82;">N</span>;
        true -&gt;
            <span style="color: #98fb98;">lib_primes</span>:<span style="color: #98fb98;">make_prime</span>(<span style="color: #eedd82;">K</span>)
    <span style="color: #00ffff;">end</span>.
</pre>
</div>

<pre class="example">
     请注意它是如何纳入在前一节中开发的警报处理函数的
</pre>
</div>
</div>
<div id="outline-container-orgf573389" class="outline-3">
<h3 id="orgf573389">面积服务器</h3>
<div class="outline-text-3" id="text-orgf573389">
<p>
现在轮到面积服务器了,它也是用 gen_server 行为编写的
</p>

<pre class="example">
     请注意,用这种方式编写服务器速度极快。在编写这个示例时剪切粘贴了质数服务器里的代码,然后把它转变成面积服务器。这只用了几分钟时间

     这个面积服务器不是全世界最有才的程序,而且它还包含一个故意设置的错误,就是为了让服务器崩溃然后被监控器重启

     此外还会在错误日志里获得关于这一切的报告
</pre>

<div class="org-src-container">
<pre class="src src-erlang"><span style="color: #7fffd4;">-module</span>(area_server).
<span style="color: #7fffd4;">-behaviour</span>(gen_server).

<span style="color: #7fffd4;">-export</span>([<span style="color: #98fb98;">area/1</span>, <span style="color: #98fb98;">start_link/0</span>]).

<span style="color: #ff4500;">%% </span><span style="color: #ff4500;">gen_server callbacks</span>
<span style="color: #7fffd4;">-export</span>([<span style="color: #98fb98;">init/1</span>, <span style="color: #98fb98;">handle_call/3</span>, <span style="color: #98fb98;">handle_cast/2</span>, <span style="color: #98fb98;">handle_info/2</span>,
         <span style="color: #98fb98;">terminate/2</span>, <span style="color: #98fb98;">code_change/3</span>]).

<span style="color: #87cefa;">start_link</span>() -&gt;
    <span style="color: #98fb98;">gen_server</span>:<span style="color: #98fb98;">start_link</span>({local, ?<span style="color: #7fffd4;">MODULE</span>}, ?<span style="color: #7fffd4;">MODULE</span>, [], []).

<span style="color: #87cefa;">area</span>(<span style="color: #eedd82;">Thing</span>) -&gt;
    <span style="color: #98fb98;">gen_server</span>:<span style="color: #98fb98;">call</span>(?<span style="color: #7fffd4;">MODULE</span>, {area, <span style="color: #eedd82;">Thing</span>}).

<span style="color: #87cefa;">init</span>([]) -&gt;
    <span style="color: #ff4500;">%% </span><span style="color: #ff4500;">Note we must set trap_exit = true if we </span>
    <span style="color: #ff4500;">%% </span><span style="color: #ff4500;">want terminate/2 to be called when the application</span>
    <span style="color: #ff4500;">%% </span><span style="color: #ff4500;">is stopped</span>
    <span style="color: #b0c4de;">process_flag</span>(trap_exit, true),
    <span style="color: #98fb98;">io</span>:<span style="color: #98fb98;">format</span>(<span style="color: #ffa07a;">"~p starting~n"</span>,[?<span style="color: #7fffd4;">MODULE</span>]),
    {ok, 0}.

<span style="color: #87cefa;">handle_call</span>({area, <span style="color: #eedd82;">Thing</span>}, <span style="color: #eedd82;">_From</span>, <span style="color: #eedd82;">N</span>) -&gt;<span style="color: #87cefa;"> </span>{reply, <span style="color: #98fb98;">compute_area</span>(<span style="color: #eedd82;">Thing</span>), <span style="color: #eedd82;">N</span>+1}.

<span style="color: #87cefa;">handle_cast</span>(<span style="color: #eedd82;">_Msg</span>, <span style="color: #eedd82;">N</span>)  -&gt;<span style="color: #87cefa;"> </span>{noreply, <span style="color: #eedd82;">N</span>}.

<span style="color: #87cefa;">handle_info</span>(<span style="color: #eedd82;">_Info</span>, <span style="color: #eedd82;">N</span>)  -&gt;<span style="color: #87cefa;"> </span>{noreply, <span style="color: #eedd82;">N</span>}.

<span style="color: #87cefa;">terminate</span>(<span style="color: #eedd82;">_Reason</span>, <span style="color: #eedd82;">_N</span>) -&gt;<span style="color: #87cefa;"> </span>
    <span style="color: #98fb98;">io</span>:<span style="color: #98fb98;">format</span>(<span style="color: #ffa07a;">"~p stopping~n"</span>,[?<span style="color: #7fffd4;">MODULE</span>]),
    ok.

<span style="color: #87cefa;">code_change</span>(<span style="color: #eedd82;">_OldVsn</span>, <span style="color: #eedd82;">N</span>, <span style="color: #eedd82;">_Extra</span>) -&gt;<span style="color: #87cefa;"> </span>{ok, <span style="color: #eedd82;">N</span>}.

<span style="color: #87cefa;">compute_area</span>({square, <span style="color: #eedd82;">X</span>})       -&gt;<span style="color: #87cefa;"> </span><span style="color: #eedd82;">X</span>*<span style="color: #eedd82;">X</span>;
<span style="color: #87cefa;">compute_area</span>({rectongle, <span style="color: #eedd82;">X</span>, <span style="color: #eedd82;">Y</span>}) -&gt;<span style="color: #87cefa;"> </span><span style="color: #eedd82;">X</span>*<span style="color: #eedd82;">Y</span>.
</pre>
</div>

<pre class="example">
     已经编写完了应用程序代码,还加了一个小错误

     现在必须设立一个监控结构来检测和纠正所有可能在运行时发生的错误
</pre>
</div>
</div>
</div>
<div id="outline-container-org20c3171" class="outline-2">
<h2 id="org20c3171">监控树</h2>
<div class="outline-text-2" id="text-org20c3171">
<p>
监控树是一种由 <span class="underline">进程</span> 组成的 <span class="underline">树形结构</span> 。树的 <span class="underline">上级进程</span> (监控器)监视着 <span class="underline">下级进程</span> (工作器), 如果下级进程挂了就会重启它们。监控树有两种：
</p>


<div class="figure">
<p><img src="pic/monitor-tree.png" alt="monitor-tree.png" width="70%" /> 
</p>
</div>

<ul class="org-ul">
<li>一对一监控树：如果某个工作器崩溃了,就会被 监控器重启</li>
<li>一对多监控树：如果任何一个工作器崩溃了,所有工作进程都会被终止(通过调用相应回调模块里的 terminate/2 函数)然后重启</li>
</ul>

<p>
监控器是用 <span class="underline">OTP supervisor</span> 行为创建的。这个行为用一个 <span class="underline">回调模块</span> 作为参数,里面指定了 <span class="underline">监控策略</span> 以及如何 <span class="underline">启动</span> 监控树里的各个工作进程。监控树通过以下形式的函数指定：
</p>

<div class="org-src-container">
<pre class="src src-erlang"><span style="color: #87cefa;">init</span>(...) -&gt;
    {ok, {
          {<span style="color: #eedd82;">RestartStrategy</span>, <span style="color: #eedd82;">MaxRestarts</span>, <span style="color: #eedd82;">Time</span>},
          [worker1, worker2, ...]
         }}
</pre>
</div>

<ul class="org-ul">
<li>RestartStrategy 是原子 one_for_one 或 one_for_all</li>
<li>MaxRestarts 和 Time 则指定“重启频率”。如果一个监控器在 Time 秒内执行了超过 MaxRestarts 次重启,那么这个监控器就会终止所有工作进程然后退出
<ul class="org-ul">
<li>这是为了防止出现一种情形,即某个进程崩溃、被重启,然后又因为相同原因崩溃而形成的无限循环</li>
</ul></li>
<li>Worker1 和 Worker2 这些是描述如何启动各个工作进程的元组</li>
</ul>

<pre class="example">
现在回到前面的代码上来,同时构建一个监控树

要做的第一件事是给公司选一个名字,决定叫它 sellaprime

sellaprime 监控器的工作是确保质数和面积服务器始终保持运行
</pre>


<p>
为了做到这一点,将编写另一个用于 <span class="underline">gen_supervisor</span> 的回调模块。这个模块的代码如下:
</p>

<div class="org-src-container">
<pre class="src src-erlang"><span style="color: #7fffd4;">-module</span>(sellaprime_supervisor).
<span style="color: #7fffd4;">-behaviour</span>(supervisor).         <span style="color: #ff4500;">% </span><span style="color: #ff4500;">see erl -man supervisor</span>
<span style="color: #7fffd4;">-export</span>([<span style="color: #98fb98;">start/0</span>, <span style="color: #98fb98;">start_in_shell_for_testing/0</span>, <span style="color: #98fb98;">start_link/1</span>, <span style="color: #98fb98;">init/1</span>]).

<span style="color: #87cefa;">start</span>() -&gt;
    <span style="color: #b0c4de;">spawn</span>(<span style="color: #00ffff;">fun</span>() -&gt;
                  <span style="color: #98fb98;">supervisor</span>:<span style="color: #98fb98;">start_link</span>({local,?<span style="color: #7fffd4;">MODULE</span>}, ?<span style="color: #7fffd4;">MODULE</span>, <span style="color: #eedd82;">_Arg</span> = [])
          <span style="color: #00ffff;">end</span>).
<span style="color: #87cefa;">start_in_shell_for_testing</span>() -&gt;
    {ok, <span style="color: #eedd82;">Pid</span>} = <span style="color: #98fb98;">supervisor</span>:<span style="color: #98fb98;">start_link</span>({local,?<span style="color: #7fffd4;">MODULE</span>}, ?<span style="color: #7fffd4;">MODULE</span>, <span style="color: #eedd82;">_Arg</span> = []),
    <span style="color: #b0c4de;">unlink</span>(<span style="color: #eedd82;">Pid</span>).
<span style="color: #87cefa;">start_link</span>(<span style="color: #eedd82;">Args</span>) -&gt;
    <span style="color: #98fb98;">supervisor</span>:<span style="color: #98fb98;">start_link</span>({local,?<span style="color: #7fffd4;">MODULE</span>}, ?<span style="color: #7fffd4;">MODULE</span>, <span style="color: #eedd82;">Args</span>).
<span style="color: #87cefa;">init</span>([]) -&gt;
    <span style="color: #ff4500;">%% </span><span style="color: #ff4500;">Install my personal error handler</span>
     <span style="color: #98fb98;">gen_event</span>:<span style="color: #98fb98;">swap_handler</span>(alarm_handler, 
                                   {alarm_handler, swap},
                                   {my_alarm_handler, xyz}),
    {ok, {{one_for_one, 3, 10},
          [{tag1, 
            {area_server, start_link, []},
            permanent, 
            10000, 
            worker, 
            [area_server]},
           {tag2, 
            {prime_server, start_link, []},
            permanent, 
            10000, 
            worker, 
            [prime_server]}
          ]}}.
</pre>
</div>

<p>
重点部分是 init/1 返回的数据结构：
</p>
<div class="org-src-container">
<pre class="src src-erlang">{ok, {{one_for_one, 3, 10},
      [{tag1, 
        {area_server, start_link, []},
        permanent, 
        10000, 
        worker, 
        [area_server]},
       {tag2, 
        {prime_server, start_link, []},
        permanent, 
        10000, 
        worker, 
        [prime_server]}
      ]}}
</pre>
</div>

<p>
这个数据结构定义了一种监控策略
</p>
<pre class="example">
    之前讨论过监控策略和重启频率，现在来看下的面积服务器和质数服务器的启动格式
</pre>

<p>
Worker 的格式是下面这种元组:
</p>
<div class="org-src-container">
<pre class="src src-erlang">{ <span style="color: #eedd82;">Tag</span>, 
  {<span style="color: #eedd82;">Mod</span>, <span style="color: #eedd82;">Func</span>, <span style="color: #eedd82;">ArgList</span>}, 
  <span style="color: #eedd82;">Restart</span>, 
  <span style="color: #eedd82;">Shutdown</span>, 
  <span style="color: #eedd82;">Type</span>, 
  [<span style="color: #eedd82;">Mod1</span>]}
</pre>
</div>

<p>
这些参数的意义如下。
</p>
<ul class="org-ul">
<li>Tag: 这是一个原子类型的标签,将来可以用它指代 <span class="underline">工作进程</span> (如果有必要的话)</li>
<li>{Mod, Func, ArgList}: 它定义了监控器用于 <span class="underline">启动工作器的函数</span> ,将被用作 apply(Mod, Fun, ArgList) 的参数</li>
<li>Restart = permanent | transient | temporary
<ul class="org-ul">
<li>permanent (永久)进程 <span class="underline">总是会被</span> 重启</li>
<li>transient (过渡)进程只有在以 <span class="underline">非正常退出值</span> 终止时才会被重启</li>
<li>temporary (临时)进程 <span class="underline">不会被</span> 重启。</li>
</ul></li>
<li>Shutdown 这关闭时间,也就是工作器 <span class="underline">终止过程允许耗费的最长时间</span> 。如果超过这个时间,工作进程就会被杀掉</li>
<li>Type = worker | supervisor 这是被 <span class="underline">监控进程的类型</span> 。可以用监控进程代替工作进程来构建一个由监控器组成的树</li>
<li>[Mod1] 如果子进程是 <span class="underline">监控器</span> 或者 gen_server 行为的 <span class="underline">回调模块</span> ,就在这里 <b>指定</b> 回调模块名</li>
</ul>

<pre class="example">
    这些参数看上去很吓人,但其实不是

    在实践中,可以剪切粘贴之前面积服务器代码里的值,然后插入你的模块名。这对大多数用途来说足够了
</pre>
</div>
</div>
<div id="outline-container-orgd88058a" class="outline-2">
<h2 id="orgd88058a">启动系统</h2>
<div class="outline-text-2" id="text-orgd88058a">
<p>
现在万事俱备，首先启动系统：
</p>

<div class="org-src-container">
<pre class="src src-sh">$ erl -boot start_sasl -config elog3  
Erlang/OTP 18 [erts-7.3] [source] [64-bit] [smp:6:6] [async-threads:10] [kernel-poll:false]

Eshell V7.3  (abort with ^G)
2&gt; sellaprime_supervisor:start_in_shell_for_testing() <span style="color: #b0c4de;">.</span> 
*** my_alarm_handler init:{xyz,{alarm_handler,[]}}
area_server starting
prime_server starting
true
</pre>
</div>

<p>
现在生成一个有效查询：
</p>

<div class="org-src-container">
<pre class="src src-sh">3&gt; area_server:area({square, 10}) <span style="color: #b0c4de;">.</span> 
100
</pre>
</div>

<p>
再生成一个无效查询：
</p>

<div class="org-src-container">
<pre class="src src-sh">4&gt; area_server:area({rectangle, 10, 20}) <span style="color: #b0c4de;">.</span>  
area_server stopping
area_server starting

=ERROR <span style="color: #eedd82;">REPORT</span>==== 15-Apr-2021::11:52:58 ===
** Generic server area_server terminating 
** Last message<span style="color: #00ffff;"> in</span> was {area,{rectangle,10,20}}
** When Server state == 1
** Reason for termination == 
** {function_clause,[{area_server,compute_area,
                                  [{rectangle,10,20}],
                                  [{file,<span style="color: #ffa07a;">"area_server.erl"</span>},{line,44}]},
                     {area_server,handle_call,3,
                                  [{file,<span style="color: #ffa07a;">"area_server.erl"</span>},{line,32}]},
                     {gen_server,try_handle_call,4,
                                 [{file,<span style="color: #ffa07a;">"gen_server.erl"</span>},{line,629}]},
                     {gen_server,handle_msg,5,
                                 [{file,<span style="color: #ffa07a;">"gen_server.erl"</span>},{line,661}]},
                     {proc_lib,init_p_do_apply,3,
                               [{file,<span style="color: #ffa07a;">"proc_lib.erl"</span>},{line,240}]}]}
** exception exit: {{function_clause,[{area_server,compute_area,
                                                   [{rectangle,10,20}],
                                                   [{file,<span style="color: #ffa07a;">"area_server.erl"</span>},{line,44}]},
                                      {area_server,handle_call,3,
                                                   [{file,<span style="color: #ffa07a;">"area_server.erl"</span>},{line,32}]},
                                      {gen_server,try_handle_call,4,
                                                  [{file,<span style="color: #ffa07a;">"gen_server.erl"</span>},{line,629}]},
                                      {gen_server,handle_msg,5,
                                                  [{file,<span style="color: #ffa07a;">"gen_server.erl"</span>},{line,661}]},
                                      {proc_lib,init_p_do_apply,3,
                                                [{file,<span style="color: #ffa07a;">"proc_lib.erl"</span>},{line,240}]}]},
                    {gen_server,call,[area_server,{area,{rectangle,10,20}}]}}
     <span style="color: #00ffff;">in</span> <span style="color: #00ffff;">function</span>  <span style="color: #87cefa;">gen_server</span>:call/2 (gen_server.erl, line 204)
</pre>
</div>

<pre class="example">
    不好,面积服务器崩溃了,触发了有意设置的错误。监控器检测到这次崩溃并重启了面积服务器

    所有这些都被错误记录器记录下来,也看到了这个错误的打印输出

    错误消息显示出问题所在:程序尝试执行 area_server:compute_area({rectangle,10,20}) 时崩溃了

    也就是错误消息 function_clase 的第一行所展示的。错误消息的格式是 {Mod,Func,[Args]}

    回去看看定义面积计算的部分(在 compute_area/1 里),应该能找到这个错误
</pre>
<p>
崩溃发生后,一切都恢复正常,就像构想的那样。接下来生成一个合法请求：
</p>

<div class="org-src-container">
<pre class="src src-sh">5&gt; area_server:area({square, 25}) <span style="color: #b0c4de;">.</span>         
625
</pre>
</div>
<p>
系统又能正常工作了。现在来生成一个小质数：
</p>

<div class="org-src-container">
<pre class="src src-sh">6&gt; prime_server:new_prime(20) <span style="color: #b0c4de;">.</span>     
Generating a 20 digit prime ..........
53076482275705498811
</pre>
</div>

<p>
再生成一个大质数：
</p>

<div class="org-src-container">
<pre class="src src-sh">7&gt; prime_server:new_prime(120) <span style="color: #b0c4de;">.</span> 
Generating a 120 digit prime ..
=ERROR <span style="color: #eedd82;">REPORT</span>==== 15-Apr-2021::11:54:07 ===
*** Tell the Engineer to turn on the fan
........................................................................................................................................................................................................................
629843095964883326439380674600451197441649615389439715257065277990540813955811087214345485499172035124010556643218342941
</pre>
</div>

<pre class="example">
    现在有了一个能正常运行的系统。如果某个服务器崩溃了,就会被自动重启,错误日志里则会有关于这个错误的信息
</pre>
<p>
来看一下错误日志：
</p>

<div class="org-src-container">
<pre class="src src-sh">8&gt; rb:start([{max, 20}]) <span style="color: #b0c4de;">.</span> 
rb: reading report...done.
{ok,&lt;0.59.0&gt;}

9&gt; rb:list() <span style="color: #b0c4de;">.</span> 
  No                Type      Process       Date     Time
  ==                ====      =======       ====     ====
  13            progress     &lt;0.31.0&gt; 2021-04-15 11:51:05
  12            progress     &lt;0.31.0&gt; 2021-04-15 11:51:05
  11            progress     &lt;0.31.0&gt; 2021-04-15 11:51:05
  10            progress     &lt;0.31.0&gt; 2021-04-15 11:51:05
   9            progress     &lt;0.24.0&gt; 2021-04-15 11:51:05
   8            progress     &lt;0.25.0&gt; 2021-04-15 11:51:44
   7            progress     &lt;0.25.0&gt; 2021-04-15 11:51:44
   6               error     &lt;0.25.0&gt; 2021-04-15 11:52:58
   5        crash_report  area_server 2021-04-15 11:52:58
   4   supervisor_report     &lt;0.25.0&gt; 2021-04-15 11:52:58
   3            progress     &lt;0.25.0&gt; 2021-04-15 11:52:58
   2               error     &lt;0.31.0&gt; 2021-04-15 11:54:07
   1               error     &lt;0.31.0&gt; 2021-04-15 11:54:08
ok
</pre>
</div>

<p>
有地方出问题了，能看到一个面积服务器的错误报告。要想查明发生了什么,可以查看错误报告：
</p>
<div class="org-src-container">
<pre class="src src-sh">10&gt; rb:show(5) <span style="color: #b0c4de;">.</span> 

CRASH REPORT  &lt;0.49.0&gt;                                      2021-04-15 11:52:58
===============================================================================
Crashing process                                                               
   initial_call                              {area_server,init,[<span style="color: #ffa07a;">'Argument__1'</span>]}
   pid                                                                 &lt;0.49.0&gt;
   registered_name                                                  area_server
   error_info
         {<span style="color: #00ffff;">exit</span>,
            {function_clause,
                [{area_server,compute_area,
                     [{rectangle,10,20}],
                     [{file,<span style="color: #ffa07a;">"area_server.erl"</span>},{line,44}]},
                 {area_server,handle_call,3,
                     [{file,<span style="color: #ffa07a;">"area_server.erl"</span>},{line,32}]},
                 {gen_server,try_handle_call,4,
                     [{file,<span style="color: #ffa07a;">"gen_server.erl"</span>},{line,629}]},
                 {gen_server,handle_msg,5,
                     [{file,<span style="color: #ffa07a;">"gen_server.erl"</span>},{line,661}]},
                 {proc_lib,init_p_do_apply,3,
                     [{file,<span style="color: #ffa07a;">"proc_lib.erl"</span>},{line,240}]}]},
            [{gen_server,terminate,7,[{file,<span style="color: #ffa07a;">"gen_server.erl"</span>},{line,826}]},
             {proc_lib,init_p_do_apply,3,
                 [{file,<span style="color: #ffa07a;">"proc_lib.erl"</span>},{line,240}]}]}
   ancestors                                   [sellaprime_supervisor,&lt;0.41.0&gt;]
   messages                                                                  []
   links                                                             [&lt;0.48.0&gt;]
   dictionary                                                                []
   trap_exit                                                               true
   status                                                               running
   heap_size                                                                610
   stack_size                                                                27
   reductions                                                               181

ok
</pre>
</div>

<p>
打印输出 {function_clause, compute_area, &#x2026;} 展示了程序里导致服务器崩溃的准确位置。定位和纠正这个错误应该是件简单的事。再看一下后面这些错误：
</p>
<div class="org-src-container">
<pre class="src src-sh">11&gt; rb:show(2) <span style="color: #b0c4de;">.</span> 

ERROR REPORT  &lt;0.35.0&gt;                                      2021-04-15 11:54:07
===============================================================================

*** Tell the Engineer to turn on the fan
ok

12&gt; rb:show(1) <span style="color: #b0c4de;">.</span> 

ERROR REPORT  &lt;0.35.0&gt;                                      2021-04-15 11:54:08
===============================================================================

*** Danger over. Turn off the fan
ok
</pre>
</div>

<p>
这些是因为计算的质数过大而引发的风扇警报! 
</p>

<pre class="example">
Erlang被设计用来编写容错式系统。它最初是在瑞典电信公司爱立信的计算机科学实验室里开发的。从那时起,爱立信的OTP团队在许多内部用户的帮助下接过了开发任务

通过使用 gen_server 和 gen_supervisor 等行为,人们用Erlang构建了可靠性为99.9999999%的系统(9个9)

如果用法正确,错误处理机制能帮助你的程序永久运行(好吧,几乎永久运行)。这里介绍的错误记录器已经在线上产品里运行多年了
</pre>
</div>
</div>
<div id="outline-container-org9052d82" class="outline-2">
<h2 id="org9052d82">应用程序</h2>
<div class="outline-text-2" id="text-org9052d82">
<p>
差不多已经完工了。现在要做的是编写一个扩展名为 .app 的文件,它包含关于这个应用程序的信息：
</p>

<div class="org-src-container">
<pre class="src src-erlang"><span style="color: #ff4500;">%% </span><span style="color: #ff4500;">This is the application resource file (.app file) for the 'base'</span>
<span style="color: #ff4500;">%% </span><span style="color: #ff4500;">application.</span>
{application, sellaprime, 
 [{description, <span style="color: #ffa07a;">"The Prime Number Shop"</span>},
  {vsn, <span style="color: #ffa07a;">"1.0"</span>},
  {modules, [sellaprime_app, sellaprime_supervisor, area_server, 
             prime_server, lib_lin, lib_primes, my_alarm_handler]},     
  {registered,[area_server, prime_server, sellaprime_super]},
  {applications, [kernel,stdlib]},
  {mod, {sellaprime_app,[]}},
  {start_phases, []}
 ]}.
</pre>
</div>

<p>
现在必须编写一个回调模块,它的名称与 <span class="underline">前面文件里的 mod 文件名</span> 相同：
</p>

<div class="org-src-container">
<pre class="src src-erlang"><span style="color: #7fffd4;">-module</span>(sellaprime_app).
<span style="color: #7fffd4;">-behaviour</span>(application).
<span style="color: #7fffd4;">-export</span>([<span style="color: #98fb98;">start/2</span>, <span style="color: #98fb98;">stop/1</span>]).
<span style="color: #87cefa;">start</span>(<span style="color: #eedd82;">_Type</span>, <span style="color: #eedd82;">StartArgs</span>) -&gt;
    <span style="color: #98fb98;">sellaprime_supervisor</span>:<span style="color: #98fb98;">start_link</span>(<span style="color: #eedd82;">StartArgs</span>).
<span style="color: #87cefa;">stop</span>(<span style="color: #eedd82;">_State</span>) -&gt;
    ok.
</pre>
</div>
<p>
它必须导出函数 <span class="underline">start/2</span> 和 <span class="underline">stop/1</span> 。做完这一切之后,就可以在shell里启动和停止应用程序了：
</p>

<div class="org-src-container">
<pre class="src src-sh">$ erl -boot start_sasl -config elog3 
Erlang/OTP 18 [erts-7.3] [source] [64-bit] [smp:6:6] [async-threads:10] [kernel-poll:false]
Eshell V7.3  (abort with ^G)

2&gt; application:loaded_applications() <span style="color: #b0c4de;">.</span> 
[{stdlib,<span style="color: #ffa07a;">"ERTS  CXC 138 10"</span>,<span style="color: #ffa07a;">"2.8"</span>},
 {sasl,<span style="color: #ffa07a;">"SASL  CXC 138 11"</span>,<span style="color: #ffa07a;">"2.7"</span>},
 {kernel,<span style="color: #ffa07a;">"ERTS  CXC 138 10"</span>,<span style="color: #ffa07a;">"4.2"</span>}]

4&gt; application:load(sellaprime) <span style="color: #b0c4de;">.</span>      
ok

5&gt; application:loaded_applications() <span style="color: #b0c4de;">.</span> 
[{stdlib,<span style="color: #ffa07a;">"ERTS  CXC 138 10"</span>,<span style="color: #ffa07a;">"2.8"</span>},
 {sellaprime,<span style="color: #ffa07a;">"The Prime Number Shop"</span>,<span style="color: #ffa07a;">"1.0"</span>},
 {sasl,<span style="color: #ffa07a;">"SASL  CXC 138 11"</span>,<span style="color: #ffa07a;">"2.7"</span>},
 {kernel,<span style="color: #ffa07a;">"ERTS  CXC 138 10"</span>,<span style="color: #ffa07a;">"4.2"</span>}]

6&gt; application:start(sellaprime) <span style="color: #b0c4de;">.</span>     
*** my_alarm_handler init:{xyz,{alarm_handler,[]}}
area_server starting
prime_server starting
ok

7&gt; application:stop(sellaprime) <span style="color: #b0c4de;">.</span>  
prime_server stopping
area_server stopping
ok

=INFO <span style="color: #eedd82;">REPORT</span>==== 16-Apr-2021::09:13:42 ===
    application: sellaprime
    exited: stopped
    <span style="color: #b0c4de;">type</span>: temporary

8&gt; application:unload(sellaprime) <span style="color: #b0c4de;">.</span> 
ok

9&gt; application:loaded_applications() <span style="color: #b0c4de;">.</span> 
[{stdlib,<span style="color: #ffa07a;">"ERTS  CXC 138 10"</span>,<span style="color: #ffa07a;">"2.8"</span>},
 {sasl,<span style="color: #ffa07a;">"SASL  CXC 138 11"</span>,<span style="color: #ffa07a;">"2.7"</span>},
 {kernel,<span style="color: #ffa07a;">"ERTS  CXC 138 10"</span>,<span style="color: #ffa07a;">"4.2"</span>}]
</pre>
</div>

<p>
现在它就是一个功能完备的OTP应用程序了：
</p>
<ul class="org-ul">
<li>在第4行里载入了应用程序,这么做会载入全部代码,但不会启动应用程序</li>
<li>第6行启动了应用程序,第7行则停止了它</li>
<li>在第8行卸载了应用程序,这样应用程序里的所有模块代码都被移除了</li>
</ul>

<pre class="example">
    请注意,启动和停止应用程序时能看到打印输出,因为它调用了面积服务器和质数服务器里相应的回调函数

    用OTP构建复杂的系统时,会把它们打包成应用程序。这样就能统一启动、停止和管理它们
</pre>

<p>
用 init:stop() 关闭系统时,所有运行中的应用程序会按顺序一一关闭 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ erl -boot start_sasl -config elog3 
Erlang/OTP 18 [erts-7.3] [source] [64-bit] [smp:6:6] [async-threads:10] [kernel-poll:false]

Eshell V7.3  (abort with ^G)

1&gt; application:start(sellaprime) <span style="color: #b0c4de;">.</span> 
*** my_alarm_handler init:{xyz,{alarm_handler,[]}}
area_server starting
prime_server starting
ok

2&gt; init:stop() <span style="color: #b0c4de;">.</span> 
ok
prime_server stopping
area_server stopping
</pre>
</div>

<pre class="example">
init:stop() 后面的两行文本来自面积与质数服务器,这就表示各个 gen_server 回调模块里的 terminate/2 函数都得到了调用
</pre>
</div>
</div>

<div id="outline-container-orgbc22648" class="outline-2">
<h2 id="orgbc22648">代码组织方式</h2>
<div class="outline-text-2" id="text-orgbc22648">
<pre class="example">
    还没有提到过文件系统的组织方式,这是有原因的：目的是每次只解决一个问题
</pre>

<p>
规范的应用程序各个部分所属的文件通常都处于定义明确的位置。这不是必要条件,只要相关文件能在运行时找到,文件是如何组织的并不重要 
</p>

<pre class="example">
    把本书的大多数演示文件都放在同一个目录里。这么做简化了示例,也避免了搜索路径和不同程序之间的交互等问题
</pre>

<table border="1" cellspacing="0" cellpadding="6" rules="all" frame="boader">
<caption class="t-above"><span class="table-number">Table 1:</span> sellaprime公司使用的主要文件如下</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">文件</td>
<td class="org-left">内容</td>
</tr>

<tr>
<td class="org-left">area_server.erl</td>
<td class="org-left">面积服务器( gen_server 回调模块)</td>
</tr>

<tr>
<td class="org-left">prime_server.erl</td>
<td class="org-left">质数服务器( gen_server 回调模块)</td>
</tr>

<tr>
<td class="org-left">sellaprime_supervisor.erl</td>
<td class="org-left">监控器回调模块</td>
</tr>

<tr>
<td class="org-left">sellaprime_app.erl</td>
<td class="org-left">应用程序回调模块</td>
</tr>

<tr>
<td class="org-left">my_alam_handler.erl</td>
<td class="org-left">用于 gen_event 的事件回调模块</td>
</tr>

<tr>
<td class="org-left">sellaprime.app</td>
<td class="org-left">应用程序规范</td>
</tr>

<tr>
<td class="org-left">elog4.config</td>
<td class="org-left">错误记录器配置文件</td>
</tr>
</tbody>
</table>


<p>
要了解这些文件和模块是如何使用的,可以来看看启动应用程序时发生的事件序列：
</p>
<ol class="org-ol">
<li>用下列命令启动系统 <span class="underline">application:start(sellaprime) .</span> : 
<ul class="org-ul">
<li>sellaprime.app 文件必须位于Erlang的启动根目录或它的子目录里</li>
<li>应用程序控制器随后在 sellaprime.app 里寻找一个 <span class="underline">{mod, &#x2026;}</span> 声明：它包含应用程序控制器的名称
<ul class="org-ul">
<li>在这个案例里是模块 sellaprime_app</li>
</ul></li>
</ul></li>
<li>回调方法 <span class="underline">sellaprime_app:start/2</span> 被调用</li>
<li>sellaprime_app:start/2 调用 <span class="underline">sellaprime_supervisor:start_link/2</span> ,  <b>启动</b>  sellaprime <span class="underline">监控器</span></li>
<li>监控器回调函数 <span class="underline">sellaprime_supervisor:init/1</span> 被调用,它会 <b>安装</b> 一个 <span class="underline">错误处理器</span> ,然后返回一个监控规范
<ul class="org-ul">
<li>这个监控规范说明了如何启动面积服务器和质数服务器</li>
</ul></li>
<li>sellaprime 监控器 <b>启动</b> 面积服务器和质数服务器,两者都是 gen_server 的回调模块</li>
</ol>

<pre class="example">
    停止这一切很容易,只需要调用 application:stop(sellaprime) 或 init:stop() 
</pre>
</div>
</div>

<div id="outline-container-org521f3d6" class="outline-2">
<h2 id="org521f3d6">深入探索</h2>
<div class="outline-text-2" id="text-org521f3d6">
<p>
在目前这个阶段,已经涉及了构建兼容OTP框架的常规Erlang应用程序所需要的全部重要主题
</p>

<pre class="example">
    在这里省略了很多细节,只解释了相关的原则

    可以在 gen_event 、 error_logger 、 supervisor 和 application 的手册页里找到详细介绍

    更多OTP设计原则的细节可以在Erlang/OTP系统文档里找到
</pre>

<p>
<a href="otp.html">Previous：OTP库</a>
</p>

<p>
<a href="concurrency.html">Home：目录</a>
</p>
</div>
</div>
</div>
<div id="postamble" class="status">

		  <br/>
		  <div class='ds-thread'></div>
		  <script>
		  var duoshuoQuery = {short_name:'klose911'};
		  (function() {
					  var dsThread = document.getElementsByClassName('ds-thread')[0];
					  dsThread.setAttribute('data-thread-key', document.title);
					  dsThread.setAttribute('data-title', document.title);
					  dsThread.setAttribute('data-url', window.location.href);
					  var ds = document.createElement('script');
					  ds.type = 'text/javascript';ds.async = true;
					  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
					  ds.charset = 'UTF-8';
					  (document.getElementsByTagName('head')[0] 
						|| document.getElementsByTagName('body')[0]).appendChild(ds);
					  })();
		  </script>
		  <script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
		  ga('create', 'UA-90850421-1', 'auto');
		  ga('send', 'pageview');
		  </script>
</div>
</body>
</html>
