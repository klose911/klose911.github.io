<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>水平自动扩展</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wu, Shanliang" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="../../css/main.css" />
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="cronjob.html"> UP </a>
 |
 <a accesskey="H" href="controller.html"> HOME </a>
</div><div id="content">
<h1 class="title">水平自动扩展</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org1628a9c">解析</a></li>
<li><a href="#orgedd4128">Metrics</a></li>
<li><a href="#org864b48f">管理</a></li>
<li><a href="#org7651789">管理</a></li>
<li><a href="#org8f1a035">定义</a></li>
<li><a href="#orgd7cce1b">原理</a></li>
<li><a href="#orgc5f7b64">API</a></li>
<li><a href="#org0310454">使用</a>
<ul>
<li><a href="#org63ca082">滚动更新期间的自动扩缩容</a></li>
<li><a href="#org42841b7">多个 metric</a></li>
<li><a href="#org17593a5">自定义 metric</a>
<ul>
<li><a href="#org662677e">配置</a></li>
<li><a href="#org3526af0">定义APIService</a></li>
<li><a href="#org242575b">部署Prometheus</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<pre class="example" id="org0a9807d">
应用的资源使用率通常都有高峰和低谷的时候，如何削峰填谷，提高集群的整体资源利用率，让service中的Pod个数自动调整呢？
</pre>

<p>
这就有赖于 <span class="underline">Horizontal Pod Autoscaling</span> 了，顾名思义，使Pod水平自动缩放
</p>

<pre class="example" id="orga1a6e35">
这个Object（跟Pod、Deployment一样都是API resource）也是最能体现kubernetes之于传统运维价值的地方，不再需要手动扩容了

终于实现自动化了，还可以自定义指标，没准未来还可以通过人工智能自动进化呢！
</pre>

<p>
HPA属于Kubernetes中的 <span class="underline">autoscaling SIG</span> （Special Interest Group），其下有两个feature：
</p>
<ul class="org-ul">
<li><a href="https:/github.com/kubernetes/features/issues/117">Arbitrary/Custom Metrics in the Horizontal Pod Autoscaler#117</a></li>
<li><a href="https://github.com/kubernetes/features/issues/118">Monitoring Pipeline Metrics HPA API #118</a></li>
</ul>

<pre class="example" id="org2bb84a4">
Kubernetes自1.2版本引入HPA机制，到1.6版本之前一直是通过kubelet来获取监控指标来判断是否需要扩缩容

1.6版本之后必须通过API server、Heapseter或者kube-aggregator来获取监控指标
</pre>
<div id="outline-container-org1628a9c" class="outline-2">
<h2 id="org1628a9c">解析</h2>
<div class="outline-text-2" id="text-org1628a9c">
<p>
Horizontal Pod Autoscaling仅适用于 <span class="underline">Deployment</span> 和 <span class="underline">ReplicaSet</span> ，在v1版本中仅支持根据 <span class="underline">Pod的CPU利用率</span> 扩缩容，在v1alpha版本中，支持根据 <span class="underline">内存</span> 和 <span class="underline">用户自定义的metric</span> 扩缩容 
</p>



<div id="org3fa33dc" class="figure">
<p><img src="../../pic/horizontal-pod-autoscaler.png" alt="horizontal-pod-autoscaler.png" width="80%" />
</p>
</div>

<p>
Horizontal Pod Autoscaling由API server和controller共同实现
</p>
</div>
</div>
<div id="outline-container-orgedd4128" class="outline-2">
<h2 id="orgedd4128">Metrics</h2>
<div class="outline-text-2" id="text-orgedd4128">
<p>
在不同版本的API中，HPA autoscale时可以根据以下指标来判断：
</p>
<ul class="org-ul">
<li>autoscaling/v1
<ul class="org-ul">
<li>CPU</li>
</ul></li>
<li>autoscaling/v1alpha1
<ul class="org-ul">
<li>内存</li>
<li>自定义metrics
<ul class="org-ul">
<li>kubernetes1.6起支持自定义metrics，但是必须在 <span class="underline">kube-controller-manager</span> 中配置如下两项：
<ul class="org-ul">
<li><span class="underline">&#x2013;horizontal-pod-autoscaler-use-rest-clients</span> =true</li>
<li><p>
<span class="underline">&#x2013;api-server</span> 指向kube-aggregator
</p>
<pre class="example" id="orgbcd7482">
也可以使用heapster来实现，通过在启动heapster的时候指定--api-server=true
</pre></li>
</ul></li>
</ul></li>
</ul></li>
<li>多种metrics组合：HPA会根据每个metric的值计算出scale的值，并将最大的那个值作为扩容的最终结果　</li>
</ul>
</div>
</div>
<div id="outline-container-org864b48f" class="outline-2">
<h2 id="org864b48f">管理</h2>
<div class="outline-text-2" id="text-org864b48f">
<p>
在不同版本的API中，HPA autoscale时可以根据以下指标来判断：
</p>
<ul class="org-ul">
<li>autoscaling/v1
<ul class="org-ul">
<li>CPU</li>
</ul></li>
<li>autoscaling/v1alpha1
<ul class="org-ul">
<li>内存</li>
<li>自定义metrics
<ul class="org-ul">
<li>kubernetes1.6起支持自定义metrics，但是必须在 <span class="underline">kube-controller-manager</span> 中配置如下两项：
<ul class="org-ul">
<li><span class="underline">&#x2013;horizontal-pod-autoscaler-use-rest-clients</span> =true</li>
<li><p>
<span class="underline">&#x2013;api-server</span> 指向kube-aggregator
</p>
<pre class="example" id="orgee66307">
也可以使用heapster来实现，通过在启动heapster的时候指定--api-server=true
</pre></li>
</ul></li>
</ul></li>
</ul></li>
<li>多种metrics组合：HPA会根据每个metric的值计算出scale的值，并将最大的那个值作为扩容的最终结果　</li>
</ul>
</div>
</div>
<div id="outline-container-org7651789" class="outline-2">
<h2 id="org7651789">管理</h2>
<div class="outline-text-2" id="text-org7651789">
<p>
Horizontal Pod Autoscaling作为API resource也可以像Pod、Deployment一样使用kubeclt命令管理，使用方法跟它们一样，资源名称为 <span class="underline">hpa</span> 
</p>

<div class="org-src-container">
<pre class="src src-sh">$ kubectl create hpa
$ kubectl get hpa
$ kubectl describe hpa
$ kubectl delete hpa
</pre>
</div>

<p>
有一点不同的是，可以直接使用 <span class="underline">kubectl autoscale</span> 通过命令行的方式创建Horizontal Pod Autoscaler：
</p>

<pre class="example" id="orge36b83d">
kubectl autoscale (-f FILENAME | TYPE NAME | TYPE/NAME) [--min=MINPODS] --max=MAXPODS
[--cpu-percent=CPU] [flags] [options]
</pre>

<p>
例如：
</p>

<div class="org-src-container">
<pre class="src src-sh">kubectl autoscale deployment foo --min=2 --max=5 --cpu-percent=80
</pre>
</div>

<pre class="example" id="org512737a">
为Deployment foo创建 一个autoscaler，当Pod的CPU利用率达到80%的时候，RC的replica数在2到5之间
</pre>

<ul class="org-ul">
<li>如果为ReplicaSet创建HPA的话，无法使用rolling update</li>
<li>对于Deployment来说是可以的，因为Deployment在执行rolling update的时候会自动创建新的ReplicationController</li>
</ul>
</div>
</div>
<div id="outline-container-org8f1a035" class="outline-2">
<h2 id="org8f1a035">定义</h2>
<div class="outline-text-2" id="text-org8f1a035">
<p>
利用 Horizontal Pod Autoscaling，kubernetes 能够根据 <span class="underline">监测到</span> 的 <span class="underline">CPU 利用率</span> （或者在 alpha 版本中支持的应用提供的 metric） <b>自动的扩容</b> <span class="underline">replication controller</span> ， <span class="underline">deployment</span> 和 <span class="underline">replica set</span> 。Horizontal Pod Autoscaler 作为 <span class="underline">kubernetes API resource</span> 和 <span class="underline">controller</span> 的实现：
</p>
<ul class="org-ul">
<li>Resource: 确定 controller 的行为</li>
<li>Controller: 会根据监测到用户指定的目标的 CPU 利用率周期性得调整 replication controller 或 deployment 的 replica 数量</li>
</ul>
</div>
</div>
<div id="outline-container-orgd7cce1b" class="outline-2">
<h2 id="orgd7cce1b">原理</h2>
<div class="outline-text-2" id="text-orgd7cce1b">
<ol class="org-ol">
<li>Horizontal Pod Autoscaler 由一个 <b>控制循环</b> 实现，循环周期由 <span class="underline">controller manager</span> 中的 <span class="underline">&#x2013;horizontal-pod-autoscaler-sync-period</span> 标志指定（默认是 30 秒）</li>
<li>在每个周期内， <span class="underline">controller manager</span> 会 <b>查询</b> <span class="underline">HorizontalPodAutoscaler</span> 中定义的 <span class="underline">metric</span> 的资源利用率。Controller manager从下面获取 metric :
<ul class="org-ul">
<li>从 resource metric API（每个 pod 的 resource metric）</li>
<li>或者自定义 metric API（所有的metric）中</li>
</ul></li>
<li><p>
如果 <b>设置</b> 了 <span class="underline">目标利用率</span> ，controller 计算利用的值与每个 Pod 的容器里的 resource request 值的百分比。如果 <b>设置</b> 了 <span class="underline">目标原始值</span> ，将直接使用该原始 metric 值
</p>
<pre class="example" id="org4d4fd64">
请注意，如果某些 Pod 的容器没有设置相关的 resource request ，则不会定义 Pod 的 CPU 利用率，并且 Aucoscaler 也不会对该 metric 采取任何操作

对于每个 Pod 自定义的 metric，controller 功能类似于每个 Pod 的 resource metric，只是它使用原始值而不是利用率值

对于 object metric，获取单个度量（描述有问题的对象），并与目标值进行比较，以产生如上所述的比率
</pre></li>
<li>controller 计算所有目标 Pod 的利用率或原始值（取决于所指定的目标类型）的 <b>平均值</b> ，产生一个用于缩放所需 replica 数量的比率</li>
<li>HorizontalPodAutoscaler 控制器可以以两种不同的方式获取 metric ：直接的 <span class="underline">Heapster</span> 访问和 <span class="underline">REST 客户端</span> 访问
<ul class="org-ul">
<li><p>
当使用直接的 Heapster 访问时，HorizontalPodAutoscaler 直接通过 API 服务器的服务代理子资源查询 Heapster
</p>
<pre class="example" id="orgc00d648">
需要在集群上部署 Heapster 并在 kube-system namespace 中运行
</pre></li>
<li>Autoscaler 访问相应的 replication controller，deployment 或 replica set 来缩放子资源
<ul class="org-ul">
<li>Scale 是一个允许动态设置副本数并检查其当前状态的接口</li>
</ul></li>
</ul></li>
</ol>
</div>
</div>
<div id="outline-container-orgc5f7b64" class="outline-2">
<h2 id="orgc5f7b64">API</h2>
<div class="outline-text-2" id="text-orgc5f7b64">
<p>
<span class="underline">Horizontal Pod Autoscaler</span> 是 kubernetes 的 <span class="underline">autoscaling API</span> 组中的 <b>API 资源</b> 
</p>
</div>
</div>
<div id="outline-container-org0310454" class="outline-2">
<h2 id="org0310454">使用</h2>
<div class="outline-text-2" id="text-org0310454">
<p>
Horizontal Pod Autoscaler 和其他的所有 API 资源一样，通过 kubectl 以标准的方式支持。
</p>
<ul class="org-ul">
<li>使用kubectl create命令创建一个新的 autoscaler</li>
<li>使用kubectl get hpa列出所有的 autoscaler</li>
<li>使用kubectl describe hpa获取其详细信息</li>
<li>使用kubectl delete hpa删除 autoscaler。</li>
</ul>

<p>
另外，可以使用kubectl autoscale命令，很轻易的就可以创建一个 Horizontal Pod Autoscaler
</p>
</div>

<div id="outline-container-org63ca082" class="outline-3">
<h3 id="org63ca082">滚动更新期间的自动扩缩容</h3>
<div class="outline-text-3" id="text-org63ca082">
<pre class="example" id="orga0ef80f">
目前在Kubernetes中，可以通过直接管理 replication controller 或使用 deployment 对象来执行 滚动更新

deployment 对象会自动管理基础 replication controller
</pre>
<p>
Horizontal Pod Autoscaler 仅支持后一种方法：Horizontal Pod Autoscaler 被绑定到 deployment 对象，它设置 deployment 对象的大小，deployment 负责设置底层 replication controller 的大小
</p>

<pre class="example" id="org6102ddd">
Horizontal Pod Autoscaler 不能使用直接操作 replication controller 进行滚动更新，即不能将 Horizontal Pod Autoscaler 绑定到 replication controller，并进行滚动更新（例如使用kubectl rolling-update）

这不行的原因是，当滚动更新创建一个新的 replication controller 时，Horizontal Pod Autoscaler 将不会绑定到新的 replication controller 上
</pre>
</div>
</div>

<div id="outline-container-org42841b7" class="outline-3">
<h3 id="org42841b7">多个 metric</h3>
<div class="outline-text-3" id="text-org42841b7">
<p>
Kubernetes 1.6 中增加了支持基于多个 metric 的扩缩容
</p>

<pre class="example" id="orga74a615">
可以使用autoscaling/v2alpha1 API 版本来为 Horizontal Pod Autoscaler 指定多个 metric

然后 Horizontal Pod Autoscaler controller 将权衡每一个 metric，并根据该 metric 提议一个新的 scale，在所有提议里最大的那个 scale 将作为最终的 scale
</pre>
</div>
</div>

<div id="outline-container-org17593a5" class="outline-3">
<h3 id="org17593a5">自定义 metric</h3>
<div class="outline-text-3" id="text-org17593a5">
<pre class="example" id="orgfc24b40">
kubernetes1.8版本以后的kubernetes中，使用 聚合的API server 来实现自定义指标的HPA
</pre>
</div>

<div id="outline-container-org662677e" class="outline-4">
<h4 id="org662677e">配置</h4>
<div class="outline-text-4" id="text-org662677e">
<ul class="org-ul">
<li><p>
将 <span class="underline">kube-controller-manager</span> 的启动参数中 <span class="underline">&#x2013;horizontal-pod-autoscaler-use-rest-clients</span> 设置为 <span class="underline">true</span> ，并指定 <span class="underline">&#x2013;master</span> 为 <b>API server地址</b> 
</p>
<pre class="example" id="org93471d5">
如--master=http://172.20.0.113:8080
</pre></li>
<li><p>
修改 <span class="underline">kube-apiserver</span> 的配置文件 <span class="underline">apiserver</span> ，增加一条配置用来配置aggregator的CA证书 
</p>
<pre class="example" id="org5912d1d">
--requestheader-client-ca-file=/etc/kubernetes/ssl/ca.pem --requestheader-allowed-names=aggregator --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --proxy-client-cert-file=/etc/kubernetes/ssl/kubernetes.pem --proxy-client-key-file=/etc/kubernetes/ssl/kubernetes-key.pem
</pre></li>
</ul>
</div>
</div>

<div id="outline-container-org3526af0" class="outline-4">
<h4 id="org3526af0">定义APIService</h4>
<div class="outline-text-4" id="text-org3526af0">
<p>
已经内置了apiregistration.k8s.io/v1beta1 API，可以直接定义APIService，如：
</p>

<pre class="example" id="org9d40d50">
apiVersion: apiregistration.k8s.io/v1
kind: APIService
metadata:
  name: v1.custom-metrics.metrics.k8s.io
spec:
  insecureSkipTLSVerify: true
  group: custom-metrics.metrics.k8s.io
  groupPriorityMinimum: 1000
  versionPriority: 5
  service:
    name: api
    namespace: custom-metrics
  version: v1alpha1
</pre>
</div>
</div>

<div id="outline-container-org242575b" class="outline-4">
<h4 id="org242575b">部署Prometheus</h4>
<div class="outline-text-4" id="text-org242575b">
<p>
最后使用prometheus-operator.yaml文件部署Prometheus operator
</p>

<p>
这会产生一个自定义的API：<a href="http://xxx.xxx.xxx.xxx:8080/apis/custom-metrics.metrics.k8s.io/v1alpha1">http://xxx.xxx.xxx.xxx:8080/apis/custom-metrics.metrics.k8s.io/v1alpha1</a> 它可以通过浏览器访问，也可以使用下面的命令可以检查该API：
</p>

<div class="org-src-container">
<pre class="src src-sh">$ kubectl get --raw=apis/custom-metrics.metrics.k8s.io/v1alpha1
{<span style="color: #deb887;">"kind"</span>:<span style="color: #deb887;">"APIResourceList"</span>,<span style="color: #deb887;">"apiVersion"</span>:<span style="color: #deb887;">"v1"</span>,<span style="color: #deb887;">"groupVersion"</span>:<span style="color: #deb887;">"custom-metrics.metrics.k8s.io/v1alpha1"</span>,<span style="color: #deb887;">"resources"</span>:[{<span style="color: #deb887;">"name"</span>:<span style="color: #deb887;">"jobs.batch/http_requests"</span>,<span style="color: #deb887;">"singularName"</span>:<span style="color: #deb887;">""</span>,<span style="color: #deb887;">"namespaced"</span>:true,<span style="color: #deb887;">"kind"</span>:<span style="color: #deb887;">"MetricValueList"</span>,<span style="color: #deb887;">"verbs"</span>:[<span style="color: #deb887;">"get"</span>]},{<span style="color: #deb887;">"name"</span>:<span style="color: #deb887;">"namespaces/http_requests"</span>,<span style="color: #deb887;">"singularName"</span>:<span style="color: #deb887;">""</span>,<span style="color: #deb887;">"namespaced"</span>:false,<span style="color: #deb887;">"kind"</span>:<span style="color: #deb887;">"MetricValueList"</span>,<span style="color: #deb887;">"verbs"</span>:[<span style="color: #deb887;">"get"</span>]},{<span style="color: #deb887;">"name"</span>:<span style="color: #deb887;">"jobs.batch/up"</span>,<span style="color: #deb887;">"singularName"</span>:<span style="color: #deb887;">""</span>,<span style="color: #deb887;">"namespaced"</span>:true,<span style="color: #deb887;">"kind"</span>:<span style="color: #deb887;">"MetricValueList"</span>,<span style="color: #deb887;">"verbs"</span>:[<span style="color: #deb887;">"get"</span>]},{<span style="color: #deb887;">"name"</span>:<span style="color: #deb887;">"pods/up"</span>,<span style="color: #deb887;">"singularName"</span>:<span style="color: #deb887;">""</span>,<span style="color: #deb887;">"namespaced"</span>:true,<span style="color: #deb887;">"kind"</span>:<span style="color: #deb887;">"MetricValueList"</span>,<span style="color: #deb887;">"verbs"</span>:[<span style="color: #deb887;">"get"</span>]},{<span style="color: #deb887;">"name"</span>:<span style="color: #deb887;">"services/scrape_samples_scraped"</span>,<span style="color: #deb887;">"singularName"</span>:<span style="color: #deb887;">""</span>,<span style="color: #deb887;">"namespaced"</span>:true,<span style="color: #deb887;">"kind"</span>:<span style="color: #deb887;">"MetricValueList"</span>,<span style="color: #deb887;">"verbs"</span>:[<span style="color: #deb887;">"get"</span>]},{<span style="color: #deb887;">"name"</span>:<span style="color: #deb887;">"namespaces/scrape_samples_scraped"</span>,<span style="color: #deb887;">"singularName"</span>:<span style="color: #deb887;">""</span>,<span style="color: #deb887;">"namespaced"</span>:false,<span style="color: #deb887;">"kind"</span>:<span style="color: #deb887;">"MetricValueList"</span>,<span style="color: #deb887;">"verbs"</span>:[<span style="color: #deb887;">"get"</span>]},{<span style="color: #deb887;">"name"</span>:<span style="color: #deb887;">"pods/scrape_duration_seconds"</span>,<span style="color: #deb887;">"singularName"</span>:<span style="color: #deb887;">""</span>,<span style="color: #deb887;">"namespaced"</span>:true,<span style="color: #deb887;">"kind"</span>:<span style="color: #deb887;">"MetricValueList"</span>,<span style="color: #deb887;">"verbs"</span>:[<span style="color: #deb887;">"get"</span>]},{<span style="color: #deb887;">"name"</span>:<span style="color: #deb887;">"services/scrape_duration_seconds"</span>,<span style="color: #deb887;">"singularName"</span>:<span style="color: #deb887;">""</span>,<span style="color: #deb887;">"namespaced"</span>:true,<span style="color: #deb887;">"kind"</span>:<span style="color: #deb887;">"MetricValueList"</span>,<span style="color: #deb887;">"verbs"</span>:[<span style="color: #deb887;">"get"</span>]},{<span style="color: #deb887;">"name"</span>:<span style="color: #deb887;">"pods/http_requests"</span>,<span style="color: #deb887;">"singularName"</span>:<span style="color: #deb887;">""</span>,<span style="color: #deb887;">"namespaced"</span>:true,<span style="color: #deb887;">"kind"</span>:<span style="color: #deb887;">"MetricValueList"</span>,<span style="color: #deb887;">"verbs"</span>:[<span style="color: #deb887;">"get"</span>]},{<span style="color: #deb887;">"name"</span>:<span style="color: #deb887;">"pods/scrape_samples_post_metric_relabeling"</span>,<span style="color: #deb887;">"singularName"</span>:<span style="color: #deb887;">""</span>,<span style="color: #deb887;">"namespaced"</span>:true,<span style="color: #deb887;">"kind"</span>:<span style="color: #deb887;">"MetricValueList"</span>,<span style="color: #deb887;">"verbs"</span>:[<span style="color: #deb887;">"get"</span>]},{<span style="color: #deb887;">"name"</span>:<span style="color: #deb887;">"jobs.batch/scrape_samples_scraped"</span>,<span style="color: #deb887;">"singularName"</span>:<span style="color: #deb887;">""</span>,<span style="color: #deb887;">"namespaced"</span>:true,<span style="color: #deb887;">"kind"</span>:<span style="color: #deb887;">"MetricValueList"</span>,<span style="color: #deb887;">"verbs"</span>:[<span style="color: #deb887;">"get"</span>]},{<span style="color: #deb887;">"name"</span>:<span style="color: #deb887;">"jobs.batch/scrape_duration_seconds"</span>,<span style="color: #deb887;">"singularName"</span>:<span style="color: #deb887;">""</span>,<span style="color: #deb887;">"namespaced"</span>:true,<span style="color: #deb887;">"kind"</span>:<span style="color: #deb887;">"MetricValueList"</span>,<span style="color: #deb887;">"verbs"</span>:[<span style="color: #deb887;">"get"</span>]},{<span style="color: #deb887;">"name"</span>:<span style="color: #deb887;">"namespaces/scrape_duration_seconds"</span>,<span style="color: #deb887;">"singularName"</span>:<span style="color: #deb887;">""</span>,<span style="color: #deb887;">"namespaced"</span>:false,<span style="color: #deb887;">"kind"</span>:<span style="color: #deb887;">"MetricValueList"</span>,<span style="color: #deb887;">"verbs"</span>:[<span style="color: #deb887;">"get"</span>]},{<span style="color: #deb887;">"name"</span>:<span style="color: #deb887;">"namespaces/scrape_samples_post_metric_relabeling"</span>,<span style="color: #deb887;">"singularName"</span>:<span style="color: #deb887;">""</span>,<span style="color: #deb887;">"namespaced"</span>:false,<span style="color: #deb887;">"kind"</span>:<span style="color: #deb887;">"MetricValueList"</span>,<span style="color: #deb887;">"verbs"</span>:[<span style="color: #deb887;">"get"</span>]},{<span style="color: #deb887;">"name"</span>:<span style="color: #deb887;">"services/scrape_samples_post_metric_relabeling"</span>,<span style="color: #deb887;">"singularName"</span>:<span style="color: #deb887;">""</span>,<span style="color: #deb887;">"namespaced"</span>:true,<span style="color: #deb887;">"kind"</span>:<span style="color: #deb887;">"MetricValueList"</span>,<span style="color: #deb887;">"verbs"</span>:[<span style="color: #deb887;">"get"</span>]},{<span style="color: #deb887;">"name"</span>:<span style="color: #deb887;">"services/up"</span>,<span style="color: #deb887;">"singularName"</span>:<span style="color: #deb887;">""</span>,<span style="color: #deb887;">"namespaced"</span>:true,<span style="color: #deb887;">"kind"</span>:<span style="color: #deb887;">"MetricValueList"</span>,<span style="color: #deb887;">"verbs"</span>:[<span style="color: #deb887;">"get"</span>]},{<span style="color: #deb887;">"name"</span>:<span style="color: #deb887;">"pods/scrape_samples_scraped"</span>,<span style="color: #deb887;">"singularName"</span>:<span style="color: #deb887;">""</span>,<span style="color: #deb887;">"namespaced"</span>:true,<span style="color: #deb887;">"kind"</span>:<span style="color: #deb887;">"MetricValueList"</span>,<span style="color: #deb887;">"verbs"</span>:[<span style="color: #deb887;">"get"</span>]},{<span style="color: #deb887;">"name"</span>:<span style="color: #deb887;">"services/http_requests"</span>,<span style="color: #deb887;">"singularName"</span>:<span style="color: #deb887;">""</span>,<span style="color: #deb887;">"namespaced"</span>:true,<span style="color: #deb887;">"kind"</span>:<span style="color: #deb887;">"MetricValueList"</span>,<span style="color: #deb887;">"verbs"</span>:[<span style="color: #deb887;">"get"</span>]},{<span style="color: #deb887;">"name"</span>:<span style="color: #deb887;">"jobs.batch/scrape_samples_post_metric_relabeling"</span>,<span style="color: #deb887;">"singularName"</span>:<span style="color: #deb887;">""</span>,<span style="color: #deb887;">"namespaced"</span>:true,<span style="color: #deb887;">"kind"</span>:<span style="color: #deb887;">"MetricValueList"</span>,<span style="color: #deb887;">"verbs"</span>:[<span style="color: #deb887;">"get"</span>]},{<span style="color: #deb887;">"name"</span>:<span style="color: #deb887;">"namespaces/up"</span>,<span style="color: #deb887;">"singularName"</span>:<span style="color: #deb887;">""</span>,<span style="color: #deb887;">"namespaced"</span>:false,<span style="color: #deb887;">"kind"</span>:<span style="color: #deb887;">"MetricValueList"</span>,<span style="color: #deb887;">"verbs"</span>:[<span style="color: #deb887;">"get"</span>]}]}
</pre>
</div>

<p>
<a href="admission_controller.html">Next：准入控制器</a>
</p>

<p>
<a href="cronjob.html">Previous: CronJob</a>
</p>

<p>
<a href="controller.html">Home：Controller</a>
</p>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

		  <br/>
		  <div class='ds-thread'></div>
		  <script>
		  var duoshuoQuery = {short_name:'klose911'};
		  (function() {
					  var dsThread = document.getElementsByClassName('ds-thread')[0];
					  dsThread.setAttribute('data-thread-key', document.title);
					  dsThread.setAttribute('data-title', document.title);
					  dsThread.setAttribute('data-url', window.location.href);
					  var ds = document.createElement('script');
					  ds.type = 'text/javascript';ds.async = true;
					  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
					  ds.charset = 'UTF-8';
					  (document.getElementsByTagName('head')[0] 
						|| document.getElementsByTagName('body')[0]).appendChild(ds);
					  })();
		  </script>
		  <script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
		  ga('create', 'UA-90850421-1', 'auto');
		  ga('send', 'pageview');
		  </script>
</div>
</body>
</html>
