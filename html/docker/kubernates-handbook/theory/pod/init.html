<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Init 容器</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wu, Shanliang" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="../../css/main.css" />
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="mechanism.html"> UP </a>
 |
 <a accesskey="H" href="pod.html"> HOME </a>
</div><div id="content">
<h1 class="title">Init 容器</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgadda4f5">概念</a>
<ul>
<li><a href="#org2d8a8cb">与普通容器的不同之处</a></li>
</ul>
</li>
<li><a href="#org303b5c9">目的</a>
<ul>
<li><a href="#org3bc92a5">示例</a></li>
<li><a href="#orgcd11ba9">使用</a></li>
</ul>
</li>
<li><a href="#orgf2fac55">解析</a>
<ul>
<li><a href="#orgd7dcda2">资源</a></li>
<li><a href="#org38818c1">Pod 重启</a></li>
</ul>
</li>
</ul>
</div>
</div>
<pre class="example" id="org46803ea">
该特性自 Kubernetes 1.6 版本推出 beta 版本

Init 容器可以在 PodSpec 中同应用程序的 containers 数组一起来指定

此前 beta 注解的值仍将保留，并覆盖 PodSpec 字段值
</pre>
<p>
接下来讲解  <span class="underline">Init 容器</span> 的基本概念，这是一种 <b>专用的</b> 容器 ，在应用程序容器启动之前运行，用来包含一些应用镜像中不存在的实用工具或安装脚本
</p>
<div id="outline-container-orgadda4f5" class="outline-2">
<h2 id="orgadda4f5">概念</h2>
<div class="outline-text-2" id="text-orgadda4f5">
<p>
Pod 能够具有多个容器，应用运行在容器里面，但是它也可能有一个或多个先于应用容器启动的 Init 容器。Init 容器与普通的容器非常像，除了如下两点：
</p>
<ul class="org-ul">
<li>Init 容器总是 <b>运行到成功完成</b> 为止</li>
<li>每个 Init 容器都必须在 <b>下一个 Init 容器启动之前成功完成</b></li>
</ul>

<p>
如果 Pod 的 <span class="underline">Init 容器失败</span> ，Kubernetes 会 <b>不断地重启</b> 该 Pod，直到 Init 容器成功为止
</p>

<pre class="example" id="orgbd6dcac">
然而，如果 Pod 对应的 restartPolicy 为 Never，它不会重新启动 
</pre>

<p>
指定容器为 Init 容器：
</p>
<ol class="org-ol">
<li>在 PodSpec 中添加 <span class="underline">initContainers</span> 字段
<ul class="org-ul">
<li>以 v1.Container 类型对象的 JSON 数组的形式</li>
<li>还有 app 的 containers 数组</li>
</ul></li>
<li>Init 容器的状态在 <span class="underline">status.initContainerStatuses</span> 字段中以容器状态数组的格式返回（类似 status.containerStatuses 字段）</li>
</ol>
</div>

<div id="outline-container-org2d8a8cb" class="outline-3">
<h3 id="org2d8a8cb">与普通容器的不同之处</h3>
<div class="outline-text-3" id="text-org2d8a8cb">
<p>
Init 容器支持应用容器的全部字段和特性，包括资源限制、数据卷和安全设置
</p>

<pre class="example" id="orga2bab21">
Init 容器对资源请求和限制的处理稍有不同，在下面 资源 处有说明

而且 Init 容器不支持 Readiness Probe，因为它们必须在 Pod 就绪之前运行完成
</pre>

<p>
如果为一个 Pod 指定了多个 Init 容器，那些容器会按顺序一次运行一个
</p>

<pre class="example" id="org6b0efa7">
只有当前面的 Init 容器必须运行成功后，才可以运行下一个 Init 容器

当所有的 Init 容器运行完成后，Kubernetes 才初始化 Pod 和运行应用容器
</pre>
</div>
</div>
</div>

<div id="outline-container-org303b5c9" class="outline-2">
<h2 id="org303b5c9">目的</h2>
<div class="outline-text-2" id="text-org303b5c9">
<p>
因为 Init 容器具有与应用程序容器分离的单独镜像，所以它们的启动相关代码具有如下优势：
</p>
<ul class="org-ul">
<li>可以包含并运行实用工具，但是出于安全考虑，是不建议在应用程序容器镜像中包含这些实用工具的</li>
<li><p>
可以包含使用工具和定制化代码来安装，但是不能出现在应用程序镜像中
</p>
<pre class="example" id="orgffa3c96">
例如，创建镜像没必要 FROM 另一个镜像，只需要在安装过程中使用类似 sed、 awk、 python 或 dig 这样的工具
</pre></li>
<li>应用程序镜像可以分离出创建和部署的角色，而没有必要联合它们构建一个单独的镜像</li>
<li><p>
Init 容器使用 Linux Namespace，所以相对应用程序容器来说具有不同的文件系统视图
</p>
<pre class="example" id="org8b916d9">
它们能够具有访问 Secret 的权限，而应用程序容器则不能
</pre></li>
<li>它们必须在应用程序容器启动之前运行完成，而应用程序容器是并行运行的，所以 Init 容器能够提供了一种简单的 <span class="underline">阻塞或延迟</span> 应用容器的启动的方法，直到满足了一组先决条件</li>
</ul>
</div>

<div id="outline-container-org3bc92a5" class="outline-3">
<h3 id="org3bc92a5">示例</h3>
<div class="outline-text-3" id="text-org3bc92a5">
<p>
下面列举了 Init 容器的一些用途：
</p>
<ul class="org-ul">
<li><p>
等待一个 Service 创建完成，通过类似如下 shell 命令
</p>
<div class="org-src-container">
<pre class="src src-sh">$ for i<span style="color: #00bfff; font-weight: bold;"> in</span> {1..100}; <span style="color: #00bfff; font-weight: bold;">do</span> sleep 1; <span style="color: #00bfff; font-weight: bold;">if</span> dig myservice; <span style="color: #00bfff; font-weight: bold;">then exit</span> 0; <span style="color: #00bfff; font-weight: bold;">fi</span>; <span style="color: #00bfff; font-weight: bold;">exit</span> 1
</pre>
</div></li>
<li><p>
将 Pod 注册到远程服务器，通过在命令中调用 API，类似如下：
</p>
<div class="org-src-container">
<pre class="src src-sh">$ curl -X POST http://$<span style="color: #4eee94;">MANAGEMENT_SERVICE_HOST</span>:$<span style="color: #4eee94;">MANAGEMENT_SERVICE_PORT</span>/register -d <span style="color: #deb887;">'instance=$(&lt;POD_NAME&gt;)&amp;ip=$(&lt;POD_IP&gt;)'</span>
</pre>
</div></li>
<li>在启动应用容器之前等一段时间，使用类似 sleep 60 的命令</li>
<li>克隆 Git 仓库到数据卷</li>
<li><p>
将配置值放到配置文件中，运行模板工具为主应用容器动态地生成配置文件
</p>
<pre class="example" id="org31fabb7">
例如，在配置文件中存放 POD_IP 值，并使用 Jinja 生成主应用配置文件
</pre></li>
</ul>
</div>
</div>

<div id="outline-container-orgcd11ba9" class="outline-3">
<h3 id="orgcd11ba9">使用</h3>
<div class="outline-text-3" id="text-orgcd11ba9">
<p>
下面 yaml 文件，展示了一个具有 2 个 Init 容器的简单 Pod，第一个等待 myservice 启动，第二个等待 mydb 启动。一旦这两个 Service 都启动完成，Pod 将开始启动：
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #4eee94;">apiVersion</span>: v1
<span style="color: #4eee94;">kind</span>: Pod
<span style="color: #4eee94;">metadata</span>:
  <span style="color: #4eee94;">name</span>: myapp-pod
  <span style="color: #4eee94;">labels</span>:
    <span style="color: #4eee94;">app</span>: myapp
<span style="color: #4eee94;">spec</span>:
  <span style="color: #4eee94;">containers</span>:
  - <span style="color: #4eee94;">name</span>: myapp-container
    <span style="color: #4eee94;">image</span>: busybox
    <span style="color: #4eee94;">command</span>: [<span style="color: #deb887;">'sh'</span>, <span style="color: #deb887;">'-c'</span>, <span style="color: #deb887;">'echo The app is running! &amp;&amp; sleep 3600'</span>]
  <span style="color: #4eee94;">initContainers</span>:
  - <span style="color: #4eee94;">name</span>: init-myservice
    <span style="color: #4eee94;">image</span>: busybox
    <span style="color: #4eee94;">command</span>: [<span style="color: #deb887;">'sh'</span>, <span style="color: #deb887;">'-c'</span>, <span style="color: #deb887;">'until nslookup myservice; do echo waiting for myservice; sleep 2; done;'</span>]
  - <span style="color: #4eee94;">name</span>: init-mydb
    <span style="color: #4eee94;">image</span>: busybox
    <span style="color: #4eee94;">command</span>: [<span style="color: #deb887;">'sh'</span>, <span style="color: #deb887;">'-c'</span>, <span style="color: #deb887;">'until nslookup mydb; do echo waiting for mydb; sleep 2; done;'</span>]
</pre>
</div>

<p>
下面的 YAML 文件展示了 mydb 和 myservice 两个 Service：
</p>

<div class="org-src-container">
<pre class="src src-yaml">
<span style="color: #4eee94;">kind</span>: Service
<span style="color: #4eee94;">apiVersion</span>: v1
<span style="color: #4eee94;">metadata</span>:
  <span style="color: #4eee94;">name</span>: myservice
<span style="color: #4eee94;">spec</span>:
  <span style="color: #4eee94;">ports</span>:
    - <span style="color: #4eee94;">protocol</span>: TCP
      <span style="color: #4eee94;">port</span>: 80
      <span style="color: #4eee94;">targetPort</span>: 9376
<span style="color: #5f9ea0; font-style: italic;">---</span>
<span style="color: #4eee94;">kind</span>: Service
<span style="color: #4eee94;">apiVersion</span>: v1
<span style="color: #4eee94;">metadata</span>:
  <span style="color: #4eee94;">name</span>: mydb
<span style="color: #4eee94;">spec</span>:
  <span style="color: #4eee94;">ports</span>:
    - <span style="color: #4eee94;">protocol</span>: TCP
      <span style="color: #4eee94;">port</span>: 80
      <span style="color: #4eee94;">targetPort</span>: 9377
</pre>
</div>

<p>
这个 Pod 可以使用下面的命令进行启动和调试：
</p>

<div class="org-src-container">
<pre class="src src-sh">
$ kubectl create -f myapp.yaml
pod <span style="color: #deb887;">"myapp-pod"</span> created
$ kubectl get -f myapp.yaml
NAME        READY     STATUS     RESTARTS   AGE
myapp-pod   0/1       Init:0/2   0          6m
$ kubectl describe -f myapp.yaml 
Name:          myapp-pod
Namespace:     default
[...]
Labels:        <span style="color: #4eee94;">app</span>=myapp
Status:        Pending
[...]
Init Containers:
  init-myservice:
[...]
    State:         Running
[...]
  init-mydb:
[...]
    State:         Waiting
      Reason:      PodInitializing
    Ready:         False
[...]
Containers:
  myapp-container:
[...]
    State:         Waiting
      Reason:      PodInitializing
    Ready:         False
[...]
Events:
  FirstSeen    LastSeen    Count    From                      SubObjectPath                           Type          Reason        Message
  ---------    --------    -----    ----                      -------------                           --------      ------        -------
  16s          16s         1        {default-scheduler }                                              Normal        Scheduled     Successfully assigned myapp-pod to 172.17.4.201
  16s          16s         1        {kubelet 172.17.4.201}    spec.initContainers{init-myservice}     Normal        Pulling       pulling image <span style="color: #deb887;">"busybox"</span>
  13s          13s         1        {kubelet 172.17.4.201}    spec.initContainers{init-myservice}     Normal        Pulled        Successfully pulled image <span style="color: #deb887;">"busybox"</span>
  13s          13s         1        {kubelet 172.17.4.201}    spec.initContainers{init-myservice}     Normal        Created       Created container with docker id 5ced34a04634; Security:[<span style="color: #4eee94;">seccomp</span>=unconfined]
  13s          13s         1        {kubelet 172.17.4.201}    spec.initContainers{init-myservice}     Normal        Started       Started container with docker id 5ced34a04634
$ kubectl logs myapp-pod -c init-myservice <span style="color: #5f9ea0; font-style: italic;"># </span><span style="color: #5f9ea0; font-style: italic;">Inspect the first init container</span>
$ kubectl logs myapp-pod -c init-mydb      <span style="color: #5f9ea0; font-style: italic;"># </span><span style="color: #5f9ea0; font-style: italic;">Inspect the second init container</span>
</pre>
</div>

<p>
一旦启动了 mydb 和 myservice 这两个 Service，能够看到 Init 容器完成，并且 myapp-pod 被创建：
</p>

<div class="org-src-container">
<pre class="src src-sh">$ kubectl create -f services.yaml
service <span style="color: #deb887;">"myservice"</span> created
service <span style="color: #deb887;">"mydb"</span> created
$ kubectl get -f myapp.yaml
NAME        READY     STATUS    RESTARTS   AGE
myapp-pod   1/1       Running   0          9m
</pre>
</div>

<pre class="example" id="orgbb3263b">
这个例子非常简单，但是应该能够为创建自己的 Init 容器提供一些启发
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf2fac55" class="outline-2">
<h2 id="orgf2fac55">解析</h2>
<div class="outline-text-2" id="text-orgf2fac55">
<p>
在 Pod 启动过程中，Init 容器会按顺序在网络和数据卷初始化之后启动。每个容器必须在下一个容器启动之前成功退出。如果由于运行时或失败退出，将导致容器启动失败，它会根据 Pod 的 restartPolicy 指定的策略进行重试。然而，如果 Pod 的 restartPolicy 设置为 Always，Init 容器失败时会使用 RestartPolicy 策略：
</p>
<ol class="org-ol">
<li>在所有的 Init 容器没有成功之前，Pod 将 <b>不会变成 Ready 状态</b> 
<ul class="org-ul">
<li>Init 容器的端口将不会在 Service 中进行聚集</li>
<li>正在初始化中的 Pod 处于 <span class="underline">Pending</span> 状态</li>
<li>应该会将 <span class="underline">Initializing 状态</span> 设置为 <span class="underline">true</span></li>
</ul></li>
<li>如果 Pod 重启，所有 Init 容器必须重新执行</li>
<li><p>
对 Init 容器 spec 的修改被限制在容器 image 字段，修改其他字段都不会生效
</p>
<pre class="example" id="org29c12c2">
更改 Init 容器的 image 字段，等价于重启该 Pod
</pre></li>
<li><p>
因为 Init 容器可能会被重启、重试或者重新执行，所以 Init 容器的代码应该是 <b>幂等的</b> 
</p>
<pre class="example" id="org6fff4bf">
特别地当写到 EmptyDirs 文件中的代码，应该对输出文件可能已经存在做好准备
</pre></li>
<li><p>
Init 容器具有应用容器的所有字段。除了 <span class="underline">readinessProbe</span>
</p>
<pre class="example" id="org0250946">
因为 Init 容器无法定义不同于完成（completion）的就绪（readiness）之外的其他状态，这会在验证过程中强制执行
</pre></li>
<li><p>
在 Pod 上使用 <span class="underline">activeDeadlineSeconds</span> ，在容器上使用 <span class="underline">livenessProbe</span> 
</p>
<pre class="example" id="org3ce512d">
这样能够避免 Init 容器一直失败，这就为 Init 容器活跃设置了一个期限
</pre></li>
<li><p>
在 Pod 中的每个 app 和 Init 容器的名称必须唯一
</p>
<pre class="example" id="org6d45068">
与任何其它容器共享同一个名称，会在验证时抛出错误
</pre></li>
</ol>
</div>

<div id="outline-container-orgd7dcda2" class="outline-3">
<h3 id="orgd7dcda2">资源</h3>
<div class="outline-text-3" id="text-orgd7dcda2">
<p>
为 Init 容器指定顺序和执行逻辑，下面对资源使用的规则将被应用：
</p>
<ul class="org-ul">
<li>在所有 Init 容器上定义的，任何特殊资源请求或限制的最大值，是 <span class="underline">有效初始请求/限制</span></li>
<li><p>
Pod 对资源的有效请求/限制要高于：
</p>
<ul class="org-ul">
<li>所有应用容器对某个资源的请求/限制之和</li>
<li>对某个资源的有效初始请求/限制</li>
</ul>
<pre class="example" id="org3707a85">
基于有效请求/限制完成调度，这意味着 Init 容器能够为初始化预留资源，这些资源在 Pod 生命周期过程中并没有被使用
</pre></li>
<li><p>
Pod 的 有效 QoS 层，是 Init 容器和应用容器相同的 QoS 层
</p>
<pre class="example" id="orge494466">
Pod 级别的 cgroups 是基于有效 Pod 请求和限制，和调度器相同
</pre></li>
</ul>
</div>
</div>

<div id="outline-container-org38818c1" class="outline-3">
<h3 id="org38818c1">Pod 重启</h3>
<div class="outline-text-3" id="text-org38818c1">
<p>
Pod 重启，会导致 Init 容器重新执行，主要有如下几个原因：
</p>
<ul class="org-ul">
<li><p>
用户更新 PodSpec 导致 Init 容器镜像发生改变
</p>
<pre class="example" id="org311b72e">
应用容器镜像的变更只会重启应用容器
</pre></li>
<li><p>
Pod 基础设施容器被重启
</p>
<pre class="example" id="orgda83282">
这不多见，但某些具有 root 权限可访问 Node 的人可能会这样做
</pre></li>
<li><p>
当 restartPolicy 设置为 Always，Pod 中所有容器会终止，强制重启
</p>
<pre class="example" id="org2f86ef4">
由于垃圾收集导致 Init 容器完整的记录丢失
</pre></li>
</ul>

<p>
<a href="pause.html">Next：Pause 容器</a>
</p>

<p>
<a href="mechanism.html">Previous：解析</a>
</p>

<p>
<a href="pod.html">Home: pod</a>
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

		  <br/>
		  <div class='ds-thread'></div>
		  <script>
		  var duoshuoQuery = {short_name:'klose911'};
		  (function() {
					  var dsThread = document.getElementsByClassName('ds-thread')[0];
					  dsThread.setAttribute('data-thread-key', document.title);
					  dsThread.setAttribute('data-title', document.title);
					  dsThread.setAttribute('data-url', window.location.href);
					  var ds = document.createElement('script');
					  ds.type = 'text/javascript';ds.async = true;
					  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
					  ds.charset = 'UTF-8';
					  (document.getElementsByTagName('head')[0] 
						|| document.getElementsByTagName('body')[0]).appendChild(ds);
					  })();
		  </script>
		  <script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
		  ga('create', 'UA-90850421-1', 'auto');
		  ga('send', 'pageview');
		  </script>
</div>
</body>
</html>
