<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Docker-Compose</title>
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Wu, Shanliang" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="css/main.css" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="mechanism.html"> UP </a>
 |
 <a accesskey="H" href="docker.html"> HOME </a>
</div><div id="content">
<h1 class="title">Docker-Compose</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">简介</a></li>
<li><a href="#sec-2">安装(略)</a></li>
<li><a href="#sec-3">使用</a>
<ul>
<li><a href="#sec-3-1">术语</a></li>
<li><a href="#sec-3-2">场景</a></li>
<li><a href="#sec-3-3">实现</a>
<ul>
<li><a href="#sec-3-3-1">web子目录</a>
<ul>
<li><a href="#sec-3-3-1-1">index.py</a></li>
<li><a href="#sec-3-3-1-2">index.html</a></li>
<li><a href="#sec-3-3-1-3">Dockerfile</a></li>
</ul>
</li>
<li><a href="#sec-3-3-2">haproxy 目录</a>
<ul>
<li><a href="#sec-3-3-2-1">haproxy.cfg</a></li>
<li><a href="#sec-3-3-2-2">docker-compose.yml</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-3-4">运行</a></li>
</ul>
</li>
<li><a href="#sec-4">Compose 命令</a>
<ul>
<li><a href="#sec-4-1">选项</a></li>
<li><a href="#sec-4-2">命令</a>
<ul>
<li><a href="#sec-4-2-1">build</a></li>
<li><a href="#sec-4-2-2">help</a></li>
<li><a href="#sec-4-2-3">kill</a></li>
<li><a href="#sec-4-2-4">logs</a></li>
<li><a href="#sec-4-2-5">port</a></li>
<li><a href="#sec-4-2-6">ps</a></li>
<li><a href="#sec-4-2-7">pull</a></li>
<li><a href="#sec-4-2-8">rm</a></li>
<li><a href="#sec-4-2-9">run</a></li>
<li><a href="#sec-4-2-10">scale</a></li>
<li><a href="#sec-4-2-11">start</a></li>
<li><a href="#sec-4-2-12">stop</a></li>
<li><a href="#sec-4-2-13">up</a></li>
</ul>
</li>
<li><a href="#sec-4-3">环境变量</a></li>
</ul>
</li>
<li><a href="#sec-5">yaml模板</a>
<ul>
<li><a href="#sec-5-1">image</a></li>
<li><a href="#sec-5-2">build</a></li>
<li><a href="#sec-5-3">command</a></li>
<li><a href="#sec-5-4">links</a></li>
<li><a href="#sec-5-5">external_links</a></li>
<li><a href="#sec-5-6">ports</a></li>
<li><a href="#sec-5-7">expose</a></li>
<li><a href="#sec-5-8">volumes</a></li>
<li><a href="#sec-5-9">volumes_from</a></li>
<li><a href="#sec-5-10">environment</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">简介</h2>
<div class="outline-text-2" id="text-1">
<p>
Dockerfile 可以让用户管理一个单独的应用容器；而 Compose 则允许用户在一个模板（YAML 格式）中定义一组相关联的应用容器（被称为一个 project，即项目），例如一个 Web 服务容器再加上后端的数据库服务容器等
</p>
<p>
<img src="./pic/compose.png" alt="compose.png" width="90%" />
该项目由 Python 编写，实际上调用了 Docker 提供的 API 来实现。
</p>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">安装(略)</h2>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">使用</h2>
<div class="outline-text-2" id="text-3">
</div><div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1">术语</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li>服务(service)：一个应用容器，实际上可以运行多个相同镜像的实例
</li>
<li>项目(project)：由一组关联的应用容器组成的一个完整业务单元
</li>
</ul>
<p>
一个项目可以由多个服务（容器）关联而成，Compose面向项目进行管理
</p>
</div>
</div>
<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2">场景</h3>
<div class="outline-text-3" id="text-3-2">
<p>
一个经典的 Web 项目：一个Haproxy，挂载三个Web容器
</p>
</div>
</div>
<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3">实现</h3>
<div class="outline-text-3" id="text-3-3">
<p>
创建一个compose-haproxy-web目录，作为项目工作目录，并在其中分别创建两个子目录：haproxy 和 web
</p>
</div>
<div id="outline-container-sec-3-3-1" class="outline-4">
<h4 id="sec-3-3-1">web子目录</h4>
<div class="outline-text-4" id="text-3-3-1">
<p>
用Python程序来提供一个简单的HTTP服务，打印出访问者的IP和实际的本地IP
</p>
</div>
<div id="outline-container-sec-3-3-1-1" class="outline-5">
<h5 id="sec-3-3-1-1">index.py</h5>
<div class="outline-text-5" id="text-3-3-1-1">
<p>
编写一个index.py作为服务器文件
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #ff4500;">#</span><span style="color: #ff4500;">!/usr/bin/python</span>
<span style="color: #ff4500;">#</span><span style="color: #ff4500;">authors: yeasy.github.com</span>
<span style="color: #ff4500;">#</span><span style="color: #ff4500;">date: 2013-07-05</span>

<span style="color: #00ffff;">import</span> sys
<span style="color: #00ffff;">import</span> BaseHTTPServer
<span style="color: #00ffff;">from</span> SimpleHTTPServer <span style="color: #00ffff;">import</span> SimpleHTTPRequestHandler
<span style="color: #00ffff;">import</span> socket
<span style="color: #00ffff;">import</span> fcntl
<span style="color: #00ffff;">import</span> struct
<span style="color: #00ffff;">import</span> pickle
<span style="color: #00ffff;">from</span> datetime <span style="color: #00ffff;">import</span> datetime
<span style="color: #00ffff;">from</span> collections <span style="color: #00ffff;">import</span> OrderedDict

<span style="color: #00ffff;">class</span> <span style="color: #98fb98;">HandlerClass</span>(SimpleHTTPRequestHandler):
    <span style="color: #00ffff;">def</span> <span style="color: #87cefa;">get_ip_address</span>(<span style="color: #00ffff;">self</span>,ifname):
        <span style="color: #eedd82;">s</span> = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        <span style="color: #00ffff;">return</span> socket.inet_ntoa(fcntl.ioctl(
            s.fileno(),
            0x8915,  <span style="color: #ff4500;"># </span><span style="color: #ff4500;">SIOCGIFADDR</span>
            struct.pack(<span style="color: #ffa07a;">'256s'</span>, ifname[:15])
        )[20:24])
    <span style="color: #00ffff;">def</span> <span style="color: #87cefa;">log_message</span>(<span style="color: #00ffff;">self</span>, <span style="color: #b0c4de;">format</span>, *args):
        <span style="color: #00ffff;">if</span> <span style="color: #b0c4de;">len</span>(args) &lt; 3 <span style="color: #00ffff;">or</span> <span style="color: #ffa07a;">"200"</span> <span style="color: #00ffff;">not</span> <span style="color: #00ffff;">in</span> args[1]:
            <span style="color: #00ffff;">return</span>
        <span style="color: #00ffff;">try</span>:
            <span style="color: #eedd82;">request</span> = pickle.load(<span style="color: #b0c4de;">open</span>(<span style="color: #ffa07a;">"pickle_data.txt"</span>,<span style="color: #ffa07a;">"r"</span>))
        <span style="color: #00ffff;">except</span>:
            <span style="color: #eedd82;">request</span>=OrderedDict()
            <span style="color: #eedd82;">time_now</span> = datetime.now()
            <span style="color: #eedd82;">ts</span> = time_now.strftime(<span style="color: #ffa07a;">'%Y-%m-%d %H:%M:%S'</span>)
            <span style="color: #eedd82;">server</span> = <span style="color: #00ffff;">self</span>.get_ip_address(<span style="color: #ffa07a;">'eth0'</span>)
            <span style="color: #eedd82;">host</span>=<span style="color: #00ffff;">self</span>.address_string()
            <span style="color: #eedd82;">addr_pair</span> = (host,server)
        <span style="color: #00ffff;">if</span> addr_pair <span style="color: #00ffff;">not</span> <span style="color: #00ffff;">in</span> request:
            <span style="color: #eedd82;">request</span>[addr_pair]=[1,ts]
        <span style="color: #00ffff;">else</span>:
            <span style="color: #eedd82;">num</span> = request[addr_pair][0]+1
            <span style="color: #00ffff;">del</span> request[addr_pair]
            <span style="color: #eedd82;">request</span>[addr_pair]=[num,ts]
            <span style="color: #b0c4de;">file</span>=<span style="color: #b0c4de;">open</span>(<span style="color: #ffa07a;">"index.html"</span>, <span style="color: #ffa07a;">"w"</span>)
            <span style="color: #b0c4de;">file</span>.write(<span style="color: #ffa07a;">"&lt;!DOCTYPE html&gt; &lt;html&gt; &lt;body&gt;&lt;center&gt;&lt;h1&gt;&lt;font color=\"blue\" face=\"Georgia, Arial\" size=8&gt;&lt;em&gt;HA&lt;/em&gt;&lt;/font&gt; Webpage Visit Results&lt;/h1&gt;&lt;/center&gt;"</span>);
        <span style="color: #00ffff;">for</span> pair <span style="color: #00ffff;">in</span> request:
            <span style="color: #00ffff;">if</span> pair[0] == host:
                <span style="color: #eedd82;">guest</span> = <span style="color: #ffa07a;">"LOCAL: "</span>+pair[0]
            <span style="color: #00ffff;">else</span>:
                <span style="color: #eedd82;">guest</span> = pair[0]
            <span style="color: #00ffff;">if</span> (time_now-datetime.strptime(request[pair][1],<span style="color: #ffa07a;">'%Y-%m-%d %H:%M:%S'</span>)).seconds &lt; 3:
                <span style="color: #b0c4de;">file</span>.write(<span style="color: #ffa07a;">"&lt;p style=\"font-size:150%\" &gt;#"</span>+ <span style="color: #b0c4de;">str</span>(request[pair][1]) +<span style="color: #ffa07a;">": &lt;font color=\"red\"&gt;"</span>+<span style="color: #b0c4de;">str</span>(request[pair][0])+ <span style="color: #ffa07a;">"&lt;/font&gt; requests "</span> + <span style="color: #ffa07a;">"from &amp;lt&lt;font color=\"blue\"&gt;"</span>+guest+<span style="color: #ffa07a;">"&lt;/font&gt;&amp;gt to WebServer &amp;lt&lt;font color=\"blue\"&gt;"</span>+pair[1]+<span style="color: #ffa07a;">"&lt;/font&gt;&amp;gt&lt;/p&gt;"</span>)
            <span style="color: #00ffff;">else</span>:
                <span style="color: #b0c4de;">file</span>.write(<span style="color: #ffa07a;">"&lt;p style=\"font-size:150%\" &gt;#"</span>+ <span style="color: #b0c4de;">str</span>(request[pair][1]) +<span style="color: #ffa07a;">": &lt;font color=\"maroon\"&gt;"</span>+<span style="color: #b0c4de;">str</span>(request[pair][0])+ <span style="color: #ffa07a;">"&lt;/font&gt; requests "</span> + <span style="color: #ffa07a;">"from &amp;lt&lt;font color=\"navy\"&gt;"</span>+guest+<span style="color: #ffa07a;">"&lt;/font&gt;&amp;gt to WebServer &amp;lt&lt;font color=\"navy\"&gt;"</span>+pair[1]+<span style="color: #ffa07a;">"&lt;/font&gt;&amp;gt&lt;/p&gt;"</span>)
                <span style="color: #b0c4de;">file</span>.write(<span style="color: #ffa07a;">"&lt;/body&gt; &lt;/html&gt;"</span>);
                <span style="color: #b0c4de;">file</span>.close()
                pickle.dump(request,<span style="color: #b0c4de;">open</span>(<span style="color: #ffa07a;">"pickle_data.txt"</span>,<span style="color: #ffa07a;">"w"</span>))

<span style="color: #00ffff;">if</span> <span style="color: #b0c4de;">__name__</span> == <span style="color: #ffa07a;">'__main__'</span>:
    <span style="color: #00ffff;">try</span>:
        <span style="color: #eedd82;">ServerClass</span>  = BaseHTTPServer.HTTPServer
        <span style="color: #eedd82;">Protocol</span>     = <span style="color: #ffa07a;">"HTTP/1.0"</span>
        <span style="color: #eedd82;">addr</span> = <span style="color: #b0c4de;">len</span>(sys.argv) &lt; 2 <span style="color: #00ffff;">and</span> <span style="color: #ffa07a;">"0.0.0.0"</span> <span style="color: #00ffff;">or</span> sys.argv[1]
        <span style="color: #eedd82;">port</span> = <span style="color: #b0c4de;">len</span>(sys.argv) &lt; 3 <span style="color: #00ffff;">and</span> 80 <span style="color: #00ffff;">or</span> <span style="color: #b0c4de;">int</span>(sys.argv[2])
        <span style="color: #eedd82;">HandlerClass.protocol_version</span> = Protocol
        <span style="color: #eedd82;">httpd</span> = ServerClass((addr, port), HandlerClass)
        <span style="color: #eedd82;">sa</span> = httpd.socket.getsockname()
        <span style="color: #00ffff;">print</span> <span style="color: #ffa07a;">"Serving HTTP on"</span>, sa[0], <span style="color: #ffa07a;">"port"</span>, sa[1], <span style="color: #ffa07a;">"..."</span>
        httpd.serve_forever()
    <span style="color: #00ffff;">except</span>:
        <span style="color: #7fffd4;">exit</span>()
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-3-1-2" class="outline-5">
<h5 id="sec-3-3-1-2">index.html</h5>
<div class="outline-text-5" id="text-3-3-1-2">
<p>
生成一个临时的index.html文件，其内容会被index.py更新
</p>
<div class="org-src-container">

<pre class="src src-sh">$ touch index.html
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-3-1-3" class="outline-5">
<h5 id="sec-3-3-1-3">Dockerfile</h5>
<div class="outline-text-5" id="text-3-3-1-3">
<p>
生成一个Dockerfile
</p>
<pre class="example">
FROM python:2.7
WORKDIR /code
ADD . /code
EXPOSE 80
CMD python index.py
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-3-2" class="outline-4">
<h4 id="sec-3-3-2">haproxy 目录</h4>
<div class="outline-text-4" id="text-3-3-2">
</div><div id="outline-container-sec-3-3-2-1" class="outline-5">
<h5 id="sec-3-3-2-1">haproxy.cfg</h5>
<div class="outline-text-5" id="text-3-3-2-1">
<pre class="example">
global
  log 127.0.0.1 local0
  log 127.0.0.1 local1 notice

defaults
  log global
  mode http
  option httplog
  option dontlognull
  timeout connect 5000ms
  timeout client 50000ms
  timeout server 50000ms

listen stats :70
    stats enable
    stats uri /

frontend balancer
    bind 0.0.0.0:80
    mode http
    default_backend web_backends

backend web_backends
    mode http
    option forwardfor
    balance roundrobin
    server weba weba:80 check
    server webb webb:80 check
    server webc webc:80 check
    option httpchk GET /
    http-check expect status 200
</pre>
</div>
</div>
<div id="outline-container-sec-3-3-2-2" class="outline-5">
<h5 id="sec-3-3-2-2">docker-compose.yml</h5>
<div class="outline-text-5" id="text-3-3-2-2">
<p>
编写 docker-compose.yml 文件，这个是 Compose 使用的主模板文件。内容十分简单，指定 3 个 web 容器，以及 1 个 haproxy 容器
</p>

<div class="org-src-container">

<pre class="src src-yml">weba:
    build: ./web
    expose:
	- 80

webb:
    build: ./web
    expose:
	- 80

webc:
    build: ./web
    expose:
	- 80

haproxy:
    image: haproxy:latest
    volumes:
	- haproxy:/haproxy-override
	- haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    links:
	- weba
	- webb
	- webc
    ports:
	- "80:80"
	- "70:70"
    expose:
	- "80"
	- "70
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-3-4" class="outline-3">
<h3 id="sec-3-4">运行</h3>
<div class="outline-text-3" id="text-3-4">
<p>
现在 compose-haproxy-web 目录长成下面的样子：
</p>
<pre class="example">
compose-haproxy-web
├── docker-compose.yml
├── haproxy
│   └── haproxy.cfg
└── web
    ├── Dockerfile
    ├── index.html
    └── index.py
</pre>
<p>
在该目录下执行 docker-compose up 命令，会整合输出所有容器的输出
</p>
<div class="org-src-container">

<pre class="src src-sh">$<span style="color: #eedd82;">sudo</span> docker-compose up

Recreating composehaproxyweb_webb_1...
Recreating composehaproxyweb_webc_1...
Recreating composehaproxyweb_weba_1...
Recreating composehaproxyweb_haproxy_1...
Attaching to composehaproxyweb_webb_1, composehaproxyweb_webc_1, composehaproxyweb_weba_1, composehaproxyweb_haproxy_1
</pre>
</div>
<p>
访问本地的 80 端口，会经过 haproxy 自动转发到后端的某个 web 容器上，刷新页面，可以观察到访问的容器地址的变化
</p>

<p>
访问本地 70 端口，可以查看到 haproxy 的统计信息
</p>

<p>
还可以使用 consul、etcd 等实现服务发现，这样就可以避免手动指定后端的 web 容器了，更为灵活
</p>
</div>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">Compose 命令</h2>
<div class="outline-text-2" id="text-4">
<p>
基本的使用格式是：
</p>
<pre class="example">
docker-compose [options] [COMMAND] [ARGS...]
</pre>
</div>
<div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1">选项</h3>
<div class="outline-text-3" id="text-4-1">
<ul class="org-ul">
<li>&#x2013;verbose：输出更多调试信息
</li>
<li>&#x2013;version ：打印版本并退出
</li>
<li>-f, &#x2013;file FILE ：使用特定的 compose 模板文件，默认为 docker-compose.yml
</li>
<li>-p, &#x2013;project-name NAME ：指定项目名称，默认使用目录名称
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2">命令</h3>
<div class="outline-text-3" id="text-4-2">
</div><div id="outline-container-sec-4-2-1" class="outline-4">
<h4 id="sec-4-2-1">build</h4>
<div class="outline-text-4" id="text-4-2-1">
<p>
构建或重新构建服务，服务一旦构建后，将会带上一个标记名，例如 web_db
</p>
</div>
</div>
<div id="outline-container-sec-4-2-2" class="outline-4">
<h4 id="sec-4-2-2">help</h4>
<div class="outline-text-4" id="text-4-2-2">
<p>
获得一个命令的帮助
</p>
</div>
</div>
<div id="outline-container-sec-4-2-3" class="outline-4">
<h4 id="sec-4-2-3">kill</h4>
<div class="outline-text-4" id="text-4-2-3">
<p>
通过发送 SIGKILL 信号来强制停止服务容器。支持通过参数来指定发送的信号，例如：
</p>
<div class="org-src-container">

<pre class="src src-sh">$ docker-compose kill -s SIGINT
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-2-4" class="outline-4">
<h4 id="sec-4-2-4">logs</h4>
<div class="outline-text-4" id="text-4-2-4">
<p>
查看服务的输出
</p>
</div>
</div>
<div id="outline-container-sec-4-2-5" class="outline-4">
<h4 id="sec-4-2-5">port</h4>
<div class="outline-text-4" id="text-4-2-5">
<p>
打印绑定的公共端口
</p>
</div>
</div>
<div id="outline-container-sec-4-2-6" class="outline-4">
<h4 id="sec-4-2-6">ps</h4>
<div class="outline-text-4" id="text-4-2-6">
<p>
列出所有容器
</p>
</div>
</div>
<div id="outline-container-sec-4-2-7" class="outline-4">
<h4 id="sec-4-2-7">pull</h4>
<div class="outline-text-4" id="text-4-2-7">
<p>
拉取服务镜像
</p>
</div>
</div>
<div id="outline-container-sec-4-2-8" class="outline-4">
<h4 id="sec-4-2-8">rm</h4>
<div class="outline-text-4" id="text-4-2-8">
<p>
删除停止的服务容器
</p>
</div>
</div>
<div id="outline-container-sec-4-2-9" class="outline-4">
<h4 id="sec-4-2-9">run</h4>
<div class="outline-text-4" id="text-4-2-9">
<p>
在一个服务上执行一个命令，启动一个 ubuntu 服务，执行 ping docker.com 命令：
</p>
<div class="org-src-container">

<pre class="src src-sh">$ docker-compose run ubuntu ping docker.com
</pre>
</div>
<p>
默认情况下，所有关联的服务将会自动被启动，除非这些服务已经在运行中。
</p>

<p>
该命令类似启动容器后运行指定的命令，相关卷、链接等等都将会按照期望创建，两个不同点：
</p>
<ul class="org-ul">
<li>给定命令将会覆盖原有的自动运行命令
</li>
<li>不会自动创建端口，以避免冲突
</li>
</ul>

<p>
如果不希望自动启动关联的容器，可以使用 &#x2013;no-deps 选项，例如：
</p>
<div class="org-src-container">

<pre class="src src-sh">$ docker-compose run --no-deps web python manage.py shell
</pre>
</div>
<p>
将不会启动 web 容器所关联的其它容器
</p>
</div>
</div>

<div id="outline-container-sec-4-2-10" class="outline-4">
<h4 id="sec-4-2-10">scale</h4>
<div class="outline-text-4" id="text-4-2-10">
<p>
设置同一个服务运行的容器个数。通过 service=num 的参数来设置数量。例如：
</p>
<div class="org-src-container">

<pre class="src src-sh">$ docker-compose scale <span style="color: #eedd82;">web</span>=2 <span style="color: #eedd82;">worker</span>=3
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-2-11" class="outline-4">
<h4 id="sec-4-2-11">start</h4>
<div class="outline-text-4" id="text-4-2-11">
<p>
启动一个已经存在的服务容器
</p>
</div>
</div>

<div id="outline-container-sec-4-2-12" class="outline-4">
<h4 id="sec-4-2-12">stop</h4>
<div class="outline-text-4" id="text-4-2-12">
<p>
停止一个已经运行的容器，但不删除它。通过 docker-compose start 可以再次启动这些容器
</p>
</div>
</div>

<div id="outline-container-sec-4-2-13" class="outline-4">
<h4 id="sec-4-2-13">up</h4>
<div class="outline-text-4" id="text-4-2-13">
<p>
构建，（重新）创建，启动，链接一个服务相关的容器
</p>

<p>
链接的服务都将会启动，除非他们已经运行
</p>

<p>
默认情况， docker-compose up 将会整合所有容器的输出，并且退出时，所有容器将会停止
</p>

<p>
如果使用 docker-compose up -d ，将会在后台启动并运行所有的容器。
</p>

<p>
默认情况，如果该服务的容器已经存在， docker-compose up 将会停止并尝试重新创建他们（保持使用 volumes-from 挂载的卷），以保证 docker-compose.yml 的修改生效。如果你不想容器被停止并重新创建，可以使用 docker-compose up &#x2013;no-recreate。如果需要的话，这样将会启动已经停止的容器
</p>
</div>
</div>
</div>

<div id="outline-container-sec-4-3" class="outline-3">
<h3 id="sec-4-3">环境变量</h3>
<div class="outline-text-3" id="text-4-3">
<p>
环境变量可以用来配置 Compose 的行为
</p>

<p>
以DOCKER_开头的变量和用来配置 Docker 命令行客户端的使用一样。如果使用 boot2docker , $(boot2docker shellinit) 将会设置它们为正确的值：
</p>
<ul class="org-ul">
<li>COMPOSE_PROJECT_NAME：设置通过 Compose 启动的每一个容器前添加的项目名称，默认是当前工作目录的名字
</li>
<li>COMPOSE_FILE：设置要使用的 docker-compose.yml 的路径。默认路径是当前工作目录
</li>
<li>DOCKER_HOST：设置 Docker daemon 的地址。默认使用 unix:///var/run/docker.sock，与 Docker 客户端采用的默认值一致
</li>
<li>DOCKER_TLS_VERIFY：如果设置不为空，则与 Docker daemon 交互通过 TLS 进行
</li>
<li>DOCKER_CERT_PATH：配置 TLS 通信所需要的验证（ca.pem、cert.pem 和 key.pem）文件的路径，默认是 ~/.docker
</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">yaml模板</h2>
<div class="outline-text-2" id="text-5">
<p>
默认的模板文件是 docker-compose.yml，其中定义的每个服务都必须通过 image 指令指定镜像或 build 指令（需要 Dockerfile）来自动构建
</p>

<p>
如果使用 build 指令，在 Dockerfile 中设置的选项(例如：CMD, EXPOSE, VOLUME, ENV 等) 将会自动被获取，无需在 docker-compose.yml 中再次设置
</p>
</div>

<div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1">image</h3>
<div class="outline-text-3" id="text-5-1">
<p>
指定为镜像名称或镜像 ID。如果镜像在本地不存在，Compose 将会尝试拉去这个镜像。
</p>
<pre class="example">
image: ubuntu
image: orchardup/postgresql
image: a4bc65fd
</pre>
</div>
</div>

<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2">build</h3>
<div class="outline-text-3" id="text-5-2">
<p>
指定 Dockerfile 所在文件夹的路径。 Compose 将会利用它自动构建这个镜像，然后使用这个镜像
</p>
<pre class="example">
build: /path/to/build/dir
</pre>
</div>
</div>

<div id="outline-container-sec-5-3" class="outline-3">
<h3 id="sec-5-3">command</h3>
<div class="outline-text-3" id="text-5-3">
<p>
覆盖容器启动后默认执行的命令
</p>
<pre class="example">
command: bundle exec thin -p 3000
</pre>
</div>
</div>

<div id="outline-container-sec-5-4" class="outline-3">
<h3 id="sec-5-4">links</h3>
<div class="outline-text-3" id="text-5-4">
<p>
链接到其它服务中的容器。使用服务名称（同时作为别名）或服务名称：服务别名 （SERVICE:ALIAS） 格式都可以
</p>
<pre class="example">
links:
 - db
 - db:database
 - redis
</pre>
<p>
使用的别名将会自动在服务容器中的 /etc/hosts 里创建。例如：
</p>
<pre class="example">
172.17.2.186  db
172.17.2.186  database
172.17.2.187  redis
</pre>
<p>
相应的环境变量也将被创建
</p>
</div>
</div>

<div id="outline-container-sec-5-5" class="outline-3">
<h3 id="sec-5-5">external_links</h3>
<div class="outline-text-3" id="text-5-5">
<p>
链接到 docker-compose.yml 外部的容器，甚至 并非 Compose 管理的容器。参数格式跟 links 类似:
</p>
<pre class="example">
external_links:
 - redis_1
 - project_db_1:mysql
 - project_db_1:postgresql
</pre>
</div>
</div>

<div id="outline-container-sec-5-6" class="outline-3">
<h3 id="sec-5-6">ports</h3>
<div class="outline-text-3" id="text-5-6">
<p>
暴露端口信息。使用宿主：容器 （HOST:CONTAINER）格式或者仅仅指定容器的端口（宿主将会随机选择端口）都可以
</p>
<pre class="example">
ports:
 - "3000"
 - "8000:8000"
 - "49100:22"
 - "127.0.0.1:8001:8001"
</pre>
</div>
</div>

<div id="outline-container-sec-5-7" class="outline-3">
<h3 id="sec-5-7">expose</h3>
<div class="outline-text-3" id="text-5-7">
<p>
暴露端口，但不映射到宿主机，只被连接的服务访问：
</p>
<pre class="example">
expose:
 - "3000"
 - "8000"
</pre>
</div>
</div>

<div id="outline-container-sec-5-8" class="outline-3">
<h3 id="sec-5-8">volumes</h3>
<div class="outline-text-3" id="text-5-8">
<p>
卷挂载路径设置。可以设置宿主机路径 （HOST:CONTAINER） 或加上访问模式 （HOST:CONTAINER:ro）:
</p>
<pre class="example">
volumes:
 - /var/lib/mysql
 - cache/:/tmp/cache
 - ~/configs:/etc/configs/:ro
</pre>
</div>
</div>

<div id="outline-container-sec-5-9" class="outline-3">
<h3 id="sec-5-9">volumes_from</h3>
<div class="outline-text-3" id="text-5-9">
<p>
从另一个服务或容器挂载它的所有卷：
</p>
<pre class="example">
volumes_from:
 - service_name
 - container_name
</pre>
</div>
</div>

<div id="outline-container-sec-5-10" class="outline-3">
<h3 id="sec-5-10">environment</h3>
</div>
</div>
</div>
<div id="postamble" class="status">

		  <br/>
		  <div class='ds-thread'></div>
		  <script>
		  var duoshuoQuery = {short_name:'klose911'};
		  (function() {
					  var dsThread = document.getElementsByClassName('ds-thread')[0];
					  dsThread.setAttribute('data-thread-key', document.title);
					  dsThread.setAttribute('data-title', document.title);
					  dsThread.setAttribute('data-url', window.location.href);
					  var ds = document.createElement('script');
					  ds.type = 'text/javascript';ds.async = true;
					  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
					  ds.charset = 'UTF-8';
					  (document.getElementsByTagName('head')[0] 
						|| document.getElementsByTagName('body')[0]).appendChild(ds);
					  })();
		  </script>
		  <script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
		  ga('create', 'UA-90850421-1', 'auto');
		  ga('send', 'pageview');
		  </script>
</div>
</body>
</html>
