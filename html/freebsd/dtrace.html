<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DTrace</title>
<meta name="author" content="Wu, Shanliang" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="css/main.css" />
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href=""> UP </a>
 |
 <a accesskey="H" href="freebsd.html"> HOME </a>
</div><div id="content" class="content">
<h1 class="title">DTrace</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org3f06986">实现上的差异</a></li>
<li><a href="#org3dd61c6">启用 DTrace 支持</a></li>
<li><a href="#org782fdfa">使用 DTrace</a>
<ul>
<li><a href="#orgf611542">hotkernel</a></li>
<li><a href="#org4b8036d">procsystime</a></li>
</ul>
</li>
<li><a href="#org7545fde">D 语言</a></li>
</ul>
</div>
</div>
<p>
<span class="underline">DTrace</span> ，也称为 <b>动态跟踪</b> ，是由 <span class="underline">Sun™</span> 开发的一个用来在生产和试验性生产系统上找出系统瓶颈的工具。 在任何情况下它都不是一个调试工具， 而是一个实时系统分析寻找出性能及其他问题的工具
</p>

<pre class="example" id="org5734e88">
DTrace 是个特别好的分析工具，带有大量的帮助诊断系统问题的特性，还可以使用预先写好的脚本利用它的功能

用户也可以通过使用 DTrace D 语言创建他们自己定制的分析工具， 以满足特定的需求
</pre>
<div id="outline-container-org3f06986" class="outline-2">
<h2 id="org3f06986">实现上的差异</h2>
<div class="outline-text-2" id="text-org3f06986">
<pre class="example" id="org89ff88f">
虽然 FreeBSD 上的 DTrace 与 Solaris™ 上的非常相似， 在继续深入之前需要说明一下存在的差异
</pre>

<p>
用户首先会注意到的便是 FreeBSD 上的 DTrace 需要明确地被启用。DTrace 相关的内核选项和模块必须开启后才能正常工作
</p>

<p>
有一个 <span class="underline">DDB_CTF</span>  <b>内核选项</b> 用来开启从内核与内核模块加载 CTF 数据。CTF 是 Solaris™  <span class="underline">Compact C Type Format</span> 封装了类似于 DWARF 和 venerable stabs 简化的 <b>调试信息</b> 。CTF 数据是由 <span class="underline">ctfconvert</span> 和 <span class="underline">ctfmerge</span> 工具加入二进制文件的
</p>
<ul class="org-ul">
<li>ctfconvert 工具分析由编译器生成的 DWARFELF 调试 section</li>
<li>ctfmerge 合并目标文件的 CTFELF section 到可执行文件或共享库</li>
</ul>

<pre class="example" id="org05cb1d7">
更多关于在启用 FreeBSD 内核上启用此项的详细内容即将完成
</pre>

<p>
比起 Solaris™， FreeBSD 有几个不同提供器。 最值得注意的是 <span class="underline">dtmalloc 提供器</span> ， 可以根据类型追踪 FreeBSD 内核中的 malloc()。
</p>

<p>
只有 <b>root</b> 可以使用 FreeBSD 上的 DTrace
</p>
<pre class="example" id="org6fede4d">
这是由系统安全上的差异造成的，Solaris™ 提供了一些 FreeBSD 上还未实现的低层的安全检查
</pre>

<p>
同样， <span class="underline">/dev/dtrace/dtrace</span> 也被严格的限制为仅供 root 用户访问
</p>

<p>
最后，DTrace 为 <span class="underline">Sun™ CDDL 许可</span> 下发布的软件，这个许可表示带有 DTrace 选项的 FreeBSD 内核仍为 BSD 许可； 然而， 以二进制发布模块， 或者加载二进制模块则需遵守 CDDL
</p>

<pre class="example" id="org3dfceae">
随 FreeBSD 发行的 Common Development and Distribution License

可以在查阅 /usr/src/cddl/contrib/opensolaris/OPENSOLARIS.LICENSE 或者通过 http://www.opensolaris.org/os/licensing 查看在线版本。
</pre>
</div>
</div>
<div id="outline-container-org3dd61c6" class="outline-2">
<h2 id="org3dd61c6">启用 DTrace 支持</h2>
<div class="outline-text-2" id="text-org3dd61c6">
<p>
在内核配置文件中加入以下几行来开启对 DTrace 的支持：
</p>

<div class="org-src-container">
<pre class="src src-sh">options         KDTRACE_HOOKS
options         DDB_CTF
</pre>
</div>

<pre class="example" id="org3832862">
使用 AMD64 架构的需要在内核配置文件中加入如下这行：

options         KDTRACE_FRAME

此选项提供了对 FBT 特性的支持。 DTrace 可以在没有此选项的情况下正常工作， 但是函数边界跟踪便会有所限制
</pre>

<p>
所有的源代码都必须重新使用 <span class="underline">CTF 选项</span> 编译安装。重新编译 FreeBSD 源代码可以通过以下的命令完成：
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cd /usr/src

$ make <span style="color: #eedd82;">WITH_CTF</span>=1 kernel

<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#31995;&#32479;&#38656;&#35201;&#37325;&#26032;&#21551;&#21160;</span>
</pre>
</div>

<p>
在重新启动和新内核载入内存之后，需要添加 <span class="underline">Korn shell</span> 的支持，安装 <span class="underline">shells/ksh93</span> 。 同样也可以通过 shells/pdksh 或者 shells/mksh 使用这些工具
</p>

<pre class="example" id="org2ac7f8c">
因为 DTrace 工具包有一些工具是由 ksh 写的
</pre>

<p>
最后是获得最新的 DTrace 工具包。 当前版本可以通过下面的链接找到 <a href="http://www.opensolaris.org/os/community/dtrace/dtracetoolkit/">http://www.opensolaris.org/os/community/dtrace/dtracetoolkit/</a>
</p>

<pre class="example" id="org38f3435">
这个工具包含有一个安装机制，尽管如此，并不需要安装便可使用它们
</pre>
</div>
</div>
<div id="outline-container-org782fdfa" class="outline-2">
<h2 id="org782fdfa">使用 DTrace</h2>
<div class="outline-text-2" id="text-org782fdfa">
<p>
在使用 DTrace 的功能之前，DTrace 设备必须存在。 使用如下的命令装载此设备：
</p>

<div class="org-src-container">
<pre class="src src-sh">$ kldload dtraceall
</pre>
</div>

<p>
DTrace 支持现在应该可以使用了。 管理员现在可以使用如下的命令查看所有的探测器：
</p>

<div class="org-src-container">
<pre class="src src-sh">$ dtrace -l | more
</pre>
</div>

<p>
工具包是事先写好的一堆脚本，与 DTrace 一起运行来收集系统信息。有脚本用来检查已打开的文件，内存，CPU 使用率和许多东西。使用如下的命令解开脚本：
</p>

<div class="org-src-container">
<pre class="src src-sh">$ gunzip -c DTraceToolkit* | tar xvf -
</pre>
</div>

<p>
使用 cd 命令切换到那个目录， 并修改所有文件的可执行权限，把那些名字小写的文件权限改为 755。所有这些脚本都需要修改它们的内容。那些指向 /usr/bin/ksh 需要修改成 /usr/local/bin/ksh，另外使用 /usr/bin/sh 需要变更为 /bin/sh，最后还有使用 /usr/bin/perl 的需要变更为 /usr/local/bin/perl
</p>

<pre class="example" id="org39fb6c6">
此刻还需谨慎提醒一下 FreeBSD 的 DTrace 支持仍是 不完整的 和 试验性 的

这些脚本中的大多数都无法运行，因为它们过于针对 Solaris™ 或者使用了目前还不支持的探测器
</pre>

<p>
至今 DTrace 工具包中只有两个脚本在 FreeBSD 上是完全支持的： <span class="underline">hotkernel</span> 和 <span class="underline">procsystime</span> 脚本。这两个脚本便是下一部分将要探讨的
</p>
</div>

<div id="outline-container-orgf611542" class="outline-3">
<h3 id="orgf611542">hotkernel</h3>
<div class="outline-text-3" id="text-orgf611542">
<p>
hotkernel 被设计成验明哪个函数占用了内核时间。 正常运行的话，它将生成类似以下的输出：
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ./hotkernel
Sampling... Hit Ctrl-C to end.
</pre>
</div>

<p>
系统管理员必须使用 Ctrl+C 组合键停止这个进程。 紧接着中止之后，脚本便会一张内核函数与测定时间的列表， 使用增量排序输出：
</p>

<div class="org-src-container">
<pre class="src src-sh">kernel<span style="color: #fa8072;">`_thread_lock_flags                                   2   0.0%</span>
<span style="color: #fa8072;">0xc1097063                                                  2   0.0%</span>
<span style="color: #fa8072;">kernel`</span>sched_userret                                        2   0.0%
kernel<span style="color: #fa8072;">`kern_select                                          2   0.0%</span>
<span style="color: #fa8072;">kernel`</span>generic_copyin                                       3   0.0%
kernel<span style="color: #fa8072;">`_mtx_assert                                          3   0.0%</span>
<span style="color: #fa8072;">kernel`</span>vm_fault                                             3   0.0%
kernel<span style="color: #fa8072;">`sopoll_generic                                       3   0.0%</span>
<span style="color: #fa8072;">kernel`</span>fixup_filename                                       4   0.0%
kernel<span style="color: #fa8072;">`_isitmyx                                             4   0.0%</span>
<span style="color: #fa8072;">kernel`</span>find_instance                                        4   0.0%
kernel<span style="color: #fa8072;">`_mtx_unlock_flags                                    5   0.0%</span>
<span style="color: #fa8072;">kernel`</span>syscall                                              5   0.0%
kernel<span style="color: #fa8072;">`DELAY                                                5   0.0%</span>
<span style="color: #fa8072;">0xc108a253                                                  6   0.0%</span>
<span style="color: #fa8072;">kernel`</span>witness_lock                                         7   0.0%
kernel<span style="color: #fa8072;">`read_aux_data_no_wait                                7   0.0%</span>
<span style="color: #fa8072;">kernel`</span>Xint0x80_syscall                                     7   0.0%
kernel<span style="color: #fa8072;">`witness_checkorder                                   7   0.0%</span>
<span style="color: #fa8072;">kernel`</span>sse2_pagezero                                        8   0.0%
kernel<span style="color: #fa8072;">`strncmp                                              9   0.0%</span>
<span style="color: #fa8072;">kernel`</span>spinlock_exit                                       10   0.0%
kernel<span style="color: #fa8072;">`_mtx_lock_flags                                     11   0.0%</span>
<span style="color: #fa8072;">kernel`</span>witness_unlock                                      15   0.0%
kernel<span style="color: #fa8072;">`sched_idletd                                       137   0.3%</span>
<span style="color: #fa8072;">0xc10981a5                                              42139  99.3%</span>
</pre>
</div>

<p>
这个脚本也能与内核模块一起工作。要使用此特性， 用 <span class="underline">-m</span> 标志运行脚本：
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ./hotkernel -m
Sampling... Hit Ctrl-C to end.
^C

MODULE                                                  COUNT   PCNT
0xc107882e                                                  1   0.0%
0xc10e6aa4                                                  1   0.0%
0xc1076983                                                  1   0.0%
0xc109708a                                                  1   0.0%
0xc1075a5d                                                  1   0.0%
0xc1077325                                                  1   0.0%
0xc108a245                                                  1   0.0%
0xc107730d                                                  1   0.0%
0xc1097063                                                  2   0.0%
0xc108a253                                                 73   0.0%
kernel                                                    874   0.4%
0xc10981a5                                             213781  99.6%
</pre>
</div>
</div>
</div>

<div id="outline-container-org4b8036d" class="outline-3">
<h3 id="org4b8036d">procsystime</h3>
<div class="outline-text-3" id="text-org4b8036d">
<p>
procsystime 脚本捕捉并打印给定 PID 的系统调用时间。 在下面的例子中，新生成了一个 /bin/csh 实例。procsystime 执行后则等待在新运行的 csh 上键入一些命令。 这是测试的结果：
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ./procsystime -n csh
Tracing... Hit Ctrl-C to end...
^C

Elapsed Times for processes csh,

         SYSCALL          TIME (ns)
          getpid               6131
       sigreturn               8121
           close              19127
           fcntl              19959
             dup              26955
         setpgid              28070
            stat              31899
       setitimer              40938
           wait4              62717
       sigaction              67372
     sigprocmask             119091
    gettimeofday             183710
           write             263242
          execve             492547
           ioctl             770073
           vfork            3258923
      sigsuspend            6985124
            <span style="color: #b0c4de;">read</span>         3988049784
</pre>
</div>

<pre class="example" id="orgf992bb7">
正如显示的那样，read 系统调用似乎使用了最多的纳秒单位时间， getpid() 系统调用使用了最少的时间
</pre>
</div>
</div>
</div>

<div id="outline-container-org7545fde" class="outline-2">
<h2 id="org7545fde">D 语言</h2>
<div class="outline-text-2" id="text-org7545fde">
<p>
DTrace 工具包包括了很多由 DTrace 特殊语言写成的脚本。 在 Sun™ 的文档中称这类语言为 <span class="underline">D 语言</span> ， 它与 C++ 非常类似
</p>

<pre class="example" id="org6d5eb54">
对此语言更深入的讨论则超出了这篇文章的范围

更多相关的讨论可以在 http://wikis.sun.com/display/DTrace/Documentation 找到
</pre>
</div>
</div>
</div>
<div id="postamble" class="status">

		  <br/>
		  <div class='ds-thread'></div>
		  <script>
		  var duoshuoQuery = {short_name:'klose911'};
		  (function() {
					  var dsThread = document.getElementsByClassName('ds-thread')[0];
					  dsThread.setAttribute('data-thread-key', document.title);
					  dsThread.setAttribute('data-title', document.title);
					  dsThread.setAttribute('data-url', window.location.href);
					  var ds = document.createElement('script');
					  ds.type = 'text/javascript';ds.async = true;
					  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
					  ds.charset = 'UTF-8';
					  (document.getElementsByTagName('head')[0] 
						|| document.getElementsByTagName('body')[0]).appendChild(ds);
					  })();
		  </script>
		  <script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
		  ga('create', 'UA-90850421-1', 'auto');
		  ga('send', 'pageview');
		  </script>
</div>
</body>
</html>
