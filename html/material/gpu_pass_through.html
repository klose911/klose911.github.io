<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>显卡直通</title>
<meta name="author" content="Wu, Shanliang" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="css/main.css" />
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">显卡直通</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orga32e05b">为什么要这么做？</a></li>
<li><a href="#org7a67090">Nvidia显卡</a>
<ul>
<li><a href="#org58983ba">NVIDIA Optimus 的 MUXless</a></li>
<li><a href="#org7193877">NVIDIA Optimus 的 MUXed</a></li>
<li><a href="#orgef62e77">游戏本</a></li>
<li><a href="#org39d5e53">如何判断电脑是哪一种结构</a></li>
</ul>
</li>
<li><a href="#org07ae3bb">OPtimus Muxless 直通</a>
<ul>
<li><a href="#org6e0105f">系统环境</a></li>
<li><a href="#org5a2729b">禁止宿主系统管理 NVIDIA 独显</a></li>
<li><a href="#orgb0e5996">配置 Intel GVT-g 虚拟核显</a></li>
<li><a href="#org2073b8f">配置 NVIDIA 独显直通</a></li>
<li><a href="#org6e8f6b5">下一步呢？</a>
<ul>
<li><a href="#org607820a">附录</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org9d40a1e">Optimus Muxed直通</a></li>
</ul>
</div>
</div>

<div id="outline-container-orga32e05b" class="outline-2">
<h2 id="orga32e05b">为什么要这么做？</h2>
<div class="outline-text-2" id="text-orga32e05b">
<p>
我平常浏览网页、写代码等操作都在 Arch Linux 系统下完成，很少使用 Windows 双系统。但是有的时候我想和同学联机游戏，就不得不重启到 Windows 系统。
</p>

<pre class="example" id="org9ca6d3f">
虽然已经有了 Wine、Proton 兼容层来运行 Windows 应用，还有 DXVK 来转译 DirectX 命令到 Vulkan 来提升性能

但是还是有很多游戏无法在 Wine 环境下正常运行，例如自带 DRM 或者反作弊保护的游戏，以及调用了奇怪 API 的游戏
</pre>

<p>
但双系统意味着需要维护两套系统，包括分别的系统更新、数据的共享和同步等等
</p>
<pre class="example" id="org76057ef">
例如我为了在 Windows 下正常访问自己的文件，不得不开了台 Hyper-V 虚拟机装上 Linux

然后把 Linux ZFS 分区所在的硬盘直通进去，再用 Samba 共享出来

内存立减 1G，而且启动还慢，进桌面后过两三分钟网络驱动器才连接上
</pre>

<p>
而传统的虚拟机软件（QEMU，VirtualBox，VMware）等的 3D 图形性能都很差：
</p>
<ul class="org-ul">
<li>QEMU：3D 加速是什么？
<ul class="org-ul">
<li>指只支持 2D 加速的 QXL</li>
<li>有 Virtio-GPU 这个支持 3D 的尝试，但功能不完整且不支持 Windows</li>
</ul></li>
<li>VirtualBox：3D 加速聊胜于无
<ul class="org-ul">
<li>支持一点 DirectX，但是还是不完整</li>
<li>VirtualBox 的 2D 图形绘制也会时常出错</li>
<li>VirtualBox 有时会卡死（与 ZFS 的兼容性问题？）</li>
</ul></li>
<li>VMware：3D 加速（相对）最好的一个
<ul class="org-ul">
<li>还是不够用</li>
<li>闭源+收费</li>
</ul></li>
</ul>

<p>
另一种常用的方法是使用虚拟机软件的 <b>PCIe 直通</b> 功能，让虚拟机独占高性能显卡，直接加载显卡对应的驱动，和显卡直接通信：
</p>
<ul class="org-ul">
<li>这种方法需要 CPU 支持 VT-d 技术（Intel）或者 AMD-Vi（AMD），但近几年的 CPU 应该都支持</li>
<li>同时需要至少两张显卡（集显/核显也算在内）因为高性能独显被虚拟机占走了，如果没有第二张显卡，宿主系统就没有地方显示信息了</li>
<li>同时需要一个支持 PCIe 直通的虚拟机软件
<ul class="org-ul">
<li>VirtualBox 和 VMware Workstation 据我所知是不行的</li>
<li>VMware ESXi（一个专门用于虚拟化的操作系统）是可以的
<ul class="org-ul">
<li>对于个人用户免费，而且有非常方便的网页界面</li>
<li>缺点是闭源，挑网卡驱动，而且占用资源有点大（比如内存）</li>
</ul></li>
<li>Proxmox VE 也支持
<ul class="org-ul">
<li>一个基于 Debian 的、专门针对虚拟化的系统</li>
<li>系统本身免费开源，技术支持收费</li>
<li>基于 QEMU</li>
</ul></li>
<li>或者你在自己的 Linux 上装个 QEMU 也可以
<ul class="org-ul">
<li>QEMU：免费，开源，神</li>
<li>QEMU 启动要输一长串命令，但可以用 Libvirt 及 Virt-Manager 进行方便的管理</li>
</ul></li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org7a67090" class="outline-2">
<h2 id="org7a67090">Nvidia显卡</h2>
<div class="outline-text-2" id="text-org7a67090">
<p>
但是对于 NVIDIA 显卡和笔记本平台来说，事情又要麻烦一些：
</p>

<pre class="example" id="orge6bfd6f">
NVIDIA 的驱动在虚拟机中会拒绝加载

NVIDIA 不想让你买了几千块钱的民用卡就在虚拟机里用，他们希望你去买上万的 GRID 虚拟化专用卡

因此需要用一大堆神奇的操作来隐藏 “这是个虚拟机” 的事实，让 NVIDIA 驱动乖乖启动
</pre>

<p>
另外笔记本电脑上的 NVIDIA 显卡和台式机上的是不一样的,不止是指性能，在整体架构上也有区别。在台式机上，显卡的连接方式是这样的：
</p>


<div id="org785547f" class="figure">
<p><img src="pic/nvidia-desktop.png" alt="nvidia-desktop.png" width="40%" />
</p>
</div>

<pre class="example" id="org22debd4">
也就是显卡只连接 CPU 和显示器，不关心其它的东西
</pre>

<p>
但在笔记本上又有不同，而且不同的笔记本电脑也是有区别的
</p>
</div>
<div id="outline-container-org58983ba" class="outline-3">
<h3 id="org58983ba">NVIDIA Optimus 的 MUXless</h3>
<div class="outline-text-3" id="text-org58983ba">
<p>
如果买的是几千元的中低端游戏本，连接方式可能是这样的：
</p>


<div id="orgfd9193f" class="figure">
<p><img src="pic/nvidia-optimus-muxless.png" alt="nvidia-optimus-muxless.png" width="40%" />
</p>
</div>

<p>
区别在于，独显不直连显示器，而是将渲染好的画面传输给核显，让核显发给显示器。这种方案称为 <span class="underline">NVIDIA Optimus 的 MUXless 结构</span> ：
</p>
<ul class="org-ul">
<li>优点：
<ul class="org-ul">
<li>省电（独显不用时可以直接关闭）</li>
<li>省钱（相比另外几种方案）</li>
</ul></li>
<li>缺点：
<ul class="org-ul">
<li>游戏画面渲染延迟大（因为独显需要额外一步传输画面到核显）</li>
<li>显卡直通时会遇到严重的技术难题：
<ul class="org-ul">
<li>Windows 优先把游戏放在当前显示器对应的显卡上运行，由于独显没有连接显示器，因此游戏不会优先使用独显，而是根据虚拟机配置，使用低性能虚拟显卡（例如 QXL）或者使用 Intel 的 GVT-g 虚拟显卡（核显级性能）</li>
<li><p>
在 Intel + NVIDIA Optimus 的组合中，NVIDIA 的驱动会负责把游戏调到独显上渲染。但是 NVIDIA 驱动不承认 Intel GVT-g 虚拟显卡可以加入这个组合，就不会启动 Optimus
</p>
<pre class="example" id="org3dbd7ea">
也就是，除非游戏主动检测并调用独显，否则游戏会在核显上运行
</pre></li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org7193877" class="outline-3">
<h3 id="org7193877">NVIDIA Optimus 的 MUXed</h3>
<div class="outline-text-3" id="text-org7193877">
<p>
如果买的是一万元左右的中高端游戏本，连接方式可能是这样的：
</p>


<div id="org3257748" class="figure">
<p><img src="pic/nvidia-optimus-muxed.png" alt="nvidia-optimus-muxed.png" width="40%" />
</p>
</div>

<p>
与上一种方案的区别在于，电脑主板的电路上加入了开关，可以设置 HDMI 接口及显示器分别由核显或独显进行管理。这种方案也是 NVIDIA Optimus 的一种，称为 <span class="underline">MUXed 结构</span> ：
</p>
<ul class="org-ul">
<li>优点：
<ul class="org-ul">
<li>省电（独显不用时可以关闭）</li>
<li>游戏渲染延迟小（只要将显示器切到独显上即可）</li>
<li><p>
显卡直通更方便
</p>
<pre class="example" id="orgb03f9f0">
例如，可以把独显切给 HDMI 接口，再在淘宝上 5 块钱买一个 HDMI 欺骗器（假显示器），这样虚拟机里的游戏就都会调用独显了

再用远程桌面等软件查看独显画面
</pre></li>
</ul></li>
<li>缺点：贵（电路复杂）</li>
</ul>
</div>
</div>
<div id="outline-container-orgef62e77" class="outline-3">
<h3 id="orgef62e77">游戏本</h3>
<div class="outline-text-3" id="text-orgef62e77">
<p>
如果买的是几万块钱的 "后浪专用" 厚砖游戏本，连接方式可能是这样的：
</p>


<div id="org780967d" class="figure">
<p><img src="pic/nvidia-desktop.png" alt="nvidia-desktop.png" width="40%" />
</p>
</div>

<pre class="example" id="org069a45a">
你问核显哪去了？你都买几万块钱的电脑玩游戏，还要核显有什么用？
</pre>
<p>
这种方案下，厂商直接硬件切断了核显的供电，以将供电全部分配给 CPU 和独显，取得更好的性能。实际上和台式机的架构没什么区别：
</p>
<ul class="org-ul">
<li>优点：
<ul class="org-ul">
<li>高性能，游戏渲染延迟小（独显直通显示器，核显不会和 CPU 和独显抢电）</li>
<li>省钱（没有复杂的切换电路）</li>
</ul></li>
<li><p>
缺点：
</p>
<ul class="org-ul">
<li>费电（独显需要一直开着）</li>
</ul>
<pre class="example" id="orgd5f9bff">
但你买几万块钱的游戏本估计也不关心续航了
</pre>
<ul class="org-ul">
<li><p>
对显卡直通的毁灭性打击
</p>
<ul class="org-ul">
<li>因为只有一块显卡，一旦直通进虚拟机，主系统就没有显卡可用了</li>
</ul>
<pre class="example" id="orgdbe1336">
如果你要坚持进行直通，你需要自己编写显卡在虚拟机和主机之间切换的脚本，并且需要准备一种方法在失去显示的时候进行调试

艺高人胆大的可以上!
</pre></li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org39d5e53" class="outline-3">
<h3 id="org39d5e53">如何判断电脑是哪一种结构</h3>
<div class="outline-text-3" id="text-org39d5e53">
<p>
在电脑的 Linux 系统中运行 lspci，查找有关 Intel HD Graphics 和 NVIDIA 的设备：
</p>
<ul class="org-ul">
<li>如果独显设备名以 <span class="underline">3D Controller</span> 开头，那你的电脑就是第一种 Optimus muxless 架构（核显直连显示器）</li>
<li>如果独显设备名以 <span class="underline">VGA Controller</span> 开头，并且有一个 HD Graphics 核显，那你的电脑是第二种 <span class="underline">Optimus muxed</span> 架构（核显、独显切换）</li>
<li>如果独显设备名以 VGA Controller 开头，并且没有 HD Graphics 核显，那你的电脑是第三种屏蔽核显的架构</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org07ae3bb" class="outline-2">
<h2 id="org07ae3bb">OPtimus Muxless 直通</h2>
<div class="outline-text-2" id="text-org07ae3bb">
</div>
<div id="outline-container-org6e0105f" class="outline-3">
<h3 id="org6e0105f">系统环境</h3>
<div class="outline-text-3" id="text-org6e0105f">
<p>
我使用的电脑及系统环境如下：
</p>
<ul class="org-ul">
<li>联想拯救者 R720-15IKBN 笔记本电脑（i7-7700HQ，GTX 1050）
<ul class="org-ul">
<li>属于第一种的 Optimus MUXless 架构，核显直连显示器</li>
</ul></li>
<li>宿主系统使用 Arch Linux，并更新到写本文时的最新版本</li>
<li>虚拟机软件使用 QEMU，并且安装 Libvirt 及 Virt-Manager 进行图形化管理</li>
<li>虚拟机内使用 Windows 10 LTSC 2019</li>
</ul>

<p>
目标如下：
</p>
<ul class="org-ul">
<li>创建一个 Intel 的 GVT-g 虚拟核显，将其直通进虚拟机</li>
<li>因为是虚拟显卡，宿主系统仍可正常显示图像</li>
<li>在宿主系统上禁用 NVIDIA 独显，将其完全交由虚拟机管理</li>
</ul>

<p>
开始以下步骤前，需要准备这些东西：
</p>
<ul class="org-ul">
<li>一个装好 Windows 10 系统的 QEMU（Libvirt）虚拟机
<ul class="org-ul">
<li>使用 UEFI（OVMF）启动，用 BIOS 方式（SeaBIOS）不一定能成功</li>
<li>配置有 QXL 虚拟显卡</li>
</ul></li>
<li>一个能在宿主机上启动的 Windows 系统，只要能打开设备管理器即可
<ul class="org-ul">
<li>可以是双系统，Windows To Go 等</li>
<li>Windows PE 或许也可以</li>
</ul></li>
<li>宿主机使用 Intel 核显显示内容，独显要么被禁用，要么驱动被卸载
<ul class="org-ul">
<li>否则无法完成直通 GVT-g 虚拟显卡（Virt-Manager 会闪退）</li>
<li>也无法完成直通独显（因为独显被宿主系统占用了）</li>
</ul></li>
</ul>

<p>
重要的提示：
</p>
<ol class="org-ol">
<li>整个步骤中会多次重启宿主系统，同时一些操作可能导致宿主系统崩溃，请备份好数据</li>
<li>整个步骤中不需要手动下载任何显卡驱动，交给 Windows 自动下载就好
<ul class="org-ul">
<li>如果 Windows 自动下载失败，手动安装驱动的底线是下载驱动 EXE 然后双击安装</li>
<li>千万不要在设备管理器中手动指定设备安装</li>
<li>手动安装显卡驱动有时反而会干扰判断</li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-org5a2729b" class="outline-3">
<h3 id="org5a2729b">禁止宿主系统管理 NVIDIA 独显</h3>
<div class="outline-text-3" id="text-org5a2729b">
<p>
宿主系统上的 NVIDIA 的驱动会占用独显，阻止虚拟机调用它，因此需要先用 PCIe 直通用的 <span class="underline">vfio-pci 驱动</span> 替换掉它 
</p>

<pre class="example" id="org93f2fc1">
即使你不需要直通独显，你仍然需要一种方法把宿主系统的图形显示调整到核显上，否则后续直通核显时 Virt-Manager 会崩溃

你可以用这里的方法禁用 NVIDIA 驱动，或者使用 optimus-manager 等软件进行管理
</pre>

<p>
禁用 NVIDIA 驱动，把独显交给处理虚拟机 PCIe 直通的内核模块管理的步骤如下：
</p>
<ol class="org-ol">
<li><p>
运行 <span class="underline">lspci -nn | grep NVIDIA</span> ，获得类似如下输出：
</p>
<div class="org-src-container">
<pre class="src src-sh">$ lspci -nn | grep NVIDIA

01:00.0 3D controller [0302]: NVIDIA Corporation GP107M [GeForce GTX 1050 Mobile] [10de:1c8d] (rev a1)
</pre>
</div>
<pre class="example" id="orge1132d2">
这里的 [10de:1c8d] 就是独显的制造商 ID 和设备 ID

其中 10de 代表这个 PCIe 设备由 NVIDIA 生产，而 1c8d 代表这是张 1050
</pre></li>
<li><p>
创建 <span class="underline">/etc/modprobe.d/nvidia.conf</span> ，添加如下内容：
</p>
<div class="org-src-container">
<pre class="src src-sh">options vfio-pci <span style="color: #eedd82;">ids</span>=10de:1c8d
</pre>
</div>
<pre class="example" id="orgbf4aef0">
给 vfio-pci 这个负责 PCIe 直通的内核驱动一个配置，让它去管理独显

ids 参数就是要直通的独显的制造商 ID 和设备 ID
</pre></li>
<li><p>
修改 <span class="underline">/etc/mkinitcpio.conf</span> ，在 MODULES 中添加以下内容：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #eedd82;">MODULES</span>=(vfio_pci vfio vfio_iommu_type1 vfio_virqfd)
</pre>
</div>
<pre class="example" id="orgc41b5c2">
并且删除 nvidia 等与 NVIDIA 驱动相关的内核模块

这样 PCIe 直通模块就会在系统启动的早期抢占独显，阻止 NVIDIA 驱动后续占用
</pre></li>
<li>运行 <span class="underline">mkinitcpio -P</span> 更新 initramfs</li>
<li><p>
重启电脑
</p>
<pre class="example" id="orga0c73e8">
也可以等到配置完核显直通的第一步后再重启
</pre></li>
</ol>
</div>
</div>

<div id="outline-container-orgb0e5996" class="outline-3">
<h3 id="orgb0e5996">配置 Intel GVT-g 虚拟核显</h3>
<div class="outline-text-3" id="text-orgb0e5996">
<pre class="example" id="org9ab92ab">
还记得前面提到的上万的 NVIDIA GRID 显卡吗？

在使用那些显卡时，显卡驱动本身支持虚拟出多个显卡分别分配给不同虚拟机，就像 CPU 的虚拟化技术一样

与 NVIDIA 不同，Intel 的 5 代及之后的 CPU 自带的核显都直接支持了这个功能，不需要额外花钱去购买昂贵的计算卡了

虽然核显本身性能非常弱鸡，但是相比 QXL 等方案，它至少能让虚拟机内可以流畅的完成浏览网页等工作
</pre>

<p>
同时 Intel 核显直通配置相对简单：
</p>
<ol class="org-ol">
<li>启用 GVT-g 所需的内核配置，加载对应的内核模块
<ul class="org-ul">
<li><p>
编辑内核参数（如果使用 Systemd-boot，在类似 <span class="underline">/boot/loader/entries/arch.conf</span>  的位置），添加如下内容：
</p>
<div class="org-src-container">
<pre class="src src-sh">i915.enable_gvt=1 kvm.ignore_msrs=1 <span style="color: #eedd82;">intel_iommu</span>=on
</pre>
</div></li>
<li><p>
编辑 <span class="underline">/etc/modules-load.d/intel.conf</span> ，添加如下三行内容：
</p>
<div class="org-src-container">
<pre class="src src-sh">kvmgt
vfio-iommu-type1
vfio-mdev
</pre>
</div>
<pre class="example" id="org90a9789">
这三行对应了需要加载的内核模块
</pre></li>
<li>重启电脑</li>
</ul></li>
<li>创建虚拟显卡
<ul class="org-ul">
<li><p>
运行 <span class="underline">lspci | grep "HD Graphics"</span> 查找核显的 PCIe 总线位置编号：
</p>
<div class="org-src-container">
<pre class="src src-sh">lspci | grep <span style="color: #ffa07a;">"HD Graphics"</span> 

00:02.0 VGA compatible controller: Intel Corporation HD Graphics 630 (rev 04)
</pre>
</div>
<pre class="example" id="org99926c8">
代表核显的总线位置是 00:02.0
</pre></li>
<li><p>
运行以下命令创建虚拟显卡：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#38656;&#35201;&#20197; root &#36523;&#20221;&#25191;&#34892;</span>
sudo su
<span style="color: #b0c4de;">echo</span> <span style="color: #ffa07a;">"af5972fb-5530-41a7-0000-fd836204445b"</span> &gt; <span style="color: #ffa07a;">"/sys/devices/pci0000:00/0000:00:02.0/mdev_supported_types/i915-GVTg_V5_4/create"</span>
</pre>
</div>
<pre class="example" id="orgffc001d">
注意：替换核显的 PCIe 编号，以及可以替换传入的 UUID

另外，每次系统重启后，都需要在启动虚拟机之前手动运行这条命令

可以把这条命令加入 /etc/rc.local，在开机时自动添加虚拟显卡。虚拟机不运行时，虚拟显卡是不影响性能的
</pre></li>
</ul></li>
<li>修改虚拟机配置，让虚拟显卡对虚拟机可见：
<ul class="org-ul">
<li><p>
运行 <span class="underline">virsh edit Win10</span> ，其中 <span class="underline">Win10</span> 是 <b>虚拟机名</b> ，在 <span class="underline">&lt;/devices&gt;</span> 前加入以下内容：
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #87cefa;">hostdev</span> <span style="color: #eedd82;">mode</span>=<span style="color: #ffa07a;">'subsystem'</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'mdev'</span> <span style="color: #eedd82;">managed</span>=<span style="color: #ffa07a;">'no'</span> <span style="color: #eedd82;">model</span>=<span style="color: #ffa07a;">'vfio-pci'</span> <span style="color: #eedd82;">display</span>=<span style="color: #ffa07a;">'off'</span>&gt;
  &lt;<span style="color: #87cefa;">source</span>&gt;
    &lt;<span style="color: #87cefa;">address</span> <span style="color: #eedd82;">uuid</span>=<span style="color: #ffa07a;">'af5972fb-5530-41a7-0000-fd836204445b'</span>/&gt;
  &lt;/<span style="color: #87cefa;">source</span>&gt;
&lt;/<span style="color: #87cefa;">hostdev</span>&gt;
</pre>
</div>
<pre class="example" id="org5cd4c0d">
注意：替换里面的 UUID，和上一步的一致

同时这里的 display 的值是 off，目前是正常的
</pre></li>
<li>注意：先不要删掉 QXL 显卡</li>
<li>启动虚拟机，打开设备管理器，应该会多出一个 <span class="underline">Microsoft 基本显示适配器</span></li>
<li>把虚拟机连上网，等一会，系统会自动装好 Intel 的核显驱动，开始菜单里会出现 Intel 控制面板
<ul class="org-ul">
<li><p>
如果等了很长时间系统还没有装好驱动，可以去 Intel 官网下载核心显卡的驱动（就是普通那个），然后拷进虚拟机尝试安装
</p>
<pre class="example" id="org252f8bc">
如果安装失败，代表操作出了问题，或者虚拟机软件有 Bug
</pre></li>
</ul></li>
<li><p>
驱动安装成功后，虚拟机已经看到了 Intel 显卡，但是因为当前的显示器显示的是 QXL 显卡的图像，Intel 显卡不是主显卡，因此 Windows 还没有把任何程序放到上面运行
</p>
<pre class="example" id="org492797e">
下一步就要禁用 QXL 显卡了
</pre></li>
</ul></li>
<li>关闭虚拟机，再次修改虚拟机配置：
<ul class="org-ul">
<li>在上面添加的这个 <span class="underline">&lt;hostdev&gt;</span> 中，把 <span class="underline">display='off'</span> 改成 <span class="underline">display='on'</span></li>
<li><p>
删除 <span class="underline">&lt;graphics&gt;&#x2026;&lt;/graphics&gt;</span> 和 <span class="underline">&lt;video&gt;&#x2026;&lt;/video&gt;</span> 的所有内容，用如下内容替换：
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #87cefa;">graphics</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'spice'</span>&gt;
  &lt;<span style="color: #87cefa;">listen</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'none'</span>/&gt;
  &lt;<span style="color: #87cefa;">image</span> <span style="color: #eedd82;">compression</span>=<span style="color: #ffa07a;">'off'</span>/&gt;
  &lt;<span style="color: #87cefa;">gl</span> <span style="color: #eedd82;">enable</span>=<span style="color: #ffa07a;">'yes'</span>/&gt;
&lt;/<span style="color: #87cefa;">graphics</span>&gt;

&lt;<span style="color: #87cefa;">video</span>&gt;
  &lt;<span style="color: #87cefa;">model</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'none'</span>/&gt;
&lt;/<span style="color: #87cefa;">video</span>&gt;
</pre>
</div></li>
<li><p>
在 <span class="underline">&lt;/domain&gt;</span> 之前添加如下内容：
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">commandline</span>&gt;
  &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'-set'</span>/&gt;
  &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'device.hostdev0.ramfb=on'</span>/&gt;
  &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'-set'</span>/&gt;
  &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'device.hostdev0.driver=vfio-pci-nohotplug'</span>/&gt;
  &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'-set'</span>/&gt;
  &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'device.hostdev0.x-igd-opregion=on'</span>/&gt;
  &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'-set'</span>/&gt;
  &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'device.hostdev0.xres=1920'</span>/&gt;
  &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'-set'</span>/&gt;
  &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'device.hostdev0.yres=1080'</span>/&gt;
  &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'-set'</span>/&gt;
  &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'device.hostdev0.romfile=/vbios_gvt_uefi.rom'</span>/&gt;
  &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">env</span> <span style="color: #eedd82;">name</span>=<span style="color: #ffa07a;">'MESA_LOADER_DRIVER_OVERRIDE'</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'i965'</span>/&gt;
&lt;/<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">commandline</span>&gt;
</pre>
</div>
<pre class="example" id="orgfbc7d85">
其中 vbios_gvt_uefi.rom 从 http://120.25.59.132:3000/vbios_gvt_uefi.rom 下载，放在根目录下

如果移动了位置，也要对应修改 romfile 参数
</pre></li>
<li>把整个文件第一行的 <span class="underline">&lt;domain type='kvm'&gt;</span> 改成 <span class="underline">&lt;domain type='kvm' xmlns:qemu='http://libvirt.org/schemas/domain/qemu/1.0'&gt;</span></li>
</ul></li>
<li><p>
重新启动虚拟机，应该有正常的图像显示
</p>
<pre class="example" id="org4e16235">
此时虚拟机就开始使用 GVT-g 虚拟显卡了
</pre></li>
</ol>
</div>
</div>

<div id="outline-container-org2073b8f" class="outline-3">
<h3 id="org2073b8f">配置 NVIDIA 独显直通</h3>
<div class="outline-text-3" id="text-org2073b8f">
<pre class="example" id="org7be46bc">
在前面的步骤中，宿主系统的 NVIDIA 官方驱动已经被禁用，独显现在由主管 PCIe 直通的 vfio-pci 驱动管理
</pre>
<p>
将显卡直通进虚拟机本身是个简单的操作，但是丧心病狂的 NVIDIA 为了收钱，在驱动程序上做了很多限制：
</p>
<ul class="org-ul">
<li>显卡必须连接在正确的 PCIe 总线位置上</li>
<li>系统不能有明显的虚拟机特征</li>
<li>系统必须有电池</li>
<li>系统的 ACPI 表中必须能找得到显卡 BIOS</li>
<li>等等……</li>
</ul>

<pre class="example" id="orgd61c8b9">
因此必须一步步绕过这些坑

从 465 版本开始，NVIDIA 解除了大部分的限制，理论上来说现在直接把显卡直通进虚拟机就能用

但也只是理论上而已
</pre>

<p>
依然建议做完所有的隐藏虚拟机的步骤，因为：
</p>
<ul class="org-ul">
<li><p>
对于笔记本电脑来说，NVIDIA 并没有解除所有的限制
</p>
<pre class="example" id="org02bf706">
至少在我测试时，显卡的 PCIe 总线位置和系统是否存在电池依然会导致直通失败、驱动报错代码 43
</pre></li>
<li><p>
即使 NVIDIA 驱动不检测虚拟机，运行的程序也会检测虚拟机，隐藏虚拟机特征可以提高成功运行这些程序的概率
</p>
<pre class="example" id="org5101728">
典型例子包括带有反作弊系统的网游，或者部分需要联网激活的商业软件
</pre></li>
<li>由于 Optimus MUXless 的架构限制，仍然需要修改 UEFI 固件，以让虚拟机内的显卡驱动能够读取 GPU vBIOS</li>
</ul>


<ol class="org-ol">
<li>首先把宿主机重启到 Windows 系统，做如下事情：
<ul class="org-ul">
<li>（可选）下载一个 GPU-Z，导出显卡的 BIOS 备用</li>
<li>进入设备管理器，找到显卡，查看它的硬件 ID，类似 PCI\VEN_10DE&amp;DEV_1C8D&amp;SUBSYS_39D117AA&amp;REV_A1，记录下来备用</li>
</ul></li>
<li><p>
重启回 Linux。如果你上面一步没有导出显卡的 BIOS，这里也可以使用 <span class="underline">VBiosFinder</span> 软件，从电脑的 BIOS 更新中提取显卡 BIOS 内容：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#19979;&#36733; VBiosFinder</span>
git clone https://github.com/coderobe/VBiosFinder.git
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#21435;&#20320;&#30005;&#33041;&#30340;&#25216;&#26415;&#25903;&#25345;&#32593;&#31449;&#19979;&#36733; BIOS &#26356;&#26032;&#65292;&#19968;&#33324;&#26159;&#19968;&#20010; EXE &#31243;&#24207;&#12290;</span>
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#25105;&#30340; BIOS &#26356;&#26032;&#21517;&#20026; BIOS-4KCN45WW.exe&#65292;&#22914;&#26524;&#26377;&#19981;&#21516;&#27880;&#24847;&#26367;&#25442;</span>
mv BIOS-4KCN45WW.exe VBiosFinder/
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#23433;&#35013;&#20381;&#36182;</span>
pikaur -S ruby ruby-bundler innoextract p7zip upx
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#23433;&#35013; rom-parser</span>
git clone https://github.com/awilliam/rom-parser.git
<span style="color: #b0c4de;">cd</span> rom-parser
make
mv rom-parser ../VBiosFinder/3rdparty
<span style="color: #b0c4de;">cd</span> ..
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#23433;&#35013; UEFIExtract</span>
git clone https://github.com/LongSoft/UEFITool.git -b new_engine
<span style="color: #b0c4de;">cd</span> UEFITool
./unixbuild.sh
mv UEFIExtract/UEFIExtract ../VBiosFinder/3rdparty
<span style="color: #b0c4de;">cd</span> ..
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#24320;&#22987;&#25552;&#21462;&#26174;&#21345; BIOS</span>
<span style="color: #b0c4de;">cd</span> VBiosFinder
bundle update --bundler
bundle install --path=vendor/bundle
./vbiosfinder extract BIOS-4KCN45WW.exe
ls output
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">output &#25991;&#20214;&#22841;&#20869;&#26377;&#20960;&#20010;&#21629;&#21517;&#31867;&#20284;&#22914;&#19979;&#30340;&#25991;&#20214;&#65306;</span>
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">- vbios_10de_1c8c.rom</span>
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">- vbios_10de_1c8d.rom</span>
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">- vbios_10de_1c8e.rom</span>
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">- ...</span>
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#25214;&#21040;&#23545;&#24212;&#26174;&#21345;&#21046;&#36896;&#21830; ID &#21644;&#35774;&#22791; ID &#30340;&#25991;&#20214;&#65292;&#23601;&#26159;&#20320;&#30340;&#26174;&#21345; BIOS</span>
</pre>
</div></li>
<li><p>
把显卡 BIOS 添加到虚拟机的 UEFI 固件（即 OVMF）中
</p>
<pre class="example" id="org0afbbef">
在 Optimus 笔记本电脑上，NVIDIA 的驱动会去系统的 ACPI 表中查找显卡的 BIOS，并将其加载到显卡上，而 ACPI 表由 UEFI 固件管理

因此需要修改 UEFI 固件添加显卡 BIOS
</pre>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#26681;&#25454; GitHub &#19978;&#29992;&#25143;&#21453;&#39304;&#65292;UEFI &#22266;&#20214;&#32534;&#35793;&#23436;&#25104;&#21518;&#19981;&#33021;&#31227;&#21160;&#20301;&#32622;</span>
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#25152;&#20197;&#35201;&#20808;&#25214;&#22909;&#23384;&#25918;&#30340;&#22320;&#26041;</span>
<span style="color: #b0c4de;">cd</span> /opt
git clone https://github.com/tianocore/edk2.git
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#23433;&#35013;&#32534;&#35793;&#36807;&#31243;&#20013;&#38656;&#35201;&#30340;&#20381;&#36182;</span>
pikaur -S git python2 iasl nasm subversion perl-libwww vim dos2unix gcc5
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#20551;&#35774;&#20320;&#23548;&#20986;&#30340;&#26174;&#21345; BIOS &#23384;&#25918;&#22312; /vbios.rom</span>
<span style="color: #b0c4de;">cd</span> edk2/OvmfPkg/AcpiPlatformDxe
xxd -i /vbios.rom vrom.h
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#32534;&#36753; vrom.h&#65292;&#25226; unsigned char &#25968;&#32452;&#30340;&#21517;&#23383;&#20462;&#25913;&#25104; VROM_BIN</span>
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#25226;&#25991;&#20214;&#26411;&#23614;&#30340;&#38271;&#24230;&#21464;&#37327;&#25913;&#21517;&#20026; VROM_BIN_LEN&#65292;&#24182;&#35760;&#24405;&#19979;&#38271;&#24230;&#20540;&#65292;&#25105;&#30340;&#26159; 167936</span>
wget https://github.com/jscinoz/optimus-vfio-docs/files/1842788/ssdt.txt -O ssdt.asl
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#32534;&#36753; ssdt.asl&#65292;&#20462;&#25913;&#31532; 37 &#34892;&#20026; VROM_BIN_LEN &#30340;&#20540;</span>
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#28982;&#21518;&#25191;&#34892;&#19979;&#38754;&#36825;&#34892;&#21629;&#20196;&#65292;&#20250;&#25253;&#38169;&#20294;&#26159;&#27809;&#20851;&#31995;&#65292;&#21482;&#35201; Ssdt.aml &#26377;&#20102;&#23601;&#34892;</span>
iasl -f ssdt.asl
xxd -c1 Ssdt.aml | tail -n +37 | cut -f2 -d<span style="color: #ffa07a;">' '</span> | paste -sd<span style="color: #ffa07a;">' '</span> | sed <span style="color: #ffa07a;">'s/ //g'</span> | xxd -r -p &gt; vrom_table.aml
xxd -i vrom_table.aml | sed <span style="color: #ffa07a;">'s/vrom_table_aml/vrom_table/g'</span> &gt; vrom_table.h
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#36820;&#22238; edk2 &#30340;&#30446;&#24405;&#19979;&#25171;&#34917;&#19969;</span>
<span style="color: #b0c4de;">cd</span> ../..
wget https://gist.github.com/jscinoz/c43a81882929ceaf7ec90afd820cd470/raw/139799c87fc806a966250e5686e15a28676fc84e/nvidia-hack.diff
patch -p1 &lt; nvidia-hack.diff
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#24320;&#22987;&#32534;&#35793; OVMF</span>
make -C BaseTools
. ./edksetup.sh BaseTools
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#20462;&#25913; Conf/target.txt &#20013;&#22914;&#19979;&#21464;&#37327;&#30340;&#20540;&#65306;</span>
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">- ACTIVE_PLATFORM       = OvmfPkg/OvmfPkgX64.dsc</span>
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">- TARGET_ARCH           = X64</span>
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">- TOOL_CHAIN_TAG        = GCC5</span>
build
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#31561;&#24453;&#32534;&#35793;&#23436;&#25104;&#65292;&#30830;&#35748; Build/OvmfX64/DEBUG_GCC5/FV &#25991;&#20214;&#22841;&#19979;&#26377;&#36825;&#20004;&#20010;&#25991;&#20214;&#65306;</span>
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">- OVMF_CODE.fd</span>
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">- OVMF_VARS.fd</span>
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#28982;&#21518;&#26367;&#25442;&#20320;&#30340;&#34394;&#25311;&#26426;&#30340; UEFI &#21442;&#25968;&#65292;&#27880;&#24847;&#20462;&#25913;&#34394;&#25311;&#26426;&#21517;</span>
cp Build/OvmfX64/DEBUG_GCC5/FV/OVMF_VARS.fd /var/lib/libvirt/qemu/nvram/Win10_VARS.fd
</pre>
</div></li>
<li><p>
编辑虚拟机配置 <span class="underline">virsh edit Win10</span> ，做如下修改：
</p>
<div class="org-src-container">
<pre class="src src-xml"><span style="color: #ff4500;">&lt;!-- </span><span style="color: #ff4500;">&#25226; os &#19968;&#27573;&#25913;&#25104;&#36825;&#26679;&#65292;&#27880;&#24847;&#23545;&#24212;&#20320;&#30340; OVMF_CODE.fd &#36335;&#24452;</span><span style="color: #ff4500;"> --&gt;</span>
&lt;<span style="color: #87cefa;">os</span>&gt;
  &lt;<span style="color: #87cefa;">type</span> <span style="color: #eedd82;">arch</span>=<span style="color: #ffa07a;">'x86_64'</span> <span style="color: #eedd82;">machine</span>=<span style="color: #ffa07a;">'pc-q35-4.2'</span>&gt;hvm&lt;/<span style="color: #87cefa;">type</span>&gt;
  &lt;<span style="color: #87cefa;">loader</span> <span style="color: #eedd82;">readonly</span>=<span style="color: #ffa07a;">'yes'</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pflash'</span>&gt;/opt/edk2/Build/OvmfX64/DEBUG_GCC5/FV/OVMF_CODE.fd&lt;/<span style="color: #87cefa;">loader</span>&gt;
  &lt;<span style="color: #87cefa;">nvram</span>&gt;/var/lib/libvirt/qemu/nvram/Win10_VARS.fd&lt;/<span style="color: #87cefa;">nvram</span>&gt;
&lt;/<span style="color: #87cefa;">os</span>&gt;
<span style="color: #ff4500;">&lt;!-- </span><span style="color: #ff4500;">&#25226; features &#19968;&#27573;&#25913;&#25104;&#36825;&#26679;&#65292;&#23601;&#26159;&#35753; QEMU &#38544;&#34255;&#34394;&#25311;&#26426;&#30340;&#29305;&#24449;</span><span style="color: #ff4500;"> --&gt;</span>
&lt;<span style="color: #87cefa;">features</span>&gt;
  &lt;<span style="color: #87cefa;">acpi</span>/&gt;
  &lt;<span style="color: #87cefa;">apic</span>/&gt;
  &lt;<span style="color: #87cefa;">hyperv</span>&gt;
    &lt;<span style="color: #87cefa;">relaxed</span> <span style="color: #eedd82;">state</span>=<span style="color: #ffa07a;">'on'</span>/&gt;
    &lt;<span style="color: #87cefa;">vapic</span> <span style="color: #eedd82;">state</span>=<span style="color: #ffa07a;">'on'</span>/&gt;
    &lt;<span style="color: #87cefa;">spinlocks</span> <span style="color: #eedd82;">state</span>=<span style="color: #ffa07a;">'on'</span> <span style="color: #eedd82;">retries</span>=<span style="color: #ffa07a;">'8191'</span>/&gt;
    &lt;<span style="color: #87cefa;">vendor_id</span> <span style="color: #eedd82;">state</span>=<span style="color: #ffa07a;">'on'</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'GenuineIntel'</span>/&gt;
  &lt;/<span style="color: #87cefa;">hyperv</span>&gt;
  &lt;<span style="color: #87cefa;">kvm</span>&gt;
    &lt;<span style="color: #87cefa;">hidden</span> <span style="color: #eedd82;">state</span>=<span style="color: #ffa07a;">'on'</span>/&gt;
  &lt;/<span style="color: #87cefa;">kvm</span>&gt;
  &lt;<span style="color: #87cefa;">vmport</span> <span style="color: #eedd82;">state</span>=<span style="color: #ffa07a;">'off'</span>/&gt;
&lt;/<span style="color: #87cefa;">features</span>&gt;
<span style="color: #ff4500;">&lt;!-- </span><span style="color: #ff4500;">&#28155;&#21152;&#26174;&#21345;&#30452;&#36890;&#30340; PCIe &#35774;&#22791;&#65292;&#24517;&#39035;&#25918;&#22312;&#26680;&#26174; hostdev &#30340;&#21518;&#38754;</span><span style="color: #ff4500;"> --&gt;</span>
&lt;<span style="color: #87cefa;">hostdev</span> <span style="color: #eedd82;">mode</span>=<span style="color: #ffa07a;">'subsystem'</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">managed</span>=<span style="color: #ffa07a;">'yes'</span>&gt;
  &lt;<span style="color: #87cefa;">source</span>&gt;
    &lt;<span style="color: #87cefa;">address</span> <span style="color: #eedd82;">domain</span>=<span style="color: #ffa07a;">'0x0000'</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'0x01'</span> <span style="color: #eedd82;">slot</span>=<span style="color: #ffa07a;">'0x00'</span> <span style="color: #eedd82;">function</span>=<span style="color: #ffa07a;">'0x0'</span>/&gt;
  &lt;/<span style="color: #87cefa;">source</span>&gt;
  &lt;<span style="color: #87cefa;">rom</span> <span style="color: #eedd82;">bar</span>=<span style="color: #ffa07a;">'off'</span>/&gt;
  <span style="color: #ff4500;">&lt;!-- </span><span style="color: #ff4500;">&#27880;&#24847;&#36825;&#37324;&#30340; PCIe &#24635;&#32447;&#22320;&#22336;&#24517;&#39035;&#26159; 01:00.0&#65292;&#19968;&#28857;&#37117;&#19981;&#33021;&#24046;</span><span style="color: #ff4500;"> --&gt;</span>
  <span style="color: #ff4500;">&lt;!-- </span><span style="color: #ff4500;">&#22914;&#26524;&#20445;&#23384;&#26102;&#25552;&#31034; PCIe &#24635;&#32447;&#22320;&#22336;&#20914;&#31361;&#65292;&#23601;&#25226;&#20854;&#23427;&#35774;&#22791;&#30340; &lt;address&gt; &#20840;&#37096;&#21024;&#25481;</span><span style="color: #ff4500;"> --&gt;</span>
  <span style="color: #ff4500;">&lt;!-- </span><span style="color: #ff4500;">&#36825;&#26679; Libvirt &#20250;&#37325;&#26032;&#20998;&#37197;&#19968;&#36941; PCIe &#22320;&#22336;</span><span style="color: #ff4500;"> --&gt;</span>
  &lt;<span style="color: #87cefa;">address</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">domain</span>=<span style="color: #ffa07a;">'0x0000'</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'0x01'</span> <span style="color: #eedd82;">slot</span>=<span style="color: #ffa07a;">'0x00'</span> <span style="color: #eedd82;">function</span>=<span style="color: #ffa07a;">'0x0'</span> <span style="color: #eedd82;">multifunction</span>=<span style="color: #ffa07a;">'on'</span>/&gt;
&lt;/<span style="color: #87cefa;">hostdev</span>&gt;
<span style="color: #ff4500;">&lt;!-- </span><span style="color: #ff4500;">&#22312; &lt;/qemu:commandline&gt; &#20043;&#21069;&#28155;&#21152;&#36825;&#20123;&#21442;&#25968;</span><span style="color: #ff4500;"> --&gt;</span>
&lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'-set'</span>/&gt;
&lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'device.hostdev1.x-pci-vendor-id=0x10de'</span>/&gt;
&lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'-set'</span>/&gt;
&lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'device.hostdev1.x-pci-device-id=0x1c8d'</span>/&gt;
&lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'-set'</span>/&gt;
&lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'device.hostdev1.x-pci-sub-vendor-id=0x17aa'</span>/&gt;
&lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'-set'</span>/&gt;
&lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'device.hostdev1.x-pci-sub-device-id=0x39d1'</span>/&gt;
&lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'-acpitable'</span>/&gt;
&lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'file=/ssdt1.dat'</span>/&gt;
</pre>
</div>
<ul class="org-ul">
<li>此处的 ID 对应之前从设备管理器里查出的硬件 ID，PCI\VEN_10DE&amp;DEV_1C8D&amp;SUBSYS_39D117AA&amp;REV_A1</li>
<li><p>
此处的 ssdt1.dat 对应如下 Base64，可以用 Base64 解码网站转换成二进制文件，放在根目录。如果移动了，需要对应修改上面的 file 参数：
</p>
<div class="org-src-container">
<pre class="src src-sh">U1NEVKEAAAAB9EJPQ0hTAEJYUENTU0RUAQAAAElOVEwYEBkgoA8AFVwuX1NCX1BDSTAGABBMBi5f
U0JfUENJMFuCTwVCQVQwCF9ISUQMQdAMCghfVUlEABQJX1NUQQCkCh8UK19CSUYApBIjDQELcBcL
<span style="color: #eedd82;">cBcBC9A5C1gCCywBCjwKPA0ADQANTElPTgANABQSX0JTVACkEgoEAAALcBcL0Dk</span>=
</pre>
</div>
<pre class="example" id="orgc5f6b48">
这也是一个修改后的 ACPI 表，用来模拟一块满电的电池，只不过不需要合并到 OVMF 里，而是直接用参数加载就可以
</pre></li>
</ul></li>
<li>启动虚拟机，等一会，Windows 10 会自动装好 NVIDIA 驱动
<ul class="org-ul">
<li>如果设备管理器里显卡打感叹号，显示代码 43，即驱动程序加载失败，你需要 检查上面的步骤有没有遗漏，所有配置是否正确：
<ul class="org-ul">
<li><p>
将设备管理器切换到 <span class="underline">Device by Connection</span> （按照连接方式显示设备），确认： <b>显卡的地址</b> 是 <span class="underline">总线 Bus 1</span> ， <span class="underline">接口 Slot 0</span> ， <span class="underline">功能 Function 0</span> ，并且确认 <b>显卡上级的 PCIe 接口</b> 是 <span class="underline">总线 Bus 0</span> ， <span class="underline">接口 Slot 1</span> ， <span class="underline">功能 Function 0</span> 
</p>
<pre class="example" id="org73cfc91">
是的，NVIDIA 驱动的检查就是这么严格
</pre></li>
<li>如果对不上，你需要按上面的方法重新分配一遍设备的 PCIe 地址</li>
</ul></li>
<li><p>
如果系统没有自动安装 NVIDIA 驱动，并且手动下载的也显示系统不兼容/找不到显卡，那么需要查看 <span class="underline">显卡的属性</span> ，其 <b>硬件 ID</b> 是否与宿主机上查看到的一致
</p>
<pre class="example" id="org0af00e7">
即使显卡正常工作了，依然打不开 NVIDIA 控制面板（显示未连接显示器），这是正常现象
</pre></li>
</ul></li>
</ol>
</div>
</div>
<div id="outline-container-org6e8f6b5" class="outline-3">
<h3 id="org6e8f6b5">下一步呢？</h3>
<div class="outline-text-3" id="text-org6e8f6b5">
<p>
即使配置完了上面的所有步骤，核显和独显都在虚拟机里正常工作了，对玩游戏的帮助也不大：
</p>
<ul class="org-ul">
<li>由于 Windows 认为主显示器连接在 GVT-g 虚拟核显上，系统会把所有 3D 应用交给性能孱弱的核显来渲染
<ul class="org-ul">
<li><p>
如果没直通 GVT-g 虚拟核显，那就是主显示器连接在 QXL 上
</p>
<pre class="example" id="orgd48a1f2">
例外：根据反馈部分虚幻引擎游戏会自动检测并主动调用独显
</pre></li>
</ul></li>
<li>由于 MUXless Optimus 独显没有直连显示器，因此无法以任意方式指定独显为主显示卡</li>
<li>Intel GVT-g 虚拟核显与 NVIDIA 独显无法正常组成 Optimus，因此 NVIDIA 驱动也不会主动把游戏调到独显上渲染</li>
<li>如果只留 NVIDIA 一块显卡，虽然 Windows 会把渲染放在独显上（没得选了），但分辨率会被限制到 640x480，同时你就必须依赖远程桌面玩游戏了。</li>
</ul>

<pre class="example" id="org5cbe53d">
因此目前 Optimus 显卡直通的炫技成分更大于实用。如果你是驱动开发大佬，可以从以下几个方向进行研究：

1. 让 Intel GVT-g 虚拟核显和 NVIDIA 独显正常组成 Optimus
2. 让 QXL 和 NVIDIA 独显组成 Optimus
3. 魔改 NVIDIA 驱动加一个虚拟显示器
</pre>
</div>

<div id="outline-container-org607820a" class="outline-4">
<h4 id="org607820a">附录</h4>
<div class="outline-text-4" id="text-org607820a">
<p>
最终 Libvirt XML 文件：
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #87cefa;">domain</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'kvm'</span> <span style="color: #b0c4de;">xmlns</span>:<span style="color: #eedd82;">qemu</span>=<span style="color: #ffa07a;">'http://libvirt.org/schemas/domain/qemu/1.0'</span>&gt;
  &lt;<span style="color: #87cefa;">name</span>&gt;Win10&lt;/<span style="color: #87cefa;">name</span>&gt;
  &lt;<span style="color: #87cefa;">uuid</span>&gt;6f0e09e1-a7d4-4d33-b4f8-0dc69eaaed9b&lt;/<span style="color: #87cefa;">uuid</span>&gt;
  &lt;<span style="color: #87cefa;">metadata</span>&gt;
    &lt;<span style="color: #b0c4de;">libosinfo</span>:<span style="color: #87cefa;">libosinfo</span> <span style="color: #b0c4de;">xmlns</span>:<span style="color: #eedd82;">libosinfo</span>=<span style="color: #ffa07a;">"http://libosinfo.org/xmlns/libvirt/domain/1.0"</span>&gt;
      &lt;<span style="color: #b0c4de;">libosinfo</span>:<span style="color: #87cefa;">os</span> <span style="color: #eedd82;">id</span>=<span style="color: #ffa07a;">"http://microsoft.com/win/10"</span>/&gt;
    &lt;/<span style="color: #b0c4de;">libosinfo</span>:<span style="color: #87cefa;">libosinfo</span>&gt;
  &lt;/<span style="color: #87cefa;">metadata</span>&gt;
  &lt;<span style="color: #87cefa;">memory</span> <span style="color: #eedd82;">unit</span>=<span style="color: #ffa07a;">'KiB'</span>&gt;4194304&lt;/<span style="color: #87cefa;">memory</span>&gt;
  &lt;<span style="color: #87cefa;">currentMemory</span> <span style="color: #eedd82;">unit</span>=<span style="color: #ffa07a;">'KiB'</span>&gt;4194304&lt;/<span style="color: #87cefa;">currentMemory</span>&gt;
  &lt;<span style="color: #87cefa;">vcpu</span> <span style="color: #eedd82;">placement</span>=<span style="color: #ffa07a;">'static'</span>&gt;8&lt;/<span style="color: #87cefa;">vcpu</span>&gt;
  &lt;<span style="color: #87cefa;">os</span>&gt;
    &lt;<span style="color: #87cefa;">type</span> <span style="color: #eedd82;">arch</span>=<span style="color: #ffa07a;">'x86_64'</span> <span style="color: #eedd82;">machine</span>=<span style="color: #ffa07a;">'pc-q35-4.2'</span>&gt;hvm&lt;/<span style="color: #87cefa;">type</span>&gt;
    &lt;<span style="color: #87cefa;">loader</span> <span style="color: #eedd82;">readonly</span>=<span style="color: #ffa07a;">'yes'</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pflash'</span>&gt;/opt/edk2/Build/OvmfX64/DEBUG_GCC5/FV/OVMF_CODE.fd&lt;/<span style="color: #87cefa;">loader</span>&gt;
    &lt;<span style="color: #87cefa;">nvram</span>&gt;/var/lib/libvirt/qemu/nvram/Win10_VARS.fd&lt;/<span style="color: #87cefa;">nvram</span>&gt;
  &lt;/<span style="color: #87cefa;">os</span>&gt;
  &lt;<span style="color: #87cefa;">features</span>&gt;
    &lt;<span style="color: #87cefa;">acpi</span>/&gt;
    &lt;<span style="color: #87cefa;">apic</span>/&gt;
    &lt;<span style="color: #87cefa;">hyperv</span>&gt;
      &lt;<span style="color: #87cefa;">relaxed</span> <span style="color: #eedd82;">state</span>=<span style="color: #ffa07a;">'on'</span>/&gt;
      &lt;<span style="color: #87cefa;">vapic</span> <span style="color: #eedd82;">state</span>=<span style="color: #ffa07a;">'on'</span>/&gt;
      &lt;<span style="color: #87cefa;">spinlocks</span> <span style="color: #eedd82;">state</span>=<span style="color: #ffa07a;">'on'</span> <span style="color: #eedd82;">retries</span>=<span style="color: #ffa07a;">'8191'</span>/&gt;
      &lt;<span style="color: #87cefa;">vendor_id</span> <span style="color: #eedd82;">state</span>=<span style="color: #ffa07a;">'on'</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'GenuineIntel'</span>/&gt;
    &lt;/<span style="color: #87cefa;">hyperv</span>&gt;
    &lt;<span style="color: #87cefa;">kvm</span>&gt;
      &lt;<span style="color: #87cefa;">hidden</span> <span style="color: #eedd82;">state</span>=<span style="color: #ffa07a;">'on'</span>/&gt;
    &lt;/<span style="color: #87cefa;">kvm</span>&gt;
    &lt;<span style="color: #87cefa;">vmport</span> <span style="color: #eedd82;">state</span>=<span style="color: #ffa07a;">'off'</span>/&gt;
  &lt;/<span style="color: #87cefa;">features</span>&gt;
  &lt;<span style="color: #87cefa;">cpu</span> <span style="color: #eedd82;">mode</span>=<span style="color: #ffa07a;">'host-model'</span> <span style="color: #eedd82;">check</span>=<span style="color: #ffa07a;">'partial'</span>&gt;
    &lt;<span style="color: #87cefa;">topology</span> <span style="color: #eedd82;">sockets</span>=<span style="color: #ffa07a;">'1'</span> <span style="color: #eedd82;">dies</span>=<span style="color: #ffa07a;">'1'</span> <span style="color: #eedd82;">cores</span>=<span style="color: #ffa07a;">'4'</span> <span style="color: #eedd82;">threads</span>=<span style="color: #ffa07a;">'2'</span>/&gt;
  &lt;/<span style="color: #87cefa;">cpu</span>&gt;
  &lt;<span style="color: #87cefa;">clock</span> <span style="color: #eedd82;">offset</span>=<span style="color: #ffa07a;">'localtime'</span>&gt;
    &lt;<span style="color: #87cefa;">timer</span> <span style="color: #eedd82;">name</span>=<span style="color: #ffa07a;">'rtc'</span> <span style="color: #eedd82;">tickpolicy</span>=<span style="color: #ffa07a;">'catchup'</span>/&gt;
    &lt;<span style="color: #87cefa;">timer</span> <span style="color: #eedd82;">name</span>=<span style="color: #ffa07a;">'pit'</span> <span style="color: #eedd82;">tickpolicy</span>=<span style="color: #ffa07a;">'delay'</span>/&gt;
    &lt;<span style="color: #87cefa;">timer</span> <span style="color: #eedd82;">name</span>=<span style="color: #ffa07a;">'hpet'</span> <span style="color: #eedd82;">present</span>=<span style="color: #ffa07a;">'no'</span>/&gt;
    &lt;<span style="color: #87cefa;">timer</span> <span style="color: #eedd82;">name</span>=<span style="color: #ffa07a;">'hypervclock'</span> <span style="color: #eedd82;">present</span>=<span style="color: #ffa07a;">'yes'</span>/&gt;
  &lt;/<span style="color: #87cefa;">clock</span>&gt;
  &lt;<span style="color: #87cefa;">on_poweroff</span>&gt;destroy&lt;/<span style="color: #87cefa;">on_poweroff</span>&gt;
  &lt;<span style="color: #87cefa;">on_reboot</span>&gt;restart&lt;/<span style="color: #87cefa;">on_reboot</span>&gt;
  &lt;<span style="color: #87cefa;">on_crash</span>&gt;destroy&lt;/<span style="color: #87cefa;">on_crash</span>&gt;
  &lt;<span style="color: #87cefa;">pm</span>&gt;
    &lt;<span style="color: #87cefa;">suspend-to-mem</span> <span style="color: #eedd82;">enabled</span>=<span style="color: #ffa07a;">'no'</span>/&gt;
    &lt;<span style="color: #87cefa;">suspend-to-disk</span> <span style="color: #eedd82;">enabled</span>=<span style="color: #ffa07a;">'no'</span>/&gt;
  &lt;/<span style="color: #87cefa;">pm</span>&gt;
  &lt;<span style="color: #87cefa;">devices</span>&gt;
    &lt;<span style="color: #87cefa;">emulator</span>&gt;/usr/bin/qemu-system-x86_64&lt;/<span style="color: #87cefa;">emulator</span>&gt;
    &lt;<span style="color: #87cefa;">disk</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'file'</span> <span style="color: #eedd82;">device</span>=<span style="color: #ffa07a;">'disk'</span>&gt;
      &lt;<span style="color: #87cefa;">driver</span> <span style="color: #eedd82;">name</span>=<span style="color: #ffa07a;">'qemu'</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'raw'</span>/&gt;
      &lt;<span style="color: #87cefa;">source</span> <span style="color: #eedd82;">file</span>=<span style="color: #ffa07a;">'/var/lib/libvirt/images/Win10.img'</span>/&gt;
      &lt;<span style="color: #87cefa;">target</span> <span style="color: #eedd82;">dev</span>=<span style="color: #ffa07a;">'vda'</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'virtio'</span>/&gt;
      &lt;<span style="color: #87cefa;">boot</span> <span style="color: #eedd82;">order</span>=<span style="color: #ffa07a;">'1'</span>/&gt;
      &lt;<span style="color: #87cefa;">address</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">domain</span>=<span style="color: #ffa07a;">'0x0000'</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'0x07'</span> <span style="color: #eedd82;">slot</span>=<span style="color: #ffa07a;">'0x00'</span> <span style="color: #eedd82;">function</span>=<span style="color: #ffa07a;">'0x0'</span>/&gt;
    &lt;/<span style="color: #87cefa;">disk</span>&gt;
    &lt;<span style="color: #87cefa;">disk</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'file'</span> <span style="color: #eedd82;">device</span>=<span style="color: #ffa07a;">'cdrom'</span>&gt;
      &lt;<span style="color: #87cefa;">driver</span> <span style="color: #eedd82;">name</span>=<span style="color: #ffa07a;">'qemu'</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'raw'</span>/&gt;
      &lt;<span style="color: #87cefa;">source</span> <span style="color: #eedd82;">file</span>=<span style="color: #ffa07a;">'/mnt/files/LegacyOS/Common/virtio-win-0.1.141.iso'</span>/&gt;
      &lt;<span style="color: #87cefa;">target</span> <span style="color: #eedd82;">dev</span>=<span style="color: #ffa07a;">'sda'</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'sata'</span>/&gt;
      &lt;<span style="color: #87cefa;">readonly</span>/&gt;
      &lt;<span style="color: #87cefa;">boot</span> <span style="color: #eedd82;">order</span>=<span style="color: #ffa07a;">'2'</span>/&gt;
      &lt;<span style="color: #87cefa;">address</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'drive'</span> <span style="color: #eedd82;">controller</span>=<span style="color: #ffa07a;">'0'</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'0'</span> <span style="color: #eedd82;">target</span>=<span style="color: #ffa07a;">'0'</span> <span style="color: #eedd82;">unit</span>=<span style="color: #ffa07a;">'0'</span>/&gt;
    &lt;/<span style="color: #87cefa;">disk</span>&gt;
    &lt;<span style="color: #87cefa;">controller</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'usb'</span> <span style="color: #eedd82;">index</span>=<span style="color: #ffa07a;">'0'</span> <span style="color: #eedd82;">model</span>=<span style="color: #ffa07a;">'qemu-xhci'</span> <span style="color: #eedd82;">ports</span>=<span style="color: #ffa07a;">'15'</span>&gt;
      &lt;<span style="color: #87cefa;">address</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">domain</span>=<span style="color: #ffa07a;">'0x0000'</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'0x04'</span> <span style="color: #eedd82;">slot</span>=<span style="color: #ffa07a;">'0x00'</span> <span style="color: #eedd82;">function</span>=<span style="color: #ffa07a;">'0x0'</span>/&gt;
    &lt;/<span style="color: #87cefa;">controller</span>&gt;
    &lt;<span style="color: #87cefa;">controller</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'sata'</span> <span style="color: #eedd82;">index</span>=<span style="color: #ffa07a;">'0'</span>&gt;
      &lt;<span style="color: #87cefa;">address</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">domain</span>=<span style="color: #ffa07a;">'0x0000'</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'0x00'</span> <span style="color: #eedd82;">slot</span>=<span style="color: #ffa07a;">'0x1f'</span> <span style="color: #eedd82;">function</span>=<span style="color: #ffa07a;">'0x2'</span>/&gt;
    &lt;/<span style="color: #87cefa;">controller</span>&gt;
    &lt;<span style="color: #87cefa;">controller</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">index</span>=<span style="color: #ffa07a;">'0'</span> <span style="color: #eedd82;">model</span>=<span style="color: #ffa07a;">'pcie-root'</span>/&gt;
    &lt;<span style="color: #87cefa;">controller</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">index</span>=<span style="color: #ffa07a;">'1'</span> <span style="color: #eedd82;">model</span>=<span style="color: #ffa07a;">'pcie-root-port'</span>&gt;
      &lt;<span style="color: #87cefa;">model</span> <span style="color: #eedd82;">name</span>=<span style="color: #ffa07a;">'pcie-root-port'</span>/&gt;
      &lt;<span style="color: #87cefa;">target</span> <span style="color: #eedd82;">chassis</span>=<span style="color: #ffa07a;">'1'</span> <span style="color: #eedd82;">port</span>=<span style="color: #ffa07a;">'0x10'</span>/&gt;
      &lt;<span style="color: #87cefa;">address</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">domain</span>=<span style="color: #ffa07a;">'0x0000'</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'0x00'</span> <span style="color: #eedd82;">slot</span>=<span style="color: #ffa07a;">'0x01'</span> <span style="color: #eedd82;">function</span>=<span style="color: #ffa07a;">'0x0'</span> <span style="color: #eedd82;">multifunction</span>=<span style="color: #ffa07a;">'on'</span>/&gt;
    &lt;/<span style="color: #87cefa;">controller</span>&gt;
    &lt;<span style="color: #87cefa;">controller</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">index</span>=<span style="color: #ffa07a;">'2'</span> <span style="color: #eedd82;">model</span>=<span style="color: #ffa07a;">'pcie-root-port'</span>&gt;
      &lt;<span style="color: #87cefa;">model</span> <span style="color: #eedd82;">name</span>=<span style="color: #ffa07a;">'pcie-root-port'</span>/&gt;
      &lt;<span style="color: #87cefa;">target</span> <span style="color: #eedd82;">chassis</span>=<span style="color: #ffa07a;">'2'</span> <span style="color: #eedd82;">port</span>=<span style="color: #ffa07a;">'0x11'</span>/&gt;
      &lt;<span style="color: #87cefa;">address</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">domain</span>=<span style="color: #ffa07a;">'0x0000'</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'0x00'</span> <span style="color: #eedd82;">slot</span>=<span style="color: #ffa07a;">'0x01'</span> <span style="color: #eedd82;">function</span>=<span style="color: #ffa07a;">'0x1'</span>/&gt;
    &lt;/<span style="color: #87cefa;">controller</span>&gt;
    &lt;<span style="color: #87cefa;">controller</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">index</span>=<span style="color: #ffa07a;">'3'</span> <span style="color: #eedd82;">model</span>=<span style="color: #ffa07a;">'pcie-root-port'</span>&gt;
      &lt;<span style="color: #87cefa;">model</span> <span style="color: #eedd82;">name</span>=<span style="color: #ffa07a;">'pcie-root-port'</span>/&gt;
      &lt;<span style="color: #87cefa;">target</span> <span style="color: #eedd82;">chassis</span>=<span style="color: #ffa07a;">'3'</span> <span style="color: #eedd82;">port</span>=<span style="color: #ffa07a;">'0x12'</span>/&gt;
      &lt;<span style="color: #87cefa;">address</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">domain</span>=<span style="color: #ffa07a;">'0x0000'</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'0x00'</span> <span style="color: #eedd82;">slot</span>=<span style="color: #ffa07a;">'0x01'</span> <span style="color: #eedd82;">function</span>=<span style="color: #ffa07a;">'0x2'</span>/&gt;
    &lt;/<span style="color: #87cefa;">controller</span>&gt;
    &lt;<span style="color: #87cefa;">controller</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">index</span>=<span style="color: #ffa07a;">'4'</span> <span style="color: #eedd82;">model</span>=<span style="color: #ffa07a;">'pcie-root-port'</span>&gt;
      &lt;<span style="color: #87cefa;">model</span> <span style="color: #eedd82;">name</span>=<span style="color: #ffa07a;">'pcie-root-port'</span>/&gt;
      &lt;<span style="color: #87cefa;">target</span> <span style="color: #eedd82;">chassis</span>=<span style="color: #ffa07a;">'4'</span> <span style="color: #eedd82;">port</span>=<span style="color: #ffa07a;">'0x13'</span>/&gt;
      &lt;<span style="color: #87cefa;">address</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">domain</span>=<span style="color: #ffa07a;">'0x0000'</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'0x00'</span> <span style="color: #eedd82;">slot</span>=<span style="color: #ffa07a;">'0x01'</span> <span style="color: #eedd82;">function</span>=<span style="color: #ffa07a;">'0x3'</span>/&gt;
    &lt;/<span style="color: #87cefa;">controller</span>&gt;
    &lt;<span style="color: #87cefa;">controller</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">index</span>=<span style="color: #ffa07a;">'5'</span> <span style="color: #eedd82;">model</span>=<span style="color: #ffa07a;">'pcie-root-port'</span>&gt;
      &lt;<span style="color: #87cefa;">model</span> <span style="color: #eedd82;">name</span>=<span style="color: #ffa07a;">'pcie-root-port'</span>/&gt;
      &lt;<span style="color: #87cefa;">target</span> <span style="color: #eedd82;">chassis</span>=<span style="color: #ffa07a;">'5'</span> <span style="color: #eedd82;">port</span>=<span style="color: #ffa07a;">'0x14'</span>/&gt;
      &lt;<span style="color: #87cefa;">address</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">domain</span>=<span style="color: #ffa07a;">'0x0000'</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'0x00'</span> <span style="color: #eedd82;">slot</span>=<span style="color: #ffa07a;">'0x01'</span> <span style="color: #eedd82;">function</span>=<span style="color: #ffa07a;">'0x4'</span>/&gt;
    &lt;/<span style="color: #87cefa;">controller</span>&gt;
    &lt;<span style="color: #87cefa;">controller</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">index</span>=<span style="color: #ffa07a;">'6'</span> <span style="color: #eedd82;">model</span>=<span style="color: #ffa07a;">'pcie-root-port'</span>&gt;
      &lt;<span style="color: #87cefa;">model</span> <span style="color: #eedd82;">name</span>=<span style="color: #ffa07a;">'pcie-root-port'</span>/&gt;
      &lt;<span style="color: #87cefa;">target</span> <span style="color: #eedd82;">chassis</span>=<span style="color: #ffa07a;">'6'</span> <span style="color: #eedd82;">port</span>=<span style="color: #ffa07a;">'0x15'</span>/&gt;
      &lt;<span style="color: #87cefa;">address</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">domain</span>=<span style="color: #ffa07a;">'0x0000'</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'0x00'</span> <span style="color: #eedd82;">slot</span>=<span style="color: #ffa07a;">'0x01'</span> <span style="color: #eedd82;">function</span>=<span style="color: #ffa07a;">'0x5'</span>/&gt;
    &lt;/<span style="color: #87cefa;">controller</span>&gt;
    &lt;<span style="color: #87cefa;">controller</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">index</span>=<span style="color: #ffa07a;">'7'</span> <span style="color: #eedd82;">model</span>=<span style="color: #ffa07a;">'pcie-root-port'</span>&gt;
      &lt;<span style="color: #87cefa;">model</span> <span style="color: #eedd82;">name</span>=<span style="color: #ffa07a;">'pcie-root-port'</span>/&gt;
      &lt;<span style="color: #87cefa;">target</span> <span style="color: #eedd82;">chassis</span>=<span style="color: #ffa07a;">'7'</span> <span style="color: #eedd82;">port</span>=<span style="color: #ffa07a;">'0x8'</span>/&gt;
      &lt;<span style="color: #87cefa;">address</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">domain</span>=<span style="color: #ffa07a;">'0x0000'</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'0x00'</span> <span style="color: #eedd82;">slot</span>=<span style="color: #ffa07a;">'0x01'</span> <span style="color: #eedd82;">function</span>=<span style="color: #ffa07a;">'0x6'</span>/&gt;
    &lt;/<span style="color: #87cefa;">controller</span>&gt;
    &lt;<span style="color: #87cefa;">controller</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">index</span>=<span style="color: #ffa07a;">'8'</span> <span style="color: #eedd82;">model</span>=<span style="color: #ffa07a;">'pcie-root-port'</span>&gt;
      &lt;<span style="color: #87cefa;">model</span> <span style="color: #eedd82;">name</span>=<span style="color: #ffa07a;">'pcie-root-port'</span>/&gt;
      &lt;<span style="color: #87cefa;">target</span> <span style="color: #eedd82;">chassis</span>=<span style="color: #ffa07a;">'8'</span> <span style="color: #eedd82;">port</span>=<span style="color: #ffa07a;">'0x9'</span>/&gt;
      &lt;<span style="color: #87cefa;">address</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">domain</span>=<span style="color: #ffa07a;">'0x0000'</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'0x00'</span> <span style="color: #eedd82;">slot</span>=<span style="color: #ffa07a;">'0x01'</span> <span style="color: #eedd82;">function</span>=<span style="color: #ffa07a;">'0x7'</span>/&gt;
    &lt;/<span style="color: #87cefa;">controller</span>&gt;
    &lt;<span style="color: #87cefa;">controller</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">index</span>=<span style="color: #ffa07a;">'9'</span> <span style="color: #eedd82;">model</span>=<span style="color: #ffa07a;">'pcie-to-pci-bridge'</span>&gt;
      &lt;<span style="color: #87cefa;">model</span> <span style="color: #eedd82;">name</span>=<span style="color: #ffa07a;">'pcie-pci-bridge'</span>/&gt;
      &lt;<span style="color: #87cefa;">address</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">domain</span>=<span style="color: #ffa07a;">'0x0000'</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'0x02'</span> <span style="color: #eedd82;">slot</span>=<span style="color: #ffa07a;">'0x00'</span> <span style="color: #eedd82;">function</span>=<span style="color: #ffa07a;">'0x0'</span>/&gt;
    &lt;/<span style="color: #87cefa;">controller</span>&gt;
    &lt;<span style="color: #87cefa;">controller</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">index</span>=<span style="color: #ffa07a;">'10'</span> <span style="color: #eedd82;">model</span>=<span style="color: #ffa07a;">'pcie-root-port'</span>&gt;
      &lt;<span style="color: #87cefa;">model</span> <span style="color: #eedd82;">name</span>=<span style="color: #ffa07a;">'pcie-root-port'</span>/&gt;
      &lt;<span style="color: #87cefa;">target</span> <span style="color: #eedd82;">chassis</span>=<span style="color: #ffa07a;">'10'</span> <span style="color: #eedd82;">port</span>=<span style="color: #ffa07a;">'0xa'</span>/&gt;
      &lt;<span style="color: #87cefa;">address</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">domain</span>=<span style="color: #ffa07a;">'0x0000'</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'0x00'</span> <span style="color: #eedd82;">slot</span>=<span style="color: #ffa07a;">'0x03'</span> <span style="color: #eedd82;">function</span>=<span style="color: #ffa07a;">'0x0'</span> <span style="color: #eedd82;">multifunction</span>=<span style="color: #ffa07a;">'on'</span>/&gt;
    &lt;/<span style="color: #87cefa;">controller</span>&gt;
    &lt;<span style="color: #87cefa;">controller</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">index</span>=<span style="color: #ffa07a;">'11'</span> <span style="color: #eedd82;">model</span>=<span style="color: #ffa07a;">'pcie-root-port'</span>&gt;
      &lt;<span style="color: #87cefa;">model</span> <span style="color: #eedd82;">name</span>=<span style="color: #ffa07a;">'pcie-root-port'</span>/&gt;
      &lt;<span style="color: #87cefa;">target</span> <span style="color: #eedd82;">chassis</span>=<span style="color: #ffa07a;">'11'</span> <span style="color: #eedd82;">port</span>=<span style="color: #ffa07a;">'0xb'</span>/&gt;
      &lt;<span style="color: #87cefa;">address</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">domain</span>=<span style="color: #ffa07a;">'0x0000'</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'0x00'</span> <span style="color: #eedd82;">slot</span>=<span style="color: #ffa07a;">'0x03'</span> <span style="color: #eedd82;">function</span>=<span style="color: #ffa07a;">'0x1'</span>/&gt;
    &lt;/<span style="color: #87cefa;">controller</span>&gt;
    &lt;<span style="color: #87cefa;">controller</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'virtio-serial'</span> <span style="color: #eedd82;">index</span>=<span style="color: #ffa07a;">'0'</span>&gt;
      &lt;<span style="color: #87cefa;">address</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">domain</span>=<span style="color: #ffa07a;">'0x0000'</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'0x05'</span> <span style="color: #eedd82;">slot</span>=<span style="color: #ffa07a;">'0x00'</span> <span style="color: #eedd82;">function</span>=<span style="color: #ffa07a;">'0x0'</span>/&gt;
    &lt;/<span style="color: #87cefa;">controller</span>&gt;
    &lt;<span style="color: #87cefa;">controller</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'scsi'</span> <span style="color: #eedd82;">index</span>=<span style="color: #ffa07a;">'0'</span> <span style="color: #eedd82;">model</span>=<span style="color: #ffa07a;">'virtio-scsi'</span>&gt;
      &lt;<span style="color: #87cefa;">address</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">domain</span>=<span style="color: #ffa07a;">'0x0000'</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'0x06'</span> <span style="color: #eedd82;">slot</span>=<span style="color: #ffa07a;">'0x00'</span> <span style="color: #eedd82;">function</span>=<span style="color: #ffa07a;">'0x0'</span>/&gt;
    &lt;/<span style="color: #87cefa;">controller</span>&gt;
    &lt;<span style="color: #87cefa;">interface</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'bridge'</span>&gt;
      &lt;<span style="color: #87cefa;">mac</span> <span style="color: #eedd82;">address</span>=<span style="color: #ffa07a;">'52:54:00:b0:65:5a'</span>/&gt;
      &lt;<span style="color: #87cefa;">source</span> <span style="color: #eedd82;">bridge</span>=<span style="color: #ffa07a;">'br0'</span>/&gt;
      &lt;<span style="color: #87cefa;">model</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'virtio'</span>/&gt;
      &lt;<span style="color: #87cefa;">address</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">domain</span>=<span style="color: #ffa07a;">'0x0000'</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'0x03'</span> <span style="color: #eedd82;">slot</span>=<span style="color: #ffa07a;">'0x00'</span> <span style="color: #eedd82;">function</span>=<span style="color: #ffa07a;">'0x0'</span>/&gt;
    &lt;/<span style="color: #87cefa;">interface</span>&gt;
    &lt;<span style="color: #87cefa;">serial</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pty'</span>&gt;
      &lt;<span style="color: #87cefa;">target</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'isa-serial'</span> <span style="color: #eedd82;">port</span>=<span style="color: #ffa07a;">'0'</span>&gt;
        &lt;<span style="color: #87cefa;">model</span> <span style="color: #eedd82;">name</span>=<span style="color: #ffa07a;">'isa-serial'</span>/&gt;
      &lt;/<span style="color: #87cefa;">target</span>&gt;
    &lt;/<span style="color: #87cefa;">serial</span>&gt;
    &lt;<span style="color: #87cefa;">console</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pty'</span>&gt;
      &lt;<span style="color: #87cefa;">target</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'serial'</span> <span style="color: #eedd82;">port</span>=<span style="color: #ffa07a;">'0'</span>/&gt;
    &lt;/<span style="color: #87cefa;">console</span>&gt;
    &lt;<span style="color: #87cefa;">channel</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'spicevmc'</span>&gt;
      &lt;<span style="color: #87cefa;">target</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'virtio'</span> <span style="color: #eedd82;">name</span>=<span style="color: #ffa07a;">'com.redhat.spice.0'</span>/&gt;
      &lt;<span style="color: #87cefa;">address</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'virtio-serial'</span> <span style="color: #eedd82;">controller</span>=<span style="color: #ffa07a;">'0'</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'0'</span> <span style="color: #eedd82;">port</span>=<span style="color: #ffa07a;">'1'</span>/&gt;
    &lt;/<span style="color: #87cefa;">channel</span>&gt;
    &lt;<span style="color: #87cefa;">input</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'tablet'</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'usb'</span>&gt;
      &lt;<span style="color: #87cefa;">address</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'usb'</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'0'</span> <span style="color: #eedd82;">port</span>=<span style="color: #ffa07a;">'1'</span>/&gt;
    &lt;/<span style="color: #87cefa;">input</span>&gt;
    &lt;<span style="color: #87cefa;">input</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'mouse'</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'ps2'</span>/&gt;
    &lt;<span style="color: #87cefa;">input</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'keyboard'</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'ps2'</span>/&gt;
    &lt;<span style="color: #87cefa;">graphics</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'spice'</span>&gt;
      &lt;<span style="color: #87cefa;">listen</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'none'</span>/&gt;
      &lt;<span style="color: #87cefa;">image</span> <span style="color: #eedd82;">compression</span>=<span style="color: #ffa07a;">'off'</span>/&gt;
      &lt;<span style="color: #87cefa;">gl</span> <span style="color: #eedd82;">enable</span>=<span style="color: #ffa07a;">'yes'</span>/&gt;
    &lt;/<span style="color: #87cefa;">graphics</span>&gt;
    &lt;<span style="color: #87cefa;">sound</span> <span style="color: #eedd82;">model</span>=<span style="color: #ffa07a;">'ich9'</span>&gt;
      &lt;<span style="color: #87cefa;">address</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">domain</span>=<span style="color: #ffa07a;">'0x0000'</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'0x00'</span> <span style="color: #eedd82;">slot</span>=<span style="color: #ffa07a;">'0x1b'</span> <span style="color: #eedd82;">function</span>=<span style="color: #ffa07a;">'0x0'</span>/&gt;
    &lt;/<span style="color: #87cefa;">sound</span>&gt;
    &lt;<span style="color: #87cefa;">video</span>&gt;
      &lt;<span style="color: #87cefa;">model</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'none'</span>/&gt;
    &lt;/<span style="color: #87cefa;">video</span>&gt;
    &lt;<span style="color: #87cefa;">hostdev</span> <span style="color: #eedd82;">mode</span>=<span style="color: #ffa07a;">'subsystem'</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'mdev'</span> <span style="color: #eedd82;">managed</span>=<span style="color: #ffa07a;">'no'</span> <span style="color: #eedd82;">model</span>=<span style="color: #ffa07a;">'vfio-pci'</span> <span style="color: #eedd82;">display</span>=<span style="color: #ffa07a;">'on'</span>&gt;
      &lt;<span style="color: #87cefa;">source</span>&gt;
        &lt;<span style="color: #87cefa;">address</span> <span style="color: #eedd82;">uuid</span>=<span style="color: #ffa07a;">'af5972fb-5530-41a7-0000-fd836204445b'</span>/&gt;
      &lt;/<span style="color: #87cefa;">source</span>&gt;
      &lt;<span style="color: #87cefa;">address</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">domain</span>=<span style="color: #ffa07a;">'0x0000'</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'0x0a'</span> <span style="color: #eedd82;">slot</span>=<span style="color: #ffa07a;">'0x00'</span> <span style="color: #eedd82;">function</span>=<span style="color: #ffa07a;">'0x0'</span>/&gt;
    &lt;/<span style="color: #87cefa;">hostdev</span>&gt;
    &lt;<span style="color: #87cefa;">hostdev</span> <span style="color: #eedd82;">mode</span>=<span style="color: #ffa07a;">'subsystem'</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">managed</span>=<span style="color: #ffa07a;">'yes'</span>&gt;
      &lt;<span style="color: #87cefa;">source</span>&gt;
        &lt;<span style="color: #87cefa;">address</span> <span style="color: #eedd82;">domain</span>=<span style="color: #ffa07a;">'0x0000'</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'0x01'</span> <span style="color: #eedd82;">slot</span>=<span style="color: #ffa07a;">'0x00'</span> <span style="color: #eedd82;">function</span>=<span style="color: #ffa07a;">'0x0'</span>/&gt;
      &lt;/<span style="color: #87cefa;">source</span>&gt;
      &lt;<span style="color: #87cefa;">rom</span> <span style="color: #eedd82;">bar</span>=<span style="color: #ffa07a;">'off'</span>/&gt;
      &lt;<span style="color: #87cefa;">address</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">domain</span>=<span style="color: #ffa07a;">'0x0000'</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'0x01'</span> <span style="color: #eedd82;">slot</span>=<span style="color: #ffa07a;">'0x00'</span> <span style="color: #eedd82;">function</span>=<span style="color: #ffa07a;">'0x0'</span> <span style="color: #eedd82;">multifunction</span>=<span style="color: #ffa07a;">'on'</span>/&gt;
    &lt;/<span style="color: #87cefa;">hostdev</span>&gt;
    &lt;<span style="color: #87cefa;">redirdev</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'usb'</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'spicevmc'</span>&gt;
      &lt;<span style="color: #87cefa;">address</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'usb'</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'0'</span> <span style="color: #eedd82;">port</span>=<span style="color: #ffa07a;">'2'</span>/&gt;
    &lt;/<span style="color: #87cefa;">redirdev</span>&gt;
    &lt;<span style="color: #87cefa;">redirdev</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'usb'</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'spicevmc'</span>&gt;
      &lt;<span style="color: #87cefa;">address</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'usb'</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'0'</span> <span style="color: #eedd82;">port</span>=<span style="color: #ffa07a;">'3'</span>/&gt;
    &lt;/<span style="color: #87cefa;">redirdev</span>&gt;
    &lt;<span style="color: #87cefa;">memballoon</span> <span style="color: #eedd82;">model</span>=<span style="color: #ffa07a;">'virtio'</span>&gt;
      &lt;<span style="color: #87cefa;">address</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">'pci'</span> <span style="color: #eedd82;">domain</span>=<span style="color: #ffa07a;">'0x0000'</span> <span style="color: #eedd82;">bus</span>=<span style="color: #ffa07a;">'0x08'</span> <span style="color: #eedd82;">slot</span>=<span style="color: #ffa07a;">'0x00'</span> <span style="color: #eedd82;">function</span>=<span style="color: #ffa07a;">'0x0'</span>/&gt;
    &lt;/<span style="color: #87cefa;">memballoon</span>&gt;
  &lt;/<span style="color: #87cefa;">devices</span>&gt;
  &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">commandline</span>&gt;
    &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'-set'</span>/&gt;
    &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'device.hostdev0.ramfb=on'</span>/&gt;
    &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'-set'</span>/&gt;
    &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'device.hostdev0.driver=vfio-pci-nohotplug'</span>/&gt;
    &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'-set'</span>/&gt;
    &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'device.hostdev0.x-igd-opregion=on'</span>/&gt;
    &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'-set'</span>/&gt;
    &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'device.hostdev0.xres=1920'</span>/&gt;
    &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'-set'</span>/&gt;
    &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'device.hostdev0.yres=1080'</span>/&gt;
    &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'-set'</span>/&gt;
    &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'device.hostdev0.romfile=/vbios_gvt_uefi.rom'</span>/&gt;
    &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'-set'</span>/&gt;
    &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'device.hostdev1.x-pci-vendor-id=0x10de'</span>/&gt;
    &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'-set'</span>/&gt;
    &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'device.hostdev1.x-pci-device-id=0x1c8d'</span>/&gt;
    &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'-set'</span>/&gt;
    &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'device.hostdev1.x-pci-sub-vendor-id=0x17aa'</span>/&gt;
    &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'-set'</span>/&gt;
    &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'device.hostdev1.x-pci-sub-device-id=0x39d1'</span>/&gt;
    &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'-acpitable'</span>/&gt;
    &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">arg</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'file=/ssdt1.dat'</span>/&gt;
    &lt;<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">env</span> <span style="color: #eedd82;">name</span>=<span style="color: #ffa07a;">'MESA_LOADER_DRIVER_OVERRIDE'</span> <span style="color: #eedd82;">value</span>=<span style="color: #ffa07a;">'i965'</span>/&gt;
  &lt;/<span style="color: #b0c4de;">qemu</span>:<span style="color: #87cefa;">commandline</span>&gt;
&lt;/<span style="color: #87cefa;">domain</span>&gt;
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-org9d40a1e" class="outline-2">
<h2 id="org9d40a1e">Optimus Muxed直通</h2>
</div>
</div>
<div id="postamble" class="status">

		  <br/>
		  <div class='ds-thread'></div>
		  <script>
		  var duoshuoQuery = {short_name:'klose911'};
		  (function() {
					  var dsThread = document.getElementsByClassName('ds-thread')[0];
					  dsThread.setAttribute('data-thread-key', document.title);
					  dsThread.setAttribute('data-title', document.title);
					  dsThread.setAttribute('data-url', window.location.href);
					  var ds = document.createElement('script');
					  ds.type = 'text/javascript';ds.async = true;
					  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
					  ds.charset = 'UTF-8';
					  (document.getElementsByTagName('head')[0] 
						|| document.getElementsByTagName('body')[0]).appendChild(ds);
					  })();
		  </script>
		  <script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
		  ga('create', 'UA-90850421-1', 'auto');
		  ga('send', 'pageview');
		  </script>
</div>
</body>
</html>
