<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RISCV 中断</title>
<meta name="author" content="Wu, Shanliang" />
<meta name="generator" content="Org Mode" />
<style type="text/css">
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="css/main.css" />
</head>
<body>
<div id="content" class="content">
<h1 class="title">RISCV 中断</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgfa01905">中断有关的寄存器</a>
<ul>
<li><a href="#orgd942420">M-mode</a>
<ul>
<li><a href="#org101b591">mcause</a></li>
<li><a href="#orgb707c4d">mstatus</a></li>
<li><a href="#org42e0677">mtvec</a></li>
<li><a href="#org0c11215">medeleg 与 mideleg</a></li>
<li><a href="#org9c2cbc8">mip 与 mie</a></li>
<li><a href="#org497947c">mpec</a></li>
<li><a href="#org08f064f">mtval</a></li>
</ul>
</li>
<li><a href="#org373f607">S-mode</a>
<ul>
<li><a href="#orgd1485a6">sstatus</a></li>
<li><a href="#org6caa02f">其它 s 特权级寄存器</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org413628d">特权级转换</a>
<ul>
<li><a href="#orgf215fd3">U 与 S 间的切换</a>
<ul>
<li><a href="#org7ff7612">U 切换到 S</a></li>
<li><a href="#org3c753f1">S 切换到 U</a></li>
</ul>
</li>
<li><a href="#org949e81b">S 与 M 间的切换</a>
<ul>
<li><a href="#orgb4e16c8">S 切换到 M</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org2d14e6c"></a></li>
</ul>
</div>
</div>
<p>
<b>trap</b>  <span class="underline">陷阱</span> 可以分为 <b>异常</b> 与 <b>中断</b> 。在 RISC v 下，中断有三种来源：
</p>
<ul class="org-ul">
<li>software interrupt</li>
<li>timer interrupt（顾名思义，时钟中断）</li>
<li>external interrupt</li>
</ul>

<p>
你可能见过 NMI，但是这是一种中断类型而非中断来源：
</p>
<ul class="org-ul">
<li>Non-maskable interrupt，不可屏蔽中断，与之相对的就是可屏蔽中断</li>
<li>NMI 都是硬件中断，只有在发生严重错误时才会触发这种类型的中断</li>
</ul>

<pre class="example" id="orgb1e438d">
你可能接触过 Linux 中的软中断，即 softirq

但是请注意 software interrupt 与 softirq 是完完全全不一样的

</pre>

<p>
接下来将全面介绍 RISC v 下的中断发送与处理、软件中断、用户态中断和特权级转换，并结合 xv6 内核、rcore、Linux 内核等实现进行介绍
</p>
<div id="outline-container-orgfa01905" class="outline-2">
<h2 id="orgfa01905">中断有关的寄存器</h2>
<div class="outline-text-2" id="text-orgfa01905">
<ul class="org-ul">
<li>M-mode 寄存器：</li>
</ul>
<p>
<b>mstatus</b> ， <b>mtvec</b> ， <b>medeleg</b> ， <b>mideleg</b> ， <b>mip</b> ， <b>mie</b> ， <b>mepc</b> ， <b>mcause</b> ， <b>mtval</b> 
</p>
<ul class="org-ul">
<li>S-mode 寄存器:</li>
</ul>
<p>
<b>sstatus</b> ， <b>stvec</b> ， <b>sip</b> ， <b>sie</b> ， <b>sepc</b> ， <b>scause</b> ， <b>stval</b> ， <b>satp</b>
</p>

<p>
在后文中，可能会有 <span class="underline">xstatus</span> , <span class="underline">xtvec</span> 等的写法，其中 x 表示特权级 m 或者 s 或者 u（u 仅仅在实现了用户态中断的 CPU 上存在）
</p>
</div>
<div id="outline-container-orgd942420" class="outline-3">
<h3 id="orgd942420">M-mode</h3>
<div class="outline-text-3" id="text-orgd942420">
</div>
<div id="outline-container-org101b591" class="outline-4">
<h4 id="org101b591">mcause</h4>
<div class="outline-text-4" id="text-org101b591">

<div id="org06a1c05" class="figure">
<p><img src="pic/1653979-20230712210012313-359133103.png" alt="1653979-20230712210012313-359133103.png" width="100%" />
</p>
</div>

<p>
RISC-V 定义 mcause 的高位和低位分别表示不同的信息：
</p>
<ul class="org-ul">
<li>最高位 (Interrupt bit)
<ul class="org-ul">
<li>0：表示 异常 (Exception)</li>
<li>1：表示 中断 (Interrupt)</li>
</ul></li>
<li>其余位 (Exception Code / Interrupt Code)
<ul class="org-ul">
<li>当最高位是 0：剩余位表示 异常原因</li>
<li>当最高位是 1：剩余位表示 中断类型</li>
</ul></li>
</ul>


<table border="1" cellspacing="0" cellpadding="6" rules="all" frame="boader">
<caption class="t-above"><span class="table-number">Table 1:</span> 常见异常代码（当 Interrupt=0）</caption>

<colgroup>
<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-right">Code</td>
<td class="org-left">异常 (Exception) 类型</td>
</tr>

<tr>
<td class="org-right">0</td>
<td class="org-left">指令地址不对齐 (Instruction address misaligned)</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-left">指令访问错误 (Instruction access fault)</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-left">非法指令 (Illegal instruction)</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-left">断点 (Breakpoint)</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-left">加载地址不对齐 (Load address misaligned)</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-left">加载访问错误 (Load access fault)</td>
</tr>

<tr>
<td class="org-right">6</td>
<td class="org-left">存储/AMO 地址不对齐 (Store/AMO address misaligned)</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-left">存储/AMO 访问错误 (Store/AMO access fault)</td>
</tr>

<tr>
<td class="org-right">8</td>
<td class="org-left">环境调用 U 模式 (Environment call from U-mode)</td>
</tr>

<tr>
<td class="org-right">9</td>
<td class="org-left">环境调用 S 模式 (Environment call from S-mode)</td>
</tr>

<tr>
<td class="org-right">11</td>
<td class="org-left">环境调用 M 模式 (Environment call from M-mode)</td>
</tr>

<tr>
<td class="org-right">12</td>
<td class="org-left">指令页错误 (Instruction page fault)</td>
</tr>

<tr>
<td class="org-right">13</td>
<td class="org-left">加载页错误 (Load page fault)</td>
</tr>

<tr>
<td class="org-right">15</td>
<td class="org-left">存储/AMO 页错误 (Store/AMO page fault)</td>
</tr>
</tbody>
</table>


<table border="1" cellspacing="0" cellpadding="6" rules="all" frame="boader">
<caption class="t-above"><span class="table-number">Table 2:</span> 常见中断代码（当 Interrupt=1）</caption>

<colgroup>
<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-right">Code</td>
<td class="org-left">中断 (Interrupt) 类型</td>
</tr>

<tr>
<td class="org-right">0</td>
<td class="org-left">用户软件中断 (User software interrupt)</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-left">管理员软件中断 (Supervisor software interrupt)</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-left">机器软件中断 (Machine software interrupt)</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-left">用户定时器中断 (User timer interrupt)</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-left">管理员定时器中断 (Supervisor timer interrupt)</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-left">机器定时器中断 (Machine timer interrupt)</td>
</tr>

<tr>
<td class="org-right">8</td>
<td class="org-left">用户外部中断 (User external interrupt)</td>
</tr>

<tr>
<td class="org-right">9</td>
<td class="org-left">管理员外部中断 (Supervisor external interrupt)</td>
</tr>

<tr>
<td class="org-right">11</td>
<td class="org-left">机器外部中断 (Machine external interrupt)</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-orgb707c4d" class="outline-4">
<h4 id="orgb707c4d">mstatus</h4>
<div class="outline-text-4" id="text-orgb707c4d">

<div id="org2756faf" class="figure">
<p><img src="pic/1653979-20230712210012932-1184025042.png" alt="1653979-20230712210012932-1184025042.png" width="100%" /> 
</p>
</div>

<p>
<span class="underline">MIE</span> 与 <span class="underline">SIE</span> 是 <b>全局中断使能位</b> ，当 xIE 为 1 时，允许在 x 特权级发生中断，否则不允许中断。
</p>
<ul class="org-ul">
<li>当 hart 处于 x 特权级时
<ul class="org-ul">
<li>当 xIE 为 0 时，x 特权级的中断被全部禁用， xIE 为1 时被全部启用</li>
<li>当 xIE 为 0 时
<ul class="org-ul">
<li>对于任意的 w&lt;x，w 特权级的中断都是处于全局禁用状态</li>
<li>对于任意的 y&gt;x，y 特权级的中断默认处于全局启用状态，无论 xIE 是否为 1</li>
</ul></li>
</ul></li>
<li>为支持嵌套陷阱，每个可以响应中断的特权模式 x 都有一个 <b>两级中断使能位</b> 和 <b>特权模式堆栈</b>
<ul class="org-ul">
<li>xPIE 保存陷阱之前活动的中断使能位的值</li>
<li>xPP 保存之前的特权模式
<ul class="org-ul">
<li>xPP 字段只能保存 x 及以下特权模式，因此 <span class="underline">MPP</span> 为 <b>两位</b> 宽， <span class="underline">SPP</span> 为 <b>一位</b> 宽</li>
</ul></li>
<li>当从特权模式 y 进入特权模式 x 时
<ul class="org-ul">
<li>xPIE 设置为 xIE 的值，xIE 设置为 0</li>
<li>xPP 设置为 y：对于 MPP，可以设置的值有 0b00（用户模式），0b01（S-mode），0b10(reserved)，0b11(M-mode)</li>
</ul></li>
</ul></li>
<li>在 M 模式或 S 模式中，使用 <b>mret</b> 或 <b>sret</b> 指令返回陷阱。执行 xret 指令时
<ul class="org-ul">
<li>将 xIE 设置为 xPIE；将 xPIE 设置为 1</li>
<li>假设 xPP 值为 y，则将特权模式更改为 y</li>
<li>将 xPP 设置为 U（如果不支持用户模式，则为 M）
<ul class="org-ul">
<li>如果 xPP≠M，则 xRET 还会设置 MPRV=0</li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org42e0677" class="outline-4">
<h4 id="org42e0677">mtvec</h4>
<div class="outline-text-4" id="text-org42e0677">

<div id="org7d750d5" class="figure">
<p><img src="pic/1653979-20230712210013404-19738400.png" alt="1653979-20230712210013404-19738400.png" width="100%" />
</p>
</div>

<p>
<b>mtvec</b> 记录的是 <span class="underline">异常处理函数的起始地址</span> ：
</p>
<ul class="org-ul">
<li>BASE 字段中的值必须始终对齐于 4 字节边界</li>
<li>MODE 设置可能会对 BASE 字段中的值施加额外的对齐约束
<ul class="org-ul">
<li>如果 MODE 为 0，那么所有的异常处理都有同一个入口地址</li>
<li><p>
否则的话异常处理的入口地址是 BASE+4*CAUSE
</p>
<pre class="example" id="org4e448df">
cause 记录在 xcause 中
</pre></li>
</ul></li>
</ul>


<div id="org8723059" class="figure">
<p><img src="pic/1653979-20230712210013684-694188924.png" alt="1653979-20230712210013684-694188924.png" width="100%" />
</p>
</div>
</div>
</div>
<div id="outline-container-org0c11215" class="outline-4">
<h4 id="org0c11215">medeleg 与 mideleg</h4>
<div class="outline-text-4" id="text-org0c11215">
<pre class="example" id="org4b49046">
默认情况下，各个特权级的陷阱都是被捕捉到了 M-mode

可以通过代码实现将 trap 转发到其它特权级进行处理
</pre>
<p>
为了提高转发的性能在 CPU 级别做了改进并提供了 <b>medeleg</b> 和 <b>mideleg</b> 两个寄存器：
</p>
<ul class="org-ul">
<li>medeleg <span class="underline">machine exception delegation</span> 用于指示转发哪些异常到 S-mode</li>
<li>mideleg <span class="underline">machine interrupt delegation</span> 用于指示转发哪些中断到 S-mode</li>
</ul>

<p>
当将陷阱委托给 S 模式时
</p>
<ul class="org-ul">
<li>scause 寄存器会写入 <b>陷阱原因</b></li>
<li>sepc 寄存器会写入 <b>引发陷阱的指令的虚拟地址</b></li>
<li>stval 寄存器会写入 <b>特定于异常的数据</b></li>
<li>mstatus 的 <span class="underline">SPP</span> 字段会写入 <b>发生陷阱时的活动特权级</b></li>
<li>mstatus 的 <span class="underline">SPIE</span> 字段会写入 <b>发生陷阱时的 SIE 字段的值</b></li>
<li>mstatus 的 <span class="underline">SIE</span> 字段会被 <b>清除</b></li>
<li>mcause、mepc 和 mtval 寄存器以及 mstatus 的 MPP 和 MPIE 字段不会被写入</li>
</ul>

<p>
被委托的中断会导致该中断在委托者所在的特权级 <b>屏蔽</b>
</p>
<pre class="example" id="orga74647f">
比如说 M-mode 将一些中断委托给了 S-mode，那么 M-mode 就无法捕捉到这些中断了
</pre>
</div>
</div>
<div id="outline-container-org9c2cbc8" class="outline-4">
<h4 id="org9c2cbc8">mip 与 mie</h4>
<div class="outline-text-4" id="text-org9c2cbc8">
<p>
<b>mip</b> 与 <b>mie</b> 是分别用于保存 <span class="underline">pending interrupt</span> 和 <span class="underline">pending interrupt enable bits</span>
</p>

<pre class="example" id="orgef5ee91">
每个中断都有中断号 i（定义在 mcause 表中）

每个中断号如果被 pending 了，那么对应的第 i 位就会被置为 1

因为 RISC v spec 定义了 16 个标准的中断，因此低 16bit 是用于标准用途，其它位则自定义
</pre>
<p>
如下图所示是低 16bit 的 mip 与 mie 寄存器
</p>

<div id="orga3d7e5d" class="figure">
<p><img src="pic/1653979-20230712210014053-1431446270.png" alt="1653979-20230712210014053-1431446270.png" width="100%" /> 
</p>
</div>

<pre class="example" id="org38cdfb5">
只需要知道 mcause 中的中断源即可

例如 SSIP 就是 supervisor software interrupt pending

SSIE 就是 supervisor software interrupt enable
</pre>

<table border="1" cellspacing="0" cellpadding="6" rules="all" frame="boader">
<caption class="t-above"><span class="table-number">Table 3:</span> mie 寄存器（Machine Interrupt Enable Register）</caption>

<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-right">位位置</td>
<td class="org-left">名称</td>
<td class="org-left">含义</td>
</tr>

<tr>
<td class="org-right">0</td>
<td class="org-left">USIE</td>
<td class="org-left">用户软件中断使能</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-left">SSIE</td>
<td class="org-left">管理员（S 模式）软件中断使能</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-left">MSIE</td>
<td class="org-left">机器（M 模式）软件中断使能</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-left">UTIE</td>
<td class="org-left">用户定时器中断使能</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-left">STIE</td>
<td class="org-left">S 模式定时器中断使能</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-left">MTIE</td>
<td class="org-left">M 模式定时器中断使能</td>
</tr>

<tr>
<td class="org-right">8</td>
<td class="org-left">UEIE</td>
<td class="org-left">用户外部中断使能</td>
</tr>

<tr>
<td class="org-right">9</td>
<td class="org-left">SEIE</td>
<td class="org-left">S 模式外部中断使能</td>
</tr>

<tr>
<td class="org-right">11</td>
<td class="org-left">MEIE</td>
<td class="org-left">M 模式外部中断使能</td>
</tr>
</tbody>
</table>

<pre class="example" id="org6b9c4c9">
如果要允许 “机器定时器中断” ，就需要把 mie.MTIE 位置 1
</pre>

<table border="1" cellspacing="0" cellpadding="6" rules="all" frame="boader">
<caption class="t-above"><span class="table-number">Table 4:</span> mip 寄存器（Machine Interrupt Pending Register）</caption>

<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-right">位位置</td>
<td class="org-left">名称</td>
<td class="org-left">含义</td>
</tr>

<tr>
<td class="org-right">0</td>
<td class="org-left">USIP</td>
<td class="org-left">用户软件中断挂起</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-left">SSIP</td>
<td class="org-left">S 模式软件中断挂起</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-left">MSIP</td>
<td class="org-left">M 模式软件中断挂起</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-left">UTIP</td>
<td class="org-left">用户定时器中断挂起</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-left">STIP</td>
<td class="org-left">S 模式定时器中断挂起</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-left">MTIP</td>
<td class="org-left">M 模式定时器中断挂起</td>
</tr>

<tr>
<td class="org-right">8</td>
<td class="org-left">UEIP</td>
<td class="org-left">用户外部中断挂起</td>
</tr>

<tr>
<td class="org-right">9</td>
<td class="org-left">SEIP</td>
<td class="org-left">S 模式外部中断挂起</td>
</tr>

<tr>
<td class="org-right">11</td>
<td class="org-left">MEIP</td>
<td class="org-left">M 模式外部中断挂起</td>
</tr>
</tbody>
</table>

<pre class="example" id="org974fadd">
当定时器溢出时，硬件会把 mip.MTIP 置 1，表示有一个 M 模式定时器中断等待处理
</pre>

<p>
mie 和 mip 的关系
</p>
<ul class="org-ul">
<li>mie: 允许哪些中断</li>
<li>mip: 哪些中断正在等待</li>
</ul>

<p>
CPU 是否真正响应中断取决于：
</p>

<pre class="example" id="org2be1589">
if (mstatus.MIE == 1) and (mip &amp; mie 有重叠的位) → 触发中断
</pre>
<p>
也就是说：
</p>
<ol class="org-ol">
<li>必须 全局中断使能位 mstatus.MIE=1</li>
<li>必须 mie 里对应的中断源被允许</li>
<li>必须 mip 里对应的中断源正在挂起</li>
</ol>

<pre class="example" id="org9d0f5a9">
举个例子：机器定时器中断

1. 硬件定时器达到设定值 → mip.MTIP = 1
2. 软件提前打开了 mie.MTIE = 1
3. 且全局 mstatus.MIE = 1

→ 4. CPU 立即跳转到 mtvec 指定的中断入口
  5. 处理中断时，硬件会自动清 mstatus.MIE=0，防止嵌套
  6. 返回时执行 mret，恢复原始 MIE 状态
</pre>
</div>
</div>
<div id="outline-container-org497947c" class="outline-4">
<h4 id="org497947c">mpec</h4>
<div class="outline-text-4" id="text-org497947c">
<p>
当 trap 陷入到 M-mode 时，mepc 会被 CPU 自动写入 <b>引发 trap 的指令的虚拟地址</b> 或者是 <b>被中断的指令的虚拟地址</b> 
</p>
</div>
</div>
<div id="outline-container-org08f064f" class="outline-4">
<h4 id="org08f064f">mtval</h4>
<div class="outline-text-4" id="text-org08f064f">
<p>
当 trap 陷入到 M-mode 时，mtval 会被 <b>置零</b> 或者被写入与 <b>异常相关的信息</b> 来辅助处理 trap
</p>
<ul class="org-ul">
<li>当触发 <span class="underline">硬件断点</span> 、 <span class="underline">地址未对齐</span> 、 <span class="underline">access fault</span> 、 <span class="underline">page fault</span> 时，mtval 记录的是 <b>引发这些问题的虚拟地址</b></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org373f607" class="outline-3">
<h3 id="org373f607">S-mode</h3>
<div class="outline-text-3" id="text-org373f607">
</div>
<div id="outline-container-orgd1485a6" class="outline-4">
<h4 id="orgd1485a6">sstatus</h4>
<div class="outline-text-4" id="text-orgd1485a6">

<div id="orgab32a62" class="figure">
<p><img src="pic/1653979-20230712210014505-699545048.png" alt="1653979-20230712210014505-699545048.png" width="100%" /> 
</p>
</div>

<p>
与中断相关的字段是 <span class="underline">SIE</span> 、 <span class="underline">SPIE</span> 、 <span class="underline">SPP</span> ：
</p>
<ul class="org-ul">
<li>SPP 位：指示处理器 <span class="underline">进入 supervisor 模式之前</span> 的 <b>特权级别</b>
<ul class="org-ul">
<li>当发生陷阱时，如果该陷阱来自用户模式，则 SPP 设置为 0；否则设置为 1</li>
<li>当执行 SRET 指令从陷阱处理程序返回时
<ul class="org-ul">
<li>如果 SPP 位为 0，则特权级别设置为用户模式</li>
<li>如果 SPP 位为 1，则特权级别设置为 supervisor 模式，然后将 SPP 设置为 0</li>
</ul></li>
</ul></li>
<li>SIE 位：在 supervisor 模式下 <span class="underline">启用</span> 或 <span class="underline">禁用</span> 所有中断
<ul class="org-ul">
<li>当 SIE 为零时，在 supervisor 模式下不会进行中断处理</li>
<li>当处理器在用户模式下运行时，忽略 SIE 的值，并启用 supervisor 级别的中断</li>
<li>可以使用 sie 寄存器 来禁用单个中断源</li>
</ul></li>
<li>SPIE 位：指示 <span class="underline">陷入 supervisor 模式</span> 之前是否 <b>启用</b> 了 supervisor 级别的中断
<ul class="org-ul">
<li><p>
当执行跳转到 supervisor 模式的陷阱时，将 SPIE 设置为 SIE，并将 SIE 设置为 0
</p>
<div class="org-src-container">
<pre class="src src-c">SPIE = SIE;
SIE = 0;
</pre>
</div></li>
<li><p>
当执行 SRET 指令时，将 SIE 设置为 SPIE，然后将 SPIE 设置为 1
</p>
<div class="org-src-container">
<pre class="src src-c">SIE = SPIE;
SPIE = 1;
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org6caa02f" class="outline-4">
<h4 id="org6caa02f">其它 s 特权级寄存器</h4>
<div class="outline-text-4" id="text-org6caa02f">
<pre class="example" id="org8db4ae1">
stvec, sip, sie,sepc, scause, stval 与 m-mode 的相应寄存器区别不大

可自行参阅 RISC v 的 spec
</pre>

<p>
satp 比较特殊，在 M-mode 没有对应的寄存器，因为 M-mode 没有分页，satp 记录的是 <b>根页表物理地址的页帧号</b> 
</p>

<pre class="example" id="org886685d">
在从 U 切换到 S 时，需要切换页表，也即是切换 satp 的根页表物理地址的页帧号
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org413628d" class="outline-2">
<h2 id="org413628d">特权级转换</h2>
<div class="outline-text-2" id="text-org413628d">
</div>
<div id="outline-container-orgf215fd3" class="outline-3">
<h3 id="orgf215fd3">U 与 S 间的切换</h3>
<div class="outline-text-3" id="text-orgf215fd3">
</div>
<div id="outline-container-org7ff7612" class="outline-4">
<h4 id="org7ff7612">U 切换到 S</h4>
</div>

<div id="outline-container-org3c753f1" class="outline-4">
<h4 id="org3c753f1">S 切换到 U</h4>
</div>
</div>
<div id="outline-container-org949e81b" class="outline-3">
<h3 id="org949e81b">S 与 M 间的切换</h3>
<div class="outline-text-3" id="text-org949e81b">
</div>
<div id="outline-container-orgb4e16c8" class="outline-4">
<h4 id="orgb4e16c8">S 切换到 M</h4>
</div>
</div>
</div>
<div id="outline-container-org2d14e6c" class="outline-2">
<h2 id="org2d14e6c"></h2>
</div>
</div>
<div id="postamble" class="status">

		  <br/>
		  <div class='ds-thread'></div>
		  <script>
		  var duoshuoQuery = {short_name:'klose911'};
		  (function() {
					  var dsThread = document.getElementsByClassName('ds-thread')[0];
					  dsThread.setAttribute('data-thread-key', document.title);
					  dsThread.setAttribute('data-title', document.title);
					  dsThread.setAttribute('data-url', window.location.href);
					  var ds = document.createElement('script');
					  ds.type = 'text/javascript';ds.async = true;
					  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
					  ds.charset = 'UTF-8';
					  (document.getElementsByTagName('head')[0] 
						|| document.getElementsByTagName('body')[0]).appendChild(ds);
					  })();
		  </script>
		  <script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
		  ga('create', 'UA-90850421-1', 'auto');
		  ga('send', 'pageview');
		  </script>
</div>
</body>
</html>
