#+TITLE: 制作小内存 VPS 的 DD 磁盘镜像
#+HTML_HEAD: <link rel="stylesheet" type="text/css" href="../css/main.css" />
#+OPTIONS: num:nil timestamp:nil ^:nil 
#+HTML_LINK_UP: package.html
#+HTML_LINK_HOME: practise.html

#+begin_example
  黑色星期五已经过了，相信有一些朋友新买了一些特价的 VPS、云服务器等，并且想在 VPS 上安装 NixOS

  但是由于 NixOS 的知名度不如 CentOS、Debian、Ubuntu 等老牌 Linux 发行版，几乎没有 VPS 服务商提供预装 NixOS 的磁盘镜像

  只能由用户使用以下方法之一手动安装：自行挂载 NixOS 的安装 ISO 镜像，然后手动格盘安装
#+end_example
由于可以在 NixOS 安装镜像的环境中随意操作 VPS 的硬盘，这种方法自由度最高，可以任意对硬盘进行分区，指定文件系统格式。但是，使用这种方法前，主机商需要在以下三项前提中满足任意一项：
1. 主机商直接提供 NixOS 的 ISO 镜像挂载（即使是很老的版本）
2. 主机商允许用户上传自定义 ISO 镜像，此时可以直接上传一份 NixOS 的安装 ISO
3. 主机商提供启动 netboot.xyz（一个可以通过网络安装多种 Linux 发行版的工具）的方式，并且 VPS 内存超过 1GB，有足够空间让 netboot.xyz 将 NixOS 的安装镜像解压到内存中
   
#+begin_example
  我这次就购买了一台内存刚好为 1GB 的 VPS，没有足够内存解压 NixOS 23.05 的镜像，因此无法使用 netboot.xyz 启动 NixOS 安装环境

  同时由于我的主机商也不提供自定义镜像功能，我也无法通过光盘启动 NixOS 安装程序
#+end_example

使用 NixOS-Infect 或 NixOS-Anywhere 等工具，直接替换运行在 VPS 上的操作系统
+ NixOS-Infect 工具的原理是在本地系统上安装 Nix Daemon，再使用它构建一个完整的 NixOS 系统，最后将原系统的启动项替换成 NixOS 的
  #+begin_example
    由于这种方法不需要在内存中解压 NixOS 的完整安装镜像，这种方法更适合小内存的 VPS

    但这种方法的缺点是无法自定义分区结构和文件系统类型，只能使用 VPS 服务商的默认分区配置

    对于使用 Btrfs/ZFS 以及 Impermanence 等非标准分区方案/文件系统的用户不友好
  #+end_example
+ 而NixOS-Anywhere 的原理是通过 Linux 内核的 kexec 功能替换当前运行的内核，直接启动到内存中的 NixOS 的安装镜像
  #+begin_example
    本质原理与 netboot.xyz 大致相同，因此也与 netboot.xyz 一样需要较大的内存空间
  #+end_example

先 NixOS-Infect，再在恢复环境中手动调整分区
#+begin_example
  对于类似的小内存 VPS，我曾经使用的方法是，先使用 NixOS-Infect 安装一个普通的 NixOS

  接着部署一份开启了 Btrfs 和 Impermanence 的配置，然后重启到恢复环境

  在恢复环境中调整分区、转换分区格式

  这种方法能用，但是很麻烦，而且一旦中间一步操作出错，很难修复系统，只能从头开始

  还有别的方法吗？
#+end_example

最近 NixOS 社区发布了一款工具 _Disko_ ，它的原本用途是在 NixOS 安装环境中自动对硬盘进行分区，从而实现用 Nix 配置文件声明式管理硬盘分区。但是，这款工具也 *提供* 了根据给定的 _分区表和 NixOS 配置_ ， *自动生成* _磁盘镜像_ 的功能。那么，就可以配置好 Btrfs/ZFS/Impermanence，生成对应的磁盘镜像，再在 VPS 上直接用 dd 命令写入硬盘，就可以简单地安装 NixOS 了 

#+begin_example
  由于这种方法对 VPS 上运行的恢复环境几乎没有要求（有网络和 dd 命令就可以）

  我们可以启动到占用内存很小的 Alpine Linux 发行版，然后通过网络传输磁盘镜像写入 VPS 硬盘
#+end_example
* 准备 NixOS 配置
* 配置镜像中的分区（开启 Impermanence）
* 配置镜像中的分区（普通安装）
* 生成磁盘镜像
* 将磁盘镜像上传到 VPS
* 扩展分区大小
